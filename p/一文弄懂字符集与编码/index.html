<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="这是一个关于计算机和字符的故事">
<title>一文弄懂字符集与编码</title>

<link rel='canonical' href='https://blog.928330.xyz/p/%E4%B8%80%E6%96%87%E5%BC%84%E6%87%82%E5%AD%97%E7%AC%A6%E9%9B%86%E4%B8%8E%E7%BC%96%E7%A0%81/'>

<link rel="stylesheet" href="/scss/style.min.b57f0cd20bf55bdea5fe2a15d986c7a4440b4a33b2d4f9138d2f95367c967d39.css"><meta property='og:title' content="一文弄懂字符集与编码">
<meta property='og:description' content="这是一个关于计算机和字符的故事">
<meta property='og:url' content='https://blog.928330.xyz/p/%E4%B8%80%E6%96%87%E5%BC%84%E6%87%82%E5%AD%97%E7%AC%A6%E9%9B%86%E4%B8%8E%E7%BC%96%E7%A0%81/'>
<meta property='og:site_name' content='kakahuote'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='misc' /><meta property='article:published_time' content='2025-08-13T14:32:41&#43;08:00'/><meta property='article:modified_time' content='2025-08-24T21:42:35&#43;08:00'/><meta property='og:image' content='http://picture.928330.xyz/typora/unicode-101-introduction.social.jpg' />
<meta name="twitter:title" content="一文弄懂字符集与编码">
<meta name="twitter:description" content="这是一个关于计算机和字符的故事"><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='http://picture.928330.xyz/typora/unicode-101-introduction.social.jpg' />
    <link rel="shortcut icon" href="/favicon.ico" />
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>加载动画</title>
    <style>
        .loading {
            position: fixed;
            display: flex;
            flex-direction: column;  
            justify-content: center;
            align-items: center;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 99;
            background-color: #f5f5fa;
            transition: transform 1.5s, opacity 1.5s;
            transform: scale(1);
            opacity: 1;
        }

        .loader-bars {
            display: flex;  
            align-items: flex-end;  
            gap: 3px;  
            margin-bottom: 20px;  
        }

        .bar {
            height: 5px;
            width: 12px;
            animation-duration: 0.45s;
            animation-name: changeHeight;
            animation-iteration-count: infinite;
            animation-direction: alternate;
        }

        .red {
            background-color: #E50000;
            box-shadow: 1px 1px 10px #E50000;
            animation-delay: 0.10s;
        }

        .orange {
            background-color: #FF8D00;
            box-shadow: 1px 1px 10px #FF8D00;
            animation-delay: 0.20s;
        }

        .yellow {
            background-color: #FFEE00;
            box-shadow: 1px 1px 10px #FFEE00;
            animation-delay: 0.25s;
        }

        .green {
            background-color: #008121;
            box-shadow: 1px 1px 10px #008121;
            animation-delay: 0.30s;
        }

        .blue {
            background-color: #004CFF;
            box-shadow: 1px 1px 10px #004CFF;
            animation-delay: 0.35s;
        }

        .violet {
            background-color: #760188;
            box-shadow: 1px 1px 10px #760188;
            animation-delay: 0.40s;
        }

        @keyframes changeHeight {
            from {
                height: 5px;
            }

            to {
                height: 40px;
            }
        }

        .scaleAndFadeout {
            transform: scale(1.5);
            opacity: 0;
        }

         
        .loading-text {
            color: #333;  
            font-size: 16px;  
        }
    </style>
</head>
<body>

    <div class="loading">
        <div class="loader-bars">
            <div class="red bar"></div>
            <div class="orange bar"></div>
            <div class="yellow bar"></div>
            <div class="green bar"></div>
            <div class="blue bar"></div>
            <div class="violet bar"></div>
        </div>
        <div class="loading-text">loading...</div>
    </div>

    <script>
        function initLoading() {
            let loading = document.querySelector(".loading");
            document.addEventListener('DOMContentLoaded', function() {
                setTimeout(() => {
                    loading.classList.add("scaleAndFadeout");
                    setTimeout(() => {
                        loading.style.display = "none";
                    }, 1500);
                }, 50);
            });
        }

        initLoading();
    </script>

</body>
</html>
    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="切换菜单">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/" id="avatar-link">
                
                    
                    
                    
                        
                        <img class="site-logo original-logo" src="/img/avatar_hu_4804467f7cda2058.png" width="300" height="300" loading="lazy" alt="原始头像">
                    
                    
                        
                        <img class="site-logo hover-logo" src="/img/avatar-hover_hu_f231304c77e946da.png" width="300" height="300" loading="lazy" alt="悬停头像">
                    
                
                </a>
                
                    <span class="emoji">🤝</span>
                
            </figure>
            
        

        <div class="site-meta">
            <h1 class="site-name"><a href="/">kakahuote</a></h1>
            <h2 class="site-description">靡不有初，鲜克有终</h2>
        </div>
    </header>

    <ol class="menu-social">
                <li>
                    <a
                        href='https://bilibili.com'
                        target="_blank"
                        title="bilibili"
                        rel="me"
                    >
                        
                        
                            <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-brand-bilibili"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 10a4 4 0 0 1 4 -4h10a4 4 0 0 1 4 4v6a4 4 0 0 1 -4 4h-10a4 4 0 0 1 -4 -4v-6z" /><path d="M8 3l2 3" /><path d="M16 3l-2 3" /><path d="M9 13v-2" /><path d="M15 11v2" /></svg>
                        
                    </a>
                </li>
            
                <li>
                    <a
                        href='https://github.com'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            </ol>

    <ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>主页</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>归档</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>搜索</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E5%8F%8B%E9%93%BE/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>友链</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>暗色模式</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>
    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">目录</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li>
      <ol>
        <li><a href="#基础概念字符字形字节与字">基础概念：字符、字形、字节与字</a>
          <ol>
            <li><a href="#字符character">字符（Character）</a></li>
            <li><a href="#字形glyph">字形（Glyph）</a></li>
            <li><a href="#字节byte">字节（Byte）</a></li>
            <li><a href="#字word">字（Word）</a>
              <ol>
                <li><a href="#计算机中的字word">计算机中的“字”（Word）</a></li>
                <li><a href="#人类语言中的字">人类语言中的“字”</a></li>
              </ol>
            </li>
          </ol>
        </li>
        <li><a href="#字符集">字符集</a>
          <ol>
            <li><a href="#字符集的历史演进与兼容性问题">字符集的历史演进与兼容性问题</a>
              <ol>
                <li><a href="#ascii时代">ASCII时代</a></li>
                <li><a href="#地区性字符集时代">地区性字符集时代</a></li>
                <li><a href="#unicode时代">Unicode时代</a></li>
              </ol>
            </li>
            <li><a href="#字符集标准组织">字符集标准组织</a></li>
          </ol>
        </li>
        <li><a href="#编码">编码</a>
          <ol>
            <li><a href="#编码格式">编码格式</a>
              <ol>
                <li><a href="#多字节字符集-mbcs---multi-byte-character-set">多字节字符集 (MBCS - Multi-byte Character Set)</a></li>
                <li><a href="#宽字符-wide-character">宽字符 (Wide Character)</a></li>
              </ol>
            </li>
            <li><a href="#编码方式">编码方式</a>
              <ol>
                <li><a href="#ascii编码">ASCII编码</a></li>
                <li><a href="#gbk编码">GBK编码</a></li>
                <li><a href="#utf-8编码现代标准">UTF-8编码（现代标准）</a></li>
                <li><a href="#utf-16-编码">UTF-16 编码</a></li>
                <li><a href="#utf-32-编码">UTF-32 编码</a></li>
              </ol>
            </li>
            <li><a href="#字节序">字节序</a></li>
          </ol>
        </li>
        <li><a href="#乱码">乱码</a>
          <ol>
            <li><a href="#错误的翻译--gbk打开utf-8文件">错误的翻译 —— GBK打开UTF-8文件</a></li>
            <li><a href="#锟斤拷">“锟斤拷”</a>
              <ol>
                <li><a href="#替换字符">替换字符</a></li>
                <li><a href="#错误的诞生">错误的诞生</a></li>
              </ol>
            </li>
            <li><a href="#无能的编码检测">无能的编码检测</a></li>
          </ol>
        </li>
        <li><a href="#字符的变形">字符的变形</a>
          <ol>
            <li><a href="#同形异义">同形异义</a></li>
            <li><a href="#历史渊源">历史渊源</a></li>
            <li><a href="#归一化标准">归一化标准</a></li>
          </ol>
        </li>
        <li><a href="#特殊字符">特殊字符</a>
          <ol>
            <li><a href="#零宽字符">零宽字符</a>
              <ol>
                <li><a href="#看不见的字符">看不见的字符</a></li>
                <li><a href="#qq的反转id">QQ的反转id</a></li>
                <li><a href="#零宽字符隐写">零宽字符隐写</a></li>
              </ol>
            </li>
            <li><a href="#变体选择符">变体选择符</a></li>
          </ol>
        </li>
        <li><a href="#工具与应用">工具与应用</a>
          <ol>
            <li><a href="#输入法input-method-editor-ime">输入法（Input Method Editor, IME）</a>
              <ol>
                <li><a href="#步骤一事件拦截">步骤一：事件拦截</a></li>
                <li><a href="#步骤二转换引擎">步骤二：转换引擎</a></li>
                <li><a href="#步骤三候选界面">步骤三：候选界面</a></li>
                <li><a href="#步骤四文本提交">步骤四：文本提交</a></li>
              </ol>
            </li>
            <li><a href="#编码转换工具和库">编码转换工具和库</a>
              <ol>
                <li><a href="#iconv">iconv</a></li>
                <li><a href="#icu">ICU</a></li>
                <li><a href="#编程语言">编程语言</a></li>
              </ol>
            </li>
          </ol>
        </li>
      </ol>
    </li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/p/%E4%B8%80%E6%96%87%E5%BC%84%E6%87%82%E5%AD%97%E7%AC%A6%E9%9B%86%E4%B8%8E%E7%BC%96%E7%A0%81/">
                
                    <img src="http://picture.928330.xyz/typora/unicode-101-introduction.social.jpg" loading="lazy" alt="Featured image of post 一文弄懂字符集与编码" />
                
            </a>
        </div>
    

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/%E6%8A%80%E6%9C%AF%E9%9A%8F%E7%AC%94/" >
                技术随笔
            </a>
        
    </header>
    

    <div class="article-title-wrapper">


        <h2 class="article-title">
            <a href="/p/%E4%B8%80%E6%96%87%E5%BC%84%E6%87%82%E5%AD%97%E7%AC%A6%E9%9B%86%E4%B8%8E%E7%BC%96%E7%A0%81/">一文弄懂字符集与编码</a>
        </h2>
        
        <h3 class="article-subtitle">
            这是一个关于计算机和字符的故事
        </h3>
        

    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">
                    发布时间：2025-08-13</time>
            </div>
        

        

        <div class="article-lastmod">
               <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



               <time>
                   更新时间：2025-08-24
               </time>
           </div>
        <div>
            <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-eye"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" /><path d="M21 12c-2.4 4 -5.4 6 -9 6c-3.6 0 -6.6 -2 -9 -6c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6" /></svg>
            <time class="article-time--published">
                浏览量：<span class="waline-pageview-count" data-waline-pageview-count="0">0</span>
            </time>
        </div>
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <p>在计算机的世界里，我们看到的所有内容 —— 无论是文字、符号还是表情 —— 本质上都是一串串由<code>0</code>和<code>1</code>组成的二进制数字</p>
<p>那么一个我们能看懂的、有意义的符号，是如何被计算机存储，又是如何被准确无误地显示出来的呢？</p>
<p>这个过程就是我们今天要讲述的关于“字符”的完整故事</p>
<h2 id="基础概念字符字形字节与字">基础概念：字符、字形、字节与字
</h2><p>要理解后续的一切，我们必须先精确区分几个最基本的概念：</p>
<ul>
<li>抽象的语义单位 —— <strong>字符（Character）</strong></li>
<li>具象的视觉单位 —— <strong>字形（Glyph）</strong></li>
<li>计算机的物理存储单位 —— <strong>字节（Byte）</strong></li>
<li>以及容易混淆的“字”——<strong>计算机的字（Word）</strong> 与 <strong>人类语言的字</strong></li>
</ul>
<h3 id="字符character">字符（Character）
</h3><p><strong>字符，是一个抽象的、信息的基本语义单元，是我们用来表达意义的最小符号</strong></p>
<ul>
<li>
<p>英文字母<code>A</code>、<code>b</code>、<code>c</code>是字符</p>
</li>
<li>
<p>数字<code>1</code>、<code>2</code>、<code>3</code>是字符</p>
</li>
<li>
<p>标点符号<code>.</code>、<code>?</code>、<code>!</code>是字符</p>
</li>
<li>
<p>汉字<code>中</code>、<code>国</code>、<code>人</code>是字符</p>
</li>
<li>
<p>表情符号<code>😂</code>、<code>👍</code>也是字符！</p>
</li>
</ul>
<p>在这个层面，字符是无形的，它只关乎“是什么”，而不关乎“长什么样”或“如何存储”</p>
<h3 id="字形glyph">字形（Glyph）
</h3><p><strong>字形，是字符的具体视觉表现形式，是我们真正在屏幕上看到的那个“形状”</strong></p>
<p>一个字符可以有多种不同的字形：</p>
<ul>
<li>字符“拉丁字母A”可以有 <code>A</code> (正常), <em><strong><code>A</code></strong></em>(粗斜体), <code>𝔸</code> (空心) 等多种字形</li>
<li>同一个汉字“骨”，在宋体、楷体、草书中的字形也完全不同。</li>
</ul>
<p>反过来，多个字符也可能组合成一个字形（这被称为“合字”或“连字”，Ligature）：</p>
<ul>
<li>在某些英文字体中，字符 <code>f</code> 和 <code>i</code> 相邻时，会合并成一个单独的 <code>ﬁ</code> 字形，以避免 <code>f</code> 的钩与 <code>i</code> 的点碰撞。</li>
</ul>
<p><strong>简单说：字符是“骨”，字形是“皮肉”。我们操作和存储的是字符，而最终渲染出来给人看的是字形。</strong></p>
<h3 id="字节byte">字节（Byte）
</h3><p><strong>字节，是计算机中数据存储和处理的基本单位</strong></p>
<ul>
<li><strong>一个字节由8个比特（bit）组成，每个比特非0即1</strong></li>
<li><strong>一个字节能表示2⁸=256种不同的状态（0-255）</strong></li>
</ul>
<h3 id="字word">字（Word）
</h3><p><strong>计算机的“字”与人类的“字”毫无必然联系</strong></p>
<h4 id="计算机中的字word">计算机中的“字”（Word）
</h4><p><strong>在计算机科学中，字（Word）是CPU处理数据的自然单位，是计算机一次性读取、处理或传输的最小数据块</strong></p>
<p><strong>字的大小依赖于计算机架构</strong>：</p>
<ul>
<li>16 位系统的一个字是 2 个字节（16 位）</li>
<li>32 位系统的一个字是 4 个字节（32 位）</li>
<li>64 位系统的一个字是 8 个字节（64 位）</li>
</ul>
<p>在汇编语言和系统底层编程中，“字”是非常重要的基本数据宽度概念</p>
<h4 id="人类语言中的字">人类语言中的“字”
</h4><p>在人类语言里，“字”指的是一个书写符号单位：</p>
<ul>
<li>在中文里，“字”通常是一个汉字，例如<code>中</code>、<code>国</code></li>
<li>在英文里，没有严格对应的“字”概念，通常用<code>letter</code>（字母）或<code>word</code>（单词）描述</li>
<li>在日语里，一个“字”可能是汉字、平假名、片假名中的任意一个符号</li>
</ul>
<p><strong>在大多数情况下，人类语言里的“字”可以看作是一个字符，但它们并不是严格等同的概念</strong></p>
<p><strong>我们可以认为一个英语单词是一个“字”，但它却是多个“字符”的组合</strong></p>
<hr>
<p><span style="color:red;font-size:20px"><strong>那么此时，矛盾就出现了：</strong></span></p>
<p><strong>世界上有成千上万个抽象的“字符”，而计算机的基本存储单元“字节”一次只能表示256种状态！</strong></p>
<p><strong>这就需要建立一套完整的映射体系，才能让所有字符都能在计算机上显示</strong></p>
<h2 id="字符集">字符集
</h2><p>为了让计算机能够处理字符，人们首先需要做一件事：</p>
<p>把世界上所有的字符收集起来，排个队，给每个字符分配一个独一无二的编号</p>
<p><strong>字符集，就是这样一个“字符的集合”以及“字符与编号的对应表”。可以把它想象成一本为全世界所有字符编写的巨大“字典”，而对应的编号，我们称之为码点</strong></p>
<p>字符集本身只是一套标准、一个“名册”，它只规定了“哪个字符对应哪个数字”，但还没有规定这个数字具体应该如何在计算机中用字节来存储</p>
<h3 id="字符集的历史演进与兼容性问题">字符集的历史演进与兼容性问题
</h3><h4 id="ascii时代">ASCII时代
</h4><p>计算机诞生于美国，最早的<strong>ASCII（American Standard Code for Information Interchange，美国信息交换标准代码）字符集</strong>是为英语环境量身定做的</p>
<p>它收录了128个最常用的字符，包括：</p>
<ul>
<li>
<p>95个可打印字符：大小写英文字母（<code>A-Z</code>, <code>a-z</code>）、数字（<code>0-9</code>）、以及各种标点和符号（<code>!</code>,<code>@</code>,<code>#</code>等）</p>
</li>
<li>
<p>33个不可打印的控制字符：如回车（<code>CR</code>）、换行（<code>LF</code>）、制表符（<code>Tab</code>）等，用于控制打印机等设备</p>
</li>
<li>
<p>它的码点范围是0到127，所以用一个字节（0-255）来存储一个ASCII 字符绰绰有余</p>
<p><strong>实际上，ASCII码只用到了一个字节（8个比特）中的低7位，最高位始终为0</strong></p>
<p>例如，字符<code>'A'</code>的码点是 65，其二进制表示为<code>01000001</code></p>
<p>这个“最高位为0”的特性，为后来的扩展埋下了伏笔</p>
</li>
</ul>
<p><strong>ASCII码现在依然在被广泛使用，你可以在很多编程语言里面见到它，而且可以说它是现代字符编码体系的根基</strong></p>
<p>
<div class="post-img-view">
<a data-fancybox="gallery" data-caption="ASCII 表| 菜鸟教程" href="http://picture.928330.xyz/typora/ascii-1-1.png">
<img src="http://picture.928330.xyz/typora/ascii-1-1.png" alt="ASCII 表| 菜鸟教程"  />
</a>
</div>
</p>
<h4 id="地区性字符集时代">地区性字符集时代
</h4><p>当计算机走向世界，问题出现了：</p>
<p>欧洲需要 <code>é</code>, <code>ü</code>，中国需要汉字，日本需要假名，单一的 ASCII 远远不够用！</p>
<p>于是，世界各地纷纷利用ASCII留下的“遗产”—— 那个未被使用的最高位比特0，来扩展自己的字符集</p>
<p><strong>当一个字节的最高位是<code>0</code>时，它仍然表示一个标准的ASCII字符</strong></p>
<p><strong>当最高位是<code>1</code>时，它就进入了各个地区自定义的“扩展区”（码点范围 128-255）</strong></p>
<p>下面是一些比较有代表性的编码方案吗，我们后面还会详细说明：</p>
<ul>
<li>
<p><strong>ISO-8859-1 (Latin-1)</strong></p>
<p>面向西欧，它利用了128-255的码点来表示带音标的字母，如<code>é</code>、<code>ü</code>、<code>©</code> 等</p>
</li>
<li>
<p><strong>GB2312/GBK</strong></p>
<p>面向中国大陆，由于汉字数量远超128个，它采用<strong>双字节编码</strong>方案</p>
<p>当检测到一个字节的最高位是1时，就认为它和紧随其后的下一个字节共同表示一个汉字</p>
<p><code>GBK</code> 是 <code>GB2312</code> 的扩展，收录了更多汉字</p>
</li>
<li>
<p><strong>BIG5</strong></p>
<p>面向中国台湾地区，同样是双字节方案，用于表示繁体字</p>
</li>
<li>
<p><strong>Shift_JIS</strong></p>
<p>面向日本，是一个更复杂的变长编码方案，用于表示日文汉字和假名</p>
</li>
</ul>
<p><span style="color:red"><strong>虽然这样方便了各个地区的用户，但也是之后乱码问题出现的罪魁祸首</strong></span></p>
<h4 id="unicode时代">Unicode时代
</h4><p>为了终结大家各用各的这种混乱，Unicode应运而生</p>
<p>它的目标是“天下书同文”，它不是要创造又一个与其它标准竞争的字符集，而是要统一和包容所有字符！</p>
<p>也就是说，它要为地球上每一种语言的每一个字符都分配一个全球唯一的码点！</p>
<p>这一伟大的工程<del>应该</del>造福了全人类·，所以我们也叫他<strong>统一码/万国码</strong></p>
<p><strong>Unicode码点的标准表示方法是用<code>U+十六进制数字</code>来表示：</strong></p>
<ul>
<li>汉字<code>中 </code>的Unicode码点是<code>U+4E2D</code></li>
<li>表情<code>😂 </code>的Unicode码点是<code>U+1F602</code></li>
</ul>
<p><strong>你也可能看到另一种方法：<code>\u+十六进制数字</code>，这是编程语言中的转义字符表示法：</strong></p>
<ul>
<li>汉字<code>中 </code>的Unicode转义字符是<code>\u4E2D</code></li>
<li>表情<code>😂 </code>的Unicode转义字符是<code>\u1F602</code></li>
</ul>
<p>如何存储如此庞大的字符量呢？</p>
<p><strong>Unicode标准码点范围是从<code>U+0000</code>到<code>U+10FFFF</code>，共计约1,114,112个码点</strong></p>
<p><strong>这些码点被划分成17 个平面（Planes），每个平面包含65536（即 2¹⁶）个码点</strong>：</p>
<ul>
<li>
<p><strong>基本多文种平面（BMP, Plane 0）</strong></p>
<p>包含了从<code>U+0000</code>到<code>U+FFFF</code>的码点，涵盖了世界上绝大多数常用字符，包括常用汉字</p>
</li>
<li>
<p><strong>辅助平面（Supplementary Planes, Plane 1–16）</strong></p>
<p>包含了从<code>U+010000</code>到<code>U+10FFFF</code>的码点，用于表示生僻字、古代文字以及各种符号，比如Emoji表情</p>
</li>
</ul>
<p>从此，无论在哪个国家、哪个平台，<code>U+4E2D</code>永远只代表<code>中</code>这一个字符</p>
<h3 id="字符集标准组织">字符集标准组织
</h3><p>制定这些标准的是一些国际组织，其中最重要的是：</p>
<ul>
<li>
<p><strong>Unicode联盟（Unicode Consortium）</strong></p>
<p>一个非营利组织，其成员包括苹果、谷歌、微软、Adobe等各大科技巨头。它负责开发、维护和推广Unicode标准，包括我们日常使用的Emoji表情的标准化</p>
</li>
<li>
<p><strong>国际标准化组织（ISO）</strong></p>
<p>它也发布了与Unicode对应的 ISO/IEC 10646 标准，基本上可以认为Unicode和 ISO/IEC 10646 是同一个字符集标准的不同名称</p>
</li>
</ul>
<hr>
<p><strong>至此，我们通过字符集，成功地将所有抽象的字符转化为了全球统一的数字（码点）</strong></p>
<p><span style="color:yellow;"><strong>一个极其重要的问题</strong></span>：</p>
<p><strong>Unicode本身只定义了码点，它并没有规定这个号码在计算机中应该如何用字节来存储！</strong></p>
<h2 id="编码">编码
</h2><p>现在我们有了“字符”和“码点”的对应关系（字符集），但还有一个最关键、最实际的问题没有解决：</p>
<p>如何将这些码点（数字），特别是那些大于 255 的庞大数字，高效地用计算机唯一懂的语言来表示？</p>
<p><strong>答案是编码 —— 将字符的码点（数字）翻译成字节序列（物理存储）的具体规则</strong></p>
<p>如果说字符集是字典，那编码就是语法规则，它教我们如何用字节来书写字典里的每一个页码（码点）</p>
<h3 id="编码格式">编码格式
</h3><p>在编程领域，为了处理非ASCII字符，历史上形成了两种截然不同的解决思路</p>
<h4 id="多字节字符集-mbcs---multi-byte-character-set">多字节字符集 (MBCS - Multi-byte Character Set)
</h4><p><strong>这是一种“让程序变聪明”的编码层面解决方案</strong></p>
<p>字符串在内存中仍然以<code>char</code>数组的形式存放，但程序在处理时，必须“意识到”这个字节序列采用了某种特定编码（如 GBK）</p>
<p>比如，对于C语言字符串 <code>&quot;你好&quot;</code>，在GBK编码下，它占4个字节</p>
<ul>
<li><code>strlen(&quot;你好&quot;)</code>会返回4，因为它只认识字节</li>
<li>而一个特殊的、能识别多字节的函数<code>mbstrlen(&quot;你好&quot;)</code>则会返回2，因为它知道两个字节才构成一个汉字</li>
</ul>
<p>这种方式处理起来非常复杂且极易出错，因为我们不能再想当然地通过<code>str[i]</code>来访问第i个字符 —— <code>str[i]</code>可能只是一个汉字的前半部分！字符串的截取、遍历和修改都变得困难了！</p>
<h4 id="宽字符-wide-character">宽字符 (Wide Character)
</h4><p><strong>这是一种“让数据类型变强大”的数据类型层面解决方案</strong></p>
<p>它不再让程序去适应复杂的字节流，而是定义了一个新的、足够宽的数据类型，这个类型通常是2或4个字节</p>
<p>比如我们在C++中定义一个这样的宽字符<code>wchar_t</code>类型：</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#e5c07b">wchar_t</span><span style="color:#56b6c2">*</span> <span style="color:#e06c75">wide_str</span> <span style="color:#56b6c2">=</span> <span style="color:#98c379">L</span><span style="color:#98c379">&#34;你好&#34;</span>;
</span></span></code></pre></div><p><code>wide_str</code>数组的每个元素都能完整地存放一个字符的码点，而<code>L</code>前缀告诉编译器，这个字符串用宽字符存储，不是普通的<code>char</code>字符串</p>
<p><code>wide_str[0]</code>就是字符<code>你</code>，<code>wide_str[1]</code>就是字符<code>好</code>，数组长度为2</p>
<p>这让字符串的索引和遍历恢复了简单</p>
<p><strong>他也有不少缺点</strong>：</p>
<ul>
<li>
<p><strong>空间浪费</strong></p>
<p>即使是存储纯英文 &ldquo;hello&rdquo;，每个字符也要占用2或4个字节，造成空间浪费</p>
</li>
<li>
<p><strong>跨平台困难</strong></p>
<p>虽然很难以置信，但<code>wchar_t</code>的具体大小在不同主流操作系统上并不统一！</p>
<p>在 Windows 上它通常是 2 字节（对应 UTF-16），而在 Linux 和 macOS 上它通常是 4 字节（对应 UTF-32），这使得依赖 <code>wchar_t</code> 的代码难以跨平台移植！</p>
</li>
</ul>
<p>+++</p>
<p>正是因为这两种早期方案都有明显的缺陷，现代编程实践大多推荐直接使用UTF-8编码的普通<code>char</code>字符串，并配合专门、可靠的库（如 ICU）来处理复杂的字符串操作</p>
<p>至于什么是UTF-8编码，我们接着往下看</p>
<h3 id="编码方式">编码方式
</h3><h4 id="ascii编码">ASCII编码
</h4><p>最简单的编码，码点值就是字节值</p>
<p>字符<code>'A'</code>的码点是 65，其编码就是一个值为 65 的字节</p>
<h4 id="gbk编码">GBK编码
</h4><p>GBK的全称是国标扩展码拼音“Guóbiāo Kuòzhǎn”的缩写</p>
<p>这是一种典型的多字节编码（MBCS），解码时检查一个字节的最高位：</p>
<ul>
<li><strong>如果为<code>0</code>（0-127），则它本身就是一个单字节的ASCII字符</strong></li>
<li><strong>如果为<code>1</code>（128-255），则它必须和紧随其后的下一个字节共同组成一个双字节的汉字</strong></li>
</ul>
<h4 id="utf-8编码现代标准">UTF-8编码（现代标准）
</h4><p><strong>这是现代互联网的基石，它是一种针对Unicode的、可变长度的字符编码，其设计堪称精妙绝伦</strong></p>
<p><strong>它兼容ASCII编码</strong>：对英文字母和数字用1个字节编码，与ASCII完全一样，这意味着一个纯英文的ASCII文件，本身就是一个合法的UTF-8文件，无需任何转换</p>
<p><strong>它对不同字符有不同字节规定</strong>：对拉丁文、希腊文用2字节；对常用汉字用3字节；对罕见字符和表情用4字节</p>
<p><strong>UTF-8通过每个字节开头的几个比特来标记这个字符的长度：</strong></p>
<ul>
<li><code>0xxxxxxx</code>: 单字节，表示U+0000到U+007F(ASCII)</li>
<li><code>110xxxxx 10xxxxxx</code>: 双字节，由一个<code>110</code>开头的字节和个<code>10</code>开头的字节组成</li>
<li><code>1110xxxx 10xxxxxx 10xxxxxx</code>: 三字节，由一个<code>1110</code>开头的字节和两个<code>10</code>开头的字节组成</li>
<li><code>11110xxx 10xxxxxx 10xxxxxx 10xxxxxx</code>: 四字节</li>
</ul>
<p>具体对应关系如下：</p>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>Unicode 范围 (十六进制)</th>
          <th>UTF-8 字节序列 (二进制)</th>
          <th>字节数</th>
          <th>常见语言/用途举例</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>U+0000</code> - <code>U+007F</code></td>
          <td><code>0xxxxxxx</code></td>
          <td>1</td>
          <td><strong>英语</strong>（基本拉丁字母）、数字、ASCII 标点、控制字符</td>
      </tr>
      <tr>
          <td><code>U+0080</code> - <code>U+07FF</code></td>
          <td><code>110xxxxx 10xxxxxx</code></td>
          <td>2</td>
          <td><strong>拉丁文扩展</strong>（é ñ 等）、希腊文、俄语西里尔字母、希伯来文、阿拉伯文</td>
      </tr>
      <tr>
          <td><code>U+0800</code> - <code>U+FFFF</code></td>
          <td><code>1110xxxx 10xxxxxx 10xxxxxx</code></td>
          <td>3</td>
          <td><strong>东亚文字</strong>（中文、日文假名、韩文音节）、越南文、泰文、天城文（印地语等）、大部分表情符号</td>
      </tr>
      <tr>
          <td><code>U+10000</code> - <code>U+10FFFF</code></td>
          <td><code>11110xxx 10xxxxxx 10xxxxxx 10xxxxxx</code></td>
          <td>4</td>
          <td><strong>罕见/扩展字符</strong>（CJK 扩展汉字、古代文字、乐谱符号、更多表情符号）</td>
      </tr>
  </tbody>
</table></div>
<p><strong>这些<code>x</code>是实际用来填充字符码点二进制位的地方，从右向左、从低位到高位填充</strong></p>
<p>eg：汉字“中” (<code>U+4E2D</code>)</p>
<ol>
<li><strong>Unicode 码点</strong>：<code>U+4E2D</code></li>
<li><strong>范围</strong>：<code>4E2D</code>在<code>U+0800</code> - <code>U+FFFF</code>之间，所以需要 <strong>3 个字节</strong></li>
<li><strong>二进制表示</strong>：<code>4E2D</code>的二进制是<code>0100 1110 0010 1101</code> (16位)</li>
<li><strong>匹配模板</strong>：三字节模板是<code>1110xxxx 10xxxxxx 10xxxxxx</code>。这个模板共有4+6+6=16个<code>x</code>，正好容纳16位</li>
<li><strong>填充</strong>
<ul>
<li>最右边的6个<code>x</code>填入最低的6位：<code>001101</code></li>
<li>中间的6个<code>x</code>填入接下来的6位：<code>111000</code></li>
<li>最左边的4个<code>x</code>填入最高的4位：<code>0100</code></li>
</ul>
</li>
<li><strong>得到字节序列</strong>
<ul>
<li><code>1110 0100</code> -&gt; <code>E4</code></li>
<li><code>10 111000</code> -&gt; <code>B8</code></li>
<li><code>10 001101</code> -&gt; <code>AD</code></li>
</ul>
</li>
<li><strong>结果</strong>：汉字“中”的UTF-8编码是**<code>E4 B8 AD</code>**</li>
</ol>
<p><strong>这种设计确保了程序在任何位置开始读取字节流，都能准确判断出一个字符的起始和结束边界</strong></p>
<h4 id="utf-16-编码">UTF-16 编码
</h4><p><strong>UTF-16也是一种用于编码Unicode字符的格式</strong></p>
<p><strong>它通常使用2个字节（对于BMP内的字符）或4个字节（对于辅助平面的字符）来表示一个字符</strong></p>
<p>由于其大部分情况下定长的特性，便于程序内部进行索引，因此被广泛用作许多系统和语言的<strong>内部内存表示</strong>，例如Windows操作系统内核、Java语言的<code>String</code>类型</p>
<h4 id="utf-32-编码">UTF-32 编码
</h4><p><strong>类似UTF-16，它也是定长的，为每一个字符分配固定的4个字节（32位）来存储其Unicode码点值</strong></p>
<p>它和UTF-16一样，在文件存储和网络传输方面不如UTF-8流行，一个主要原因就是接下来要讲的字节序问题</p>
<h3 id="字节序">字节序
</h3><p>当一个字符需要用多个字节来表示时，就必须面对一个问题：</p>
<p>这些字节应该按什么顺序存储？就像写数字<code>258</code>，是从左到右写 <code>2, 5, 8</code>，还是从右到左写<code>8, 5, 2</code>？</p>
<p>这也就是所谓的<strong>字节序 —— 多字节数据在内存或文件中按字节排列的顺序</strong></p>
<p>UTF-8的编码规则中，字节内部的位顺序是固定的，没有所谓“高字节”和“低字节”的问题；而UTF-16和UTF-32是定长的，而且字节内部可以交换顺序，所以会有字节序区别</p>
<p>常见的两种字节序：</p>
<ul>
<li>
<p><strong>大端序 (Big-Endian, BE)</strong>：<strong>高位的有效字节存放在内存的低地址（大头在前）</strong></p>
<p>这符合人类的阅读习惯</p>
</li>
<li>
<p><strong>小端序 (Little-Endian, LE)</strong>：<strong>低位的有效字节存放在内存的低地址（小头在前）</strong></p>
<p>这在 x86 架构的计算机（我们日常使用的大多数 PC）中更为常见</p>
</li>
</ul>
<p>比如，字符 <code>中</code>的UTF-16编码 (<code>U+4E2D</code>) 是两个字节<code>4E</code>和<code>2D</code>：</p>
<ul>
<li>在大端序系统上，内存中存储为：<code>... [地址1000]: 4E, [地址1001]: 2D ...</code></li>
<li>在小端序系统上，内存中存储为：<code>... [地址1000]: 2D, [地址1001]: 4E ...</code></li>
</ul>
<p>如果搞错了字节序，解码就会出错！</p>
<p><strong>为了解决这个问题，人们发明了BOM(Byte Order Mark)，它是一个放在文件开头的、不可见的特殊暗号字符（码点为 <code>U+FEFF</code>）</strong></p>
<p>通过读取文件开头的几个字节，以BOM为参考，程序就可以判断文件的字节序和编码：</p>
<ul>
<li>如果文件开头是<code>FE FF</code>，说明是<strong>UTF-16 大端序</strong></li>
<li>如果文件开头是<code>FF FE</code>，说明是<strong>UTF-16 小端序</strong></li>
<li>如果文件开头是<code>EF BB BF</code>，说明是<strong>UTF-8</strong></li>
</ul>
<p><strong>正如前面所说，UTF-8本身没有字节序问题，它的BOM只是用来表明这是一个UTF-8文件</strong></p>
<p><strong>然而，在Web开发和类Unix系统中，普遍推荐使用不带 BOM 的 UTF-8（UTF-8 without BOM），因为某些旧的脚本和工具可能不认识 BOM，并将其作为垃圾内容输出，导致页面顶部出现空行或其他问题</strong></p>
<hr>
<p>理解了前面的字符集和编码，乱码的产生原因就非常清晰了</p>
<h2 id="乱码">乱码
</h2><p><span style="color:red;font-size:18px"><strong>乱码的唯一根源在于：用 A 编码方式存储的字节序列，却被当作 B 编码方式去解码和显示。</strong></span></p>
<p>这就像你拿到一份用中文密码本加密的信息，却错误地拿了一本俄文密码本去解密，结果自然是一堆谁也看不懂的天书</p>
<p>字节本身是无辜的，它们只是一串0和1，真正的罪魁祸首是解码时错误的假设</p>
<h3 id="错误的翻译--gbk打开utf-8文件">错误的翻译 —— GBK打开UTF-8文件
</h3><p><strong>这是最常见的场景：我们用国际标准的UTF-8创建了文件，但它被一个只认识本地编码的旧程序打开了</strong></p>
<p>我们用 Python 写入一句话<code>“你好，世界”</code>，并明确使用<code>utf-8</code>编码保存，查看它UTF-8编码字节</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#e06c75">text</span> <span style="color:#56b6c2">=</span> <span style="color:#98c379">&#34;你好，世界&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e06c75">utf8_bytes</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">text</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">encode</span>(<span style="color:#98c379">&#39;utf-8&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#c678dd">with</span> <span style="color:#e5c07b">open</span>(<span style="color:#98c379">&#34;utf8.txt&#34;</span>, <span style="color:#98c379">&#34;wb&#34;</span>) <span style="color:#c678dd">as</span> <span style="color:#e06c75">f</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">f</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">write</span>(<span style="color:#e06c75">utf8_bytes</span>)
</span></span><span style="display:flex;"><span><span style="color:#e5c07b">print</span>(<span style="color:#e06c75">utf8_bytes</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">hex</span>()<span style="color:#56b6c2">.</span><span style="color:#e06c75">upper</span>())
</span></span></code></pre></div><p>输出：</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#e06c75">E4BDA0E5A5BDEFBC8CE4B896E7958C</span>
</span></span></code></pre></div><p>我们再模拟一个旧程序用<code>gbk</code>编码去读取这个<code>hello_utf8.txt</code>文件：</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#c678dd">with</span> <span style="color:#e5c07b">open</span>(<span style="color:#98c379">&#34;utf8.txt&#34;</span>, <span style="color:#98c379">&#34;rb&#34;</span>) <span style="color:#c678dd">as</span> <span style="color:#e06c75">f</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">byte_data</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">f</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">read</span>()
</span></span><span style="display:flex;"><span><span style="color:#7f848e">#errors=&#39;replace&#39; 表示遇到无法解码的字节时，用 &#39;&#39; 替换</span>
</span></span><span style="display:flex;"><span><span style="color:#e06c75">garbled_text</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">byte_data</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">decode</span>(<span style="color:#98c379">&#39;gbk&#39;</span>, <span style="color:#e06c75">errors</span><span style="color:#56b6c2">=</span><span style="color:#98c379">&#39;replace&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#e5c07b">print</span>(<span style="color:#e06c75">garbled_text</span>)
</span></span></code></pre></div><p>输出：</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#e06c75">浣犲ソ锛屼笘鐣</span>�
</span></span></code></pre></div><p><strong>这就是典型的乱码，因为utf-8下的<code>E4BDA0...</code>这串字节在GBK的字典里恰好对应了另一组完全不同的汉字</strong></p>
<h3 id="锟斤拷">“锟斤拷”
</h3><p><strong>这个著名的乱码组合，就是源于将UTF-8编码的汉字，错误地用 GBK 或其他本地编码来显示</strong></p>
<p><span style="color:yellow;"><strong>它的成因非常特殊，它源于对“错误”本身的再次错误解读</strong></span></p>
<h4 id="替换字符">替换字符
</h4><p>这个故事的主角，是一个特殊的Unicode字符 —— <strong>替换字符</strong></p>
<p>当一个程序在解码字节流时，如果遇到了一个不符合当前编码规则的、无法识别的无效字节序列，该怎么办？</p>
<p>一个设计良好的程序不会崩溃，而是会遵循Unicode标准，在那个出错的位置插入一个官方的<strong>替换字符</strong>，也就是**<code>U+FFFD</code>**，它在屏幕上通常显示为一个黑色的菱形中间带一个问号</p>
<h4 id="错误的诞生">错误的诞生
</h4><p>现在，让我们用代码来模拟它的产生过程：</p>
<p>假设一个程序（比如数据库、文本编辑器等）在处理数据时，遇到了它无法理解的字节，作为安全措施，程序在内存中生成了两个Unicode替换字符，我们在Python中可以直接用它的码点 \uFFFD 来表示：</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#e06c75">error_text</span> <span style="color:#56b6c2">=</span> <span style="color:#98c379">&#34;</span><span style="color:#98c379">\uFFFD\uFFFD</span><span style="color:#98c379">&#34;</span>
</span></span></code></pre></div><p>接下来，程序将包含这两个替换字符的字符串，以标准的UTF-8格式写入文件，一个<code>U+FFFD</code>的UTF-8编码是 3个字节：<code>EF</code> <code>BF</code> <code>BD</code></p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#e06c75">utf8_error</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">error_text</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">encode</span>(<span style="color:#98c379">&#39;utf-8&#39;</span>)
</span></span></code></pre></div><p>现在，另一个程序（或用户）错误地使用 GBK 编码来读取这串字节，注意这里必须用 gbk 编码，如果用 gb2312会因字符不全而报错：</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#e06c75">text</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">utf8_error</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">decode</span>(<span style="color:#98c379">&#39;gbk&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#e5c07b">print</span>(<span style="color:#98c379">f</span><span style="color:#98c379">&#34;GBK解码结果: &#39;</span><span style="color:#98c379">{</span><span style="color:#e06c75">text</span><span style="color:#98c379">}</span><span style="color:#98c379">&#39;&#34;</span>)
</span></span></code></pre></div><p>结果：</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#e06c75">锟斤拷</span>
</span></span></code></pre></div><p><strong>其中过程是怎么样的？</strong></p>
<ol>
<li>程序读取 <code>EF BF BD EF BF BD</code>这6个字节</li>
<li>GBK 解码器按两个字节一组来处理，因为它认为最高位是 <code>1</code> 的字节都是双字节字符的一部分：
<ul>
<li>读到**<code>EF BF</code><strong>，去查GB码表，这对字节恰好对应了汉字</strong><code>锟</code>**</li>
<li>接着读到**<code>BD EF</code><strong>，再次去查GBK码表，这对字节也恰好有对应汉字</strong><code>斤</code>**</li>
<li>最后读到**<code>BF BD</code><strong>，第三次去查GBK码表，这对字节同样对应了一个汉字</strong><code>拷</code>**</li>
</ul>
</li>
<li>就这样，原本代表解码错误的、在UTF-8下有明确含义的字节序列，在 GBK解码器的一系列巧合误解之下，被翻译成了我们在座各位都无比熟悉的三个汉字——<strong><code>锟斤拷</code></strong></li>
</ol>
<p><strong>锟斤拷是传播比较广泛的乱码，真正的乱码形式多种多样，网上有人整理了常见的乱码对照表：</strong></p>
<p>
<div class="post-img-view">
<a data-fancybox="gallery" data-caption="乱码对照表_乱码符号-CSDN博客" href="http://picture.928330.xyz/typora/07e042d16001b86b36b38a36dfaf3475.jpeg">
<img src="http://picture.928330.xyz/typora/07e042d16001b86b36b38a36dfaf3475.jpeg" alt="乱码对照表_乱码符号-CSDN博客"  />
</a>
</div>
</p>
<p>如果你不记得什么是ISO-8859-1：<a class="link" href="#%e5%9c%b0%e5%8c%ba%e6%80%a7%e5%ad%97%e7%ac%a6%e9%9b%86%e6%97%b6%e4%bb%a3" >地区性字符集时代
    
</a></p>
<p>表里面提到锟拷码是gbk读取两次的结果，其实就是utf-8 -&gt;错误字符 -&gt; 替换字符 -&gt; 锟斤拷</p>
<h3 id="无能的编码检测">无能的编码检测
</h3><p>既然乱码是因编码不匹配产生的，那程序能自动检测文件的编码吗？</p>
<p><strong>答案是可以，但永远不可靠</strong></p>
<p>编码检测本质上是一种启发式猜测，线索极少</p>
<p>程序会读取一部分字节，然后用各种常见编码的规则去试，并根据以下线索进行打分：</p>
<ol>
<li>
<p><strong>BOM (Byte Order Mark)</strong></p>
<p>这是最可靠的线索，如果文件开头有<code>EF BB BF</code>，那几乎可以100%确定是UTF-8</p>
<p>但我们上面也说过了，绝大多数文件（特别是网页）为了兼容性，并不带BOM</p>
</li>
<li>
<p><strong>无效字节序列</strong></p>
<p>编码有其严格的字节组合规则，如果在尝试用GBK解码时，出现了大量不符合其双字节规则的序列（像上面例子中的单个<code>0xAA</code>），那么程序就会认为这可能不是GBK</p>
</li>
<li>
<p><strong>统计学特征</strong></p>
<p>分析字节的分布规律，例如，一段英文文本如果用UTF-8编码，大部分字节都会在0-127范围内。而一段中文GBK文本，则会出现大量连续成对的大于127的字节</p>
</li>
</ol>
<p><strong>然而，这种方法是不可靠的：</strong></p>
<ul>
<li>
<p>对于短文本，样本太少，统计学方法完全失效</p>
</li>
<li>
<p>巧合时有发生，有些字节序列在多种编码下恰好都是“合法”的，只是代表的意义不同</p>
<p>在早期的windows版本中，如果使用写字板打开txt文件，输入“联通”两个字，此时是以GBK形式保存，但由于他们的编码恰好和utf-8的双字节格式相同（比如“联”是<code>C1</code> <code>AA</code>，即<code>11000001</code> <code>10101010</code>），阅读器错误的使用utf-8解码它们，就会导致乱码</p>
<p>还有一个著名的例子就是短语<code>Bush hid the facts</code>，这也是一个在中文Windows系统上曾广为人知的文本显示乱码，当它以ASCII/UTF-8保存后，如果被程序错误地当作UTF-16LE来打开，会显示出几个汉字<code>联 আরি󏐠</code>或类似乱码</p>
</li>
</ul>
<p><strong>所以，永远不要依赖自动检测！</strong></p>
<p>与其让接收方去费力猜测，不如让发送方在明确标注语言，现代协议和格式都会提供这种明确指定编码的机制</p>
<p>例如：</p>
<p><strong>HTTP响应头</strong>：服务器在返回网页时，通过这个头信息告诉浏览器用什么编码来解析</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#e06c75">Content</span><span style="color:#56b6c2">-</span><span style="color:#e06c75">Type</span>: <span style="color:#e06c75">text</span><span style="color:#56b6c2">/</span><span style="color:#e06c75">html</span>; <span style="color:#e06c75">charset</span><span style="color:#56b6c2">=</span><span style="color:#e06c75">utf</span><span style="color:#56b6c2">-</span><span style="color:#d19a66">8</span>
</span></span></code></pre></div><p><strong>HTML文件头</strong>：在HTML文件内部，通过meta标签再次声明编码，作为服务器未发送上述头信息时的备用方案</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-HTML" data-lang="HTML"><span style="display:flex;"><span>&lt;<span style="color:#e06c75">meta</span> <span style="color:#e06c75">charset</span><span style="color:#56b6c2">=</span><span style="color:#98c379">&#34;UTF-8&#34;</span>&gt;
</span></span></code></pre></div><p><strong>XML文件头</strong>：XML文件在第一行就声明自己的编码</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-XML" data-lang="XML"><span style="display:flex;"><span><span style="color:#7f848e">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span></code></pre></div><hr>
<p><strong>说完了基础的，我们来说点高级的 —— 其实，Unicode远比“一个码点一个字”要复杂</strong></p>
<p><strong>除了我们看得见的字符，还存在一套系统，用于处理字符的等价性问题、组合显示以及控制文本的复杂行为</strong></p>
<h2 id="字符的变形">字符的变形
</h2><h3 id="同形异义">同形异义
</h3><p><strong>同一个看起来一样的字符，在Unicode中可能有多种表示方式，这在计算机看来就是完全不同的东西</strong></p>
<p>比如一个带扬抑符的字母<code>é</code>，它就有两种表示方式：</p>
<ul>
<li>
<p><strong>方式1 —— 预组合</strong></p>
<p>直接使用单个码点 <code>U+00E9</code>（<code>é</code>），就像一个现成的汉字一样</p>
</li>
<li>
<p><strong>方式2 —— 组合</strong></p>
<p>使用普通字母<code>e</code>（<code>U+0065</code>），后面紧跟一个“组合扬抑符” <code>´</code>（<code>U+0301</code>）</p>
<p>这就像汉字的一个偏旁部首，会自动“贴”到前一个字母的身上，组合成需要的样子</p>
</li>
</ul>
<p><strong>这两种方式渲染出来的字形完全一样，但在计算机内部，它们的身份是完全不同的</strong></p>
<p>如果你在一个文本中搜索 <code>U+00E9</code>，将无法匹配到由<code>U+0065</code> + <code>U+0301</code>组成的那个<code>é</code></p>
<h3 id="历史渊源">历史渊源
</h3><p>你可能会奇怪为什么它会以两种方式存在，这其实和Unicode在设计时要兼顾的两个目标有关：</p>
<ol>
<li>
<p><strong>兼容性</strong>
在 Unicode 出现之前，许多老字符集（如 Latin-1）已经有<code>é</code>这种“预组合”的单个字符</p>
<p>为了兼容旧标准，Unicode 直接收录了这些单字符形式（U+00E9）</p>
</li>
<li>
<p><strong>可组合性</strong>
Unicode 希望支持所有语言的所有字符变化（比如加不同的重音、附加符号、数学标记等），但如果每种变化都单独收一个码点，字符集会无限膨胀</p>
<p>所以，Unicode 定义了组合字符（Combining Characters）机制，允许用一个基本字母 + 一个或多个附加符号来动态组合成新字形（比如<code>U+0065</code>+<code>U+0301</code>）</p>
</li>
</ol>
<h3 id="归一化标准">归一化标准
</h3><p>为了解决这个问题，Unicode 定义了四种归一化标准，用于将“看起来一样但编码不同”的字符串转换为统一的、规范的表示形式</p>
<ul>
<li>
<p><strong>NFC (Normalization Form C – Composition)</strong>：<strong>组合</strong></p>
<p>先将字符分解，再尽可能组合为预组合形式（比如 <code>e</code> + <code>´</code> → <code>é</code>）</p>
<p>这是 W3C 推荐在网页存储和传输中使用的标准，能够保证跨平台一致性</p>
</li>
<li>
<p><strong>NFD (Normalization Form D – Decomposition)</strong>：<strong>分解</strong></p>
<p>将字符尽可能分解为基本字符和组合标记（比如 <code>é</code> → <code>e</code> + <code>´</code>）</p>
<p>这种形式常用于需要分析字符结构或对附加符号单独处理的场景</p>
</li>
<li>
<p><strong>NFKC (Normalization Form KC – Compatibility Composition)</strong>：<strong>兼容性组合</strong></p>
<p>在NFC的基础上，先进行兼容性分解（把全角字符、特殊样式字符等转换为标准字符），再尽可能组合</p>
<p>例如，<code>Ｈｅｌｌｏ</code>（全角）会被转成<code>Hello</code></p>
<p>适合搜索、匹配、用户输入标准化等场景</p>
</li>
<li>
<p><strong>NFKD (Normalization Form KD – Compatibility Decomposition)</strong>：<strong>兼容性分解</strong></p>
<p>在NFD的基础上，额外进行兼容性分解，将外观差异但语义等价的字符统一为标准形式，并保持分解状态</p>
<p>例如，罗马数字 <code>Ⅳ</code> 会被分解为 <code>I</code> + <code>V</code></p>
<p>常用于文本分析、去除装饰性差异等任务</p>
</li>
</ul>
<p><strong>前两种是比较常用的归一化方式</strong></p>
<h2 id="特殊字符">特殊字符
</h2><p>Unicode中包含很多“看不见”但有特殊功能的字符，我们上面提到的用作BOM的就是其中一种</p>
<h3 id="零宽字符">零宽字符
</h3><h4 id="看不见的字符">看不见的字符
</h4><p><strong>它们不占用任何宽度，肉眼不可见，但能产生特殊效果</strong></p>
<ul>
<li>
<p><strong>零宽空格 (ZWSP, U+200B)</strong></p>
<p>它用于在长单词或 URL 的中间建议一个“可以换行”的位置，而不会产生一个可见的空格</p>
<p>例如，在 URL <code>thisisaverylongurlthatmightoverflow</code> 中间插入 ZWSP，当容器宽度不够时，浏览器就可以在这里优雅地换行，而不会破坏链接</p>
</li>
<li>
<p><strong>零宽连字 (ZWJ, U+200D)</strong></p>
<p>它用于“粘合”两个独立的字符，告诉渲染引擎将它们显示为一个组合的字形</p>
<p>最著名的应用就是 <strong>Emoji</strong> 的组合： <code>👨</code> (男人) + <code>ZWJ</code> + <code>👩</code> (女人) + <code>ZWJ</code> + <code>👧</code> (女孩) + <code>ZWJ</code> + <code>👦</code> (男孩) = <code>👨‍👩‍👧‍👦</code> (家庭) <code>‍</code> (零宽连字) 本身不可见，但它像胶水一样把前后四个独立的 Emoji 粘合成了一个新的 Emoji</p>
</li>
<li>
<p><strong>零宽非连字 (ZWNJ, U+200C)</strong></p>
<p>与 ZWJ 相反，它用于“切断”本应自动连接的字符</p>
<p>例如，在波斯语中，某些字母会自动与后面的字母连接，插入 ZWNJ 可以强制它们断开，以显示其非连接形式</p>
</li>
<li>
<p><strong>从左到右标记 (LRM, U+200E)</strong></p>
<p>一个不可见字符，用来强制后续字符以从左到右显示</p>
<p>常用于混合方向文本中，确保英文或数字按正常方向显示。例如，在阿拉伯语句子中插入 LRM 可以保证英文单词正常显示。</p>
</li>
<li>
<p><strong>从右到左标记 (RLM, U+200F)</strong></p>
<p>类似 LRM，但强制后续字符以从右到左方向显示</p>
<p>常用于拉丁字母或数字出现在阿拉伯语或希伯来语文本时，保证它们正确的右到左排列</p>
</li>
<li>
<p><strong>从左到右嵌入 (LRE, U+202A)</strong></p>
<p>它开始一段左到右的文本嵌入，后续字符强制从左到右显示，直到遇到对应的结束符</p>
<p>在主要是阿拉伯语的文本中插入LRE和PDF，可让一段英文保持左到右排列</p>
</li>
<li>
<p><strong>从右到左嵌入 (RLE, U+202B)</strong></p>
<p>它开始一段右到左的文本嵌入，后续字符强制从右到左显示，直到遇到结束符</p>
<p>在主要为英文的文本中插入RLE和PDF，使其中一段希伯来语正常右到左排列</p>
</li>
<li>
<p><strong>弹出方向格式 (PDF, U+202C)</strong></p>
<p>它用来结束先前的方向嵌入（LRE或RLE），恢复之前的文本方向</p>
<p>例如：文本中出现LRE&hellip;PDF或RLE&hellip;PDF包裹的区域，PDF结束该嵌入状态</p>
</li>
<li>
<p><strong>从左到右覆盖 (LRO, U+202D)</strong></p>
<p>它强制后续字符全部以从左到右方向显示，覆盖其默认方向，直到遇到PDF</p>
<p>例如：在包含阿拉伯语或希伯来语的混合文本中，强制某一部分以从左到右显示</p>
</li>
<li>
<p><strong>从右到左覆盖 (RLO, U+202E)</strong></p>
<p>与LRO相反，强制后续字符全部以从右到左方向显示，覆盖默认方向，直到遇到PDF</p>
<p>这在恶意文本或混淆攻击中经常被用来制造视觉欺骗，因它会反转文字显示方向</p>
</li>
<li>
<p><strong>不可见乘号 (INVISIBLE TIMES, U+2062)</strong></p>
<p>表示数学隐式乘法操作，但不显示任何符号，常用于数学公式排版，变量间的隐式相乘</p>
</li>
<li>
<p><strong>不可见分隔符 (INVISIBLE SEPARATOR, U+2063)</strong></p>
<p>用作文本逻辑分隔符，但不显示任何空白或符号，方便文本内部逻辑处理</p>
</li>
<li>
<p><strong>零宽不间断空格 (ZWNBSP, U+FEFF)</strong></p>
<p>既是零宽的不可换行空格，也常用于Unicode文档的字节顺序标记（BOM）</p>
<p>在文件开头可标识文本编码，但不应随意插入文本中，以免引起显示问题</p>
</li>
</ul>
<h4 id="qq的反转id">QQ的反转id
</h4><p>相信不少人都看见过qq群里有些人的id后面会跟着一个“喵”之类的恶搞字符</p>
<p>当你@他时，这个字符竟然脱离了id，出现在了我们输入的话后面！这怎么回事？</p>
<p>其实这就是使用了上面我们提到的零宽字符的两种：</p>
<ul>
<li><code>U+202E</code>：从右至左覆盖</li>
<li><code>U+202D</code>：从左至右覆盖</li>
</ul>
<p>比如，我有一个id是这样的：</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-kotlin" data-lang="kotlin"><span style="display:flex;"><span><span style="color:#e06c75">快来艾特我</span>\<span style="color:#e06c75">u202E喵</span>~\<span style="color:#e06c75">u202D</span>
</span></span></code></pre></div><p>因为是不可见字符，在别人眼里是看不见的（需要使用对应的编码工具，比如：<a class="link" href="https://tool.chinaz.com/tools/unicode.aspx"  target="_blank" rel="noopener"
    >unicode编码转换
    
    <span style="white-space: nowrap;"><svg width=".7em"
        height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg">
        <path d="m13 3l3.293 3.293l-7 7l1.414 1.414l7-7L21 11V3z" fill="currentColor" />
        <path d="M19 19H5V5h7l-2-2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2v-5l-2-2v7z"
            fill="currentColor">
    </svg></span>
    
</a>）：</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-kotlin" data-lang="kotlin"><span style="display:flex;"><span><span style="color:#e06c75">快来艾特我喵</span>~
</span></span></code></pre></div><p>当别人@我发言的时候（比如说“你好”，显示应该是<code>@快来艾特我喵 你好</code>），文字显示默认从左向右</p>
<p>我们使用<code>[]</code>代表当前输入光标的位置，左右箭头代表输入方向：</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-kotlin" data-lang="kotlin"><span style="display:flex;"><span><span style="color:#e06c75">[]</span>→
</span></span><span style="display:flex;"><span>@[]→
</span></span><span style="display:flex;"><span><span style="color:#61afef">@快</span>[]→
</span></span><span style="display:flex;"><span><span style="color:#61afef">@快来</span>[]→
</span></span><span style="display:flex;"><span><span style="color:#61afef">@快来艾</span>[]→
</span></span><span style="display:flex;"><span><span style="color:#61afef">@快来艾特</span>[]→
</span></span><span style="display:flex;"><span><span style="color:#61afef">@快来艾特我</span>[]→
</span></span></code></pre></div><p>读取到这里的时候，文本框看见了控制字符<code>U+202E</code>，它立刻变成了从左向右输入：</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-kotlin" data-lang="kotlin"><span style="display:flex;"><span><span style="color:#61afef">@快来艾特我</span>←[]
</span></span><span style="display:flex;"><span><span style="color:#61afef">@快来艾特我</span>←[]<span style="color:#e06c75">喵</span>
</span></span></code></pre></div><p>输入“喵”后，他又看见了控制字符<code>U+202D</code>，又变回了从右向左输入：</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-kotlin" data-lang="kotlin"><span style="display:flex;"><span><span style="color:#61afef">@快来艾特我</span>[]→<span style="color:#e06c75">喵</span>
</span></span><span style="display:flex;"><span><span style="color:#61afef">@快来艾特我你</span>[]→<span style="color:#e06c75">喵</span>
</span></span><span style="display:flex;"><span><span style="color:#61afef">@快来艾特我你好</span>[]→<span style="color:#e06c75">喵</span>
</span></span></code></pre></div><p>输入完成之后最终效果：</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-kotlin" data-lang="kotlin"><span style="display:flex;"><span><span style="color:#61afef">@快来艾特我你好喵</span>
</span></span></code></pre></div><p>这就让别人喵喵叫啦</p>
<h4 id="零宽字符隐写">零宽字符隐写
</h4><p>这种零宽字符还诞生了一种隐写方式 —— <strong>零宽字符隐写（Zero-Width Character Steganography）</strong></p>
<p>隐写技术通过在正常文本的字符间插入零宽字符，或者利用不同零宽字符的组合，来编码隐藏信息</p>
<p>例如，用零宽空格代表二进制的0，零宽非连接符代表1，或者通过插入或不插入零宽字符表示二进制位</p>
<p>这样，隐藏的信息不会被普通阅读者察觉，因为文本外观没有变化</p>
<p><strong>你可以使用linux的vim编辑器打开，观察到\u这样的隐写痕迹</strong></p>
<p>常用的隐写工具：</p>
<p><a class="link" href="https://330k.github.io/misc_tools/unicode_steganography.html"  target="_blank" rel="noopener"
    >https://330k.github.io/misc_tools/unicode_steganography.html
    
    <span style="white-space: nowrap;"><svg width=".7em"
        height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg">
        <path d="m13 3l3.293 3.293l-7 7l1.414 1.414l7-7L21 11V3z" fill="currentColor" />
        <path d="M19 19H5V5h7l-2-2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2v-5l-2-2v7z"
            fill="currentColor">
    </svg></span>
    
</a></p>
<p><a class="link" href="https://yuanfux.github.io/zero-width-web/"  target="_blank" rel="noopener"
    >https://yuanfux.github.io/zero-width-web/
    
    <span style="white-space: nowrap;"><svg width=".7em"
        height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg">
        <path d="m13 3l3.293 3.293l-7 7l1.414 1.414l7-7L21 11V3z" fill="currentColor" />
        <path d="M19 19H5V5h7l-2-2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2v-5l-2-2v7z"
            fill="currentColor">
    </svg></span>
    
</a></p>
<h3 id="变体选择符">变体选择符
</h3><p>变体选择符是一类特殊的Unicode码点，通常紧跟在另一个字符后面，作用是“建议”或“指定”该字符的具体显示样式（字形变体），以保证不同平台或字体能正确显示</p>
<p>常见变体选择符：</p>
<ul>
<li><strong><code>U+FE0E</code>（VS15，Variation Selector-15）表示文本形式，提示字符以普通文本风格显示</strong></li>
<li><strong><code>U+FE0F</code>（VS16，Variation Selector-16）表示表情符号形式，提示字符以彩色Emoji风格显示</strong></li>
</ul>
<p>比如，Unicode字符<code>U+2764</code>是一个“心形”符号 ❤：</p>
<ul>
<li>单独使用：<code>U+2764</code>，显示可能是黑白符号，也可能是彩色Emoji，这依赖平台和字体</li>
<li>加上变体选择符：<code>U+2764 U+FE0F</code>，强制显示为彩色Emoji❤️</li>
<li>加上变体选择符：<code>U+2764 U+FE0E</code>，强制显示为黑白文本 ❤︎</li>
</ul>
<hr>
<p>讲了这么多，终于到实践的部分了</p>
<p>到目前为止，我们讨论的都是计算机如何“理解”和“存储”字符</p>
<p>现在，我们来看看在实际操作中，人类是如何与这个复杂的字符系统进行交互的</p>
<h2 id="工具与应用">工具与应用
</h2><h3 id="输入法input-method-editor-ime">输入法（Input Method Editor, IME）
</h3><p>输入法并非一个普通的应用程序，而是一个<strong>专为文本输入设计的、集成在操作系统中的系统级服务或中间件</strong></p>
<p>它的位置恰好位于<strong>物理键盘</strong>和<strong>当前聚焦的应用程序</strong>之间，为了让输入法能够“拦截”和“处理”按键，所有现代操作系统都提供了专门的框架来管理和集成它们：</p>
<ul>
<li>
<p><strong>Windows</strong>: <strong>文本服务框架 (Text Services Framework, TSF)</strong></p>
<p>这是一个先进的框架，允许输入法、手写识别、语音识别等多种文本服务以统一的方式与应用程序交互</p>
<p>在早期，Windows使用的是一个较老的系统，名为<strong>输入法管理器 (Input Method Manager, IMM)</strong></p>
</li>
<li>
<p><strong>macOS</strong>: <strong>Input Method Kit</strong></p>
<p>这是苹果为开发者提供的、用于构建输入法的官方框架</p>
</li>
<li>
<p><strong>Linux</strong>: <strong>IBus (Intelligent Input Bus)</strong> &amp; <strong>Fcitx (Flexible Context-aware Input Tool for X)</strong></p>
<p>它们都采用了一种“总线”式的架构，输入法作为服务挂载在总线上，为所有应用程序提供输入服务</p>
</li>
</ul>
<p>这些框架的核心作用，就是建立一套标准的通信协议，确保任何应用程序（只要它支持该框架）都能与任何输入法进行顺畅的对话，而无需关心对方的具体实现</p>
<p>当我们在键盘上敲下字母到最终输入文字，经历了什么？</p>
<p>我们以输入“你好”为例，一步一步看看它的过程：</p>
<h4 id="步骤一事件拦截">步骤一：事件拦截
</h4><ol>
<li>
<p><strong>物理按键触发</strong></p>
<p>当我们按下<code>n</code>键时，键盘硬件会将该按键对应的<strong>扫描码（Scan Code）</strong> 通过键盘控制器发送到计算机</p>
<p>这只是一个硬件级的信号，还不知道“n”是什么意思</p>
</li>
<li>
<p><strong>操作系统接收与封装事件</strong></p>
<p>操作系统的输入子系统（如 Windows 的 Keyboard Class Driver、Linux 的 evdev）接收到扫描码，将其转换成虚拟键码</p>
<p>这一阶段还只是“按下了哪个键”的信息，不涉及语言文字</p>
</li>
<li>
<p><strong>IME 输入法拦截</strong></p>
<p>在操作系统将键盘事件传递给当前活动应用程序（比如聊天窗口）之前，事件会先经过<strong>输入法框架</strong></p>
<p>如果当前有 IME 处于激活状态，它会拦截并消费这个按键事件 —— 这意味着这个按键不会直接传给应用，而是先进入输入法的内部处理逻辑</p>
</li>
<li>
<p><strong>建立输入上下文</strong></p>
<p>IME会根据当前的焦点控件（例如一个可编辑文本框）建立一个输入上下文，用来记录本轮输入的状态：</p>
<ul>
<li>已输入的编码（例如拼音串<code>nihao</code>）</li>
<li>光标位置</li>
<li>候选词列表</li>
<li>用户选择历史</li>
</ul>
<p>这一步相当于输入法开了一个“草稿本”，专门记录你正在打的这段文字</p>
</li>
<li>
<p><strong>生成组合字符串</strong></p>
<p>输入法会将已输入的编码（如<code>n</code> → <code>ni</code> → <code>nih</code> → <code>nihao</code>）显示在屏幕上</p>
<p>这段带虚线或高亮的临时文字被称为组合字符串，它不是应用程序缓冲区里的正式文本，而是由输入法通过IME接口直接绘制到光标位置上的</p>
<p>在这个阶段，应用程序并不知道这些字母是什么 —— 它只知道光标处有一个正在编辑的输入会话</p>
</li>
</ol>
<h4 id="步骤二转换引擎">步骤二：转换引擎
</h4><p>这是输入法最核心的部分，转换引擎根据缓冲区中的<code>nihao</code>，开始计算所有可能的候选结果</p>
<p><strong>转换引擎主要依赖两个东西 —— 词库和语言模型</strong>：</p>
<p><span style="color:orange"><strong>1.词库</strong></span></p>
<p>存储大量词语及其拼音（或其他编码）对应关系的数据集合</p>
<ul>
<li>
<p><strong>静态词库</strong></p>
<p>输入法出厂时内置的、包含数百万词条的巨大数据库。它定义了拼音与汉字、词语之间的基础对应关系</p>
</li>
<li>
<p><strong>动态/用户词库</strong></p>
<p>记录你个人常用词汇的词典。你输入过的名字、昵称、专业术语都会被添加进来，下次输入时就会优先显示</p>
</li>
<li>
<p><strong>云端词库</strong></p>
<p>现代输入法的“联网大脑”。它能实时从互联网上抓取最新的流行语、新闻热点、人名地名，让你的输入法永远“与时俱进”</p>
</li>
</ul>
<p><span style="color:orange"><strong>2.语言模型</strong></span></p>
<p>如果说词典是认字，那么语言模型就是理解语法和语境，它负责从众多同音词中，猜出你最想要的那一个</p>
<ul>
<li>
<p><strong>N-gram 模型</strong></p>
<p>这是统计学模型，它通过分析海量文本数据，计算出词语组合的概率</p>
<p>例如，它知道 <code>P(好 | 你)</code>（在“你”之后出现“好”的概率）要远远大于 <code>P(耗 | 你)</code>，因此，<code>你好</code>的排序会非常靠前</p>
</li>
<li>
<p><strong>更先进的模型（HMM, CRF, AI）</strong></p>
<p>现代输入法普遍采用更复杂的统计模型，甚至是深度学习神经网络（如 RNN/LSTM）</p>
<p>这些模型不仅看前一个词，还会综合分析整个句子的结构和语义，从而做出惊人准确的预测</p>
<p>例如，当你输入<code>jintianwanshangwomenyiqiqu</code>时，它能直接预测出 <code>今天晚上我们一起去</code>，而不是一堆不相关的单字</p>
</li>
</ul>
<h4 id="步骤三候选界面">步骤三：候选界面
</h4><ol>
<li>
<p><strong>生成列表</strong></p>
<p>转换引擎将计算出的结果，按照概率从高到低排序，生成一个候选列表</p>
</li>
<li>
<p><strong>渲染窗口</strong></p>
<p>输入法的界面模块（UI）获取这个列表，然后在屏幕上绘制出我们熟悉的候选窗口</p>
<p>这个窗口是一个独立的、悬浮在所有应用之上的图层，由输入法完全控制</p>
</li>
</ol>
<h4 id="步骤四文本提交">步骤四：文本提交
</h4><ol>
<li>
<p><strong>用户选择</strong></p>
<p>用户通过按空格、数字键或鼠标点击，在候选窗口中选择了 <code>你好</code></p>
</li>
<li>
<p><strong>发送指令</strong></p>
<p>输入法收到用户的选择后，会向操作系统的文本服务框架发送一个提交文本的指令</p>
</li>
<li>
<p><strong>内容交付</strong></p>
<p>这个指令里装的，就是最终确定的字符串 <code>你好</code></p>
<p>更底层地看，是这两个字符的Unicode 码点序列 (<code>U+4F60</code>, <code>U+597D</code>)</p>
</li>
<li>
<p><strong>应用接收</strong></p>
<p>应用程序的文本框接收到这个指令，就像接收到用户用剪贴板粘贴进来一段文本一样</p>
<p>它将这两个字符插入到自己的文本缓冲区中</p>
</li>
<li>
<p><strong>最终渲染</strong></p>
<p>应用程序调用系统的字体渲染引擎，根据当前设置的字体，将<code>U+4F60</code>和<code>U+597D</code>对应的字形绘制到屏幕上</p>
</li>
</ol>
<p>至此，输入法绘制的临时草稿（带下划线的<code>nihao</code>和候选窗口）消失，<code>你好</code>这两个字被正式地写入了应用程序，整个输入流程完成</p>
<h3 id="编码转换工具和库">编码转换工具和库
</h3><p>在处理来自不同年代、不同地区、不同系统的数据时，编码不一致是家常便饭：</p>
<ul>
<li>
<p>我们可能需要将一个使用GBK编码的旧网站数据库，迁移到新的、使用UTF-8的系统中</p>
</li>
<li>
<p>用户可能会上传各种奇奇怪怪编码的文本文件，我们的程序需要有能力正确识别和处理它们</p>
</li>
<li>
<p>我们调用的某个古老API接口，可能只接受GBK编码的请求</p>
</li>
</ul>
<p><strong>因此，编码转换很重要</strong></p>
<h4 id="iconv">iconv
</h4><p><code>iconv</code>是一个乎所有类Unix系统都自带的跨平台命令行工具和编程库，专门用于字符编码的转换</p>
<p><strong>格式：</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>iconv -f &lt;源编码&gt; -t &lt;目标编码&gt; &lt;输入文件&gt; -o &lt;输出文件&gt;
</span></span></code></pre></div><p><strong>常用参数：</strong></p>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>参数</th>
          <th>作用说明</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>-f 或 &ndash;from-code</td>
          <td>指定输入文本的字符编码格式</td>
      </tr>
      <tr>
          <td>-t 或 &ndash;to-code</td>
          <td>指定输出文本的字符编码格式</td>
      </tr>
      <tr>
          <td>-l 或 &ndash;list</td>
          <td>列出支持的所有编码格式</td>
      </tr>
      <tr>
          <td>-o 或 &ndash;output</td>
          <td>指定输出文件（否则输出到标准输出）</td>
      </tr>
      <tr>
          <td>-c</td>
          <td>忽略非法输入字符（转换时跳过错误字符）</td>
      </tr>
      <tr>
          <td>&ndash;verbose</td>
          <td>显示详细的转换过程信息</td>
      </tr>
  </tbody>
</table></div>
<p><strong>eg：将一个GBK编码的文件转换为UTF-8编码的格式</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>iconv -f GBK -t UTF-8 gbk.txt -o utf8.txt
</span></span></code></pre></div><h4 id="icu">ICU
</h4><p><strong>ICU（International Components for Unicode，Unicode国际组件）是一个由IBM（International Business Machines Corporation,国际商业机器公司）开发和维护的、功能极其强大的C/C++和Java库，后来交由了Unicode联盟管理</strong></p>
<p>其他语言也可以通过绑定或封装调用ICU库来使用大部分核心功能，但可能需要额外安装或配置</p>
<p>ICU不止是一个编码转换工具，还是一套全方位的国际化解决方案</p>
<p><strong>它提供比<code>iconv</code>更强大、更健壮的编码转换功能，支持超过200种编码，还有以下功能：</strong></p>
<ul>
<li>
<p><strong>字符归一化</strong></p>
<p>可以轻松地将字符串转换为NFC或NFD等范式</p>
</li>
<li>
<p><strong>排序</strong></p>
<p>它能实现真正符合语言习惯的排序</p>
<p>例如，简单的按字节排序会将<code>b </code>排在 <code>á</code> 前面，但ICU知道在西班牙语中它们应该如何正确排序</p>
<p>对于中文，它可以实现按拼音、部首或笔画排序</p>
</li>
<li>
<p><strong>日期、时间、数字、货币格式化</strong></p>
<p>它可以根据不同国家/地区（Locale）的习惯，将同一个日期<code>2025-08-13</code>格式化为<code>8/13/2025</code>(美国)或 <code>13/08/2025</code>(英国)</p>
</li>
<li>
<p><strong>文本边界分析</strong></p>
<p>它能准确地识别出单词、句子、段落的边界，这对于文本处理和搜索引擎至关重要</p>
</li>
</ul>
<h4 id="编程语言">编程语言
</h4><p>现代主流编程语言都内置了强大的字符串和编码处理能力，通常足以应对日常的转换需求</p>
<p>比如python内部使用unicode表示字符串，并提供了<code>.encode()</code>和<code>.decode()</code>方法，之前的示例中我们也使用过</p>
<p><strong>eg1：将GBK字节流转换为unicode字符串</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#e06c75">gbk</span> <span style="color:#56b6c2">=</span> <span style="color:#98c379">b</span><span style="color:#98c379">&#39;</span><span style="color:#98c379">\xc4\xe3\xba\xc3</span><span style="color:#98c379">&#39;</span>  <span style="color:#7f848e"># &#34;你好&#34; 的 GBK 字节</span>
</span></span><span style="display:flex;"><span><span style="color:#e06c75">unicode</span><span style="color:#56b6c2">=</span> <span style="color:#e06c75">gbk</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">decode</span>(<span style="color:#98c379">&#39;gbk&#39;</span>)
</span></span></code></pre></div><p><strong>eg2：接上一例，将unicode字符串编码为UTF-8字节流</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#e06c75">utf8</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">unicode</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">encode</span>(<span style="color:#98c379">&#39;utf-8&#39;</span>)
</span></span></code></pre></div><p>Java, JavaScript, Go, Rust 等也都提供了类似的API，使得我们可以方便地在代码层面处理编码问题</p>
<hr>
<p>到这里，一切的一切也就结束了</p>
<p>这篇文章诞生原因其实是在学linux命令的时候时常涉及字符、字等等东西，再加上以前看过不少相关文章视频，兴趣使然才写下了这些文字</p>
<p>编码的世界远比我想象的复杂，本文也只是冰山一角、抛砖引玉之作，系统的学习还要综合网上的资料才行</p>
<p>不管怎么样，希望能对你有所帮助</p>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/misc/">Misc</a>
        
    </section>


    <section class="article-lastmod">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



        <span>
            最后更新于 2025-08-24
        </span>
    </section></footer>


    
</article>

    

    

     
    
        
    <script src='//unpkg.com/@waline/client@v2/dist/waline.js'></script>
<link href='//unpkg.com/@waline/client@v2/dist/waline.css' rel='stylesheet'/>
<div id="waline" class="waline-container"></div>
<style>
    .waline-container {
        background-color: var(--card-background);
        border-radius: var(--card-border-radius);
        box-shadow: var(--shadow-l1);
        padding: var(--card-padding);
        --waline-font-size: var(--article-font-size);
    }
    .waline-container .wl-count {
        color: var(--card-text-color-main);
    }
</style><script>
    
    Waline.init({"dark":"html[data-scheme=\"dark\"]","el":"#waline","emoji":["https://npm.elemecdn.com/@waline/emojis@1.1.0/bilibili","https://npm.elemecdn.com/@waline/emojis@1.1.0/bmoji","https://npm.elemecdn.com/@waline/emojis@1.1.0/weibo"],"lang":"zh-cn","locale":{"admin":"Admin","placeholder":null},"pageview":true,"placeholder":"欢迎评论，不好的评论我会删🙄💅🏻","requiredMeta":["name","email","url"],"serverURL":"https://comment.928330.xyz/"});
</script>

    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 2025 - 2025 kakahuote | 引用请注明文章链接
    </section>

    <section class="running-time">
        距离小站第一行代码被置下已经过去
        <span id="runningdays" class="running-days"></span>    
    </section>  

    <section class="powerby">
        使用 <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> 构建 <br />
        主题 <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.30.0">Stack</a></b> 由 <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> 设计 <br />

        
        <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
        <script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>
        

        <span>...当然还有kakahuote🤓👆</span>
    </section>
</footer>

    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >
    
    <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>
<style>
     
     
     
    @font-face {
     font-family: 'yuan';
     src: url('https://blog.928330.xyz/font/round.ttf') format('truetype');
    }

     
     
     
    :root {
     --base-font-family: 'yuan';
     --code-font-family: 'yuan';
    }

     
     
     
     
     
    #backTopBtn {
     position: fixed;
     bottom: 30px;
     right: 450px;
     z-index: 99;
     cursor: pointer;
     width: 32px;
     height: 32px;
     background-image: url('/icons/backTop.svg');
     background-size: cover;
     background-color: rgba(255, 255, 255, 0.9);
     border-radius: 50%;
     box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
     transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
     transform-origin: center center;
      
     animation: gentleFloat 3s ease-in-out infinite;
      
     overflow: visible;
    }

     
    [data-scheme="dark"] #backTopBtn {
     background-image: url('/icons/backTop-dark.svg') !important;
     background-color: rgba(0, 0, 0, 0.8) !important;
     box-shadow: 0 4px 20px rgba(255, 255, 255, 0.1) !important;
    }

     
    @media (prefers-color-scheme: dark) {
      #backTopBtn {
        background-image: url('/icons/backTop-dark.svg') !important;
        background-color: rgba(0, 0, 0, 0.8) !important;
        box-shadow: 0 4px 20px rgba(255, 255, 255, 0.1) !important;
      }
      
      .button-ripple {
        background-image: url('/icons/backTop-dark.svg') !important;
         
      }
    }

     
    html[data-scheme="dark"] #backTopBtn,
    body[data-scheme="dark"] #backTopBtn,
    .dark #backTopBtn,
    .dark-mode #backTopBtn {
      background-image: url('/icons/backTop-dark.svg') !important;
      background-color: rgba(0, 0, 0, 0.8) !important;
      box-shadow: 0 4px 20px rgba(255, 255, 255, 0.1) !important;
    }

    html[data-scheme="dark"] .button-ripple,
    body[data-scheme="dark"] .button-ripple,
    .dark .button-ripple,
    .dark-mode .button-ripple {
      background-image: url('/icons/backTop-dark.svg') !important;
       
    }

     
    [data-scheme="dark"] #backTopBtn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-bottom: 10px solid #ffffff;
      transform: translate(-50%, -50%);
      z-index: 1;
       
      display: var(--show-css-arrow, none);
    }

     
    #backTopBtn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-bottom: 10px solid #000000;
      transform: translate(-50%, -50%);
      z-index: 1;
       
      display: var(--show-css-arrow, none);
    }

     
    @keyframes gentleFloat {
     0%, 100% { transform: translateY(0px); }
     50% { transform: translateY(-6px); }
    }

     
    .button-ripple {
     position: absolute;
     top: 0;
     left: 0;
     width: 32px;
     height: 32px;
     border-radius: 50%;
     background-image: url('/icons/backTop.svg');
     background-size: cover;
     background-repeat: no-repeat;
     background-position: center;
     pointer-events: none;
     z-index: -1;
     animation: buttonRippleExpand 2.5s linear infinite;
     transform-origin: center center;
      
     will-change: transform, opacity;
     backface-visibility: hidden;
     perspective: 1000px;
     contain: layout style;
      
     transform: translateZ(0);
      
     transition: animation-duration 0.3s ease;
      
     --show-css-arrow: none !important;
      
     opacity: var(--ripple-opacity, 0.8) !important;
    }

     
    [data-scheme="dark"] .button-ripple {
     background-image: url('/icons/backTop-dark.svg') !important;
      
      
     --show-css-arrow: none !important;
    }

     
    @media (prefers-color-scheme: dark) {
      .button-ripple {
        background-image: url('/icons/backTop-dark.svg') !important;
         
         
        --show-css-arrow: none !important;
      }
    }

     
    .button-ripple.hover-mode {
     animation-duration: 1s;
    }

    @keyframes buttonRippleExpand {
     0% {
       --ripple-opacity: 0.8;
       transform: scale(1);
     }
     2% {
       --ripple-opacity: 0.78;
       transform: scale(1.02);
     }
     4% {
       --ripple-opacity: 0.76;
       transform: scale(1.04);
     }
     6% {
       --ripple-opacity: 0.74;
       transform: scale(1.06);
     }
     8% {
       --ripple-opacity: 0.72;
       transform: scale(1.08);
     }
     10% {
       --ripple-opacity: 0.7;
       transform: scale(1.1);
     }
     12% {
       --ripple-opacity: 0.68;
       transform: scale(1.12);
     }
     14% {
       --ripple-opacity: 0.66;
       transform: scale(1.14);
     }
     16% {
       --ripple-opacity: 0.64;
       transform: scale(1.16);
     }
     18% {
       --ripple-opacity: 0.62;
       transform: scale(1.18);
     }
     20% {
       --ripple-opacity: 0.6;
       transform: scale(1.2);
     }
     22% {
       --ripple-opacity: 0.58;
       transform: scale(1.22);
     }
     24% {
       --ripple-opacity: 0.56;
       transform: scale(1.24);
     }
     26% {
       --ripple-opacity: 0.54;
       transform: scale(1.26);
     }
     28% {
       --ripple-opacity: 0.52;
       transform: scale(1.28);
     }
     30% {
       --ripple-opacity: 0.5;
       transform: scale(1.3);
     }
     32% {
       --ripple-opacity: 0.48;
       transform: scale(1.32);
     }
     34% {
       --ripple-opacity: 0.46;
       transform: scale(1.34);
     }
     36% {
       --ripple-opacity: 0.44;
       transform: scale(1.36);
     }
     38% {
       --ripple-opacity: 0.42;
       transform: scale(1.38);
     }
     40% {
       --ripple-opacity: 0.4;
       transform: scale(1.4);
     }
     42% {
       --ripple-opacity: 0.38;
       transform: scale(1.42);
     }
     44% {
       --ripple-opacity: 0.36;
       transform: scale(1.44);
     }
     46% {
       --ripple-opacity: 0.34;
       transform: scale(1.46);
     }
     48% {
       --ripple-opacity: 0.32;
       transform: scale(1.48);
     }
     50% {
       --ripple-opacity: 0.3;
       transform: scale(1.5);
     }
     52% {
       --ripple-opacity: 0.28;
       transform: scale(1.52);
     }
     54% {
       --ripple-opacity: 0.26;
       transform: scale(1.54);
     }
     56% {
       --ripple-opacity: 0.24;
       transform: scale(1.56);
     }
     58% {
       --ripple-opacity: 0.22;
       transform: scale(1.58);
     }
     60% {
       --ripple-opacity: 0.2;
       transform: scale(1.6);
     }
     62% {
       --ripple-opacity: 0.18;
       transform: scale(1.62);
     }
     64% {
       --ripple-opacity: 0.16;
       transform: scale(1.64);
     }
     66% {
       --ripple-opacity: 0.14;
       transform: scale(1.66);
     }
     68% {
       --ripple-opacity: 0.12;
       transform: scale(1.68);
     }
     70% {
       --ripple-opacity: 0.1;
       transform: scale(1.7);
     }
     72% {
       --ripple-opacity: 0.08;
       transform: scale(1.72);
     }
     74% {
       --ripple-opacity: 0.07;
       transform: scale(1.74);
     }
     76% {
       --ripple-opacity: 0.06;
       transform: scale(1.76);
     }
     78% {
       --ripple-opacity: 0.05;
       transform: scale(1.78);
     }
     80% {
       --ripple-opacity: 0.04;
       transform: scale(1.8);
     }
     82% {
       --ripple-opacity: 0.035;
       transform: scale(1.82);
     }
     84% {
       --ripple-opacity: 0.03;
       transform: scale(1.84);
     }
     86% {
       --ripple-opacity: 0.025;
       transform: scale(1.86);
     }
     88% {
       --ripple-opacity: 0.02;
       transform: scale(1.88);
     }
     90% {
       --ripple-opacity: 0.015;
       transform: scale(1.9);
     }
     92% {
       --ripple-opacity: 0.01;
       transform: scale(1.92);
     }
     94% {
       --ripple-opacity: 0.008;
       transform: scale(1.94);
     }
     96% {
       --ripple-opacity: 0.005;
       transform: scale(1.96);
     }
     98% {
       --ripple-opacity: 0.002;
       transform: scale(1.98);
     }
     100% {
       --ripple-opacity: 0;
       transform: scale(2.0);
     }
    }

     
    .button-tooltip {
     position: absolute;
     bottom: 45px;
     right: 450px;
     background: rgba(0, 0, 0, 0.8);
     color: white;
     padding: 8px 12px;
     border-radius: 6px;
     font-size: 12px;
     white-space: nowrap;
     opacity: 0;
     transform: translateY(10px);
     transition: all 0.3s ease;
     pointer-events: none;
     z-index: 100;
    }

    .button-tooltip.show {
     opacity: 1;
     transform: translateY(0);
    }

    .button-tooltip::after {
     content: '';
     position: absolute;
     top: 100%;
     left: 50%;
     transform: translateX(-50%);
     border: 5px solid transparent;
     border-top-color: rgba(0, 0, 0, 0.8);
    }

     
    .hover-ripple-effect {
     display: none;
    }

     
    #backTopBtn:hover {
     transform: translateY(-8px) scale(1.1);
     box-shadow: 0 8px 30px rgba(0, 0, 0, 0.25);
     background-color: rgba(255, 255, 255, 1);
    }

     
    #backTopBtn.sprinting {
     animation: energyBurst 1.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
    }

    @keyframes energyBurst {
     0% {
       transform: scale(1) rotate(0deg);
       opacity: 1;
       filter: brightness(1) hue-rotate(0deg);
       box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
     }
     15% {
       transform: scale(1.2) rotate(0deg);
       opacity: 1;
       filter: brightness(1.2) hue-rotate(0deg);
       box-shadow: 0 0 25px rgba(255, 215, 0, 0.8), 0 0 50px rgba(255, 107, 107, 0.6);
     }
     30% {
       transform: scale(1.4) rotate(0deg);
       opacity: 1;
       filter: brightness(1.4) hue-rotate(60deg);
       box-shadow: 0 0 35px rgba(255, 182, 193, 0.8), 0 0 70px rgba(255, 215, 0, 0.6);
     }
     45% {
       transform: scale(1.6) rotate(0deg);
       opacity: 1;
       filter: brightness(1.6) hue-rotate(120deg);
       box-shadow: 0 0 45px rgba(173, 216, 230, 0.8), 0 0 90px rgba(255, 182, 193, 0.6);
     }
     60% {
       transform: scale(1.4) rotate(0deg);
       opacity: 1;
       filter: brightness(1.4) hue-rotate(180deg);
       box-shadow: 0 0 35px rgba(144, 238, 144, 0.8), 0 0 70px rgba(173, 216, 230, 0.6);
     }
     75% {
       transform: scale(1.2) rotate(0deg);
       opacity: 1;
       filter: brightness(1.2) hue-rotate(240deg);
       box-shadow: 0 0 25px rgba(255, 215, 0, 0.8), 0 0 50px rgba(144, 238, 144, 0.6);
     }
     90% {
       transform: scale(1.05) rotate(0deg);
       opacity: 1;
       filter: brightness(1.05) hue-rotate(300deg);
       box-shadow: 0 0 15px rgba(255, 107, 107, 0.6), 0 0 30px rgba(255, 215, 0, 0.4);
     }
     100% {
       transform: scale(1) rotate(0deg);
       opacity: 1;
       filter: brightness(1) hue-rotate(360deg);
       box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
     }
    }

     
    #backTopBtn.reappearing {
     animation: reappear 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
    }

     
    #backTopBtn.exploding {
     animation: explosionTransition 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
      
     z-index: 1000;
    }

     
    #backTopBtn.exploding .button-ripple {
     opacity: 0;
     animation-play-state: paused;
    }

    @keyframes explosionTransition {
     0% {
       transform: scale(1.6) rotate(0deg);
       opacity: 1;
       filter: brightness(1.6) hue-rotate(0deg);
       box-shadow: 0 0 50px rgba(255, 215, 0, 0.8), 0 0 100px rgba(255, 107, 107, 0.6);
     }
     30% {
       transform: scale(1.4) rotate(5deg);
       opacity: 1;
       filter: brightness(1.4) hue-rotate(120deg);
       box-shadow: 0 0 40px rgba(255, 182, 193, 0.8), 0 0 80px rgba(255, 215, 0, 0.6);
     }
 
     100% {
       transform: scale(1) rotate(0deg);
       opacity: 1;
       filter: brightness(1) hue-rotate(360deg);
       box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
     }
    }

    @keyframes reappear {
     0% {
       transform: scale(0.85);
       opacity: 0.7;
     }
     50% {
       transform: scale(1.05);
       opacity: 1;
     }
     100% {
       transform: scale(1);
       opacity: 1;
     }
    }

    #backTopBtn.rotating {
     animation: rotate360 0.6s ease-in-out;
    }

    @keyframes rotate360 {
     0% { transform: rotate(0deg); }
     100% { transform: rotate(360deg); }
    }

     
    .particle {
     position: absolute;
     top: 50%;
     left: 50%;
     width: 4px;
     height: 4px;
     background: radial-gradient(circle, #fff, #ffd700, #ff69b4, #87ceeb);
     border-radius: 50%;
     pointer-events: none;
     z-index: -2;
     animation: particleExplode 1s ease-out forwards;
    }

    @keyframes particleExplode {
     0% {
       transform: translate(-50%, -50%) scale(0);
       opacity: 1;
     }
     50% {
       opacity: 1;
     }
     100% {
       transform: translate(-50%, -50%) scale(1) translate(var(--x), var(--y));
       opacity: 0;
     }
    }

     
    .energy-wave {
     position: absolute;
     top: 50%;
     left: 50%;
     width: 0;
     height: 0;
     border: 2px solid transparent;
     border-radius: 50%;
     pointer-events: none;
     z-index: -3;
     animation: energyWave 1.2s ease-out forwards;
    }

    @keyframes energyWave {
     0% {
       width: 0;
       height: 0;
       border-color: rgba(255, 215, 0, 0.8);
       opacity: 1;
     }
     100% {
       width: 120px;
       height: 120px;
       border-color: rgba(255, 215, 0, 0);
       opacity: 0;
     }
    }

     
    .hero-aura {
     position: absolute;
     top: 50%;
     left: 50%;
     width: 100%;
     height: 100%;
     border-radius: 50%;
     background: conic-gradient(from 0deg, #ffd700, #ff69b4, #87ceeb, #98fb98, #ffa07a, #ffd700);
     background-size: 200% 200%;
     pointer-events: none;
     z-index: -4;
     animation: heroAura 2s linear infinite;
     opacity: 0;
     transition: opacity 0.3s ease;
    }

    #backTopBtn.sprinting .hero-aura {
     opacity: 0.6;
    }

    @keyframes heroAura {
     0% {
       background-position: 0% 0%;
       transform: translate(-50%, -50%) rotate(0deg);
     }
     100% {
       background-position: 100% 100%;
       transform: translate(-50%, -50%) rotate(360deg);
     }
    }

     
    @media (max-width: 768px) {
     #backTopBtn {
       right: 20px;
       bottom: 20px;
       width: 28px;
       height: 28px;
     }
     
     .button-tooltip {
       right: 20px;
       bottom: 35px;
     }
    }

    @media (max-width: 480px) {
     #backTopBtn {
       right: 15px;
       bottom: 15px;
       width: 26px;
       height: 26px;
     }
     
     .button-tooltip {
       right: 15px;
       bottom: 31px;
     }
    }

     
     
     
    
     
    .toc-current-section {
     color: #ff8c00 !important;  
     font-weight: bold !important;
     position: relative;
     animation: tocFloat 2s ease-in-out infinite;
      
     transform: translateZ(0);
     backface-visibility: hidden;
     perspective: 1000px;
    }

     
    @keyframes tocFloat {
     0%, 100% { 
       transform: translateY(0px) translateZ(0); 
     }
     50% { 
       transform: translateY(-2px) translateZ(0); 
     }
    }

     
    .widget--toc a:hover {
     color: #ff8c00 !important;
     transition: color 0.3s ease;
    }

     
    .widget--toc .toc-current-section a {
     color: #ff8c00 !important;
     background: none !important;  
     border: none !important;  
      
     transition: color 0.3s ease !important;
    }

     
    .widget--toc a {
     transition: color 0.3s ease, transform 0.3s ease;
    }

     
    .widget--toc li {
     transition: all 0.3s ease;
      
     transform: translateZ(0);
     backface-visibility: hidden;
    }

     
    .widget--toc .toc-current-section {
      
    }

     
    .widget--toc a {
     text-decoration: none;
     transition: color 0.3s ease, transform 0.3s ease;
      
     transform: translateZ(0);
     backface-visibility: hidden;
    }

     
    .widget--toc a:hover {
     color: #ff8c00 !important;
     transform: translateX(3px);
     transition: color 0.3s ease, transform 0.3s ease;
    }

     
    .widget--toc {
      
     contain: layout style;
    }

    .widget--toc li {
      
     contain: layout;
    }

     
     
     
    #rope-container {
      position: fixed;
      top: 0;
      left: 20px;
      z-index: 10000;
      width: 50px;
      height: 480px;
      pointer-events: none;
    }

    #rope {
      position: absolute;
      top: -80px;
      left: 50%;
      width: 3px;
      height: 400px;
      background: linear-gradient(to bottom, #654321, #8B4513, #A0522D, #8B4513, #654321);
      border-radius: 1.5px;
      transform: translateX(-50%);
      pointer-events: auto;
      transition: all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      box-shadow: 0 1px 3px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.1);
    }

    #pull-ring {
      position: absolute;
      top: 300px;
      left: 50%;
      font-size: 20px;
      color: #ffffff;
      text-shadow: 0 0 8px rgba(255, 255, 255, 0.8);
      transform: translateX(-50%);
      pointer-events: auto;
      transition: all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
    }

    #rope:hover {
      box-shadow: 0 2px 6px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.2);
    }

    #pull-ring:hover {
      transform: translateX(-50%) scale(1.2);
      text-shadow: 0 0 12px rgba(255, 255, 255, 1);
      filter: drop-shadow(0 4px 8px rgba(0,0,0,0.5));
    }

     
     
     
    .highlight {
     max-height: 400px;
     overflow: hidden;
     position: relative;
     transition: max-height 0.3s ease-out;
    }

    .code-show {
     max-height: none !important;
    }

    .code-more-box {
     width: 100%;
     padding-top: 20px;
     background-image: linear-gradient(to bottom, rgba(255, 255, 255, 0), #fff);
     position: absolute;
     left: 0;
     right: 0;
     bottom: 0;
     z-index: 1;
     text-align: center;
    }

    .code-more-btn {
     display: inline-block;
     padding: 5px 15px;
     background: #f0f0f5;
     border-radius: 5px;
     cursor: pointer;
     font-size: 0.9em;
    }

     
     
     
    #particles-js {
     position: fixed;
     top: 0;
     left: 0;
      width: 100vw;
      height: 100vh;
     z-index: -1;
      pointer-events: none;
    }
    
    #particles-js canvas {
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      width: 100vw !important;
      height: 100vh !important;
    }
</style>

<script>
     
     
     

    let s1 = '2025-5-8 15:00:00'; 
    s1 = new Date(s1.replace(/-/g, "/"));
    let s2 = new Date();
    let timeDifference = s2.getTime() - s1.getTime();

    let days = Math.floor(timeDifference / (1000 * 60 * 60 * 24));
    let hours = Math.floor((timeDifference % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    let minutes = Math.floor((timeDifference % (1000 * 60 * 60)) / (1000 * 60));

    let result = days + "天" + hours + "小时" + minutes + "分钟";
    if (document.getElementById('runningdays')) {
        document.getElementById('runningdays').innerHTML = result;
    }
    
     
     
     
    
    

    function startContinuousRipple(button) {
     
     const buttonRipple = document.createElement('div');
     buttonRipple.className = 'button-ripple';
     button.appendChild(buttonRipple);
     
     
     button.buttonRipple = buttonRipple;
    }
    
    

    function createContinuousRipple(button) {
     
     if (button.querySelector('.continuous-ripple')) {
       return;
     }
     
     
     const rippleContainer = document.createElement('div');
     rippleContainer.className = 'ripple-container continuous-ripple';
     
     
     const ripple = document.createElement('div');
     ripple.className = 'ripple';
     ripple.style.background = 'radial-gradient(circle, rgba(255, 107, 107, 0.8) 0%, rgba(255, 255, 255, 0.9) 100%)';
     
     rippleContainer.appendChild(ripple);
     button.appendChild(rippleContainer);
     
     
     setTimeout(() => {
       if (rippleContainer.parentNode) {
         rippleContainer.parentNode.removeChild(rippleContainer);
       }
     }, 800);
    }
    
    

    function createHoverRipple(button) {
     
     if (button.buttonRipple) {
       
       button.buttonRipple.style.animationDuration = '1s';
       button.buttonRipple.classList.add('hover-mode');
     }
    }
    
    

    function showTooltip(button) {
     
     hideTooltip();
     
     
     const tooltip = document.createElement('div');
     tooltip.className = 'button-tooltip';
     tooltip.textContent = '返回顶部';
     document.body.appendChild(tooltip);
     
     
     setTimeout(() => {
       tooltip.classList.add('show');
     }, 10);
     
     
     button.tooltip = tooltip;
    }
    
    

    function hideTooltip() {
     const existingTooltip = document.querySelector('.button-tooltip');
     if (existingTooltip) {
       existingTooltip.classList.remove('show');
       setTimeout(() => {
         if (existingTooltip.parentNode) {
           existingTooltip.parentNode.removeChild(existingTooltip);
         }
       }, 300);
     }
    }
    
    

    function createRippleEffect(button) {
     
     
     
     const energyWave = document.createElement('div');
     energyWave.className = 'energy-wave';
     document.body.appendChild(energyWave);
     
     
     createParticleExplosion(button);
     
     
     setTimeout(() => {
       if (energyWave.parentNode) {
         energyWave.parentNode.removeChild(energyWave);
       }
     }, 1200);
    }

    

    function createParticleExplosion(button) {
     const particleCount = 16; 
     
     
     const particleColors = [
       'radial-gradient(circle, #ff6b6b, #ffd93d, #6bcf7f, #4d96ff)',
       'radial-gradient(circle, #ff8e8e, #ffed4e, #7ddb8f, #6ba6ff)',
       'radial-gradient(circle, #ffa1a1, #fff15f, #8ee79f, #89b6ff)',
       'radial-gradient(circle, #ffb4b4, #fff570, #9ff3af, #a7c6ff)'
     ];
     
     for (let i = 0; i < particleCount; i++) {
       const particle = document.createElement('div');
       particle.className = 'particle';
       
       
       const randomColor = particleColors[Math.floor(Math.random() * particleColors.length)];
       particle.style.background = randomColor;
       
       
       const angle = (i / particleCount) * 2 * Math.PI;
       const distance = 40 + Math.random() * 30; 
       const x = Math.cos(angle) * distance;
       const y = Math.sin(angle) * distance;
       
       particle.style.setProperty('--x', `${x}px`);
       particle.style.setProperty('--y', `${y}px`);
       
       
       particle.style.animationDelay = `${Math.random() * 0.4}s`;
       
       button.appendChild(particle);
       
       
       setTimeout(() => {
         if (particle.parentNode) {
           particle.parentNode.removeChild(particle);
         }
       }, 1000);
     }
    }

     
     
     
    

    function initScrollTop() {
     let rightSideBar = document.querySelector(".right-sidebar");
     if (!rightSideBar) {
      return;
     }

     
     let btn = document.createElement("div");
     btn.id = "backTopBtn";
     let isRotating = false; 

     
     const heroAura = document.createElement('div');
     heroAura.className = 'hero-aura';
     btn.appendChild(heroAura);

     
     btn.addEventListener('mouseenter', function() {
       createHoverRipple(this);
       showTooltip(this);
     });
     
     
     btn.addEventListener('mouseleave', function() {
       if (this.buttonRipple) {
         
         this.buttonRipple.style.animationDuration = '2s';
         this.buttonRipple.classList.remove('hover-mode');
       }
       hideTooltip();
     });

     btn.onclick = function() {
      if (!isRotating) {
       isRotating = true;
       backToTop(this, () => {
        isRotating = false; 
       });
      }
     };
     rightSideBar.appendChild(btn);

     
     btn.style.display = "block";
     
     
     startContinuousRipple(btn);
    }

    

    function backToTop(button, onComplete) {
     
     button.classList.add('sprinting');
     
     
     if (button.buttonRipple) {
       button.buttonRipple.style.display = 'none';
     }
     
     
     createRippleEffect(button);
     
     
     window.scrollTo({ top: 0, behavior: "smooth" });
     
     
     const checkScrollComplete = () => {
       if (window.scrollY === 0) {
         
         button.classList.remove('sprinting');
         
         
         button.classList.add('exploding');
         
         
         createParticleExplosion(button);
         
         
         if (button.buttonRipple) {
           button.buttonRipple.style.display = 'block';
         }
         
         
         setTimeout(() => {
           button.classList.remove('exploding');
           
           
           if (button.buttonRipple) {
             
             button.buttonRipple.style.animationPlayState = 'paused';
             
             button.buttonRipple.style.animation = 'none';
             button.buttonRipple.offsetHeight; 
             button.buttonRipple.style.animation = 'buttonRippleExpand 2s steps(25, end) infinite';
             button.buttonRipple.style.animationPlayState = 'running';
           }
           
           button.classList.add('reappearing');
           
           
           setTimeout(() => {
             button.classList.remove('reappearing');
             if (onComplete) {
               onComplete();
             }
           }, 600);
         }, 800); 
         
         return;
       }
       requestAnimationFrame(checkScrollComplete);
     };
     
     checkScrollComplete();
    }

    
    initScrollTop();
    
     
     
     
    

    function initRope() {
     console.log('initRope函数被调用');
     
     
     if (document.getElementById('rope-container')) {
      console.log('绳子已存在，跳过创建');
      return;
     }

     
     const monthlyEmojis = [
       { month: 1, name: "一月", ring: "❄️", falling: "❄️", description: "寒冬腊月，雪花飞舞" },
       { month: 2, name: "二月", ring: "🏮", falling: "🏮", description: "新春正月，灯笼高挂" },
       { month: 3, name: "三月", ring: "🌸", falling: "🌸", description: "春暖花开，樱花绽放" },
       { month: 4, name: "四月", ring: "🌧️", falling: "🌧️", description: "清明时节，春雨绵绵" },
       { month: 5, name: "五月", ring: "🌺", falling: "🌺", description: "立夏时节，牡丹盛开" },
       { month: 6, name: "六月", ring: "🌻", falling: "🌻", description: "芒种时节，向日葵开" },
       { month: 7, name: "七月", ring: "🌿", falling: "🌿", description: "小暑时节，绿意盎然" },
       { month: 8, name: "八月", ring: "🍉", falling: "🍉", description: "七夕时节，西瓜清甜" },
       { month: 9, name: "九月", ring: "🍁", falling: "🍁", description: "白露时节，秋叶飘落" },
       { month: 10, name: "十月", ring: "🍂", falling: "🍂", description: "寒露时节，落叶纷飞" },
       { month: 11, name: "十一月", ring: "🍊", falling: "🍊", description: "霜降时节，柑橘飘香" },
       { month: 12, name: "十二月", ring: "🌨️", falling: "🌨️", description: "大雪时节，雪花纷飞" }
     ];

     
     window.timeEmojis = [
       { period: "morning", name: "早晨", emojis: ["☀️", "🌤️", "🌱", "🌺", "🌿"], description: "晨曦初露，万物苏醒" },
       { period: "noon", name: "中午", emojis: ["🌞", "🌻", "🦋", "🦜", "🐝"], description: "烈日当空，生机勃勃" },
       { period: "evening", name: "傍晚", emojis: ["🌙", "⭐", "🦉"], description: "夕阳西下，夜幕降临" }
     ];

     
     const currentMonth = new Date().getMonth() + 1;
     const currentEmoji = monthlyEmojis.find(emoji => emoji.month === currentMonth);
     
     console.log(`当前月份: ${currentMonth}, 使用emoji: ${currentEmoji.name} - ${currentEmoji.description}`);
     console.log(`JavaScript Date.getMonth(): ${new Date().getMonth()}, 实际月份: ${currentMonth}`);

     
     let ropeContainer = document.createElement("div");
     ropeContainer.id = "rope-container";
     
     
     let rope = document.createElement("div");
     rope.id = "rope";
     rope.style.cssText = `
       position: absolute;
       top: -80px;
       left: 50%;
       width: 3px;
       height: 400px;
       background: linear-gradient(to bottom, #654321, #8B4513, #A0522D, #8B4513, #654321);
       border-radius: 1.5px;
       transform: translateX(-50%);
       pointer-events: auto;
       transition: all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
       box-shadow: 0 1px 3px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.1);
     `;
     
     
     let pullRing = document.createElement("div");
     pullRing.id = "pull-ring";
     pullRing.innerHTML = currentEmoji.ring;
     pullRing.title = `${currentEmoji.name}: ${currentEmoji.description}`;
     pullRing.style.cssText = `
       position: absolute;
       top: 300px;
       left: 50%;
       font-size: 20px;
       color: #ffffff;
       text-shadow: 0 0 8px rgba(255, 255, 255, 0.8);
       transform: translateX(-50%);
       pointer-events: auto;
       transition: all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
       filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
     `;
     
     
     function handleRopeClick() {
      console.log('拉绳被点击，开始动画...');
      
      
      rope.style.transform = 'translateX(-50%) translateY(40px)';
      rope.style.background = 'linear-gradient(to bottom, #8B4513, #A0522D, #8B4513, #A0522D, #8B4513)';
      
      
      pullRing.style.top = '340px';
      pullRing.style.transform = 'translateX(-50%) scale(0.8)';
      pullRing.style.textShadow = '0 0 15px rgba(255, 255, 255, 1)';
      pullRing.style.filter = 'drop-shadow(0 6px 12px rgba(0,0,0,0.6))';
      
      
      createSeasonalFalling(currentEmoji);
      
      
      setTimeout(() => {
       console.log('恢复拉绳原状...');
       rope.style.transform = 'translateX(-50%) translateY(0)';
       rope.style.background = 'linear-gradient(to bottom, #654321, #8B4513, #A0522D, #8B4513, #654321)';
       
       
       pullRing.style.top = '300px';
       pullRing.style.transform = 'translateX(-50%) scale(1)';
       pullRing.style.textShadow = '0 0 8px rgba(255, 255, 255, 0.8)';
       pullRing.style.filter = 'drop-shadow(0 2px 4px rgba(0,0,0,0.3))';
      }, 800);
     }
     
     
     rope.addEventListener('click', handleRopeClick);
     pullRing.addEventListener('click', handleRopeClick);
     
     
     ropeContainer.appendChild(rope);
     ropeContainer.appendChild(pullRing);
     document.body.appendChild(ropeContainer);
     
     console.log(`可拉动的绳子已创建，使用${currentEmoji.name}主题`);
    }

    

    function createSeasonalFalling(emojiConfig) {
     console.log(`开始创建${emojiConfig.name}飘落效果...`);
     console.log('emojiConfig:', emojiConfig);
     
     
     const fallingContainer = document.createElement('div');
     fallingContainer.id = 'falling-container';
     fallingContainer.style.cssText = `
       position: fixed;
       top: 0;
       left: 0;
       width: 100vw;
       height: 100vh;
       pointer-events: none;
       z-index: 9999;
       overflow: hidden;
     `;
     document.body.appendChild(fallingContainer);
     console.log('飘落容器已创建');
     
     
     const currentHour = new Date().getHours();
     let currentTimePeriod;
     if (currentHour >= 5 && currentHour < 11) {
      currentTimePeriod = window.timeEmojis.find(t => t.period === "morning");
     } else if (currentHour >= 11 && currentHour < 17) {
      currentTimePeriod = window.timeEmojis.find(t => t.period === "noon");
     } else {
      currentTimePeriod = window.timeEmojis.find(t => t.period === "evening");
     }
     
     console.log(`当前时间: ${currentHour}点, 时间段: ${currentTimePeriod.name} - ${currentTimePeriod.description}`);
     console.log('timeEmojis:', window.timeEmojis);
     
     
     const totalElements = emojiConfig.month >= 11 || emojiConfig.month <= 2 ? 30 : 25; 
     let activeElements = 0;
     
     console.log(`准备创建 ${totalElements} 个飘落元素`);
     
     for (let i = 0; i < totalElements; i++) {
      setTimeout(() => {
       const element = document.createElement('div');
       
       
       let selectedEmoji, emojiType;
       if (Math.random() < 0.7) {
        selectedEmoji = emojiConfig.falling;
        emojiType = "monthly";
       } else {
        
        selectedEmoji = currentTimePeriod.emojis[Math.floor(Math.random() * currentTimePeriod.emojis.length)];
        emojiType = "time";
       }
       
       console.log(`创建第 ${i + 1} 个元素: ${selectedEmoji} (${emojiType})`);
       element.innerHTML = selectedEmoji;
       
       
       let fontSize, color, textShadow;
       if (emojiType === "time") {
        
        if (currentTimePeriod.period === "morning") {
         
         fontSize = Math.random() * 18 + 16;
         color = '#FFD700';
         textShadow = '0 0 5px rgba(255, 215, 0, 0.7)';
        } else if (currentTimePeriod.period === "noon") {
         
         fontSize = Math.random() * 18 + 16;
         color = '#FF8C00';
         textShadow = '0 0 5px rgba(255, 140, 0, 0.7)';
        } else {
         
         fontSize = Math.random() * 18 + 16;
         color = '#4B0082';
         textShadow = '0 0 5px rgba(75, 0, 130, 0.7)';
        }
       } else {
        
        if (emojiConfig.month >= 11 || emojiConfig.month <= 2) {
         
         fontSize = Math.random() * 20 + 15;
         color = 'white';
         textShadow = '0 0 5px rgba(255, 255, 255, 0.8)';
        } else if (emojiConfig.month >= 3 && emojiConfig.month <= 5) {
         
         fontSize = Math.random() * 18 + 16;
         color = '#FF69B4';
         textShadow = '0 0 5px rgba(255, 105, 180, 0.6)';
        } else if (emojiConfig.month >= 6 && emojiConfig.month <= 8) {
         
         fontSize = Math.random() * 18 + 15;
         color = '#32CD32';
         textShadow = '0 0 5px rgba(50, 205, 50, 0.6)';
        } else {
         
         fontSize = Math.random() * 18 + 15;
         color = '#FF8C00';
         textShadow = '0 0 5px rgba(255, 140, 0, 0.6)';
        }
       }
       
       element.style.cssText = `
         position: absolute;
         font-size: ${fontSize}px;
         color: ${color};
         text-shadow: ${textShadow};
         left: ${Math.random() * window.innerWidth}px;
         top: -50px;
         user-select: none;
         pointer-events: none;
         z-index: 9999;
         transition: all 0.3s ease;
       `;
       
       fallingContainer.appendChild(element);
       activeElements++;
       
       
       const duration = 4000 + Math.random() * 2000;
       const endX = parseFloat(element.style.left) + (Math.random() - 0.5) * 400;
       const endY = window.innerHeight + 50;
       
       element.style.transition = `all ${duration}ms linear`;
       
       setTimeout(() => {
        element.style.left = endX + 'px';
        element.style.top = endY + 'px';
        element.style.opacity = '0';
       }, 50);
       
       
       setTimeout(() => {
        if (element.parentNode) {
         element.parentNode.removeChild(element);
        }
        activeElements--;
        
        
        if (activeElements === 0) {
         if (fallingContainer && fallingContainer.parentNode) {
          fallingContainer.parentNode.removeChild(fallingContainer);
         }
        }
       }, duration);
      }, i * 150);
     }
    }

     
     
     
    function initCodeMoreBox() {
     let codeBlocks = document.querySelectorAll(".highlight");
     if (!codeBlocks) {
      return;
     }
     codeBlocks.forEach(codeBlock => {
      
      if (codeBlock.scrollHeight <= codeBlock.clientHeight) {
       return;
      }
      
      
      let codeMoreBox = document.createElement('div');
      codeMoreBox.classList.add('code-more-box');
      
      let codeMoreBtn = document.createElement('span');
      codeMoreBtn.classList.add('code-more-btn');
      codeMoreBtn.innerText = '显示更多'; 
      let isExpanded = false; 

      codeMoreBtn.addEventListener('click', () => {
       if (!isExpanded) {
        codeBlock.classList.add('code-show'); 
        codeMoreBtn.innerText = '折叠'; 
        isExpanded = true;
       } else {
        codeBlock.classList.remove('code-show'); 
        codeMoreBtn.innerText = '显示更多'; 
        isExpanded = false;
       }
       
       window.dispatchEvent(new Event('resize'));
      });
      
      codeMoreBox.appendChild(codeMoreBtn);
      codeBlock.appendChild(codeMoreBox);
     });
    }

    initCodeMoreBox();
    
    
    initRope();
</script>


<div id="particles-js"></div>


<script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
<script>
  
  particlesJS('particles-js', {
    "particles": {
      "number": {
        "value": 80,
        "density": {
          "enable": true,
          "value_area": 800
        }
      },
      "color": {
        "value": ["#888888", "#aaaaaa", "#cccccc", "#eeeeee"]
      },
      "shape": {
        "type": "circle",
        "stroke": {
          "width": 0,
          "color": "#000000"
        },
        "polygon": {
          "nb_sides": 5
        }
      },
      "opacity": {
        "value": 0.5,
        "random": false,
        "anim": {
          "enable": false,
          "speed": 1,
          "opacity_min": 0.1,
          "sync": false
        }
      },
      "size": {
        "value": 2,
        "random": true,
        "anim": {
          "enable": false,
          "speed": 40,
          "size_min": 0.1,
          "sync": false
        }
      },
      "line_linked": {
        "enable": true,
        "distance": 150,
        "color": "#888888",
        "opacity": 0.4,
        "width": 1
      },
      "move": {
        "enable": true,
        "speed": 2,
        "direction": "none",
        "random": false,
        "straight": false,
        "out_mode": "out",
        "bounce": false,
        "attract": {
          "enable": false,
          "rotateX": 600,
          "rotateY": 1200
        }
      }
    },
    "interactivity": {
      "detect_on": "canvas",
      "events": {
        "onhover": {
          "enable": true,
          "mode": "grab"
        },
        "onclick": {
          "enable": true,
          "mode": "push"
        },
        "resize": true
      },
      "modes": {
        "grab": {
          "distance": 140,
          "line_linked": {
            "opacity": 1
          }
        },
        "bubble": {
          "distance": 400,
          "size": 40,
          "duration": 2,
          "opacity": 8,
          "speed": 3
        },
        "repulse": {
          "distance": 200,
          "duration": 0.4
        },
        "push": {
          "particles_nb": 4
        },
        "remove": {
          "particles_nb": 2
        }
      }
    },
    "retina_detect": true
  });
</script>

<script>
     
     
     
    
    

    function initTocHighlight() {
     
     if (document.readyState === 'loading') {
       document.addEventListener('DOMContentLoaded', initTocHighlight);
       return;
     }
     
     
     const toc = document.querySelector('#TableOfContents');
     if (!toc) {
       return;
     }
     
     console.log('目录高亮功能已初始化');
     
     
     const headers = document.querySelectorAll('.article-content h1[id], .article-content h2[id], .article-content h3[id], .article-content h4[id], .article-content h5[id], .article-content h6[id]');
     
     if (headers.length === 0) {
       console.log('未找到文章标题，尝试其他选择器...');
       
       const altHeaders = document.querySelectorAll('h1[id], h2[id], h3[id], h4[id], h5[id], h6[id]');
       if (altHeaders.length > 0) {
         console.log(`找到 ${altHeaders.length} 个标题（使用备用选择器）`);
         headers = altHeaders;
       } else {
         console.log('仍未找到文章标题');
         return;
       }
     } else {
       console.log(`找到 ${headers.length} 个文章标题`);
     }
     
     
     const tocLinks = toc.querySelectorAll('a[href^="#"]');
     
     if (tocLinks.length === 0) {
       console.log('未找到目录链接');
       return;
     }
     
     
     const headerPositions = Array.from(headers).map(header => ({
       id: header.id,
       offset: header.offsetTop,
       element: header
     }));
     
     
     let currentHighlighted = null;
     
     

     function updateTocHighlight() {
       const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
       const windowHeight = window.innerHeight;
       
       
       let currentHeader = null;
       
       
       const viewportCenter = scrollTop + windowHeight / 2;
       
       
       let closestHeader = null;
       let minDistance = Infinity;
       
       for (let i = 0; i < headerPositions.length; i++) {
         const header = headerPositions[i];
         const distance = Math.abs(header.offset - viewportCenter);
         
         if (distance < minDistance) {
           minDistance = distance;
           closestHeader = header;
         }
         
         
         if (scrollTop + 100 >= header.offset) {
           currentHeader = header;
         }
       }
       
       
       if (!currentHeader && closestHeader) {
         currentHeader = closestHeader;
       }
       
       
       if (!currentHeader && headerPositions.length > 0) {
         currentHeader = headerPositions[0];
       }
       
                if (currentHeader) {
           
           const tocLink = toc.querySelector(`a[href="#${currentHeader.id}"]`);
           if (tocLink) {
             
             if (currentHighlighted !== tocLink) {
               
               if (currentHighlighted) {
                 currentHighlighted.classList.remove('toc-current-section');
               }
               
               
               tocLink.classList.add('toc-current-section');
               currentHighlighted = tocLink;
               
               
               scrollTocToCurrent(tocLink);
               
               
               console.log(`当前高亮: ${currentHeader.id} - ${tocLink.textContent}`);
             }
           } else {
             console.log(`未找到目录链接: ${currentHeader.id}`);
           }
         }
     }
     
     

     function scrollTocToCurrent(currentLink) {
       const tocContainer = toc.closest('.widget--toc');
       if (!tocContainer) return;
       
       const linkRect = currentLink.getBoundingClientRect();
       const containerRect = tocContainer.getBoundingClientRect();
       
       
       if (linkRect.top < containerRect.top || linkRect.bottom > containerRect.bottom) {
         currentLink.scrollIntoView({
           behavior: 'smooth',
           block: 'center',
           inline: 'nearest'
         });
       }
     }
     
     
     let scrollTimeout;
     window.addEventListener('scroll', () => {
       clearTimeout(scrollTimeout);
       scrollTimeout = setTimeout(updateTocHighlight, 50); 
     });
     
     
     updateTocHighlight();
     
     
     window.addEventListener('resize', () => {
       
       headerPositions.forEach(header => {
         header.offset = header.element.offsetTop;
       });
       
       
       updateTocHighlight();
     });
    }
    
    
    if (document.readyState === 'complete') {
     initTocHighlight();
    } else {
     window.addEventListener('load', initTocHighlight);
    }
    
    
    document.addEventListener('DOMContentLoaded', () => {
     setTimeout(initTocHighlight, 100); 
    });

    
    function updateBackTopIcon() {
      const backTopBtn = document.getElementById('backTopBtn');
      const buttonRipple = document.querySelector('.buttonRipple');
      
      if (!backTopBtn) {
        console.log('返回顶部按钮未找到，等待创建...');
        return;
      }
      
      
      const isDarkMode = 
        document.documentElement.dataset.scheme === 'dark' ||
        document.documentElement.classList.contains('dark') ||
        document.body.classList.contains('dark') ||
        window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      
      
      const lightIcon = '/icons/backTop.svg';
      const darkIcon = '/icons/backTop-dark.svg';
      
      console.log('=== 主题检测调试信息 ===');
      console.log('检测到主题:', isDarkMode ? '暗色' : '浅色');
      console.log('当前data-scheme:', document.documentElement.dataset.scheme);
      console.log('document.documentElement.classList:', document.documentElement.classList.toString());
      console.log('document.body.classList:', document.body.classList.toString());
      console.log('系统偏好:', window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? '暗色' : '浅色');
      console.log('返回顶部按钮:', backTopBtn);
      console.log('按钮当前样式:', {
        backgroundImage: backTopBtn.style.backgroundImage,
        backgroundColor: backTopBtn.style.backgroundColor,
        boxShadow: backTopBtn.style.boxShadow
      });
      
      if (isDarkMode) {
        console.log('应用暗色主题样式');
        backTopBtn.style.backgroundImage = 'url(' + darkIcon + ')';
        backTopBtn.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';
        backTopBtn.style.boxShadow = '0 4px 20px rgba(255, 255, 255, 0.1)';
        
        if (buttonRipple) {
          buttonRipple.style.backgroundImage = 'url(' + darkIcon + ')';
          
          buttonRipple.style.removeProperty('opacity');
        }
      } else {
        console.log('应用浅色主题样式');
        backTopBtn.style.backgroundImage = 'url(' + lightIcon + ')';
        backTopBtn.style.backgroundColor = 'rgba(255, 255, 255, 0.9)';
        backTopBtn.style.boxShadow = '0 4px 20px rgba(0, 0, 0, 0.15)';
        
        if (buttonRipple) {
          buttonRipple.style.backgroundImage = 'url(' + lightIcon + ')';
          
          buttonRipple.style.removeProperty('opacity');
        }
      }
      
      
      setTimeout(() => {
        const img = new Image();
        img.onload = function() {
          console.log('SVG图标加载成功，隐藏CSS箭头');
          backTopBtn.style.setProperty('--show-css-arrow', 'none');
        };
        img.onerror = function() {
          console.log('SVG图标加载失败，显示CSS箭头');
          backTopBtn.style.setProperty('--show-css-arrow', 'block');
        };
        img.src = isDarkMode ? darkIcon : lightIcon;
      }, 100);
      
      console.log('样式应用完成');
      console.log('========================');
    }

    
    window.addEventListener('onColorSchemeChange', updateBackTopIcon);
    
    
    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (mutation.type === 'attributes' && mutation.attributeName === 'data-scheme') {
          console.log('检测到主题属性变化:', document.documentElement.dataset.scheme);
          updateBackTopIcon();
        }
      });
    });
    
    
    observer.observe(document.documentElement, {
      attributes: true,
      attributeFilter: ['data-scheme']
    });
    
    
    if (window.matchMedia) {
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', updateBackTopIcon);
    }
    
    
    if (document.readyState === 'complete') {
      updateBackTopIcon();
    } else {
      window.addEventListener('load', updateBackTopIcon);
    }
    
    
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(updateBackTopIcon, 100);
    });
    
    
    function waitForBackTopBtn() {
      const backTopBtn = document.getElementById('backTopBtn');
      if (backTopBtn) {
        console.log('返回顶部按钮已找到，立即应用主题样式');
        updateBackTopIcon();
      } else {
        console.log('返回顶部按钮未找到，等待创建...');
        setTimeout(waitForBackTopBtn, 500);
      }
    }
    
    
    waitForBackTopBtn();
    
    
    setInterval(updateBackTopIcon, 2000);
    
    
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden) {
        console.log('页面重新可见，重新应用主题样式');
        setTimeout(updateBackTopIcon, 100);
      }
    });
</script>




            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>
<style>
     
     
     
    @font-face {
     font-family: 'yuan';
     src: url('https://blog.928330.xyz/font/round.ttf') format('truetype');
    }

     
     
     
    :root {
     --base-font-family: 'yuan';
     --code-font-family: 'yuan';
    }

     
     
     
     
     
    #backTopBtn {
     position: fixed;
     bottom: 30px;
     right: 450px;
     z-index: 99;
     cursor: pointer;
     width: 32px;
     height: 32px;
     background-image: url('/icons/backTop.svg');
     background-size: cover;
     background-color: rgba(255, 255, 255, 0.9);
     border-radius: 50%;
     box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
     transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
     transform-origin: center center;
      
     animation: gentleFloat 3s ease-in-out infinite;
      
     overflow: visible;
    }

     
    [data-scheme="dark"] #backTopBtn {
     background-image: url('/icons/backTop-dark.svg') !important;
     background-color: rgba(0, 0, 0, 0.8) !important;
     box-shadow: 0 4px 20px rgba(255, 255, 255, 0.1) !important;
    }

     
    @media (prefers-color-scheme: dark) {
      #backTopBtn {
        background-image: url('/icons/backTop-dark.svg') !important;
        background-color: rgba(0, 0, 0, 0.8) !important;
        box-shadow: 0 4px 20px rgba(255, 255, 255, 0.1) !important;
      }
      
      .button-ripple {
        background-image: url('/icons/backTop-dark.svg') !important;
         
      }
    }

     
    html[data-scheme="dark"] #backTopBtn,
    body[data-scheme="dark"] #backTopBtn,
    .dark #backTopBtn,
    .dark-mode #backTopBtn {
      background-image: url('/icons/backTop-dark.svg') !important;
      background-color: rgba(0, 0, 0, 0.8) !important;
      box-shadow: 0 4px 20px rgba(255, 255, 255, 0.1) !important;
    }

    html[data-scheme="dark"] .button-ripple,
    body[data-scheme="dark"] .button-ripple,
    .dark .button-ripple,
    .dark-mode .button-ripple {
      background-image: url('/icons/backTop-dark.svg') !important;
       
    }

     
    [data-scheme="dark"] #backTopBtn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-bottom: 10px solid #ffffff;
      transform: translate(-50%, -50%);
      z-index: 1;
       
      display: var(--show-css-arrow, none);
    }

     
    #backTopBtn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-bottom: 10px solid #000000;
      transform: translate(-50%, -50%);
      z-index: 1;
       
      display: var(--show-css-arrow, none);
    }

     
    @keyframes gentleFloat {
     0%, 100% { transform: translateY(0px); }
     50% { transform: translateY(-6px); }
    }

     
    .button-ripple {
     position: absolute;
     top: 0;
     left: 0;
     width: 32px;
     height: 32px;
     border-radius: 50%;
     background-image: url('/icons/backTop.svg');
     background-size: cover;
     background-repeat: no-repeat;
     background-position: center;
     pointer-events: none;
     z-index: -1;
     animation: buttonRippleExpand 2.5s linear infinite;
     transform-origin: center center;
      
     will-change: transform, opacity;
     backface-visibility: hidden;
     perspective: 1000px;
     contain: layout style;
      
     transform: translateZ(0);
      
     transition: animation-duration 0.3s ease;
      
     --show-css-arrow: none !important;
      
     opacity: var(--ripple-opacity, 0.8) !important;
    }

     
    [data-scheme="dark"] .button-ripple {
     background-image: url('/icons/backTop-dark.svg') !important;
      
      
     --show-css-arrow: none !important;
    }

     
    @media (prefers-color-scheme: dark) {
      .button-ripple {
        background-image: url('/icons/backTop-dark.svg') !important;
         
         
        --show-css-arrow: none !important;
      }
    }

     
    .button-ripple.hover-mode {
     animation-duration: 1s;
    }

    @keyframes buttonRippleExpand {
     0% {
       --ripple-opacity: 0.8;
       transform: scale(1);
     }
     2% {
       --ripple-opacity: 0.78;
       transform: scale(1.02);
     }
     4% {
       --ripple-opacity: 0.76;
       transform: scale(1.04);
     }
     6% {
       --ripple-opacity: 0.74;
       transform: scale(1.06);
     }
     8% {
       --ripple-opacity: 0.72;
       transform: scale(1.08);
     }
     10% {
       --ripple-opacity: 0.7;
       transform: scale(1.1);
     }
     12% {
       --ripple-opacity: 0.68;
       transform: scale(1.12);
     }
     14% {
       --ripple-opacity: 0.66;
       transform: scale(1.14);
     }
     16% {
       --ripple-opacity: 0.64;
       transform: scale(1.16);
     }
     18% {
       --ripple-opacity: 0.62;
       transform: scale(1.18);
     }
     20% {
       --ripple-opacity: 0.6;
       transform: scale(1.2);
     }
     22% {
       --ripple-opacity: 0.58;
       transform: scale(1.22);
     }
     24% {
       --ripple-opacity: 0.56;
       transform: scale(1.24);
     }
     26% {
       --ripple-opacity: 0.54;
       transform: scale(1.26);
     }
     28% {
       --ripple-opacity: 0.52;
       transform: scale(1.28);
     }
     30% {
       --ripple-opacity: 0.5;
       transform: scale(1.3);
     }
     32% {
       --ripple-opacity: 0.48;
       transform: scale(1.32);
     }
     34% {
       --ripple-opacity: 0.46;
       transform: scale(1.34);
     }
     36% {
       --ripple-opacity: 0.44;
       transform: scale(1.36);
     }
     38% {
       --ripple-opacity: 0.42;
       transform: scale(1.38);
     }
     40% {
       --ripple-opacity: 0.4;
       transform: scale(1.4);
     }
     42% {
       --ripple-opacity: 0.38;
       transform: scale(1.42);
     }
     44% {
       --ripple-opacity: 0.36;
       transform: scale(1.44);
     }
     46% {
       --ripple-opacity: 0.34;
       transform: scale(1.46);
     }
     48% {
       --ripple-opacity: 0.32;
       transform: scale(1.48);
     }
     50% {
       --ripple-opacity: 0.3;
       transform: scale(1.5);
     }
     52% {
       --ripple-opacity: 0.28;
       transform: scale(1.52);
     }
     54% {
       --ripple-opacity: 0.26;
       transform: scale(1.54);
     }
     56% {
       --ripple-opacity: 0.24;
       transform: scale(1.56);
     }
     58% {
       --ripple-opacity: 0.22;
       transform: scale(1.58);
     }
     60% {
       --ripple-opacity: 0.2;
       transform: scale(1.6);
     }
     62% {
       --ripple-opacity: 0.18;
       transform: scale(1.62);
     }
     64% {
       --ripple-opacity: 0.16;
       transform: scale(1.64);
     }
     66% {
       --ripple-opacity: 0.14;
       transform: scale(1.66);
     }
     68% {
       --ripple-opacity: 0.12;
       transform: scale(1.68);
     }
     70% {
       --ripple-opacity: 0.1;
       transform: scale(1.7);
     }
     72% {
       --ripple-opacity: 0.08;
       transform: scale(1.72);
     }
     74% {
       --ripple-opacity: 0.07;
       transform: scale(1.74);
     }
     76% {
       --ripple-opacity: 0.06;
       transform: scale(1.76);
     }
     78% {
       --ripple-opacity: 0.05;
       transform: scale(1.78);
     }
     80% {
       --ripple-opacity: 0.04;
       transform: scale(1.8);
     }
     82% {
       --ripple-opacity: 0.035;
       transform: scale(1.82);
     }
     84% {
       --ripple-opacity: 0.03;
       transform: scale(1.84);
     }
     86% {
       --ripple-opacity: 0.025;
       transform: scale(1.86);
     }
     88% {
       --ripple-opacity: 0.02;
       transform: scale(1.88);
     }
     90% {
       --ripple-opacity: 0.015;
       transform: scale(1.9);
     }
     92% {
       --ripple-opacity: 0.01;
       transform: scale(1.92);
     }
     94% {
       --ripple-opacity: 0.008;
       transform: scale(1.94);
     }
     96% {
       --ripple-opacity: 0.005;
       transform: scale(1.96);
     }
     98% {
       --ripple-opacity: 0.002;
       transform: scale(1.98);
     }
     100% {
       --ripple-opacity: 0;
       transform: scale(2.0);
     }
    }

     
    .button-tooltip {
     position: absolute;
     bottom: 45px;
     right: 450px;
     background: rgba(0, 0, 0, 0.8);
     color: white;
     padding: 8px 12px;
     border-radius: 6px;
     font-size: 12px;
     white-space: nowrap;
     opacity: 0;
     transform: translateY(10px);
     transition: all 0.3s ease;
     pointer-events: none;
     z-index: 100;
    }

    .button-tooltip.show {
     opacity: 1;
     transform: translateY(0);
    }

    .button-tooltip::after {
     content: '';
     position: absolute;
     top: 100%;
     left: 50%;
     transform: translateX(-50%);
     border: 5px solid transparent;
     border-top-color: rgba(0, 0, 0, 0.8);
    }

     
    .hover-ripple-effect {
     display: none;
    }

     
    #backTopBtn:hover {
     transform: translateY(-8px) scale(1.1);
     box-shadow: 0 8px 30px rgba(0, 0, 0, 0.25);
     background-color: rgba(255, 255, 255, 1);
    }

     
    #backTopBtn.sprinting {
     animation: energyBurst 1.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
    }

    @keyframes energyBurst {
     0% {
       transform: scale(1) rotate(0deg);
       opacity: 1;
       filter: brightness(1) hue-rotate(0deg);
       box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
     }
     15% {
       transform: scale(1.2) rotate(0deg);
       opacity: 1;
       filter: brightness(1.2) hue-rotate(0deg);
       box-shadow: 0 0 25px rgba(255, 215, 0, 0.8), 0 0 50px rgba(255, 107, 107, 0.6);
     }
     30% {
       transform: scale(1.4) rotate(0deg);
       opacity: 1;
       filter: brightness(1.4) hue-rotate(60deg);
       box-shadow: 0 0 35px rgba(255, 182, 193, 0.8), 0 0 70px rgba(255, 215, 0, 0.6);
     }
     45% {
       transform: scale(1.6) rotate(0deg);
       opacity: 1;
       filter: brightness(1.6) hue-rotate(120deg);
       box-shadow: 0 0 45px rgba(173, 216, 230, 0.8), 0 0 90px rgba(255, 182, 193, 0.6);
     }
     60% {
       transform: scale(1.4) rotate(0deg);
       opacity: 1;
       filter: brightness(1.4) hue-rotate(180deg);
       box-shadow: 0 0 35px rgba(144, 238, 144, 0.8), 0 0 70px rgba(173, 216, 230, 0.6);
     }
     75% {
       transform: scale(1.2) rotate(0deg);
       opacity: 1;
       filter: brightness(1.2) hue-rotate(240deg);
       box-shadow: 0 0 25px rgba(255, 215, 0, 0.8), 0 0 50px rgba(144, 238, 144, 0.6);
     }
     90% {
       transform: scale(1.05) rotate(0deg);
       opacity: 1;
       filter: brightness(1.05) hue-rotate(300deg);
       box-shadow: 0 0 15px rgba(255, 107, 107, 0.6), 0 0 30px rgba(255, 215, 0, 0.4);
     }
     100% {
       transform: scale(1) rotate(0deg);
       opacity: 1;
       filter: brightness(1) hue-rotate(360deg);
       box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
     }
    }

     
    #backTopBtn.reappearing {
     animation: reappear 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
    }

     
    #backTopBtn.exploding {
     animation: explosionTransition 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
      
     z-index: 1000;
    }

     
    #backTopBtn.exploding .button-ripple {
     opacity: 0;
     animation-play-state: paused;
    }

    @keyframes explosionTransition {
     0% {
       transform: scale(1.6) rotate(0deg);
       opacity: 1;
       filter: brightness(1.6) hue-rotate(0deg);
       box-shadow: 0 0 50px rgba(255, 215, 0, 0.8), 0 0 100px rgba(255, 107, 107, 0.6);
     }
     30% {
       transform: scale(1.4) rotate(5deg);
       opacity: 1;
       filter: brightness(1.4) hue-rotate(120deg);
       box-shadow: 0 0 40px rgba(255, 182, 193, 0.8), 0 0 80px rgba(255, 215, 0, 0.6);
     }
 
     100% {
       transform: scale(1) rotate(0deg);
       opacity: 1;
       filter: brightness(1) hue-rotate(360deg);
       box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
     }
    }

    @keyframes reappear {
     0% {
       transform: scale(0.85);
       opacity: 0.7;
     }
     50% {
       transform: scale(1.05);
       opacity: 1;
     }
     100% {
       transform: scale(1);
       opacity: 1;
     }
    }

    #backTopBtn.rotating {
     animation: rotate360 0.6s ease-in-out;
    }

    @keyframes rotate360 {
     0% { transform: rotate(0deg); }
     100% { transform: rotate(360deg); }
    }

     
    .particle {
     position: absolute;
     top: 50%;
     left: 50%;
     width: 4px;
     height: 4px;
     background: radial-gradient(circle, #fff, #ffd700, #ff69b4, #87ceeb);
     border-radius: 50%;
     pointer-events: none;
     z-index: -2;
     animation: particleExplode 1s ease-out forwards;
    }

    @keyframes particleExplode {
     0% {
       transform: translate(-50%, -50%) scale(0);
       opacity: 1;
     }
     50% {
       opacity: 1;
     }
     100% {
       transform: translate(-50%, -50%) scale(1) translate(var(--x), var(--y));
       opacity: 0;
     }
    }

     
    .energy-wave {
     position: absolute;
     top: 50%;
     left: 50%;
     width: 0;
     height: 0;
     border: 2px solid transparent;
     border-radius: 50%;
     pointer-events: none;
     z-index: -3;
     animation: energyWave 1.2s ease-out forwards;
    }

    @keyframes energyWave {
     0% {
       width: 0;
       height: 0;
       border-color: rgba(255, 215, 0, 0.8);
       opacity: 1;
     }
     100% {
       width: 120px;
       height: 120px;
       border-color: rgba(255, 215, 0, 0);
       opacity: 0;
     }
    }

     
    .hero-aura {
     position: absolute;
     top: 50%;
     left: 50%;
     width: 100%;
     height: 100%;
     border-radius: 50%;
     background: conic-gradient(from 0deg, #ffd700, #ff69b4, #87ceeb, #98fb98, #ffa07a, #ffd700);
     background-size: 200% 200%;
     pointer-events: none;
     z-index: -4;
     animation: heroAura 2s linear infinite;
     opacity: 0;
     transition: opacity 0.3s ease;
    }

    #backTopBtn.sprinting .hero-aura {
     opacity: 0.6;
    }

    @keyframes heroAura {
     0% {
       background-position: 0% 0%;
       transform: translate(-50%, -50%) rotate(0deg);
     }
     100% {
       background-position: 100% 100%;
       transform: translate(-50%, -50%) rotate(360deg);
     }
    }

     
    @media (max-width: 768px) {
     #backTopBtn {
       right: 20px;
       bottom: 20px;
       width: 28px;
       height: 28px;
     }
     
     .button-tooltip {
       right: 20px;
       bottom: 35px;
     }
    }

    @media (max-width: 480px) {
     #backTopBtn {
       right: 15px;
       bottom: 15px;
       width: 26px;
       height: 26px;
     }
     
     .button-tooltip {
       right: 15px;
       bottom: 31px;
     }
    }

     
     
     
    
     
    .toc-current-section {
     color: #ff8c00 !important;  
     font-weight: bold !important;
     position: relative;
     animation: tocFloat 2s ease-in-out infinite;
      
     transform: translateZ(0);
     backface-visibility: hidden;
     perspective: 1000px;
    }

     
    @keyframes tocFloat {
     0%, 100% { 
       transform: translateY(0px) translateZ(0); 
     }
     50% { 
       transform: translateY(-2px) translateZ(0); 
     }
    }

     
    .widget--toc a:hover {
     color: #ff8c00 !important;
     transition: color 0.3s ease;
    }

     
    .widget--toc .toc-current-section a {
     color: #ff8c00 !important;
     background: none !important;  
     border: none !important;  
      
     transition: color 0.3s ease !important;
    }

     
    .widget--toc a {
     transition: color 0.3s ease, transform 0.3s ease;
    }

     
    .widget--toc li {
     transition: all 0.3s ease;
      
     transform: translateZ(0);
     backface-visibility: hidden;
    }

     
    .widget--toc .toc-current-section {
      
    }

     
    .widget--toc a {
     text-decoration: none;
     transition: color 0.3s ease, transform 0.3s ease;
      
     transform: translateZ(0);
     backface-visibility: hidden;
    }

     
    .widget--toc a:hover {
     color: #ff8c00 !important;
     transform: translateX(3px);
     transition: color 0.3s ease, transform 0.3s ease;
    }

     
    .widget--toc {
      
     contain: layout style;
    }

    .widget--toc li {
      
     contain: layout;
    }

     
     
     
    #rope-container {
      position: fixed;
      top: 0;
      left: 20px;
      z-index: 10000;
      width: 50px;
      height: 480px;
      pointer-events: none;
    }

    #rope {
      position: absolute;
      top: -80px;
      left: 50%;
      width: 3px;
      height: 400px;
      background: linear-gradient(to bottom, #654321, #8B4513, #A0522D, #8B4513, #654321);
      border-radius: 1.5px;
      transform: translateX(-50%);
      pointer-events: auto;
      transition: all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      box-shadow: 0 1px 3px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.1);
    }

    #pull-ring {
      position: absolute;
      top: 300px;
      left: 50%;
      font-size: 20px;
      color: #ffffff;
      text-shadow: 0 0 8px rgba(255, 255, 255, 0.8);
      transform: translateX(-50%);
      pointer-events: auto;
      transition: all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
    }

    #rope:hover {
      box-shadow: 0 2px 6px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.2);
    }

    #pull-ring:hover {
      transform: translateX(-50%) scale(1.2);
      text-shadow: 0 0 12px rgba(255, 255, 255, 1);
      filter: drop-shadow(0 4px 8px rgba(0,0,0,0.5));
    }

     
     
     
    .highlight {
     max-height: 400px;
     overflow: hidden;
     position: relative;
     transition: max-height 0.3s ease-out;
    }

    .code-show {
     max-height: none !important;
    }

    .code-more-box {
     width: 100%;
     padding-top: 20px;
     background-image: linear-gradient(to bottom, rgba(255, 255, 255, 0), #fff);
     position: absolute;
     left: 0;
     right: 0;
     bottom: 0;
     z-index: 1;
     text-align: center;
    }

    .code-more-btn {
     display: inline-block;
     padding: 5px 15px;
     background: #f0f0f5;
     border-radius: 5px;
     cursor: pointer;
     font-size: 0.9em;
    }

     
     
     
    #particles-js {
     position: fixed;
     top: 0;
     left: 0;
      width: 100vw;
      height: 100vh;
     z-index: -1;
      pointer-events: none;
    }
    
    #particles-js canvas {
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      width: 100vw !important;
      height: 100vh !important;
    }
</style>

<script>
     
     
     

    let s1 = '2025-5-8 15:00:00'; 
    s1 = new Date(s1.replace(/-/g, "/"));
    let s2 = new Date();
    let timeDifference = s2.getTime() - s1.getTime();

    let days = Math.floor(timeDifference / (1000 * 60 * 60 * 24));
    let hours = Math.floor((timeDifference % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    let minutes = Math.floor((timeDifference % (1000 * 60 * 60)) / (1000 * 60));

    let result = days + "天" + hours + "小时" + minutes + "分钟";
    if (document.getElementById('runningdays')) {
        document.getElementById('runningdays').innerHTML = result;
    }
    
     
     
     
    
    

    function startContinuousRipple(button) {
     
     const buttonRipple = document.createElement('div');
     buttonRipple.className = 'button-ripple';
     button.appendChild(buttonRipple);
     
     
     button.buttonRipple = buttonRipple;
    }
    
    

    function createContinuousRipple(button) {
     
     if (button.querySelector('.continuous-ripple')) {
       return;
     }
     
     
     const rippleContainer = document.createElement('div');
     rippleContainer.className = 'ripple-container continuous-ripple';
     
     
     const ripple = document.createElement('div');
     ripple.className = 'ripple';
     ripple.style.background = 'radial-gradient(circle, rgba(255, 107, 107, 0.8) 0%, rgba(255, 255, 255, 0.9) 100%)';
     
     rippleContainer.appendChild(ripple);
     button.appendChild(rippleContainer);
     
     
     setTimeout(() => {
       if (rippleContainer.parentNode) {
         rippleContainer.parentNode.removeChild(rippleContainer);
       }
     }, 800);
    }
    
    

    function createHoverRipple(button) {
     
     if (button.buttonRipple) {
       
       button.buttonRipple.style.animationDuration = '1s';
       button.buttonRipple.classList.add('hover-mode');
     }
    }
    
    

    function showTooltip(button) {
     
     hideTooltip();
     
     
     const tooltip = document.createElement('div');
     tooltip.className = 'button-tooltip';
     tooltip.textContent = '返回顶部';
     document.body.appendChild(tooltip);
     
     
     setTimeout(() => {
       tooltip.classList.add('show');
     }, 10);
     
     
     button.tooltip = tooltip;
    }
    
    

    function hideTooltip() {
     const existingTooltip = document.querySelector('.button-tooltip');
     if (existingTooltip) {
       existingTooltip.classList.remove('show');
       setTimeout(() => {
         if (existingTooltip.parentNode) {
           existingTooltip.parentNode.removeChild(existingTooltip);
         }
       }, 300);
     }
    }
    
    

    function createRippleEffect(button) {
     
     
     
     const energyWave = document.createElement('div');
     energyWave.className = 'energy-wave';
     document.body.appendChild(energyWave);
     
     
     createParticleExplosion(button);
     
     
     setTimeout(() => {
       if (energyWave.parentNode) {
         energyWave.parentNode.removeChild(energyWave);
       }
     }, 1200);
    }

    

    function createParticleExplosion(button) {
     const particleCount = 16; 
     
     
     const particleColors = [
       'radial-gradient(circle, #ff6b6b, #ffd93d, #6bcf7f, #4d96ff)',
       'radial-gradient(circle, #ff8e8e, #ffed4e, #7ddb8f, #6ba6ff)',
       'radial-gradient(circle, #ffa1a1, #fff15f, #8ee79f, #89b6ff)',
       'radial-gradient(circle, #ffb4b4, #fff570, #9ff3af, #a7c6ff)'
     ];
     
     for (let i = 0; i < particleCount; i++) {
       const particle = document.createElement('div');
       particle.className = 'particle';
       
       
       const randomColor = particleColors[Math.floor(Math.random() * particleColors.length)];
       particle.style.background = randomColor;
       
       
       const angle = (i / particleCount) * 2 * Math.PI;
       const distance = 40 + Math.random() * 30; 
       const x = Math.cos(angle) * distance;
       const y = Math.sin(angle) * distance;
       
       particle.style.setProperty('--x', `${x}px`);
       particle.style.setProperty('--y', `${y}px`);
       
       
       particle.style.animationDelay = `${Math.random() * 0.4}s`;
       
       button.appendChild(particle);
       
       
       setTimeout(() => {
         if (particle.parentNode) {
           particle.parentNode.removeChild(particle);
         }
       }, 1000);
     }
    }

     
     
     
    

    function initScrollTop() {
     let rightSideBar = document.querySelector(".right-sidebar");
     if (!rightSideBar) {
      return;
     }

     
     let btn = document.createElement("div");
     btn.id = "backTopBtn";
     let isRotating = false; 

     
     const heroAura = document.createElement('div');
     heroAura.className = 'hero-aura';
     btn.appendChild(heroAura);

     
     btn.addEventListener('mouseenter', function() {
       createHoverRipple(this);
       showTooltip(this);
     });
     
     
     btn.addEventListener('mouseleave', function() {
       if (this.buttonRipple) {
         
         this.buttonRipple.style.animationDuration = '2s';
         this.buttonRipple.classList.remove('hover-mode');
       }
       hideTooltip();
     });

     btn.onclick = function() {
      if (!isRotating) {
       isRotating = true;
       backToTop(this, () => {
        isRotating = false; 
       });
      }
     };
     rightSideBar.appendChild(btn);

     
     btn.style.display = "block";
     
     
     startContinuousRipple(btn);
    }

    

    function backToTop(button, onComplete) {
     
     button.classList.add('sprinting');
     
     
     if (button.buttonRipple) {
       button.buttonRipple.style.display = 'none';
     }
     
     
     createRippleEffect(button);
     
     
     window.scrollTo({ top: 0, behavior: "smooth" });
     
     
     const checkScrollComplete = () => {
       if (window.scrollY === 0) {
         
         button.classList.remove('sprinting');
         
         
         button.classList.add('exploding');
         
         
         createParticleExplosion(button);
         
         
         if (button.buttonRipple) {
           button.buttonRipple.style.display = 'block';
         }
         
         
         setTimeout(() => {
           button.classList.remove('exploding');
           
           
           if (button.buttonRipple) {
             
             button.buttonRipple.style.animationPlayState = 'paused';
             
             button.buttonRipple.style.animation = 'none';
             button.buttonRipple.offsetHeight; 
             button.buttonRipple.style.animation = 'buttonRippleExpand 2s steps(25, end) infinite';
             button.buttonRipple.style.animationPlayState = 'running';
           }
           
           button.classList.add('reappearing');
           
           
           setTimeout(() => {
             button.classList.remove('reappearing');
             if (onComplete) {
               onComplete();
             }
           }, 600);
         }, 800); 
         
         return;
       }
       requestAnimationFrame(checkScrollComplete);
     };
     
     checkScrollComplete();
    }

    
    initScrollTop();
    
     
     
     
    

    function initRope() {
     console.log('initRope函数被调用');
     
     
     if (document.getElementById('rope-container')) {
      console.log('绳子已存在，跳过创建');
      return;
     }

     
     const monthlyEmojis = [
       { month: 1, name: "一月", ring: "❄️", falling: "❄️", description: "寒冬腊月，雪花飞舞" },
       { month: 2, name: "二月", ring: "🏮", falling: "🏮", description: "新春正月，灯笼高挂" },
       { month: 3, name: "三月", ring: "🌸", falling: "🌸", description: "春暖花开，樱花绽放" },
       { month: 4, name: "四月", ring: "🌧️", falling: "🌧️", description: "清明时节，春雨绵绵" },
       { month: 5, name: "五月", ring: "🌺", falling: "🌺", description: "立夏时节，牡丹盛开" },
       { month: 6, name: "六月", ring: "🌻", falling: "🌻", description: "芒种时节，向日葵开" },
       { month: 7, name: "七月", ring: "🌿", falling: "🌿", description: "小暑时节，绿意盎然" },
       { month: 8, name: "八月", ring: "🍉", falling: "🍉", description: "七夕时节，西瓜清甜" },
       { month: 9, name: "九月", ring: "🍁", falling: "🍁", description: "白露时节，秋叶飘落" },
       { month: 10, name: "十月", ring: "🍂", falling: "🍂", description: "寒露时节，落叶纷飞" },
       { month: 11, name: "十一月", ring: "🍊", falling: "🍊", description: "霜降时节，柑橘飘香" },
       { month: 12, name: "十二月", ring: "🌨️", falling: "🌨️", description: "大雪时节，雪花纷飞" }
     ];

     
     window.timeEmojis = [
       { period: "morning", name: "早晨", emojis: ["☀️", "🌤️", "🌱", "🌺", "🌿"], description: "晨曦初露，万物苏醒" },
       { period: "noon", name: "中午", emojis: ["🌞", "🌻", "🦋", "🦜", "🐝"], description: "烈日当空，生机勃勃" },
       { period: "evening", name: "傍晚", emojis: ["🌙", "⭐", "🦉"], description: "夕阳西下，夜幕降临" }
     ];

     
     const currentMonth = new Date().getMonth() + 1;
     const currentEmoji = monthlyEmojis.find(emoji => emoji.month === currentMonth);
     
     console.log(`当前月份: ${currentMonth}, 使用emoji: ${currentEmoji.name} - ${currentEmoji.description}`);
     console.log(`JavaScript Date.getMonth(): ${new Date().getMonth()}, 实际月份: ${currentMonth}`);

     
     let ropeContainer = document.createElement("div");
     ropeContainer.id = "rope-container";
     
     
     let rope = document.createElement("div");
     rope.id = "rope";
     rope.style.cssText = `
       position: absolute;
       top: -80px;
       left: 50%;
       width: 3px;
       height: 400px;
       background: linear-gradient(to bottom, #654321, #8B4513, #A0522D, #8B4513, #654321);
       border-radius: 1.5px;
       transform: translateX(-50%);
       pointer-events: auto;
       transition: all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
       box-shadow: 0 1px 3px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.1);
     `;
     
     
     let pullRing = document.createElement("div");
     pullRing.id = "pull-ring";
     pullRing.innerHTML = currentEmoji.ring;
     pullRing.title = `${currentEmoji.name}: ${currentEmoji.description}`;
     pullRing.style.cssText = `
       position: absolute;
       top: 300px;
       left: 50%;
       font-size: 20px;
       color: #ffffff;
       text-shadow: 0 0 8px rgba(255, 255, 255, 0.8);
       transform: translateX(-50%);
       pointer-events: auto;
       transition: all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
       filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
     `;
     
     
     function handleRopeClick() {
      console.log('拉绳被点击，开始动画...');
      
      
      rope.style.transform = 'translateX(-50%) translateY(40px)';
      rope.style.background = 'linear-gradient(to bottom, #8B4513, #A0522D, #8B4513, #A0522D, #8B4513)';
      
      
      pullRing.style.top = '340px';
      pullRing.style.transform = 'translateX(-50%) scale(0.8)';
      pullRing.style.textShadow = '0 0 15px rgba(255, 255, 255, 1)';
      pullRing.style.filter = 'drop-shadow(0 6px 12px rgba(0,0,0,0.6))';
      
      
      createSeasonalFalling(currentEmoji);
      
      
      setTimeout(() => {
       console.log('恢复拉绳原状...');
       rope.style.transform = 'translateX(-50%) translateY(0)';
       rope.style.background = 'linear-gradient(to bottom, #654321, #8B4513, #A0522D, #8B4513, #654321)';
       
       
       pullRing.style.top = '300px';
       pullRing.style.transform = 'translateX(-50%) scale(1)';
       pullRing.style.textShadow = '0 0 8px rgba(255, 255, 255, 0.8)';
       pullRing.style.filter = 'drop-shadow(0 2px 4px rgba(0,0,0,0.3))';
      }, 800);
     }
     
     
     rope.addEventListener('click', handleRopeClick);
     pullRing.addEventListener('click', handleRopeClick);
     
     
     ropeContainer.appendChild(rope);
     ropeContainer.appendChild(pullRing);
     document.body.appendChild(ropeContainer);
     
     console.log(`可拉动的绳子已创建，使用${currentEmoji.name}主题`);
    }

    

    function createSeasonalFalling(emojiConfig) {
     console.log(`开始创建${emojiConfig.name}飘落效果...`);
     console.log('emojiConfig:', emojiConfig);
     
     
     const fallingContainer = document.createElement('div');
     fallingContainer.id = 'falling-container';
     fallingContainer.style.cssText = `
       position: fixed;
       top: 0;
       left: 0;
       width: 100vw;
       height: 100vh;
       pointer-events: none;
       z-index: 9999;
       overflow: hidden;
     `;
     document.body.appendChild(fallingContainer);
     console.log('飘落容器已创建');
     
     
     const currentHour = new Date().getHours();
     let currentTimePeriod;
     if (currentHour >= 5 && currentHour < 11) {
      currentTimePeriod = window.timeEmojis.find(t => t.period === "morning");
     } else if (currentHour >= 11 && currentHour < 17) {
      currentTimePeriod = window.timeEmojis.find(t => t.period === "noon");
     } else {
      currentTimePeriod = window.timeEmojis.find(t => t.period === "evening");
     }
     
     console.log(`当前时间: ${currentHour}点, 时间段: ${currentTimePeriod.name} - ${currentTimePeriod.description}`);
     console.log('timeEmojis:', window.timeEmojis);
     
     
     const totalElements = emojiConfig.month >= 11 || emojiConfig.month <= 2 ? 30 : 25; 
     let activeElements = 0;
     
     console.log(`准备创建 ${totalElements} 个飘落元素`);
     
     for (let i = 0; i < totalElements; i++) {
      setTimeout(() => {
       const element = document.createElement('div');
       
       
       let selectedEmoji, emojiType;
       if (Math.random() < 0.7) {
        selectedEmoji = emojiConfig.falling;
        emojiType = "monthly";
       } else {
        
        selectedEmoji = currentTimePeriod.emojis[Math.floor(Math.random() * currentTimePeriod.emojis.length)];
        emojiType = "time";
       }
       
       console.log(`创建第 ${i + 1} 个元素: ${selectedEmoji} (${emojiType})`);
       element.innerHTML = selectedEmoji;
       
       
       let fontSize, color, textShadow;
       if (emojiType === "time") {
        
        if (currentTimePeriod.period === "morning") {
         
         fontSize = Math.random() * 18 + 16;
         color = '#FFD700';
         textShadow = '0 0 5px rgba(255, 215, 0, 0.7)';
        } else if (currentTimePeriod.period === "noon") {
         
         fontSize = Math.random() * 18 + 16;
         color = '#FF8C00';
         textShadow = '0 0 5px rgba(255, 140, 0, 0.7)';
        } else {
         
         fontSize = Math.random() * 18 + 16;
         color = '#4B0082';
         textShadow = '0 0 5px rgba(75, 0, 130, 0.7)';
        }
       } else {
        
        if (emojiConfig.month >= 11 || emojiConfig.month <= 2) {
         
         fontSize = Math.random() * 20 + 15;
         color = 'white';
         textShadow = '0 0 5px rgba(255, 255, 255, 0.8)';
        } else if (emojiConfig.month >= 3 && emojiConfig.month <= 5) {
         
         fontSize = Math.random() * 18 + 16;
         color = '#FF69B4';
         textShadow = '0 0 5px rgba(255, 105, 180, 0.6)';
        } else if (emojiConfig.month >= 6 && emojiConfig.month <= 8) {
         
         fontSize = Math.random() * 18 + 15;
         color = '#32CD32';
         textShadow = '0 0 5px rgba(50, 205, 50, 0.6)';
        } else {
         
         fontSize = Math.random() * 18 + 15;
         color = '#FF8C00';
         textShadow = '0 0 5px rgba(255, 140, 0, 0.6)';
        }
       }
       
       element.style.cssText = `
         position: absolute;
         font-size: ${fontSize}px;
         color: ${color};
         text-shadow: ${textShadow};
         left: ${Math.random() * window.innerWidth}px;
         top: -50px;
         user-select: none;
         pointer-events: none;
         z-index: 9999;
         transition: all 0.3s ease;
       `;
       
       fallingContainer.appendChild(element);
       activeElements++;
       
       
       const duration = 4000 + Math.random() * 2000;
       const endX = parseFloat(element.style.left) + (Math.random() - 0.5) * 400;
       const endY = window.innerHeight + 50;
       
       element.style.transition = `all ${duration}ms linear`;
       
       setTimeout(() => {
        element.style.left = endX + 'px';
        element.style.top = endY + 'px';
        element.style.opacity = '0';
       }, 50);
       
       
       setTimeout(() => {
        if (element.parentNode) {
         element.parentNode.removeChild(element);
        }
        activeElements--;
        
        
        if (activeElements === 0) {
         if (fallingContainer && fallingContainer.parentNode) {
          fallingContainer.parentNode.removeChild(fallingContainer);
         }
        }
       }, duration);
      }, i * 150);
     }
    }

     
     
     
    function initCodeMoreBox() {
     let codeBlocks = document.querySelectorAll(".highlight");
     if (!codeBlocks) {
      return;
     }
     codeBlocks.forEach(codeBlock => {
      
      if (codeBlock.scrollHeight <= codeBlock.clientHeight) {
       return;
      }
      
      
      let codeMoreBox = document.createElement('div');
      codeMoreBox.classList.add('code-more-box');
      
      let codeMoreBtn = document.createElement('span');
      codeMoreBtn.classList.add('code-more-btn');
      codeMoreBtn.innerText = '显示更多'; 
      let isExpanded = false; 

      codeMoreBtn.addEventListener('click', () => {
       if (!isExpanded) {
        codeBlock.classList.add('code-show'); 
        codeMoreBtn.innerText = '折叠'; 
        isExpanded = true;
       } else {
        codeBlock.classList.remove('code-show'); 
        codeMoreBtn.innerText = '显示更多'; 
        isExpanded = false;
       }
       
       window.dispatchEvent(new Event('resize'));
      });
      
      codeMoreBox.appendChild(codeMoreBtn);
      codeBlock.appendChild(codeMoreBox);
     });
    }

    initCodeMoreBox();
    
    
    initRope();
</script>


<div id="particles-js"></div>


<script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
<script>
  
  particlesJS('particles-js', {
    "particles": {
      "number": {
        "value": 80,
        "density": {
          "enable": true,
          "value_area": 800
        }
      },
      "color": {
        "value": ["#888888", "#aaaaaa", "#cccccc", "#eeeeee"]
      },
      "shape": {
        "type": "circle",
        "stroke": {
          "width": 0,
          "color": "#000000"
        },
        "polygon": {
          "nb_sides": 5
        }
      },
      "opacity": {
        "value": 0.5,
        "random": false,
        "anim": {
          "enable": false,
          "speed": 1,
          "opacity_min": 0.1,
          "sync": false
        }
      },
      "size": {
        "value": 2,
        "random": true,
        "anim": {
          "enable": false,
          "speed": 40,
          "size_min": 0.1,
          "sync": false
        }
      },
      "line_linked": {
        "enable": true,
        "distance": 150,
        "color": "#888888",
        "opacity": 0.4,
        "width": 1
      },
      "move": {
        "enable": true,
        "speed": 2,
        "direction": "none",
        "random": false,
        "straight": false,
        "out_mode": "out",
        "bounce": false,
        "attract": {
          "enable": false,
          "rotateX": 600,
          "rotateY": 1200
        }
      }
    },
    "interactivity": {
      "detect_on": "canvas",
      "events": {
        "onhover": {
          "enable": true,
          "mode": "grab"
        },
        "onclick": {
          "enable": true,
          "mode": "push"
        },
        "resize": true
      },
      "modes": {
        "grab": {
          "distance": 140,
          "line_linked": {
            "opacity": 1
          }
        },
        "bubble": {
          "distance": 400,
          "size": 40,
          "duration": 2,
          "opacity": 8,
          "speed": 3
        },
        "repulse": {
          "distance": 200,
          "duration": 0.4
        },
        "push": {
          "particles_nb": 4
        },
        "remove": {
          "particles_nb": 2
        }
      }
    },
    "retina_detect": true
  });
</script>

<script>
     
     
     
    
    

    function initTocHighlight() {
     
     if (document.readyState === 'loading') {
       document.addEventListener('DOMContentLoaded', initTocHighlight);
       return;
     }
     
     
     const toc = document.querySelector('#TableOfContents');
     if (!toc) {
       return;
     }
     
     console.log('目录高亮功能已初始化');
     
     
     const headers = document.querySelectorAll('.article-content h1[id], .article-content h2[id], .article-content h3[id], .article-content h4[id], .article-content h5[id], .article-content h6[id]');
     
     if (headers.length === 0) {
       console.log('未找到文章标题，尝试其他选择器...');
       
       const altHeaders = document.querySelectorAll('h1[id], h2[id], h3[id], h4[id], h5[id], h6[id]');
       if (altHeaders.length > 0) {
         console.log(`找到 ${altHeaders.length} 个标题（使用备用选择器）`);
         headers = altHeaders;
       } else {
         console.log('仍未找到文章标题');
         return;
       }
     } else {
       console.log(`找到 ${headers.length} 个文章标题`);
     }
     
     
     const tocLinks = toc.querySelectorAll('a[href^="#"]');
     
     if (tocLinks.length === 0) {
       console.log('未找到目录链接');
       return;
     }
     
     
     const headerPositions = Array.from(headers).map(header => ({
       id: header.id,
       offset: header.offsetTop,
       element: header
     }));
     
     
     let currentHighlighted = null;
     
     

     function updateTocHighlight() {
       const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
       const windowHeight = window.innerHeight;
       
       
       let currentHeader = null;
       
       
       const viewportCenter = scrollTop + windowHeight / 2;
       
       
       let closestHeader = null;
       let minDistance = Infinity;
       
       for (let i = 0; i < headerPositions.length; i++) {
         const header = headerPositions[i];
         const distance = Math.abs(header.offset - viewportCenter);
         
         if (distance < minDistance) {
           minDistance = distance;
           closestHeader = header;
         }
         
         
         if (scrollTop + 100 >= header.offset) {
           currentHeader = header;
         }
       }
       
       
       if (!currentHeader && closestHeader) {
         currentHeader = closestHeader;
       }
       
       
       if (!currentHeader && headerPositions.length > 0) {
         currentHeader = headerPositions[0];
       }
       
                if (currentHeader) {
           
           const tocLink = toc.querySelector(`a[href="#${currentHeader.id}"]`);
           if (tocLink) {
             
             if (currentHighlighted !== tocLink) {
               
               if (currentHighlighted) {
                 currentHighlighted.classList.remove('toc-current-section');
               }
               
               
               tocLink.classList.add('toc-current-section');
               currentHighlighted = tocLink;
               
               
               scrollTocToCurrent(tocLink);
               
               
               console.log(`当前高亮: ${currentHeader.id} - ${tocLink.textContent}`);
             }
           } else {
             console.log(`未找到目录链接: ${currentHeader.id}`);
           }
         }
     }
     
     

     function scrollTocToCurrent(currentLink) {
       const tocContainer = toc.closest('.widget--toc');
       if (!tocContainer) return;
       
       const linkRect = currentLink.getBoundingClientRect();
       const containerRect = tocContainer.getBoundingClientRect();
       
       
       if (linkRect.top < containerRect.top || linkRect.bottom > containerRect.bottom) {
         currentLink.scrollIntoView({
           behavior: 'smooth',
           block: 'center',
           inline: 'nearest'
         });
       }
     }
     
     
     let scrollTimeout;
     window.addEventListener('scroll', () => {
       clearTimeout(scrollTimeout);
       scrollTimeout = setTimeout(updateTocHighlight, 50); 
     });
     
     
     updateTocHighlight();
     
     
     window.addEventListener('resize', () => {
       
       headerPositions.forEach(header => {
         header.offset = header.element.offsetTop;
       });
       
       
       updateTocHighlight();
     });
    }
    
    
    if (document.readyState === 'complete') {
     initTocHighlight();
    } else {
     window.addEventListener('load', initTocHighlight);
    }
    
    
    document.addEventListener('DOMContentLoaded', () => {
     setTimeout(initTocHighlight, 100); 
    });

    
    function updateBackTopIcon() {
      const backTopBtn = document.getElementById('backTopBtn');
      const buttonRipple = document.querySelector('.buttonRipple');
      
      if (!backTopBtn) {
        console.log('返回顶部按钮未找到，等待创建...');
        return;
      }
      
      
      const isDarkMode = 
        document.documentElement.dataset.scheme === 'dark' ||
        document.documentElement.classList.contains('dark') ||
        document.body.classList.contains('dark') ||
        window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      
      
      const lightIcon = '/icons/backTop.svg';
      const darkIcon = '/icons/backTop-dark.svg';
      
      console.log('=== 主题检测调试信息 ===');
      console.log('检测到主题:', isDarkMode ? '暗色' : '浅色');
      console.log('当前data-scheme:', document.documentElement.dataset.scheme);
      console.log('document.documentElement.classList:', document.documentElement.classList.toString());
      console.log('document.body.classList:', document.body.classList.toString());
      console.log('系统偏好:', window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? '暗色' : '浅色');
      console.log('返回顶部按钮:', backTopBtn);
      console.log('按钮当前样式:', {
        backgroundImage: backTopBtn.style.backgroundImage,
        backgroundColor: backTopBtn.style.backgroundColor,
        boxShadow: backTopBtn.style.boxShadow
      });
      
      if (isDarkMode) {
        console.log('应用暗色主题样式');
        backTopBtn.style.backgroundImage = 'url(' + darkIcon + ')';
        backTopBtn.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';
        backTopBtn.style.boxShadow = '0 4px 20px rgba(255, 255, 255, 0.1)';
        
        if (buttonRipple) {
          buttonRipple.style.backgroundImage = 'url(' + darkIcon + ')';
          
          buttonRipple.style.removeProperty('opacity');
        }
      } else {
        console.log('应用浅色主题样式');
        backTopBtn.style.backgroundImage = 'url(' + lightIcon + ')';
        backTopBtn.style.backgroundColor = 'rgba(255, 255, 255, 0.9)';
        backTopBtn.style.boxShadow = '0 4px 20px rgba(0, 0, 0, 0.15)';
        
        if (buttonRipple) {
          buttonRipple.style.backgroundImage = 'url(' + lightIcon + ')';
          
          buttonRipple.style.removeProperty('opacity');
        }
      }
      
      
      setTimeout(() => {
        const img = new Image();
        img.onload = function() {
          console.log('SVG图标加载成功，隐藏CSS箭头');
          backTopBtn.style.setProperty('--show-css-arrow', 'none');
        };
        img.onerror = function() {
          console.log('SVG图标加载失败，显示CSS箭头');
          backTopBtn.style.setProperty('--show-css-arrow', 'block');
        };
        img.src = isDarkMode ? darkIcon : lightIcon;
      }, 100);
      
      console.log('样式应用完成');
      console.log('========================');
    }

    
    window.addEventListener('onColorSchemeChange', updateBackTopIcon);
    
    
    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (mutation.type === 'attributes' && mutation.attributeName === 'data-scheme') {
          console.log('检测到主题属性变化:', document.documentElement.dataset.scheme);
          updateBackTopIcon();
        }
      });
    });
    
    
    observer.observe(document.documentElement, {
      attributes: true,
      attributeFilter: ['data-scheme']
    });
    
    
    if (window.matchMedia) {
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', updateBackTopIcon);
    }
    
    
    if (document.readyState === 'complete') {
      updateBackTopIcon();
    } else {
      window.addEventListener('load', updateBackTopIcon);
    }
    
    
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(updateBackTopIcon, 100);
    });
    
    
    function waitForBackTopBtn() {
      const backTopBtn = document.getElementById('backTopBtn');
      if (backTopBtn) {
        console.log('返回顶部按钮已找到，立即应用主题样式');
        updateBackTopIcon();
      } else {
        console.log('返回顶部按钮未找到，等待创建...');
        setTimeout(waitForBackTopBtn, 500);
      }
    }
    
    
    waitForBackTopBtn();
    
    
    setInterval(updateBackTopIcon, 2000);
    
    
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden) {
        console.log('页面重新可见，重新应用主题样式');
        setTimeout(updateBackTopIcon, 100);
      }
    });
</script>



    </body>
</html>
