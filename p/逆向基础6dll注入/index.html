<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="以彼之矛">
<title>逆向基础6：DLL注入</title>

<link rel='canonical' href='https://blog.928330.xyz/p/%E9%80%86%E5%90%91%E5%9F%BA%E7%A1%806dll%E6%B3%A8%E5%85%A5/'>

<link rel="stylesheet" href="/scss/style.min.6eb8014a7c47067a823017bd97e0272008650fbf090fa26d21e955bb600446ce.css"><meta property='og:title' content="逆向基础6：DLL注入">
<meta property='og:description' content="以彼之矛">
<meta property='og:url' content='https://blog.928330.xyz/p/%E9%80%86%E5%90%91%E5%9F%BA%E7%A1%806dll%E6%B3%A8%E5%85%A5/'>
<meta property='og:site_name' content='kakahuote'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='re' /><meta property='article:published_time' content='2025-11-02T18:44:56&#43;08:00'/><meta property='article:modified_time' content='2025-11-02T20:15:11&#43;08:00'/><meta property='og:image' content='http://picture.928330.xyz/typora/a09dbc5b24b5dd58f1f021f69aca8682.jpg' />
<meta name="twitter:title" content="逆向基础6：DLL注入">
<meta name="twitter:description" content="以彼之矛"><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='http://picture.928330.xyz/typora/a09dbc5b24b5dd58f1f021f69aca8682.jpg' />
    <link rel="shortcut icon" href="/favicon.ico" />
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>加载动画</title>
    <style>
        .loading {
            position: fixed;
            display: flex;
            flex-direction: column;  
            justify-content: center;
            align-items: center;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 99;
            background-color: #f5f5fa;
            transition: transform 1.5s, opacity 1.5s;
            transform: scale(1);
            opacity: 1;
        }

        .loader-bars {
            display: flex;  
            align-items: flex-end;  
            gap: 3px;  
            margin-bottom: 20px;  
        }

        .bar {
            height: 5px;
            width: 12px;
            animation-duration: 0.45s;
            animation-name: changeHeight;
            animation-iteration-count: infinite;
            animation-direction: alternate;
        }

        .red {
            background-color: #E50000;
            box-shadow: 1px 1px 10px #E50000;
            animation-delay: 0.10s;
        }

        .orange {
            background-color: #FF8D00;
            box-shadow: 1px 1px 10px #FF8D00;
            animation-delay: 0.20s;
        }

        .yellow {
            background-color: #FFEE00;
            box-shadow: 1px 1px 10px #FFEE00;
            animation-delay: 0.25s;
        }

        .green {
            background-color: #008121;
            box-shadow: 1px 1px 10px #008121;
            animation-delay: 0.30s;
        }

        .blue {
            background-color: #004CFF;
            box-shadow: 1px 1px 10px #004CFF;
            animation-delay: 0.35s;
        }

        .violet {
            background-color: #760188;
            box-shadow: 1px 1px 10px #760188;
            animation-delay: 0.40s;
        }

        @keyframes changeHeight {
            from {
                height: 5px;
            }

            to {
                height: 40px;
            }
        }

        .scaleAndFadeout {
            transform: scale(1.5);
            opacity: 0;
        }

         
        .loading-text {
            color: #333;  
            font-size: 16px;  
        }
    </style>
</head>
<body>

    <div class="loading">
        <div class="loader-bars">
            <div class="red bar"></div>
            <div class="orange bar"></div>
            <div class="yellow bar"></div>
            <div class="green bar"></div>
            <div class="blue bar"></div>
            <div class="violet bar"></div>
        </div>
        <div class="loading-text">loading...</div>
    </div>

    <script>
        function initLoading() {
            let loading = document.querySelector(".loading");
            document.addEventListener('DOMContentLoaded', function() {
                setTimeout(() => {
                    loading.classList.add("scaleAndFadeout");
                    setTimeout(() => {
                        loading.style.display = "none";
                    }, 1500);
                }, 50);
            });
        }

        initLoading();
    </script>

</body>
</html>
    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="切换菜单">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/" id="avatar-link">
                
                    
                    
                    
                        
                        <img class="site-logo original-logo" src="/img/avatar_hu_4804467f7cda2058.png" width="300" height="300" loading="lazy" alt="原始头像">
                    
                    
                        
                        <img class="site-logo hover-logo" src="/img/avatar-hover_hu_f231304c77e946da.png" width="300" height="300" loading="lazy" alt="悬停头像">
                    
                
                </a>
                
                    <span class="emoji">🤝</span>
                
            </figure>
            
        

        <div class="site-meta">
            <h1 class="site-name"><a href="/">kakahuote</a></h1>
            <h2 class="site-description">靡不有初，鲜克有终</h2>
        </div>
    </header>

    <ol class="menu-social">
                <li>
                    <a
                        href='https://bilibili.com'
                        target="_blank"
                        title="bilibili"
                        rel="me"
                    >
                        
                        
                            <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-brand-bilibili"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 10a4 4 0 0 1 4 -4h10a4 4 0 0 1 4 4v6a4 4 0 0 1 -4 4h-10a4 4 0 0 1 -4 -4v-6z" /><path d="M8 3l2 3" /><path d="M16 3l-2 3" /><path d="M9 13v-2" /><path d="M15 11v2" /></svg>
                        
                    </a>
                </li>
            
                <li>
                    <a
                        href='https://github.com'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            </ol>

    <ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>主页</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>归档</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>搜索</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E5%8F%8B%E9%93%BE/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>友链</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>暗色模式</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>
    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">目录</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#动态链接库-dll">动态链接库 (DLL)</a>
      <ol>
        <li><a href="#什么是动态链接库">什么是动态链接库？</a></li>
        <li><a href="#入口函数dllmain">入口函数：DllMain()</a></li>
        <li><a href="#dll注入">DLL注入</a></li>
      </ol>
    </li>
    <li><a href="#windows系统编程">Windows系统编程</a>
      <ol>
        <li><a href="#常用数据类型">常用数据类型</a></li>
        <li><a href="#unicode与ansi">Unicode与ANSI</a></li>
        <li><a href="#windows-字符串函数">Windows 字符串函数</a></li>
        <li><a href="#关键api列表">关键API列表</a>
          <ol>
            <li><a href="#进程与线程api">进程与线程API</a>
              <ol>
                <li><a href="#openprocess">OpenProcess</a></li>
                <li><a href="#createthread">CreateThread</a></li>
                <li><a href="#createremotethread">CreateRemoteThread</a></li>
              </ol>
            </li>
            <li><a href="#内存操作api">内存操作API</a>
              <ol>
                <li><a href="#virtualallocex">VirtualAllocEx</a></li>
                <li><a href="#writeprocessmemory">WriteProcessMemory</a></li>
              </ol>
            </li>
            <li><a href="#模块操作api">模块操作API</a>
              <ol>
                <li><a href="#getmodulehandle">GetModuleHandle</a></li>
                <li><a href="#getmodulefilename">GetModuleFileName</a></li>
                <li><a href="#getprocaddress">GetProcAddress</a></li>
                <li><a href="#waitforsingleobject">WaitForSingleObject</a></li>
                <li><a href="#closehandle">CloseHandle</a></li>
              </ol>
            </li>
            <li><a href="#消息钩取api">消息钩取API</a>
              <ol>
                <li><a href="#setwindowshookex">SetWindowsHookEx</a></li>
                <li><a href="#callnexthookex">CallNextHookEx</a></li>
                <li><a href="#unhookwindowshookex">UnhookWindowsHookEx</a></li>
              </ol>
            </li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#注入用dll的准备">注入用DLL的准备</a>
      <ol>
        <li><a href="#三个示例">三个示例</a>
          <ol>
            <li><a href="#弹窗messagebox">弹窗（MessageBox）</a></li>
            <li><a href="#播放系统提示音beep">播放系统提示音（Beep）</a></li>
            <li><a href="#输出到控制台allocconsole">输出到控制台（AllocConsole）</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#注入的实现方法">注入的实现方法</a>
      <ol>
        <li><a href="#创建远程线程-createremotethread">创建远程线程 (CreateRemoteThread)</a>
          <ol>
            <li><a href="#原理">原理</a></li>
            <li><a href="#步骤">步骤</a></li>
            <li><a href="#示例">示例</a></li>
          </ol>
        </li>
        <li><a href="#使用注册表-appinit_dlls">使用注册表 (AppInit_DLLs)</a>
          <ol>
            <li><a href="#原理-1">原理</a></li>
            <li><a href="#步骤-1">步骤</a></li>
            <li><a href="#示例-1">示例</a></li>
          </ol>
        </li>
        <li><a href="#消息钩取-setwindowshookex">消息钩取 (SetWindowsHookEx)</a>
          <ol>
            <li><a href="#原理-2">原理</a></li>
            <li><a href="#步骤-2">步骤</a></li>
            <li><a href="#示例-2">示例</a>
              <ol>
                <li><a href="#木马hookdllcpp">木马：HookDll.cpp</a></li>
                <li><a href="#安装器testhookcpp">安装器：TestHook.cpp</a></li>
              </ol>
            </li>
          </ol>
        </li>
        <li><a href="#修改pe导入表-静态注入">修改PE导入表 (静态注入)</a>
          <ol>
            <li><a href="#原理-3">原理</a></li>
            <li><a href="#示例-3">示例</a></li>
            <li><a href="#修改导入表">修改导入表</a>
              <ol>
                <li><a href="#定位原导入表">定位原导入表</a></li>
                <li><a href="#寻找新空间">寻找新空间</a></li>
                <li><a href="#复制添加并更新pe头">复制、添加并更新PE头</a></li>
                <li><a href="#构建新的intiat和字符串">构建新的INT、IAT和字符串</a></li>
                <li><a href="#计算新构建内容的rva">计算新构建内容的RVA</a></li>
                <li><a href="#填充新的image_import_descriptor">填充新的IMAGE_IMPORT_DESCRIPTOR**</a></li>
                <li><a href="#修改节区属性">修改节区属性</a></li>
                <li><a href="#清除绑定导入表">清除绑定导入表</a></li>
                <li><a href="#开始注入">开始注入</a></li>
              </ol>
            </li>
          </ol>
        </li>
        <li><a href="#代码注入">代码注入</a>
          <ol>
            <li><a href="#原理-4">原理</a></li>
            <li><a href="#示例-4">示例</a>
              <ol>
                <li><a href="#第1步定义共享结构体">第1步：定义共享结构体</a></li>
                <li><a href="#第2步被注入的函数-payload">第2步：被注入的函数 (Payload)</a></li>
                <li><a href="#第3步注入器-injectcode">第3步：注入器 (InjectCode)</a></li>
              </ol>
            </li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#dll的卸载-dll-eject">DLL的卸载 (Dll Eject)</a>
      <ol>
        <li><a href="#示例-5">示例</a></li>
      </ol>
    </li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/p/%E9%80%86%E5%90%91%E5%9F%BA%E7%A1%806dll%E6%B3%A8%E5%85%A5/">
                
                    <img src="http://picture.928330.xyz/typora/a09dbc5b24b5dd58f1f021f69aca8682.jpg" loading="lazy" alt="Featured image of post 逆向基础6：DLL注入" />
                
            </a>
        </div>
    

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/%E6%8A%80%E6%9C%AF%E5%AD%A6%E4%B9%A0/" >
                技术学习
            </a>
        
    </header>
    

    <div class="article-title-wrapper">


        <h2 class="article-title">
            <a href="/p/%E9%80%86%E5%90%91%E5%9F%BA%E7%A1%806dll%E6%B3%A8%E5%85%A5/">逆向基础6：DLL注入</a>
        </h2>
        
        <h3 class="article-subtitle">
            以彼之矛
        </h3>
        

    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">
                    发布时间：2025-11-02</time>
            </div>
        

        

        <div class="article-lastmod">
               <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



               <time>
                   更新时间：2025-11-02
               </time>
           </div>
        <div>
            <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-eye"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" /><path d="M21 12c-2.4 4 -5.4 6 -9 6c-3.6 0 -6.6 -2 -9 -6c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6" /></svg>
            <time class="article-time--published">
                浏览量：<span class="waline-pageview-count" data-waline-pageview-count="0">0</span>
            </time>
        </div>
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <p>在PE文件的学习中，我们了解了导入表和动态链接库是如何被PE加载器链接在一起的，这种在运行时才加载代码和数据的机制是Windows系统的核心</p>
<p>但正所谓水能载舟，亦能覆舟，这种强大的机制也诞生了问题 —— <strong>DLL注入（DLL Injection）</strong></p>
<p>DLL注入是一种强制让一个正在运行的进程加载并执行我们指定的DLL文件的技术，说白了就是执行任意代码</p>
<h1 id="动态链接库-dll">动态链接库 (DLL)
</h1><p>之前PE主要讲的是exe文件，稍稍提到了dll，现在我们正式来介绍一下这个玩意</p>
<h2 id="什么是动态链接库">什么是动态链接库？
</h2><p>DLL全称Dynamic Link Library，也就是动态链接库，是一个独立于主程序文件之外的程序库文件，它包含可被多个应用程序共享使用的代码、数据和资源</p>
<p>与静态链接lib在编译时将库代码完全复制到exe中不同，动态链接的DLL代码和数据在运行时才被加载器链接到主程序中，加载方式主要有两种：</p>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th><strong>链接方式</strong></th>
          <th><strong>链接时机</strong></th>
          <th><strong>实现方式</strong></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><strong>隐式链接</strong></td>
          <td>程序启动时</td>
          <td>由Windows加载器自动扫描PE文件的导入表，并加载所有依赖的DLL</td>
      </tr>
      <tr>
          <td><strong>显式链接</strong></td>
          <td>程序运行时按需调用</td>
          <td>程序员通过调用<code>LoadLibrary()</code>和<code>GetProcAddress()</code>API来手动加载DLL并获取函数地址</td>
      </tr>
  </tbody>
</table></div>
<p>这部分内容在之前文章已经讲过，详细的就不再说了 -&gt; <a class="link" href="https://blog.928330.xyz/p/%E9%80%86%E5%90%91%E5%9F%BA%E7%A1%804pe%E6%96%87%E4%BB%B6/#%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93dll"  target="_blank" rel="noopener"
    >逆向基础4：PE文件
    
    <span style="white-space: nowrap;"><svg width=".7em"
        height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg">
        <path d="m13 3l3.293 3.293l-7 7l1.414 1.414l7-7L21 11V3z" fill="currentColor" />
        <path d="M19 19H5V5h7l-2-2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2v-5l-2-2v7z"
            fill="currentColor">
    </svg></span>
    
</a></p>
<p>在Windows系统中，有三个核心的DLL，几乎所有图形化程序都离不开它们：</p>
<p><strong><code>Kernel32.dll</code></strong>：提供操作系统的核心功能，如进程/线程管理、内存管理和文件访问</p>
<p><strong><code>User32.dll</code></strong>：提供用户界面功能，如窗口管理、消息传递以及键盘/鼠标操作</p>
<p><strong><code>GDI32.dll</code></strong>：提供图形设备接口，负责在屏幕或打印机上绘制图形和显示文本</p>
<div class="alert alert-note">
    <div class="alert-header">
        <span class="alert-icon">
            📝
        </span>
        <span class="alert-title">
            Note
        </span>
    </div>
    <div class="alert-content">
        <p><strong>文件名里的32并不会随着操作系统的位数而改变，为了向后兼容，它也不可能改名</strong></p>
<p>但是，他们会有不同的版本以服务不同位的程序：</p>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>功能</th>
          <th>64位系统中位置</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>64位系统DLL</td>
          <td><code>C:\Windows\System32</code></td>
      </tr>
      <tr>
          <td>32位系统DLL</td>
          <td><code>C:\Windows\SysWOW64</code></td>
      </tr>
  </tbody>
</table></div>
<p><strong>在系统内部，微软通过WOW64（Windows-on-Windows 64-bit）子系统来让32位程序也能调用相同的API接口</strong></p></div>
</div>
<h2 id="入口函数dllmain">入口函数：DllMain()
</h2><p>当一个DLL被加载到进程的地址空间时，Windows加载器会查找并执行一个特殊的入口函数 ——<code>DllMain</code></p>
<p><code>DllMain</code>是DLL内部的函数，并不会作为API导出</p>
<p>它的存在至关重要，至少对我们这些攻击者来说是重要的，因为我们所有做手脚的代码都是从这里开始执行的</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#e06c75">BOOL</span> <span style="color:#e06c75">WINAPI</span> <span style="color:#61afef;font-weight:bold">DllMain</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">HINSTANCE</span> <span style="color:#e06c75">hinstDLL</span>,  <span style="color:#7f848e">// DLL实例的句柄，即DLL被映射到的基地址
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">DWORD</span> <span style="color:#e06c75">fdwReason</span>,     <span style="color:#7f848e">// 系统调用 DllMain 的原因
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">LPVOID</span> <span style="color:#e06c75">lpReserved</span>    <span style="color:#7f848e">// 保留参数
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">switch</span>(<span style="color:#e06c75">fdwReason</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">case</span> <span style="color:#e06c75">DLL_PROCESS_ATTACH</span>: 	<span style="color:#7f848e">// 进程加载 DLL —— 这是我们执行注入代码的时机！！！！！！！！
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>            <span style="color:#7f848e">// DLL 首次被加载到进程时调用，例如程序启动或调用 LoadLibrary() 时
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>            <span style="color:#7f848e">// 只会被调用一次，如果加载失败，返回 FALSE，系统会立即卸载 DLL
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>            <span style="color:#7f848e">// 常用于初始化全局变量、创建所需的资源（如文件、互斥锁、线程池等）、设置钩子、建立与主程序的通信通道
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>            <span style="color:#c678dd">break</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">case</span> <span style="color:#e06c75">DLL_THREAD_ATTACH</span>: 	<span style="color:#7f848e">// 创建新线程
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>            <span style="color:#7f848e">// 进程创建新线程时，系统会调用所有已加载DLL的这个分支
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>            <span style="color:#7f848e">// 常用于为新线程分配线程局部存储（TLS） 、初始化与该线程有关的对象
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>            <span style="color:#c678dd">break</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">case</span> <span style="color:#e06c75">DLL_THREAD_DETACH</span>: 	<span style="color:#7f848e">// 线程退出
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>            <span style="color:#7f848e">// 线程（如调用ExitThread）正常退出时调用
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>            <span style="color:#7f848e">// 常用于释放该线程的局部资源、关闭句柄、写入日志等
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>            <span style="color:#c678dd">break</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">case</span> <span style="color:#e06c75">DLL_PROCESS_DETACH</span>: 	<span style="color:#7f848e">// 卸载 DLL
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>            <span style="color:#7f848e">// DLL 从进程地址空间卸载时（如FreeLibrary）调用
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>            <span style="color:#7f848e">//  常用于清理全局资源，如关闭文件、释放内存、断开连接
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>            <span style="color:#c678dd">break</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">return</span> <span style="color:#e06c75">TRUE</span>; <span style="color:#7f848e">// 必须返回TRUE表示成功
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>}
</span></span></code></pre></div><p><strong><code>DllMain</code>的强大之处在于，它为我们提供了一个在目标进程上下文中执行任意代码的机会</strong></p>
<p>这可以用来修bug、增加新功能，当然也能被恶意代码利用</p>
<div class="alert alert-note">
    <div class="alert-header">
        <span class="alert-icon">
            📝
        </span>
        <span class="alert-title">
            Note
        </span>
    </div>
    <div class="alert-content">
        <p>如果DLL中找不到<code>DllMain</code>，Windows会从其它运行库中找一个不做任何操作的缺省<code>DllMain</code>函数来启动这个DLL</p></div>
</div>
<h2 id="dll注入">DLL注入
</h2><p>顾名思义，DLL注入就是向一个正在运行的其他进程中，强制插入一个我们指定的DLL文件</p>
<p><strong>其核心原理是以某种方式让目标进程去调用<code>LoadLibrary()</code>API，以此来加载我们的DLL</strong></p>
<p>一旦<code>LoadLibrary()</code>被调用，目标进程就会自动执行该DLL的<code>DllMain</code>函数，而<code>DllMain</code>的<code>DLL_PROCESS_ATTACH</code>分支中就包含了我们想要执行的payload</p>
<p>
<div class="post-img-view">
<a data-fancybox="gallery" data-caption="image-20251029225118284" href="http://picture.928330.xyz/typora/image-20251029225118284.png">
<img src="http://picture.928330.xyz/typora/image-20251029225118284.png" alt="image-20251029225118284"  />
</a>
</div>
</p>
<h1 id="windows系统编程">Windows系统编程
</h1><p>要实现注入，我们要先知道如何书写dll，如何使用Windows API来操纵进程</p>
<h2 id="常用数据类型">常用数据类型
</h2><p>Windows API有自己的一套数据类型定义，这些类型在<code>windows.h</code>头文件中定义：</p>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th><strong>数据类型</strong></th>
          <th><strong>含义</strong></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>VOID</code></td>
          <td>作为函数返回类型时，表示函数运行不可能失败</td>
      </tr>
      <tr>
          <td><code>BOOL</code></td>
          <td><strong><code>int</code>类型，作为函数返回类型时，<code>&gt;0</code>代表TRUE，<code>=0</code>代表FALSE</strong><br />应测试返回值是否为0，不要测试是否为TRUE</td>
      </tr>
      <tr>
          <td><code>HANDLE</code></td>
          <td><strong>内核对象的类型，用于标识进程、线程、文件句柄等</strong><br />失败时通常返回<code>NULL</code>或<code>INVALID_HANDLE_VALUE</code>(-1)</td>
      </tr>
      <tr>
          <td><code>PVOID</code>/<code>PCVOID</code></td>
          <td><strong>无类型的指针（<code>void*</code>）</strong><br />指向一块能存放任意类型值的内存空间</td>
      </tr>
      <tr>
          <td><code>LONG</code>/<code>DWORD</code></td>
          <td><strong>表示有符号/无符号的32位长整型</strong><br />作为函数返回类型时返回数量值，如果无法正确计数则返回0或-1</td>
      </tr>
      <tr>
          <td><code>PDWORD</code>/<code>LPDWORD</code></td>
          <td><strong>指向<code>DWORD</code>数据的指针类型</strong></td>
      </tr>
      <tr>
          <td><code>HMODULE</code>/<code>HINSTANCE</code></td>
          <td><strong>应用程序加载的模块的线性地址，本质上是<code>HANDLE</code></strong></td>
      </tr>
      <tr>
          <td><code>HHOOK</code></td>
          <td><strong>所安装的钩子的<code>HANDLE</code></strong></td>
      </tr>
      <tr>
          <td><code>HWND</code></td>
          <td><strong>窗口的<code>HANDLE</code></strong></td>
      </tr>
      <tr>
          <td><code>HKEY</code></td>
          <td><strong>注册表键的<code>HANDLE</code></strong></td>
      </tr>
      <tr>
          <td><code>LRESULT</code></td>
          <td><strong>由窗口过程或回调函数所返回的32位值类型</strong></td>
      </tr>
      <tr>
          <td><code>WPARAM</code>/<code>LPARAM</code></td>
          <td><strong>消息参数</strong><br /><code>LPARAM</code>即<code>LONG_PTR</code>，<code>WPARAM</code>即<code>UINT_PTR</code></td>
      </tr>
      <tr>
          <td><code>WINAPI</code></td>
          <td><strong>Windows API的函数调用惯例，相当于<code>_stdcall</code></strong></td>
      </tr>
      <tr>
          <td><code>PSECURITY_ATTRIBUTES</code></td>
          <td><strong>指向<code>SECURITY_ATTRIBUTES</code>结构的指针类型</strong></td>
      </tr>
      <tr>
          <td><code>PTHREAD_START_ROUTINE</code></td>
          <td><strong>函数指针</strong><br />指向一个线程函数，该函数返回<code>DWORD</code>并接受一个<code>LPVOID</code>参数</td>
      </tr>
      <tr>
          <td><code>HOOKPROC</code></td>
          <td><strong>钩子过程的地址（回调函数）</strong></td>
      </tr>
  </tbody>
</table></div>
<h2 id="unicode与ansi">Unicode与ANSI
</h2><p>这是在Windows编程中字符的概念：</p>
<ul>
<li>
<p><strong>ANSI</strong></p>
<p>不是严格的标准编码名，而是指基于系统区域设置的单字节或可变字节编码，也称多字节字符集</p>
<p>在这种编码下，<code>char</code>（1 字节）表示字符（或者字符的一个字节），某些字符需要用多个<code>char</code>才能表示</p>
</li>
<li>
<p><strong>Unicode</strong></p>
<p>Windows内核使用的数据类型，使用<code>wchar_t</code>（双字节）存储字符</p>
<p>关于Unicode详细内容移步：<a class="link" href="https://blog.928330.xyz/p/%E4%B8%80%E6%96%87%E5%BC%84%E6%87%82%E5%AD%97%E7%AC%A6%E9%9B%86%E4%B8%8E%E7%BC%96%E7%A0%81/"  target="_blank" rel="noopener"
    >字符集与编码
    
    <span style="white-space: nowrap;"><svg width=".7em"
        height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg">
        <path d="m13 3l3.293 3.293l-7 7l1.414 1.414l7-7L21 11V3z" fill="currentColor" />
        <path d="M19 19H5V5h7l-2-2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2v-5l-2-2v7z"
            fill="currentColor">
    </svg></span>
    
</a></p>
</li>
</ul>
<p>C运行库（<code>string.h</code>）和Windows API都为这两种类型提供了不同的函数：</p>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th><strong>标准ANSI C函数</strong></th>
          <th><strong>等价Unicode函数 (string.h)</strong></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>char *strcat(...)</code></td>
          <td><code>wchar_t *wcscat(...)</code></td>
      </tr>
      <tr>
          <td><code>char *strchr(...)</code></td>
          <td><code>wchar_t *wcschr(...)</code></td>
      </tr>
      <tr>
          <td><code>int strcmp(...)</code></td>
          <td><code>int wcscmp(...)</code></td>
      </tr>
      <tr>
          <td><code>char *strcpy(...)</code></td>
          <td><code>wchar_t *wcscpy(...)</code></td>
      </tr>
      <tr>
          <td><code>size_t strlen(...)</code></td>
          <td><code>size_t wcslen(...)</code></td>
      </tr>
  </tbody>
</table></div>
<p>Windows也定义了自己专用的Unicode数据类型：</p>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th><strong>数据类型</strong></th>
          <th><strong>说明</strong></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>WCHAR</code></td>
          <td>Unicode字符 (<code>wchar_t</code>)</td>
      </tr>
      <tr>
          <td><code>LPWSTR</code></td>
          <td>指向Unicode字符串的指针</td>
      </tr>
      <tr>
          <td><code>LPCWSTR</code></td>
          <td>指向一个<em>常量</em>Unicode字符串的指针</td>
      </tr>
  </tbody>
</table></div>
<p>为了编写兼容性代码，Windows推荐使用<code>tchar.h</code>头文件中的<strong>通用数据类型</strong>：</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#7f848e">#ifdef _UNICODE
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>  <span style="color:#c678dd">typedef</span> <span style="color:#e5c07b">wchar_t</span> <span style="color:#e06c75">TCHAR</span>;
</span></span><span style="display:flex;"><span><span style="color:#7f848e">#else
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>  <span style="color:#c678dd">typedef</span> <span style="color:#e5c07b">char</span> <span style="color:#e06c75">TCHAR</span>;
</span></span><span style="display:flex;"><span><span style="color:#7f848e">#endif
</span></span></span></code></pre></div><p>这样，你的代码就可以通过是否定义<code>_UNICODE</code>宏来编译为ANSI或Unicode版本</p>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th><strong>通用类型</strong></th>
          <th><strong>说明</strong></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>TCHAR</code></td>
          <td>字符（<code>CHAR</code>或<code>WCHAR</code>）</td>
      </tr>
      <tr>
          <td><code>LPTSTR</code></td>
          <td>字符串指针（<code>LPSTR</code>或<code>LPWSTR</code>）</td>
      </tr>
      <tr>
          <td><code>LPCTSTR</code></td>
          <td>常量字符串指针（<code>LPCSTR</code>或<code>LPCWSTR</code>）</td>
      </tr>
  </tbody>
</table></div>
<p>定义字符串常量时，应使用<code>_T()</code>/<code>_TEXT()</code>：</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#7f848e">// 1: 强制 ANSI（char*）
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#e06c75">TCHAR</span> <span style="color:#56b6c2">*</span><span style="color:#e06c75">sz1</span> <span style="color:#56b6c2">=</span> <span style="color:#98c379">&#34;Error&#34;</span>;  
</span></span><span style="display:flex;"><span><span style="color:#7f848e">// 如果 UNICODE 被定义，TCHAR 变成 wchar_t，但这里把 narrow string 赋给 wchar_t* —— 不安全/错误！
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e">// 2: 强制 Unicode（wchar_t*）
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#e06c75">TCHAR</span> <span style="color:#56b6c2">*</span><span style="color:#e06c75">sz2</span> <span style="color:#56b6c2">=</span> <span style="color:#98c379">L</span><span style="color:#98c379">&#34;Error&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#7f848e">// 如果 UNICODE 未定义，TCHAR==char，此处把 wchar_t* 赋给 char* —— 不安全/错误！
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e">// 3: 根据 UNICODE 宏自动适配（推荐用于兼容旧代码）
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#e06c75">TCHAR</span> <span style="color:#56b6c2">*</span><span style="color:#e06c75">sz3</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">_T</span>(<span style="color:#98c379">&#34;Error&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#7f848e">// 如果 UNICODE 未定义 -&gt; TCHAR==char, _T(&#34;Error&#34;) -&gt; &#34;Error&#34;  （OK）
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e">// 如果 UNICODE 定义 -&gt; TCHAR==wchar_t, _T(&#34;Error&#34;) -&gt; L&#34;Error&#34; （OK）
</span></span></span></code></pre></div><p><strong><code>_UNICODE</code>宏用于C运行时头文件（<code>tchar.h</code>），而<code>UNICODE</code>宏用于Windows头文件（<code>windows.h</code>），在项目中最好同时定义这两个宏以确保一致性</strong></p>
<p>在DLL中，函数通常会提供两个版本，例如<code>CreateWindowEx</code>：</p>
<ul>
<li><code>CreateWindowExA</code>：接受ANSI字符串 (A = ANSI)</li>
<li><code>CreateWindowExW</code>：接受Unicode字符串 (W = Wide)</li>
</ul>
<p>通常，<code>-A</code>版本的函数内部也是通过字符串转换后调用<code>-W</code>版本来实现的</p>
<h2 id="windows-字符串函数">Windows 字符串函数
</h2><p>Windows在<code>windows.h</code>中也提供了一套自己的字符串处理函数（注意函数名前缀是<code>l</code>）：</p>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th><strong>函数</strong></th>
          <th><strong>含义</strong></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>lstrcat</code></td>
          <td>将一个字符串拼接到另一个字符串的结尾</td>
      </tr>
      <tr>
          <td><code>lstrcmp</code></td>
          <td>对两个字符串进行<strong>区分大小写</strong>的比较</td>
      </tr>
      <tr>
          <td><code>lstrcmpi</code></td>
          <td>对两个字符串进行<strong>不区分大小写</strong>的比较</td>
      </tr>
      <tr>
          <td><code>lstrcpy</code></td>
          <td>将一个字符串拷贝到另一个位置</td>
      </tr>
      <tr>
          <td><code>lstrlen</code></td>
          <td>返回字符串的长度（按字符数计量）</td>
      </tr>
      <tr>
          <td><code>wsprintf</code></td>
          <td>将一系列字符和数值格式化输出到缓冲区（最大1024字节）</td>
      </tr>
  </tbody>
</table></div>
<p>有时API只接受特定类型的字符串，我们就需要手动转换：</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#e5c07b">char</span> <span style="color:#e06c75">szA</span>[<span style="color:#d19a66">100</span>];
</span></span><span style="display:flex;"><span><span style="color:#e06c75">WCHAR</span> <span style="color:#e06c75">szW</span>[<span style="color:#d19a66">100</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e">// 将Unicode字符串 L&#34;Unicode Str&#34; 转化为 ANSI字符串
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#61afef;font-weight:bold">sprintf_s</span>(<span style="color:#e06c75">szA</span>, <span style="color:#98c379">&#34;%S&#34;</span>, <span style="color:#98c379">L</span><span style="color:#98c379">&#34;Unicode Str&#34;</span>); 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e">// 将ANSI字符串 &#34;ANSI Str&#34; 转化为 Unicode字符串
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#61afef;font-weight:bold">swprintf_s</span>(<span style="color:#e06c75">szW</span>, <span style="color:#98c379">L</span><span style="color:#98c379">&#34;%S&#34;</span>, <span style="color:#98c379">&#34;ANSI Str&#34;</span>);
</span></span></code></pre></div><h2 id="关键api列表">关键API列表
</h2><h3 id="进程与线程api">进程与线程API
</h3><h4 id="openprocess">OpenProcess
</h4><p><strong>打开一个已存在的进程对象，返回一个句柄(HANDLE)：</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#e06c75">HANDLE</span> <span style="color:#e06c75">WINAPI</span> <span style="color:#61afef;font-weight:bold">OpenProcess</span>(
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">_In_</span> <span style="color:#e06c75">DWORD</span> <span style="color:#e06c75">dwDesiredAccess</span>, <span style="color:#7f848e">// 访问权限
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>  <span style="color:#e06c75">_In_</span> <span style="color:#e06c75">BOOL</span>  <span style="color:#e06c75">bInheritHandle</span>,  <span style="color:#7f848e">// 句柄是否可被继承
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>  <span style="color:#e06c75">_In_</span> <span style="color:#e06c75">DWORD</span> <span style="color:#e06c75">dwProcessId</span>      <span style="color:#7f848e">// 目标进程ID
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>);
</span></span></code></pre></div><div class="alert alert-tip">
    <div class="alert-header">
        <span class="alert-icon">
            💡
        </span>
        <span class="alert-title">
            Tip
        </span>
    </div>
    <div class="alert-content">
        <p><strong><code>_In_</code>并不是C/C++关键字，而是微软的 SAL（Source Annotation Language）注解</strong></p>
<p>它也叫<strong>代码注释宏</strong>，用于给函数参数、返回值等添加额外的语义信息，帮助静态分析器、IDE和文档生成器更好地理解代码</p>
<p>它不改变运行时行为，通常在预处理时被定义为空或被替换为编译器可识别的属性</p>
<p>常见的SAL注解：</p>
<ul>
<li><code>_In_</code>：输入参数，调用方负责初始化，不能为 NULL（默认）</li>
<li><code>_In_opt_</code>：可选输入参数，可以为 NULL</li>
<li><code>_Out_</code>：输出参数，函数负责写入（调用方提供缓冲区）</li>
<li><code>_Out_opt_</code>：可选输出参数</li>
<li><code>_Inout_</code>：输入/输出参数（调用方提供初始值，函数会读写）</li>
<li><code>_Pre_satisfies_</code>/<code>_Post_satisfies_</code>：复杂约束（较少见）</li>
<li><code>_In_reads_bytes_(n)</code>/<code>_Out_writes_bytes_(n)</code>：表明缓冲区长度（以字节计），用于检测越界</li>
<li><code>_Null_terminated_</code>：字符串以<code>\0</code>结尾</li>
<li><code>_When_(cond, annotation)</code>：条件化注解（复杂场景）</li>
</ul></div>
</div>
<p>eg：打开PID为1234的进程，并请求所有权限</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#e06c75">DWORD</span> <span style="color:#e06c75">targetPID</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">1234</span>;
</span></span><span style="display:flex;"><span><span style="color:#e06c75">HANDLE</span> <span style="color:#e06c75">hProcess</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">OpenProcess</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">PROCESS_ALL_ACCESS</span>, <span style="color:#7f848e">// 请求所有权限
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">FALSE</span>,              <span style="color:#7f848e">// 不继承句柄
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">targetPID</span>           <span style="color:#7f848e">// 目标进程ID
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">if</span> (<span style="color:#e06c75">hProcess</span> <span style="color:#56b6c2">==</span> <span style="color:#e5c07b">NULL</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// 打开失败，处理错误
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#7f848e">// 可以调用GetLastError()获取错误代码
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>}
</span></span></code></pre></div><h4 id="createthread">CreateThread
</h4><p><strong>在调用进程的虚拟地址空间中创建一个线程：</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#e06c75">HANDLE</span> <span style="color:#e06c75">WINAPI</span> <span style="color:#61afef;font-weight:bold">CreateThread</span>(
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">_In_opt_</span>  <span style="color:#e06c75">LPSECURITY_ATTRIBUTES</span>  <span style="color:#e06c75">lpThreadAttributes</span>, <span style="color:#7f848e">// 线程安全属性
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>  <span style="color:#e06c75">_In_</span>      <span style="color:#e06c75">SIZE_T</span>                 <span style="color:#e06c75">dwStackSize</span>,        <span style="color:#56b6c2">//</span> 初始堆栈大小(<span style="color:#d19a66">0</span>为默认)
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">_In_</span>      <span style="color:#e06c75">LPTHREAD_START_ROUTINE</span> <span style="color:#e06c75">lpStartAddress</span>,     <span style="color:#7f848e">// 线程函数地址
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>  <span style="color:#e06c75">_In_opt_</span>  <span style="color:#e06c75">LPVOID</span>                 <span style="color:#e06c75">lpParameter</span>,        <span style="color:#7f848e">// 传递给线程的参数
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>  <span style="color:#e06c75">_In_</span>      <span style="color:#e06c75">DWORD</span>                  <span style="color:#e06c75">dwCreationFlags</span>,    <span style="color:#7f848e">// 线程创建标志(0为立即运行)
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>  <span style="color:#e06c75">_Out_opt_</span> <span style="color:#e06c75">LPDWORD</span>                <span style="color:#e06c75">lpThreadId</span>          <span style="color:#7f848e">// 接收线程ID的指针
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>);
</span></span></code></pre></div><p>eg：在当前进程中创建一个新线程</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#7f848e">// 1. 定义我们的线程函数
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#e06c75">DWORD</span> <span style="color:#e06c75">WINAPI</span> <span style="color:#61afef;font-weight:bold">MyThreadFunction</span>(<span style="color:#e06c75">LPVOID</span> <span style="color:#e06c75">lpParam</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#e5c07b">int</span><span style="color:#56b6c2">*</span> <span style="color:#e06c75">pValue</span> <span style="color:#56b6c2">=</span> (<span style="color:#e5c07b">int</span><span style="color:#56b6c2">*</span>)<span style="color:#e06c75">lpParam</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#61afef;font-weight:bold">printf</span>(<span style="color:#98c379">&#34;线程开始，接收到的参数值: %d</span><span style="color:#98c379">\n</span><span style="color:#98c379">&#34;</span>, <span style="color:#56b6c2">*</span><span style="color:#e06c75">pValue</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// ... 执行线程任务 ...
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#c678dd">return</span> <span style="color:#d19a66">0</span>; <span style="color:#7f848e">// 线程退出
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e">// 2. 在主函数中创建线程
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#e5c07b">int</span> <span style="color:#e06c75">myValue</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">100</span>;
</span></span><span style="display:flex;"><span><span style="color:#e06c75">DWORD</span> <span style="color:#e06c75">threadId</span>;
</span></span><span style="display:flex;"><span><span style="color:#e06c75">HANDLE</span> <span style="color:#e06c75">hThread</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">CreateThread</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#e5c07b">NULL</span>,           <span style="color:#7f848e">// 默认安全属性
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#d19a66">0</span>,              <span style="color:#7f848e">// 默认堆栈大小
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">MyThreadFunction</span>, <span style="color:#7f848e">// 线程函数地址
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#56b6c2">&amp;</span><span style="color:#e06c75">myValue</span>,       <span style="color:#7f848e">// 传递给线程的参数
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#d19a66">0</span>,              <span style="color:#7f848e">// 立即运行
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#56b6c2">&amp;</span><span style="color:#e06c75">threadId</span>       <span style="color:#7f848e">// 接收线程ID
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">if</span> (<span style="color:#e06c75">hThread</span> <span style="color:#56b6c2">==</span> <span style="color:#e5c07b">NULL</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// 创建失败
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>}
</span></span></code></pre></div><h4 id="createremotethread">CreateRemoteThread
</h4><p><strong>在另一个进程(hProcess)的虚拟地址空间中创建一个线程：</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#e06c75">HANDLE</span> <span style="color:#e06c75">WINAPI</span> <span style="color:#61afef;font-weight:bold">CreateRemoteThread</span>(
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">_In_</span>  <span style="color:#e06c75">HANDLE</span>                 <span style="color:#e06c75">hProcess</span>,             <span style="color:#7f848e">// 目标进程句柄
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>  <span style="color:#e06c75">_In_</span>  <span style="color:#e06c75">LPSECURITY_ATTRIBUTES</span>  <span style="color:#e06c75">lpThreadAttributes</span>, <span style="color:#7f848e">// 线程安全属性
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>  <span style="color:#e06c75">_In_</span>  <span style="color:#e06c75">SIZE_T</span>                 <span style="color:#e06c75">dwStackSize</span>,        <span style="color:#56b6c2">//</span> 初始堆栈大小(<span style="color:#d19a66">0</span>为默认)
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">_In_</span>  <span style="color:#e06c75">LPTHREAD_START_ROUTINE</span> <span style="color:#e06c75">lpStartAddress</span>,     <span style="color:#7f848e">// 远程线程函数地址
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>  <span style="color:#e06c75">_In_</span>  <span style="color:#e06c75">LPVOID</span>                 <span style="color:#e06c75">lpParameter</span>,        <span style="color:#7f848e">// 传递给远程线程的参数
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>  <span style="color:#e06c75">_In_</span>  <span style="color:#e06c75">DWORD</span>                  <span style="color:#e06c75">dwCreationFlags</span>,    <span style="color:#7f848e">// 线程创建标志(0为立即运行)
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>  <span style="color:#e06c75">_Out_</span> <span style="color:#e06c75">LPDWORD</span>                <span style="color:#e06c75">lpThreadId</span>          <span style="color:#7f848e">// 接收线程ID的指针
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>);
</span></span></code></pre></div><p>eg：在目标进程(hTargetProcess)中创建一个远程线程</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#7f848e">// (这是一个概念性示例，假设hTargetProcess已通过OpenProcess获取)
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e">// (并且pRemoteFunction和pRemoteParam已通过VirtualAllocEx和WriteProcessMemory写入)
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e">// HANDLE hTargetProcess = ... 
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e">// LPVOID pRemoteFunction = ... (例如LoadLibraryA的地址)
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e">// LPVOID pRemoteParam = ... (例如DLL路径字符串在目标进程中的地址)
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>
</span></span><span style="display:flex;"><span><span style="color:#e06c75">HANDLE</span> <span style="color:#e06c75">hRemoteThread</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">CreateRemoteThread</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">hTargetProcess</span>,  <span style="color:#7f848e">// 目标进程句柄
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e5c07b">NULL</span>,            <span style="color:#7f848e">// 默认安全属性
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#d19a66">0</span>,               <span style="color:#7f848e">// 默认堆栈大小
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    (<span style="color:#e06c75">LPTHREAD_START_ROUTINE</span>)<span style="color:#e06c75">pRemoteFunction</span>, <span style="color:#7f848e">// 远程函数地址
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">pRemoteParam</span>,    <span style="color:#7f848e">// 远程参数地址
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#d19a66">0</span>,               <span style="color:#7f848e">// 立即运行
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e5c07b">NULL</span>             <span style="color:#7f848e">// 不关心线程ID
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">if</span> (<span style="color:#e06c75">hRemoteThread</span> <span style="color:#56b6c2">==</span> <span style="color:#e5c07b">NULL</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// 远程线程创建失败
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>}
</span></span></code></pre></div><h3 id="内存操作api">内存操作API
</h3><h4 id="virtualallocex">VirtualAllocEx
</h4><p><strong>在指定进程(hProcess)的虚拟地址空间中分配内存：</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#e06c75">LPVOID</span> <span style="color:#e06c75">WINAPI</span> <span style="color:#61afef;font-weight:bold">VirtualAllocEx</span>(
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">_In_</span>     <span style="color:#e06c75">HANDLE</span> <span style="color:#e06c75">hProcess</span>,         <span style="color:#7f848e">// 目标进程句柄
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>  <span style="color:#e06c75">_In_opt_</span> <span style="color:#e06c75">LPVOID</span> <span style="color:#e06c75">lpAddress</span>,        <span style="color:#56b6c2">//</span> 期望的起始地址(<span style="color:#e06c75">NULL为自动选择</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">_In_</span>     <span style="color:#e06c75">SIZE_T</span> <span style="color:#e06c75">dwSize</span>,           <span style="color:#7f848e">// 分配的内存大小(字节)
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>  <span style="color:#e06c75">_In_</span>     <span style="color:#e06c75">DWORD</span>  <span style="color:#e06c75">flAllocationType</span>, <span style="color:#7f848e">// 内存分配类型(如MEM_COMMIT)
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>  <span style="color:#e06c75">_In_</span>     <span style="color:#e06c75">DWORD</span>  <span style="color:#e06c75">flProtect</span>         <span style="color:#7f848e">// 内存保护属性(如PAGE_READWRITE)
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>);
</span></span></code></pre></div><p>eg：在hTargetProcess进程中分配1024字节的可读写内存</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#7f848e">// HANDLE hTargetProcess = ... (通过OpenProcess获取)
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#e06c75">SIZE_T</span> <span style="color:#e06c75">allocSize</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">1024</span>; <span style="color:#7f848e">// 1KB
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>
</span></span><span style="display:flex;"><span><span style="color:#e06c75">LPVOID</span> <span style="color:#e06c75">pRemoteBuffer</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">VirtualAllocEx</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">hTargetProcess</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e5c07b">NULL</span>,           <span style="color:#7f848e">// 系统自动选择地址
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">allocSize</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">MEM_COMMIT</span> <span style="color:#56b6c2">|</span> <span style="color:#e06c75">MEM_RESERVE</span>, <span style="color:#7f848e">// 提交并保留内存
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">PAGE_READWRITE</span>  <span style="color:#7f848e">// 内存保护：可读可写
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">if</span> (<span style="color:#e06c75">pRemoteBuffer</span> <span style="color:#56b6c2">==</span> <span style="color:#e5c07b">NULL</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// 分配失败
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>}
</span></span></code></pre></div><h4 id="writeprocessmemory">WriteProcessMemory
</h4><p><strong>将数据(lpBuffer)写入指定进程(hProcess)的内存区域(lpBaseAddress)：</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#7f848e">// 函数原型 (结构)
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#e06c75">BOOL</span> <span style="color:#e06c75">WINAPI</span> <span style="color:#61afef;font-weight:bold">WriteProcessMemory</span>(
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">_In_</span>  <span style="color:#e06c75">HANDLE</span>  <span style="color:#e06c75">hProcess</span>,               <span style="color:#7f848e">// 目标进程句柄
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>  <span style="color:#e06c75">_In_</span>  <span style="color:#e06c75">LPVOID</span>  <span style="color:#e06c75">lpBaseAddress</span>,          <span style="color:#7f848e">// 写入的目标内存基地址
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>  <span style="color:#e06c75">_In_</span>  <span style="color:#e06c75">LPCVOID</span> <span style="color:#e06c75">lpBuffer</span>,               <span style="color:#7f848e">// 指向本地数据的指针
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>  <span style="color:#e06c75">_In_</span>  <span style="color:#e06c75">SIZE_T</span>  <span style="color:#e06c75">nSize</span>,                  <span style="color:#7f848e">// 要写入的字节数
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>  <span style="color:#e06c75">_Out_</span> <span style="color:#e06c75">SIZE_T</span><span style="color:#56b6c2">*</span> <span style="color:#e06c75">lpNumberOfBytesWritten</span>  <span style="color:#7f848e">// 接收实际写入字节数的指针
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>);
</span></span></code></pre></div><p>eg：将一个本地字符串写入到远程进程已分配的内存中</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#7f848e">// HANDLE hTargetProcess = ...
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e">// LPVOID pRemoteBuffer = ... (通过VirtualAllocEx获取)
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">const</span> <span style="color:#e5c07b">char</span><span style="color:#56b6c2">*</span> <span style="color:#e06c75">myData</span> <span style="color:#56b6c2">=</span> <span style="color:#98c379">&#34;Hello, Remote Process!&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#e06c75">SIZE_T</span> <span style="color:#e06c75">dataSize</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">strlen</span>(<span style="color:#e06c75">myData</span>) <span style="color:#56b6c2">+</span> <span style="color:#d19a66">1</span>; <span style="color:#7f848e">// +1为了null终止符
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#e06c75">SIZE_T</span> <span style="color:#e06c75">bytesWritten</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e06c75">BOOL</span> <span style="color:#e06c75">bResult</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">WriteProcessMemory</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">hTargetProcess</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">pRemoteBuffer</span>,      <span style="color:#7f848e">// 写入的目标地址
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">myData</span>,             <span style="color:#7f848e">// 本地数据源
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">dataSize</span>,           <span style="color:#7f848e">// 写入大小
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#56b6c2">&amp;</span><span style="color:#e06c75">bytesWritten</span>       <span style="color:#7f848e">// 接收实际写入的字节数
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">if</span> (<span style="color:#e06c75">bResult</span> <span style="color:#56b6c2">==</span> <span style="color:#e06c75">FALSE</span> <span style="color:#56b6c2">||</span> <span style="color:#e06c75">bytesWritten</span> <span style="color:#56b6c2">!=</span> <span style="color:#e06c75">dataSize</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// 写入失败
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>}
</span></span></code></pre></div><h3 id="模块操作api">模块操作API
</h3><h4 id="getmodulehandle">GetModuleHandle
</h4><p><strong>获取一个已加载模块的句柄：</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#7f848e">// 函数原型 (结构)
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#e06c75">HMODULE</span> <span style="color:#e06c75">WINAPI</span> <span style="color:#61afef;font-weight:bold">GetModuleHandle</span>(
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">_In_opt_</span> <span style="color:#e06c75">LPCTSTR</span> <span style="color:#e06c75">lpModuleName</span>  <span style="color:#56b6c2">//</span> 模块名称(<span style="color:#e06c75">DLL或EXE</span>)，<span style="color:#e06c75">NULL为获取主EXE句柄</span>
</span></span><span style="display:flex;"><span>);
</span></span></code></pre></div><p>eg：获取当前进程EXE的句柄和kernel32.dll的句柄</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#7f848e">// 1. 获取当前进程(EXE)的模块句柄
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#e06c75">HMODULE</span> <span style="color:#e06c75">hExe</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">GetModuleHandle</span>(<span style="color:#e5c07b">NULL</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e">// 2. 获取kernel32.dll的模块句柄(它一定已被加载)
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#e06c75">HMODULE</span> <span style="color:#e06c75">hKernel32</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">GetModuleHandle</span>(<span style="color:#61afef;font-weight:bold">_T</span>(<span style="color:#98c379">&#34;kernel32.dll&#34;</span>));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">if</span> (<span style="color:#e06c75">hKernel32</span> <span style="color:#56b6c2">==</span> <span style="color:#e5c07b">NULL</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// 获取失败(极不可能发生)
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>}
</span></span></code></pre></div><h4 id="getmodulefilename">GetModuleFileName
</h4><p><strong>获取包含指定模块(hModule)的文件的完整路径：</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#7f848e">// 函数原型 (结构)
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#e06c75">DWORD</span> <span style="color:#e06c75">WINAPI</span> <span style="color:#61afef;font-weight:bold">GetModuleFileName</span>(
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">_In_opt_</span> <span style="color:#e06c75">HMODULE</span> <span style="color:#e06c75">hModule</span>,    <span style="color:#56b6c2">//</span> 模块句柄(<span style="color:#e06c75">NULL为获取当前EXE路径</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">_Out_</span>    <span style="color:#e06c75">LPTSTR</span>  <span style="color:#e06c75">lpFilename</span>, <span style="color:#7f848e">// 接收路径的缓冲区
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>  <span style="color:#e06c75">_In_</span>     <span style="color:#e06c75">DWORD</span>   <span style="color:#e06c75">nSize</span>     <span style="color:#7f848e">// 缓冲区大小(TCHARs)
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>);
</span></span></code></pre></div><p>eg：获取当前可执行文件的完整路径</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#e06c75">TCHAR</span> <span style="color:#e06c75">exePath</span>[<span style="color:#e06c75">MAX_PATH</span>]; <span style="color:#7f848e">// MAX_PATH是一个预定义常量
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#e06c75">DWORD</span> <span style="color:#e06c75">pathLen</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">GetModuleFileName</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#e5c07b">NULL</span>,    <span style="color:#7f848e">// 传递NULL来获取当前EXE的路径
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">exePath</span>, <span style="color:#7f848e">// 接收路径的缓冲区
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">MAX_PATH</span> <span style="color:#7f848e">// 缓冲区大小
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">if</span> (<span style="color:#e06c75">pathLen</span> <span style="color:#56b6c2">==</span> <span style="color:#d19a66">0</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// 获取失败
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>} <span style="color:#c678dd">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// exePath现在包含&#34;C:\Path\To\YourApp.exe&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>}
</span></span></code></pre></div><h4 id="getprocaddress">GetProcAddress
</h4><p><strong>从指定的DLL模块(hModule)中检索导出函数(lpProcName)的地址：</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#7f848e">// 函数原型 (结构)
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#e06c75">FARPROC</span> <span style="color:#e06c75">WINAPI</span> <span style="color:#61afef;font-weight:bold">GetProcAddress</span>(
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">_In_</span> <span style="color:#e06c75">HMODULE</span> <span style="color:#e06c75">hModule</span>,     <span style="color:#7f848e">// 模块句柄
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>  <span style="color:#e06c75">_In_</span> <span style="color:#e06c75">LPCSTR</span>  <span style="color:#e06c75">lpProcName</span>  <span style="color:#56b6c2">//</span> 导出函数名称(<span style="color:#e06c75">ANSI字符串</span>)
</span></span><span style="display:flex;"><span>);
</span></span></code></pre></div><p>eg：获取kernel32.dll中的CreateFileA函数的地址</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#7f848e">// 1. 定义一个函数指针类型，使其与CreateFileA匹配
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#c678dd">typedef</span> <span style="color:#61afef;font-weight:bold">HANDLE</span> (<span style="color:#e06c75">WINAPI</span> <span style="color:#56b6c2">*</span><span style="color:#e06c75">PFN_CREATEFILEA</span>)(
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">LPCSTR</span>, <span style="color:#e06c75">DWORD</span>, <span style="color:#e06c75">DWORD</span>, <span style="color:#e06c75">LPSECURITY_ATTRIBUTES</span>, <span style="color:#e06c75">DWORD</span>, <span style="color:#e06c75">DWORD</span>, <span style="color:#e06c75">HANDLE</span>
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e">// 2. 获取模块句柄
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#e06c75">HMODULE</span> <span style="color:#e06c75">hKernel32</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">GetModuleHandle</span>(<span style="color:#61afef;font-weight:bold">_T</span>(<span style="color:#98c379">&#34;kernel32.dll&#34;</span>));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e">// 3. 获取函数地址
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#e06c75">FARPROC</span> <span style="color:#e06c75">pFunc</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">GetProcAddress</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">hKernel32</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#98c379">&#34;CreateFileA&#34;</span> <span style="color:#7f848e">// 注意：必须是ANSI字符串
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">if</span> (<span style="color:#e06c75">pFunc</span> <span style="color:#56b6c2">==</span> <span style="color:#e5c07b">NULL</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// 获取地址失败
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>} <span style="color:#c678dd">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// 4. 将通用的FARPROC转换为我们定义的类型
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">PFN_CREATEFILEA</span> <span style="color:#e06c75">MyCreateFile</span> <span style="color:#56b6c2">=</span> (<span style="color:#e06c75">PFN_CREATEFILEA</span>)<span style="color:#e06c75">pFunc</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// 5. 现在可以像普通函数一样调用它
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#7f848e">// MyCreateFile(&#34;test.txt&#34;, ...);
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>}
</span></span></code></pre></div><h4 id="waitforsingleobject">WaitForSingleObject
</h4><p><strong>阻塞当前线程，直到指定句柄(hHandle)的对象被&quot;signaled&quot;或超时：</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#7f848e">// 函数原型 (结构)
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#e06c75">DWORD</span> <span style="color:#e06c75">WINAPI</span> <span style="color:#61afef;font-weight:bold">WaitForSingleObject</span>(
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">_In_</span> <span style="color:#e06c75">HANDLE</span> <span style="color:#e06c75">hHandle</span>,        <span style="color:#56b6c2">//</span> 要等待的对象句柄(如线程、进程)
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">_In_</span> <span style="color:#e06c75">DWORD</span>  <span style="color:#e06c75">dwMilliseconds</span>  <span style="color:#7f848e">// 超时时间(毫秒)，INFINITE为无限等待
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>);
</span></span></code></pre></div><p>eg：等待之前创建的hThread线程执行完毕</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#7f848e">// HANDLE hThread = ... (通过CreateThread获取)
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>
</span></span><span style="display:flex;"><span><span style="color:#e06c75">DWORD</span> <span style="color:#e06c75">waitResult</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">WaitForSingleObject</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">hThread</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">INFINITE</span> <span style="color:#7f848e">// 无限期等待，直到线程结束
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">if</span> (<span style="color:#e06c75">waitResult</span> <span style="color:#56b6c2">==</span> <span style="color:#e06c75">WAIT_OBJECT_0</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// 线程已成功结束
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#61afef;font-weight:bold">printf</span>(<span style="color:#98c379">&#34;线程已退出。</span><span style="color:#98c379">\n</span><span style="color:#98c379">&#34;</span>);
</span></span><span style="display:flex;"><span>} <span style="color:#c678dd">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// 等待失败或超时
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>}
</span></span></code></pre></div><h4 id="closehandle">CloseHandle
</h4><p><strong>关闭一个打开的对象句柄(如进程、线程句柄)：</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#7f848e">// 函数原型 (结构)
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#e06c75">BOOL</span> <span style="color:#e06c75">WINAPI</span> <span style="color:#61afef;font-weight:bold">CloseHandle</span>(
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">_In_</span> <span style="color:#e06c75">HANDLE</span> <span style="color:#e06c75">hObject</span>  <span style="color:#7f848e">// 要关闭的有效对象句柄
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>);
</span></span></code></pre></div><p>eg：关闭之前打开或创建的句柄</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#7f848e">// HANDLE hProcess = OpenProcess(...);
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e">// HANDLE hThread = CreateThread(...);
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e">// 使用完毕后...
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#c678dd">if</span> (<span style="color:#e06c75">hThread</span> <span style="color:#56b6c2">!=</span> <span style="color:#e5c07b">NULL</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#61afef;font-weight:bold">CloseHandle</span>(<span style="color:#e06c75">hThread</span>); <span style="color:#7f848e">// 关闭线程句柄
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>}
</span></span><span style="display:flex;"><span><span style="color:#c678dd">if</span> (<span style="color:#e06c75">hProcess</span> <span style="color:#56b6c2">!=</span> <span style="color:#e5c07b">NULL</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#61afef;font-weight:bold">CloseHandle</span>(<span style="color:#e06c75">hProcess</span>); <span style="color:#7f848e">// 关闭进程句柄
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>}
</span></span></code></pre></div><h3 id="消息钩取api">消息钩取API
</h3><h4 id="setwindowshookex">SetWindowsHookEx
</h4><p><strong>将一个用户定义的钩子过程(lpfn)安装到一个钩子链中：</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#e06c75">HHOOK</span> <span style="color:#e06c75">WINAPI</span> <span style="color:#61afef;font-weight:bold">SetWindowsHookEx</span>(
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">_In_</span> <span style="color:#e5c07b">int</span>       <span style="color:#e06c75">idHook</span>,     <span style="color:#56b6c2">//</span> 钩子类型(如<span style="color:#e06c75">WH_KEYBOARD_LL</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">_In_</span> <span style="color:#e06c75">HOOKPROC</span>  <span style="color:#e06c75">lpfn</span>,       <span style="color:#7f848e">// 钩子过程(回调函数)的地址
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>  <span style="color:#e06c75">_In_</span> <span style="color:#e06c75">HINSTANCE</span> <span style="color:#e06c75">hMod</span>,       <span style="color:#7f848e">// 包含钩子过程的DLL句柄
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>  <span style="color:#e06c75">_In_</span> <span style="color:#e06c75">DWORD</span>     <span style="color:#e06c75">dwThreadId</span>  <span style="color:#7f848e">// 要钩取的线程ID(0为所有线程)
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>);
</span></span></code></pre></div><p>eg：安装一个低级键盘钩子(WH_KEYBOARD_LL)</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#7f848e">// 1. 定义一个钩子过程
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#e06c75">LRESULT</span> <span style="color:#e06c75">CALLBACK</span> <span style="color:#61afef;font-weight:bold">LowLevelKeyboardProc</span>(<span style="color:#e5c07b">int</span> <span style="color:#e06c75">nCode</span>, <span style="color:#e06c75">WPARAM</span> <span style="color:#e06c75">wParam</span>, <span style="color:#e06c75">LPARAM</span> <span style="color:#e06c75">lParam</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> (<span style="color:#e06c75">nCode</span> <span style="color:#56b6c2">==</span> <span style="color:#e06c75">HC_ACTION</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#7f848e">// ... 处理键盘事件 ...
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// 必须调用下一个钩子
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#c678dd">return</span> <span style="color:#61afef;font-weight:bold">CallNextHookEx</span>(<span style="color:#e5c07b">NULL</span>, <span style="color:#e06c75">nCode</span>, <span style="color:#e06c75">wParam</span>, <span style="color:#e06c75">lParam</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e">// 2. 在主函数中安装钩子
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#e06c75">HHOOK</span> <span style="color:#e06c75">g_hHook</span> <span style="color:#56b6c2">=</span> <span style="color:#e5c07b">NULL</span>;
</span></span><span style="display:flex;"><span><span style="color:#e06c75">g_hHook</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">SetWindowsHookEx</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">WH_KEYBOARD_LL</span>,     <span style="color:#7f848e">// 钩子类型：低级键盘
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">LowLevelKeyboardProc</span>, <span style="color:#7f848e">// 钩子过程回调函数
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#61afef;font-weight:bold">GetModuleHandle</span>(<span style="color:#e5c07b">NULL</span>), <span style="color:#7f848e">// 包含回调函数的模块句柄
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#d19a66">0</span>                      <span style="color:#7f848e">// 关联到所有线程
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">if</span> (<span style="color:#e06c75">g_hHook</span> <span style="color:#56b6c2">==</span> <span style="color:#e5c07b">NULL</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// 安装钩子失败
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>}
</span></span></code></pre></div><h4 id="callnexthookex">CallNextHookEx
</h4><p><strong>将钩子信息传递给钩子链中的下一个钩子过程：</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#7f848e">// 函数原型 (结构)
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#e06c75">LRESULT</span> <span style="color:#e06c75">WINAPI</span> <span style="color:#61afef;font-weight:bold">CallNextHookEx</span>(
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">_In_opt_</span> <span style="color:#e06c75">HHOOK</span>  <span style="color:#e06c75">hhk</span>,    <span style="color:#56b6c2">//</span> 当前钩子的句柄(可忽略，传<span style="color:#e5c07b">NULL</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">_In_</span>     <span style="color:#e5c07b">int</span>    <span style="color:#e06c75">nCode</span>,  <span style="color:#7f848e">// 钩子代码(从回调函数传入)
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>  <span style="color:#e06c75">_In_</span>     <span style="color:#e06c75">WPARAM</span> <span style="color:#e06c75">wParam</span>, <span style="color:#7f848e">// 消息参数(从回调函数传入)
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>  <span style="color:#e06c75">_In_</span>     <span style="color:#e06c75">LPARAM</span> <span style="color:#e06c75">lParam</span>  <span style="color:#7f848e">// 消息参数(从回调函数传入)
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>);
</span></span></code></pre></div><p>eg：在钩子过程中调用</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#7f848e">// (HHOOK g_hHook; 在SetWindowsHookEx中获取)
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#e06c75">LRESULT</span> <span style="color:#e06c75">CALLBACK</span> <span style="color:#61afef;font-weight:bold">MyHookProc</span>(<span style="color:#e5c07b">int</span> <span style="color:#e06c75">nCode</span>, <span style="color:#e06c75">WPARAM</span> <span style="color:#e06c75">wParam</span>, <span style="color:#e06c75">LPARAM</span> <span style="color:#e06c75">lParam</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// ... 在这里可以监视或修改 wParam/lParam ...
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// 在钩子过程中调用此函数至关重要
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#7f848e">// 否则会“吞掉”消息，导致系统或其他程序功能异常
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#c678dd">return</span> <span style="color:#61afef;font-weight:bold">CallNextHookEx</span>(<span style="color:#e06c75">g_hHook</span>, <span style="color:#e06c75">nCode</span>, <span style="color:#e06c75">wParam</span>, <span style="color:#e06c75">lParam</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="unhookwindowshookex">UnhookWindowsHookEx
</h4><p><strong>移除一个由SetWindowsHookEx安装的钩子过程：</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#7f848e">// 函数原型 (结构)
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#e06c75">BOOL</span> <span style="color:#e06c75">WINAPI</span> <span style="color:#61afef;font-weight:bold">UnhookWindowsHookEx</span>(
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">_In_</span> <span style="color:#e06c75">HHOOK</span> <span style="color:#e06c75">hhk</span> <span style="color:#7f848e">// 要移除的钩子句柄
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>);
</span></span></code></pre></div><p>eg：在程序退出前，卸载之前安装的G_HHook</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#7f848e">// HHOOK g_hHook = ... (通过SetWindowsHookEx获取)
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">if</span> (<span style="color:#e06c75">g_hHook</span> <span style="color:#56b6c2">!=</span> <span style="color:#e5c07b">NULL</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">BOOL</span> <span style="color:#e06c75">bResult</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">UnhookWindowsHookEx</span>(<span style="color:#e06c75">g_hHook</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> (<span style="color:#e06c75">bResult</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#7f848e">// 卸载成功
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>        <span style="color:#e06c75">g_hHook</span> <span style="color:#56b6c2">=</span> <span style="color:#e5c07b">NULL</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h1 id="注入用dll的准备">注入用DLL的准备
</h1><p>既然要学，那肯定要实操，我们就需要一些DLL来验证我们的注入器是否工作</p>
<h2 id="三个示例">三个示例
</h2><p>以下三个示例DLL的目的都只是为了**“举手示意”**，告诉我们它已经成功在目标进程中运行，除此之外它们不会执行任何其他操作</p>
<h3 id="弹窗messagebox">弹窗（MessageBox）
</h3><p>当<code>DllMain</code>被调用时，它会立刻弹出一个消息框</p>
<p>由于<code>DllMain</code>是在目标进程的上下文中执行的，这个消息框将隶属于目标进程</p>
<p>此DLL唯一的行为就是调用<code>User32.dll</code>中的<code>MessageBox</code>API，不会对系统造成任何更改</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#7f848e">#include</span> <span style="color:#7f848e">&lt;windows.h&gt;</span><span style="color:#7f848e">
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e">#include</span> <span style="color:#7f848e">&lt;tchar.h&gt; // 为了 TCHAR 和 _T()</span><span style="color:#7f848e">
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>
</span></span><span style="display:flex;"><span><span style="color:#e06c75">BOOL</span> <span style="color:#e06c75">WINAPI</span> <span style="color:#61afef;font-weight:bold">DllMain</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">HINSTANCE</span> <span style="color:#e06c75">hinstDLL</span>,  <span style="color:#7f848e">// DLL实例句柄
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">DWORD</span> <span style="color:#e06c75">fdwReason</span>,     <span style="color:#7f848e">// 调用原因
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">LPVOID</span> <span style="color:#e06c75">lpReserved</span>    <span style="color:#7f848e">// 保留
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// 我们只关心DLL何时被“附加”到进程上
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#c678dd">switch</span> (<span style="color:#e06c75">fdwReason</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">case</span> <span style="color:#e06c75">DLL_PROCESS_ATTACH</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#7f848e">// 当DLL被加载时，在目标进程中弹出一个消息框
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>            <span style="color:#61afef;font-weight:bold">MessageBox</span>(
</span></span><span style="display:flex;"><span>                <span style="color:#e5c07b">NULL</span>,                             <span style="color:#7f848e">// 父窗口句柄 (NULL 亦可)
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                <span style="color:#61afef;font-weight:bold">_T</span>(<span style="color:#98c379">&#34;DLL 注入成功! (来自 TestDll_MsgBox)&#34;</span>), <span style="color:#7f848e">// 消息内容
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                <span style="color:#61afef;font-weight:bold">_T</span>(<span style="color:#98c379">&#34;注入测试&#34;</span>),                     <span style="color:#7f848e">// 标题
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                <span style="color:#e06c75">MB_OK</span> <span style="color:#56b6c2">|</span> <span style="color:#e06c75">MB_ICONINFORMATION</span>        <span style="color:#7f848e">// 按钮 (OK) 和图标 (信息)
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>            );
</span></span><span style="display:flex;"><span>            <span style="color:#c678dd">break</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">case</span> <span style="color:#e06c75">DLL_THREAD_ATTACH</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#7f848e">// 线程创建时不做任何事
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>            <span style="color:#c678dd">break</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">case</span> <span style="color:#e06c75">DLL_THREAD_DETACH</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#7f848e">// 线程退出时不做任何事
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>            <span style="color:#c678dd">break</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">case</span> <span style="color:#e06c75">DLL_PROCESS_DETACH</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#7f848e">// DLL被卸载时不做任何事
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>            <span style="color:#c678dd">break</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">return</span> <span style="color:#e06c75">TRUE</span>; <span style="color:#7f848e">// 始终返回 TRUE
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>}
</span></span></code></pre></div><h3 id="播放系统提示音beep">播放系统提示音（Beep）
</h3><p>有时目标进程可能没有图形界面（例如一个后台服务），或者我们不想用一个弹窗来打断目标进程的运行，在这种情况下，使用声音作为反馈是一个很好的选择</p>
<p>这个DLL在被注入时，会调用<code>MessageBeep</code>函数播放一个系统默认的信息提示音</p>
<p>此DLL唯一的行为是调用<code>User32.dll</code>中的<code>MessageBeep</code>API，它只是通过声卡播放一个短暂的提示音，不会执行任何其他操作</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#7f848e">#include</span> <span style="color:#7f848e">&lt;windows.h&gt;</span><span style="color:#7f848e">
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>
</span></span><span style="display:flex;"><span><span style="color:#e06c75">BOOL</span> <span style="color:#e06c75">WINAPI</span> <span style="color:#61afef;font-weight:bold">DllMain</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">HINSTANCE</span> <span style="color:#e06c75">hinstDLL</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">DWORD</span> <span style="color:#e06c75">fdwReason</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">LPVOID</span> <span style="color:#e06c75">lpReserved</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">switch</span> (<span style="color:#e06c75">fdwReason</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">case</span> <span style="color:#e06c75">DLL_PROCESS_ATTACH</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#7f848e">// 当DLL被加载时，播放一个“信息”提示音
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>            <span style="color:#7f848e">// MB_ICONINFORMATION 对应一个系统声音
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>            <span style="color:#7f848e">// 你也可以用 Beep(1000, 500); 来发声 (1000Hz, 500毫秒)
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>            <span style="color:#61afef;font-weight:bold">MessageBeep</span>(<span style="color:#e06c75">MB_ICONINFORMATION</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#c678dd">break</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">return</span> <span style="color:#e06c75">TRUE</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="输出到控制台allocconsole">输出到控制台（AllocConsole）
</h3><p>如果目标是一个GUI程序（如<code>notepad.exe</code>），它默认是没有控制台窗口的，而这个DLL会为目标进程创建一个新的控制台窗口，然后在该窗口中打印一条消息</p>
<p>这非常适合用来确认DLL不仅被加载了，而且可以在目标进程中分配新资源（一个控制台）并执行I/O操作（<code>printf</code>）</p>
<p>此DLL调用<code>AllocConsole</code>创建一个临时窗口，使用<code>printf</code>向其写入文本，然后调用<code>FreeConsole</code>将其关闭，没有触及目标进程的任何原有功能</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#7f848e">#include</span> <span style="color:#7f848e">&lt;windows.h&gt;</span><span style="color:#7f848e">
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e">#include</span> <span style="color:#7f848e">&lt;stdio.h&gt;    // 为了 printf 和 FILE*</span><span style="color:#7f848e">
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e">#include</span> <span style="color:#7f848e">&lt;io.h&gt;       // 为了 _open_osfhandle</span><span style="color:#7f848e">
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e">#include</span> <span style="color:#7f848e">&lt;fcntl.h&gt;    // 为了 _O_TEXT</span><span style="color:#7f848e">
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e">// 我们的控制台线程
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e">// 注意：在DllMain中执行复杂操作（比如创建控制台）是不被推荐的
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e">// 因为 DllMain 运行在加载器锁 (Loader Lock) 内部，容易造成死锁。
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e">// 最安全的方法是像这样，创建一个新线程来执行实际工作。
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#e06c75">DWORD</span> <span style="color:#e06c75">WINAPI</span> <span style="color:#61afef;font-weight:bold">ConsoleThread</span>(<span style="color:#e06c75">LPVOID</span> <span style="color:#e06c75">lpParam</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// 1. 为当前进程分配一个新的控制台窗口
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#c678dd">if</span> (<span style="color:#61afef;font-weight:bold">AllocConsole</span>())
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">FILE</span><span style="color:#56b6c2">*</span> <span style="color:#e06c75">pFile</span> <span style="color:#56b6c2">=</span> <span style="color:#e5c07b">NULL</span>;
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#7f848e">// 2. 将标准输出 (stdout) 重定向到新的控制台
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>        <span style="color:#7f848e">// freopen_s 是一个安全的方式来重新打开一个文件流
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>        <span style="color:#61afef;font-weight:bold">freopen_s</span>(<span style="color:#56b6c2">&amp;</span><span style="color:#e06c75">pFile</span>, <span style="color:#98c379">&#34;CONOUT$&#34;</span>, <span style="color:#98c379">&#34;w&#34;</span>, <span style="color:#e06c75">stdout</span>); <span style="color:#7f848e">// &#34;CONOUT$&#34; 是控制台输出的设备名
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>
</span></span><span style="display:flex;"><span>        <span style="color:#7f848e">// 3. 设置标题
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>        <span style="color:#61afef;font-weight:bold">SetConsoleTitle</span>(<span style="color:#61afef;font-weight:bold">_T</span>(<span style="color:#98c379">&#34;Injected Console - (TestDll_Console)&#34;</span>));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#7f848e">// 4. 打印我们的消息
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>        <span style="color:#61afef;font-weight:bold">printf</span>(<span style="color:#98c379">&#34;--- DLL 注入成功! ---</span><span style="color:#98c379">\n</span><span style="color:#98c379">&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#61afef;font-weight:bold">printf</span>(<span style="color:#98c379">&#34;这个控制台窗口现在属于目标进程。</span><span style="color:#98c379">\n</span><span style="color:#98c379">&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#61afef;font-weight:bold">printf</span>(<span style="color:#98c379">&#34;按回车键关闭此控制台...</span><span style="color:#98c379">\n</span><span style="color:#98c379">&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#7f848e">// 5. 等待用户输入，以便观察
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>        <span style="color:#61afef;font-weight:bold">getchar</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#7f848e">// 6. 清理并释放控制台
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>        <span style="color:#c678dd">if</span> (<span style="color:#e06c75">pFile</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#61afef;font-weight:bold">fclose</span>(<span style="color:#e06c75">pFile</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#61afef;font-weight:bold">FreeConsole</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">return</span> <span style="color:#d19a66">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e06c75">BOOL</span> <span style="color:#e06c75">WINAPI</span> <span style="color:#61afef;font-weight:bold">DllMain</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">HINSTANCE</span> <span style="color:#e06c75">hinstDLL</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">DWORD</span> <span style="color:#e06c75">fdwReason</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">LPVOID</span> <span style="color:#e06c75">lpReserved</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">switch</span> (<span style="color:#e06c75">fdwReason</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">case</span> <span style="color:#e06c75">DLL_PROCESS_ATTACH</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#7f848e">// 创建一个新线程来执行我们的控制台逻辑
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>            <span style="color:#7f848e">// 我们不希望在 DllMain 中直接做这些
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>            <span style="color:#e06c75">HANDLE</span> <span style="color:#e06c75">hThread</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">CreateThread</span>(<span style="color:#e5c07b">NULL</span>, <span style="color:#d19a66">0</span>, <span style="color:#e06c75">ConsoleThread</span>, <span style="color:#e5c07b">NULL</span>, <span style="color:#d19a66">0</span>, <span style="color:#e5c07b">NULL</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#c678dd">if</span> (<span style="color:#e06c75">hThread</span>)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#61afef;font-weight:bold">CloseHandle</span>(<span style="color:#e06c75">hThread</span>); <span style="color:#7f848e">// 关闭句柄，线程会继续执行
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#c678dd">break</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">return</span> <span style="color:#e06c75">TRUE</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h1 id="注入的实现方法">注入的实现方法
</h1><h2 id="创建远程线程-createremotethread">创建远程线程 (CreateRemoteThread)
</h2><p>这是最经典直接的注入方法</p>
<h3 id="原理">原理
</h3><p>之前说过，<code>CreateRemoteThread</code>API允许我们在另一个进程中启动一个新线程</p>
<p>为了方便观看，这里再贴一下它的结构<del>前面的内容其实你根本没看对吧</del>：</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#e06c75">HANDLE</span> <span style="color:#e06c75">WINAPI</span> <span style="color:#61afef;font-weight:bold">CreateRemoteThread</span>(
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">_In_</span>  <span style="color:#e06c75">HANDLE</span>                                       <span style="color:#e06c75">hProcess</span>,                   <span style="color:#7f848e">// 目标进程句柄
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>  <span style="color:#e06c75">_In_</span>  <span style="color:#e06c75">LPSECURITY_ATTRIBUTES</span>            <span style="color:#e06c75">lpThreadAttributes</span>,   <span style="color:#7f848e">// 线程安全属性
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>  <span style="color:#e06c75">_In_</span>  <span style="color:#e06c75">SIZE_T</span>                                           <span style="color:#e06c75">dwStackSize</span>,             <span style="color:#56b6c2">//</span> 初始堆栈大小(<span style="color:#d19a66">0</span>为默认)
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">_In_</span>  <span style="color:#e06c75">LPTHREAD_START_ROUTINE</span>        <span style="color:#e06c75">lpStartAddress</span>,         <span style="color:#7f848e">// 远程线程函数地址，重要！
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>  <span style="color:#e06c75">_In_</span>  <span style="color:#e06c75">LPVOID</span>                                         <span style="color:#e06c75">lpParameter</span>,              <span style="color:#7f848e">// 传递给远程线程的参数，重要！
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>  <span style="color:#e06c75">_In_</span>  <span style="color:#e06c75">DWORD</span>                                        <span style="color:#e06c75">dwCreationFlags</span>,      <span style="color:#7f848e">// 线程创建标志(0为立即运行)
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>  <span style="color:#e06c75">_Out_</span> <span style="color:#e06c75">LPDWORD</span>                                   <span style="color:#e06c75">lpThreadId</span>                <span style="color:#7f848e">// 接收线程ID的指针
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>);
</span></span></code></pre></div><p>哦，它接受线程函数地址和线程函数参数&hellip;&hellip;那我们岂不是可以用它来加载我们想要的东西？</p>
<h3 id="步骤">步骤
</h3><p>首先，我们将<code>lpStartAddress</code>设置为<code>LoadLibrary()</code>函数的地址</p>
<p>然后，我们将<code>lpParameter</code>设置为我们想要注入的DLL文件的路径字符串的地址</p>
<p>这个地址可以通过上面的模块操作API来得到：</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#61afef;font-weight:bold">GetProcAddress</span>(<span style="color:#61afef;font-weight:bold">GetModuleHandle</span>(<span style="color:#98c379">L</span><span style="color:#98c379">&#34;kernel32.dll&#34;</span>), <span style="color:#98c379">&#34;LoadLibraryW&#34;</span>)
</span></span></code></pre></div><p>于是当<code>CreateRemoteThread</code>执行时，它就相当于在目标进程内部调用了:</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#61afef;font-weight:bold">LoadLibrary</span>(<span style="color:#98c379">&#34;C:</span><span style="color:#98c379">\\</span><span style="color:#98c379">path</span><span style="color:#98c379">\\</span><span style="color:#98c379">to</span><span style="color:#98c379">\\</span><span style="color:#98c379">myhack.dll&#34;</span>)
</span></span></code></pre></div><p>这样就触发了<code>DllMain</code>，实现了注入</p>
<div class="alert alert-warning">
    <div class="alert-header">
        <span class="alert-icon">
            ⚠️
        </span>
        <span class="alert-title">
            Warning
        </span>
    </div>
    <div class="alert-content">
        <p><strong><code>lpStartAddress</code>和<code>lpParameter</code>都必须是目标进程虚拟地址空间中的地址</strong></p></div>
</div>
<p><strong>这里可能有个疑问：为什么我们知道<code>LoadLibrary</code>的地址？难道它是通用的？</strong></p>
<p>还真是！<code>LoadLibrary</code>函数位于<code>Kernel32.dll</code>中，而Windows操作系统为了效率，会将这些核心DLL加载到<em>所有</em>进程中几乎相同的ImageBase</p>
<p>因此，我们在自己进程中用找到的<code>LoadLibrary</code>地址，与它在目标进程中的地址是完全相同的！</p>
<p>这一整个过程下来，其实就是在说：一些为了方便的行为，早晚会变成漏洞（</p>
<h3 id="示例">示例
</h3><p>将<code>MyDll.dll</code>注入到指定PID的进程中</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#7f848e">#include</span> <span style="color:#7f848e">&lt;windows.h&gt;</span><span style="color:#7f848e">
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e">#include</span> <span style="color:#7f848e">&lt;tchar.h&gt;</span><span style="color:#7f848e">
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>
</span></span><span style="display:flex;"><span><span style="color:#e06c75">BOOL</span> <span style="color:#61afef;font-weight:bold">InjectDll</span>(<span style="color:#e06c75">DWORD</span> <span style="color:#e06c75">dwPID</span>, <span style="color:#e06c75">LPCTSTR</span> <span style="color:#e06c75">szDllPath</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">HANDLE</span> <span style="color:#e06c75">hProcess</span> <span style="color:#56b6c2">=</span> <span style="color:#e5c07b">NULL</span>, <span style="color:#e06c75">hThread</span> <span style="color:#56b6c2">=</span> <span style="color:#e5c07b">NULL</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">HMODULE</span> <span style="color:#e06c75">hMod</span> <span style="color:#56b6c2">=</span> <span style="color:#e5c07b">NULL</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">LPVOID</span> <span style="color:#e06c75">pRemoteBuf</span> <span style="color:#56b6c2">=</span> <span style="color:#e5c07b">NULL</span>;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// 1. 计算DLL路径字符串所需的字节大小 (包括结尾的 \0)
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">DWORD</span> <span style="color:#e06c75">dwBufSize</span> <span style="color:#56b6c2">=</span> (<span style="color:#e06c75">DWORD</span>)(<span style="color:#61afef;font-weight:bold">_tcslen</span>(<span style="color:#e06c75">szDllPath</span>) <span style="color:#56b6c2">+</span> <span style="color:#d19a66">1</span>) <span style="color:#56b6c2">*</span> <span style="color:#c678dd">sizeof</span>(<span style="color:#e06c75">TCHAR</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">LPTHREAD_START_ROUTINE</span> <span style="color:#e06c75">pThreadProc</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// 2. 获取目标进程句柄 (dwPID)，需要所有权限
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#c678dd">if</span> (<span style="color:#56b6c2">!</span>(<span style="color:#e06c75">hProcess</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">OpenProcess</span>(<span style="color:#e06c75">PROCESS_ALL_ACCESS</span>, <span style="color:#e06c75">FALSE</span>, <span style="color:#e06c75">dwPID</span>)))
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">return</span> <span style="color:#e06c75">FALSE</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// 3. 在目标进程中分配内存，用于存放DLL路径
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">pRemoteBuf</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">VirtualAllocEx</span>(<span style="color:#e06c75">hProcess</span>, <span style="color:#e5c07b">NULL</span>, <span style="color:#e06c75">dwBufSize</span>, <span style="color:#e06c75">MEM_COMMIT</span>, <span style="color:#e06c75">PAGE_READWRITE</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> (<span style="color:#e06c75">pRemoteBuf</span> <span style="color:#56b6c2">==</span> <span style="color:#e5c07b">NULL</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#61afef;font-weight:bold">CloseHandle</span>(<span style="color:#e06c75">hProcess</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">return</span> <span style="color:#e06c75">FALSE</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// 4. 将DLL路径字符串写入刚刚分配的远程内存中
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#c678dd">if</span> (<span style="color:#56b6c2">!</span><span style="color:#61afef;font-weight:bold">WriteProcessMemory</span>(<span style="color:#e06c75">hProcess</span>, <span style="color:#e06c75">pRemoteBuf</span>, (<span style="color:#e06c75">LPVOID</span>)<span style="color:#e06c75">szDllPath</span>, <span style="color:#e06c75">dwBufSize</span>, <span style="color:#e5c07b">NULL</span>)) {
</span></span><span style="display:flex;"><span>        <span style="color:#61afef;font-weight:bold">CloseHandle</span>(<span style="color:#e06c75">hProcess</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">return</span> <span style="color:#e06c75">FALSE</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// 5. 获取 Kernel32.dll 模块的句柄（在当前进程中）
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">hMod</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">GetModuleHandle</span>(<span style="color:#61afef;font-weight:bold">_T</span>(<span style="color:#98c379">&#34;kernel32.dll&#34;</span>));
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// 6. 获取 LoadLibraryW 函数的地址
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#7f848e">// (这里使用 LoadLibraryW 是因为我们使用了 TCHAR，并且很可能定义了 UNICODE)
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">pThreadProc</span> <span style="color:#56b6c2">=</span> (<span style="color:#e06c75">LPTHREAD_START_ROUTINE</span>)<span style="color:#61afef;font-weight:bold">GetProcAddress</span>(<span style="color:#e06c75">hMod</span>, <span style="color:#98c379">&#34;LoadLibraryW&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// 7. 在目标进程中创建远程线程
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#7f848e">// 线程函数 = LoadLibraryW 的地址
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#7f848e">// 线程参数 = 远程内存中DLL路径的地址
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">hThread</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">CreateRemoteThread</span>(<span style="color:#e06c75">hProcess</span>, <span style="color:#e5c07b">NULL</span>, <span style="color:#d19a66">0</span>, <span style="color:#e06c75">pThreadProc</span>, <span style="color:#e06c75">pRemoteBuf</span>, <span style="color:#d19a66">0</span>, <span style="color:#e5c07b">NULL</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> (<span style="color:#e06c75">hThread</span> <span style="color:#56b6c2">==</span> <span style="color:#e5c07b">NULL</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#61afef;font-weight:bold">CloseHandle</span>(<span style="color:#e06c75">hProcess</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">return</span> <span style="color:#e06c75">FALSE</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#61afef;font-weight:bold">WaitForSingleObject</span>(<span style="color:#e06c75">hThread</span>, <span style="color:#e06c75">INFINITE</span>); <span style="color:#7f848e">// 等待线程执行完毕
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// 8. 清理
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#7f848e">// VirtualFreeEx(hProcess, pRemoteBuf, 0, MEM_RELEASE); // 理论上应该释放内存
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#61afef;font-weight:bold">CloseHandle</span>(<span style="color:#e06c75">hThread</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#61afef;font-weight:bold">CloseHandle</span>(<span style="color:#e06c75">hProcess</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">return</span> <span style="color:#e06c75">TRUE</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e5c07b">int</span> <span style="color:#61afef;font-weight:bold">_tmain</span>(<span style="color:#e5c07b">int</span> <span style="color:#e06c75">argc</span>, <span style="color:#e06c75">TCHAR</span><span style="color:#56b6c2">*</span> <span style="color:#e06c75">argv</span>[]) {
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// 用法: InjectDll.exe &lt;PID&gt; &lt;DLL路径&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#7f848e">// 示例: InjectDll.exe 4232 F:\1\MyDll.dll
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#c678dd">if</span> (<span style="color:#e06c75">argc</span> <span style="color:#56b6c2">!=</span> <span style="color:#d19a66">3</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#61afef;font-weight:bold">_tprintf</span>(<span style="color:#61afef;font-weight:bold">_T</span>(<span style="color:#98c379">&#34;Usage: InjectDll.exe &lt;PID&gt; &lt;Full Dll Path&gt;</span><span style="color:#98c379">\n</span><span style="color:#98c379">&#34;</span>));
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">return</span> <span style="color:#d19a66">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> (<span style="color:#61afef;font-weight:bold">InjectDll</span>(<span style="color:#61afef;font-weight:bold">_ttoi</span>(<span style="color:#e06c75">argv</span>[<span style="color:#d19a66">1</span>]), <span style="color:#e06c75">argv</span>[<span style="color:#d19a66">2</span>])) {
</span></span><span style="display:flex;"><span>        <span style="color:#61afef;font-weight:bold">_tprintf</span>(<span style="color:#61afef;font-weight:bold">_T</span>(<span style="color:#98c379">&#34;InjectDll(</span><span style="color:#98c379">\&#34;</span><span style="color:#98c379">%s</span><span style="color:#98c379">\&#34;</span><span style="color:#98c379">) success!!!</span><span style="color:#98c379">\n</span><span style="color:#98c379">&#34;</span>), <span style="color:#e06c75">argv</span>[<span style="color:#d19a66">2</span>]);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">return</span> <span style="color:#d19a66">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>执行后，使用Process Explorer等工具查看，会发现<code>notepad.exe</code>成功加载了<code>MyDll.dll</code></p>
<h2 id="使用注册表-appinit_dlls">使用注册表 (AppInit_DLLs)
</h2><p>这是一种更被动，但影响范围更广的注入方法</p>
<h3 id="原理-1">原理
</h3><p>还记得之前说的掌管用户事件的<code>User32.dll</code>吗？当它被加载时，会读取一个特殊的注册表项：</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-kotlin" data-lang="kotlin"><span style="display:flex;"><span><span style="color:#e06c75">HKEY_LOCAL_MACHINE</span>\<span style="color:#e06c75">SOFTWARE</span>\<span style="color:#e06c75">Microsoft</span>\<span style="color:#e06c75">Windows</span> <span style="color:#e06c75">NT</span>\<span style="color:#e06c75">CurrentVersion</span>\<span style="color:#e06c75">Windows</span>
</span></span></code></pre></div><p>在这个键下，有一个名为<code>AppInit_DLLs</code>的值，如果这个值里包含了一个或多个（用逗号或空格分隔）DLL的完整路径，<code>User32.dll</code>就会自动调用<code>LoadLibrary()</code>来加载它们</p>
<p>还有一个键<code>LoadAppInit_DLLs</code>，是控制开关，决定是否启用<code>AppInit_DLLs</code>列表中指定的 DLL 的加载</p>
<p>关于注册表，你可以看看这个：<a class="link" href="https://blog.928330.xyz/p/windows%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93%E4%B8%8A/#%E6%B3%A8%E5%86%8C%E8%A1%A8"  target="_blank" rel="noopener"
    >注册表
    
    <span style="white-space: nowrap;"><svg width=".7em"
        height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg">
        <path d="m13 3l3.293 3.293l-7 7l1.414 1.414l7-7L21 11V3z" fill="currentColor" />
        <path d="M19 19H5V5h7l-2-2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2v-5l-2-2v7z"
            fill="currentColor">
    </svg></span>
    
</a></p>
<h3 id="步骤-1">步骤
</h3><p>打开注册表编辑器 (<code>regedit</code>)，定位到：</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-kotlin" data-lang="kotlin"><span style="display:flex;"><span><span style="color:#e06c75">HKEY_LOCAL_MACHINE</span>\<span style="color:#e06c75">SOFTWARE</span>\<span style="color:#e06c75">Microsoft</span>\<span style="color:#e06c75">Windows</span> <span style="color:#e06c75">NT</span>\<span style="color:#e06c75">CurrentVersion</span>\<span style="color:#e06c75">Windows</span>
</span></span></code></pre></div><p>双击<code>AppInit_DLLs</code>，将要注入的DLL的绝对路径填入</p>
<p>之后，找到<code>LoadAppInit_DLLs</code>这个<code>DWORD</code>值，将其数据从0改为1</p>
<p>最后重启电脑</p>
<p>完成上述操作后，你启动的任何GUI程序（如<code>notepad.exe</code>,<code>POWERPNT.EXE</code>,<code>iexplore.exe</code>等）都会被自动注入<code>MyDll2.dll</code>，如果没有改掉，他就会一直影响你，这也是持久化注入的方式</p>
<h3 id="示例-1">示例
</h3><p>没有示例！</p>
<p>如果你没有虚拟机，去操作本机的注册表是很危险的，尤其是自带的<code>regedit</code>没有撤回机制，很容易就整坏了</p>
<p>并且，从Windows8开始，由于安全启动（Secure Boot）的引入，<code>AppInit_DLLs</code>机制默认被禁用，除非DLL是经过签名的，不然不会被加载的</p>
<p>这个方法很简单，看一下就行了</p>
<h2 id="消息钩取-setwindowshookex">消息钩取 (SetWindowsHookEx)
</h2><p>这是利用Windows消息机制实现的注入方法</p>
<h3 id="原理-2">原理
</h3><p>Windows GUI是事件驱动的</p>
<p>每一个的键盘/鼠标操作会产生事件，操作系统会将这些事件包装成消息发送到系统消息队列，应用程序再从自己的消息队列中取出并处理消息，这个过程称为消息循环</p>
<p>消息钩子是允许我们拦截这些消息的机制，我们可以设置一个回调函数（也被称为“钩子过程”），在事件消息从操作系统向应用程序传递的过程中，获取、查看、修改甚至拦截这些消息</p>
<p>如果存在多个钩子，它们会形成一个“钩子链”</p>
<h3 id="步骤-2">步骤
</h3><p>依旧是前文提到过的函数<code>SetWindowsHookEx</code>，它是安装钩子的API</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#e06c75">HHOOK</span> <span style="color:#e06c75">WINAPI</span> <span style="color:#61afef;font-weight:bold">SetWindowsHookEx</span>(
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">_In_</span> <span style="color:#e5c07b">int</span>                      <span style="color:#e06c75">idHook</span>,          <span style="color:#56b6c2">//</span> 钩子类型(如<span style="color:#e06c75">WH_KEYBOARD_LL</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">_In_</span> <span style="color:#e06c75">HOOKPROC</span>       <span style="color:#e06c75">lpfn</span>,                <span style="color:#7f848e">// 钩子过程(回调函数)的地址
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>  <span style="color:#e06c75">_In_</span> <span style="color:#e06c75">HINSTANCE</span>        <span style="color:#e06c75">hMod</span>,            <span style="color:#7f848e">// 包含钩子过程的DLL句柄
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>  <span style="color:#e06c75">_In_</span> <span style="color:#e06c75">DWORD</span>             <span style="color:#e06c75">dwThreadId</span>    <span style="color:#7f848e">// 要钩取的线程ID(0为所有线程)
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>);
</span></span></code></pre></div><p>注入的原理就发生在<code>hMod</code>和<code>dwThreadId</code>参数上：</p>
<ol>
<li>我们将钩子过程<code>lpfn</code>放在准备注入的DLL中（我们称呼它为<code>Hook.dll</code>），<code>hMod</code>是这个<code>Hook.dll</code>的句柄</li>
<li>之后，我们让一个程序（我们称呼它为安装程序）加载<code>Hook.dll</code>，并用<code>SetWindowsHookEx</code>注册钩子</li>
<li>如果<code>dwThreadId</code>被设置为<code>0</code>，<code>SetWindowsHookEx</code>会安装一个全局钩子，也就是说系统会把这个钩子加入到系统钩子链中，它这样系统里所有相关线程产生的消息都可能触发该钩子</li>
<li>当被钩取的消息在系统中的任何进程中发生时，操作系统为了能调用钩子过程<code>lpfn</code>，会强制将包含钩子过程的DLL注入到那个进程的地址空间中</li>
</ol>
<p>就这样，只要你在<code>notepad.exe</code>里按一下键，<code>Hook.dll</code>就被注入进去了</p>
<h3 id="示例-2">示例
</h3><p>这个例子包含两部分：<code>HookDll.dll</code>（木马）和<code>TestHook.exe</code>（安装器）</p>
<h4 id="木马hookdllcpp">木马：HookDll.cpp
</h4><p>这个DLL包含了真正的钩子过程<code>KeyboardProc</code>，它还导出了两个函数<code>HkStart</code>和<code>HkStop</code>，供安装器调用</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#7f848e">#include</span> <span style="color:#7f848e">&lt;windows.h&gt;</span><span style="color:#7f848e">
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e">#include</span> <span style="color:#7f848e">&lt;tchar.h&gt;</span><span style="color:#7f848e">
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e">// 必须使用共享变量，以便在不同进程中共享句柄
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#7f848e">#pragma data_seg(&#34;Shared&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#e06c75">HINSTANCE</span> <span style="color:#e06c75">g_hInstance</span> <span style="color:#56b6c2">=</span> <span style="color:#e5c07b">NULL</span>; <span style="color:#7f848e">// DLL实例句柄
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#e06c75">HHOOK</span> <span style="color:#e06c75">g_hHook</span> <span style="color:#56b6c2">=</span> <span style="color:#e5c07b">NULL</span>;         <span style="color:#7f848e">// 钩子句柄
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#7f848e">#pragma data_seg()
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e">#pragma comment(linker, &#34;/SECTION:Shared,RWS&#34;) </span><span style="color:#7f848e">// 设置段属性为读、写、共享
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>
</span></span><span style="display:flex;"><span><span style="color:#e06c75">BOOL</span> <span style="color:#e06c75">WINAPI</span> <span style="color:#61afef;font-weight:bold">DllMain</span>(<span style="color:#e06c75">HINSTANCE</span> <span style="color:#e06c75">hinstDLL</span>, <span style="color:#e06c75">DWORD</span> <span style="color:#e06c75">dwReason</span>, <span style="color:#e06c75">LPVOID</span> <span style="color:#e06c75">lpvReserved</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> (<span style="color:#e06c75">dwReason</span> <span style="color:#56b6c2">==</span> <span style="color:#e06c75">DLL_PROCESS_ATTACH</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">g_hInstance</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">hinstDLL</span>; <span style="color:#7f848e">// 保存DLL实例句柄
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">return</span> <span style="color:#e06c75">TRUE</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e">// 钩子过程（回调函数）
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#e06c75">LRESULT</span> <span style="color:#e06c75">CALLBACK</span> <span style="color:#61afef;font-weight:bold">KeyboardProc</span>(<span style="color:#e5c07b">int</span> <span style="color:#e06c75">nCode</span>, <span style="color:#e06c75">WPARAM</span> <span style="color:#e06c75">wParam</span>, <span style="color:#e06c75">LPARAM</span> <span style="color:#e06c75">lParam</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// lParam的第31位：0表示按键，1表示释放键
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#c678dd">if</span> (<span style="color:#e06c75">nCode</span> <span style="color:#56b6c2">&gt;=</span> <span style="color:#d19a66">0</span> <span style="color:#56b6c2">&amp;&amp;</span> <span style="color:#56b6c2">!</span>(<span style="color:#e06c75">lParam</span> <span style="color:#56b6c2">&amp;</span> <span style="color:#d19a66">0x80000000</span>)) {
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">TCHAR</span> <span style="color:#e06c75">szPath</span>[<span style="color:#e06c75">MAX_PATH</span>] <span style="color:#56b6c2">=</span> {<span style="color:#d19a66">0</span>};
</span></span><span style="display:flex;"><span>        <span style="color:#61afef;font-weight:bold">GetModuleFileName</span>(<span style="color:#e5c07b">NULL</span>, <span style="color:#e06c75">szPath</span>, <span style="color:#e06c75">MAX_PATH</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">TCHAR</span> <span style="color:#56b6c2">*</span><span style="color:#e06c75">p</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">_tcsrchr</span>(<span style="color:#e06c75">szPath</span>, <span style="color:#61afef;font-weight:bold">_T</span>(<span style="color:#98c379">&#39;\\&#39;</span>));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#7f848e">// 检查当前进程是否为 notepad.exe
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>        <span style="color:#c678dd">if</span> (<span style="color:#e06c75">p</span> <span style="color:#56b6c2">&amp;&amp;</span> <span style="color:#56b6c2">!</span><span style="color:#61afef;font-weight:bold">lstrcmpi</span>(<span style="color:#e06c75">p</span> <span style="color:#56b6c2">+</span> <span style="color:#d19a66">1</span>, <span style="color:#61afef;font-weight:bold">_T</span>(<span style="color:#98c379">&#34;notepad.exe&#34;</span>))) {
</span></span><span style="display:flex;"><span>            <span style="color:#c678dd">return</span> <span style="color:#d19a66">1</span>; <span style="color:#7f848e">// 是Notepad，返回1，拦截该消息（按键失效）
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// 不是Notepad，或不是按键消息，将消息传递给下一个钩子
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#c678dd">return</span> <span style="color:#61afef;font-weight:bold">CallNextHookEx</span>(<span style="color:#e06c75">g_hHook</span>, <span style="color:#e06c75">nCode</span>, <span style="color:#e06c75">wParam</span>, <span style="color:#e06c75">lParam</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e">// 导出函数：开始钩取
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#c678dd">extern</span> <span style="color:#98c379">&#34;C&#34;</span> <span style="color:#c678dd">__declspec</span>(<span style="color:#e06c75">dllexport</span>) <span style="color:#e5c07b">void</span> <span style="color:#61afef;font-weight:bold">HkStart</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">g_hHook</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">SetWindowsHookEx</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">WH_KEYBOARD</span>,    <span style="color:#7f848e">// 钩子类型：键盘
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>        <span style="color:#e06c75">KeyboardProc</span>,   <span style="color:#7f848e">// 钩子过程地址
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>        <span style="color:#e06c75">g_hInstance</span>,    <span style="color:#7f848e">// DLL实例句柄
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>        <span style="color:#d19a66">0</span>               <span style="color:#7f848e">// 全局钩子（所有线程）
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    );
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e">// 导出函数：停止钩取
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#c678dd">extern</span> <span style="color:#98c379">&#34;C&#34;</span> <span style="color:#c678dd">__declspec</span>(<span style="color:#e06c75">dllexport</span>) <span style="color:#e5c07b">void</span> <span style="color:#61afef;font-weight:bold">HkStop</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> (<span style="color:#e06c75">g_hHook</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#61afef;font-weight:bold">UnhookWindowsHookEx</span>(<span style="color:#e06c75">g_hHook</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">g_hHook</span> <span style="color:#56b6c2">=</span> <span style="color:#e5c07b">NULL</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="安装器testhookcpp">安装器：TestHook.cpp
</h4><p>这个程序负责加载<code>HookDll.dll</code>并调用其导出的<code>HkStart</code>来安装全局钩子</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#7f848e">#include</span> <span style="color:#7f848e">&lt;windows.h&gt;</span><span style="color:#7f848e">
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e">#include</span> <span style="color:#7f848e">&lt;tchar.h&gt;</span><span style="color:#7f848e">
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e">// 定义导出函数的指针类型
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#c678dd">typedef</span> <span style="color:#61afef;font-weight:bold">void</span> (<span style="color:#56b6c2">*</span><span style="color:#e06c75">PFN_HOOKSTART</span>)();
</span></span><span style="display:flex;"><span><span style="color:#c678dd">typedef</span> <span style="color:#61afef;font-weight:bold">void</span> (<span style="color:#56b6c2">*</span><span style="color:#e06c75">PFN_HOOKSTOP</span>)();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e5c07b">int</span> <span style="color:#61afef;font-weight:bold">_tmain</span>(<span style="color:#e5c07b">int</span> <span style="color:#e06c75">argc</span>, <span style="color:#e06c75">TCHAR</span><span style="color:#56b6c2">*</span> <span style="color:#e06c75">argv</span>[]) {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">HMODULE</span> <span style="color:#e06c75">hDll</span> <span style="color:#56b6c2">=</span> <span style="color:#e5c07b">NULL</span>;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// 1. 加载DLL
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#c678dd">if</span> (<span style="color:#56b6c2">!</span>(<span style="color:#e06c75">hDll</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">LoadLibraryA</span>(<span style="color:#98c379">&#34;HookDll.dll&#34;</span>))) <span style="color:#7f848e">// 使用A版本
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>        <span style="color:#c678dd">return</span> <span style="color:#d19a66">1</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// 2. 获取导出函数地址
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">PFN_HOOKSTART</span> <span style="color:#e06c75">HookStart</span> <span style="color:#56b6c2">=</span> (<span style="color:#e06c75">PFN_HOOKSTART</span>)<span style="color:#61afef;font-weight:bold">GetProcAddress</span>(<span style="color:#e06c75">hDll</span>, <span style="color:#98c379">&#34;HkStart&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">PFN_HOOKSTOP</span> <span style="color:#e06c75">HookStop</span> <span style="color:#56b6c2">=</span> (<span style="color:#e06c75">PFN_HOOKSTOP</span>)<span style="color:#61afef;font-weight:bold">GetProcAddress</span>(<span style="color:#e06c75">hDll</span>, <span style="color:#98c379">&#34;HkStop&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> (<span style="color:#56b6c2">!</span><span style="color:#e06c75">HookStart</span> <span style="color:#56b6c2">||</span> <span style="color:#56b6c2">!</span><span style="color:#e06c75">HookStop</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#61afef;font-weight:bold">FreeLibrary</span>(<span style="color:#e06c75">hDll</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">return</span> <span style="color:#d19a66">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// 3. 调用导出函数，安装全局钩子
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#61afef;font-weight:bold">HookStart</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#61afef;font-weight:bold">_tprintf</span>(<span style="color:#61afef;font-weight:bold">_T</span>(<span style="color:#98c379">&#34;Hook installed. Press &#39;q&#39; to quit!</span><span style="color:#98c379">\n</span><span style="color:#98c379">&#34;</span>));
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// 4. 阻塞，等待用户退出
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#c678dd">while</span> (<span style="color:#61afef;font-weight:bold">getchar</span>() <span style="color:#56b6c2">!=</span> <span style="color:#98c379">&#39;q&#39;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// 5. 卸载钩子
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#61afef;font-weight:bold">HookStop</span>();
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// 6. 释放DLL
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#61afef;font-weight:bold">FreeLibrary</span>(<span style="color:#e06c75">hDll</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">return</span> <span style="color:#d19a66">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>运行<code>TestHook.exe</code>后，打开记事本（<code>notepad.exe</code>），你会发现无法输入任何字符，因为键盘消息被<code>HookDll.dll</code>拦截了</p>
<h2 id="修改pe导入表-静态注入">修改PE导入表 (静态注入)
</h2><p>不操作运行中的进程，而是直接修改磁盘上的exe文件</p>
<h3 id="原理-3">原理
</h3><p>我们直接在目标exe的PE结构中，将其导入表指向的<code>IMAGE_IMPORT_DESCRIPTOR</code>数组进行修改，添加一个指向我们DLL的新条目</p>
<p>这样，当Windows加载器运行这个被修改的exe时，它会像加载<code>kernel32.dll</code>一样，自动加载我们的<code>MyDll3.dll</code></p>
<h3 id="示例-3">示例
</h3><p>PE加载器导入DLL的目的是为了调用它的函数，因此，我们的注入DLL必须至少提供一个导出函数，否则无法被隐式链接</p>
<p>我们可以提供一个空的函数（也就是所谓的<code>dummy</code>函数）糊弄它：</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#7f848e">#include</span> <span style="color:#7f848e">&lt;windows.h&gt;</span><span style="color:#7f848e">
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e">#include</span> <span style="color:#7f848e">&lt;tchar.h&gt;</span><span style="color:#7f848e">
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e">#include</span> <span style="color:#7f848e">&lt;urlmon.h&gt;</span><span style="color:#7f848e">
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e">#pragma comment(lib, &#34;urlmon.lib&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e">// 必须提供至少一个导出函数
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#c678dd">extern</span> <span style="color:#98c379">&#34;C&#34;</span> <span style="color:#c678dd">__declspec</span>(<span style="color:#e06c75">dllexport</span>) <span style="color:#e5c07b">void</span> <span style="color:#61afef;font-weight:bold">dummy</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">return</span>;    <span style="color:#7f848e">//什么也不做
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>}
</span></span></code></pre></div><h3 id="修改导入表">修改导入表
</h3><h4 id="定位原导入表">定位原导入表
</h4><p>使用PEview查看<code>notepad.exe</code>，找到导入表，这个事情我们在之前的课中已经做过</p>
<h4 id="寻找新空间">寻找新空间
</h4><p>因为原导入表后面紧跟着其他数据，空间已满，我们无法直接在末尾添加新条目，所以必须把整个导入表移动到文件中的一个空白区域</p>
<p>如何查找文件中的空白区域？例如，<code>.reloc</code>节区末尾可能有几百字节的<code>00</code>填充：</p>
<p>
<div class="post-img-view">
<a data-fancybox="gallery" data-caption="image-20251102163528866" href="http://picture.928330.xyz/typora/image-20251102163528866.png">
<img src="http://picture.928330.xyz/typora/image-20251102163528866.png" alt="image-20251102163528866"  />
</a>
</div>
</p>
<h4 id="复制添加并更新pe头">复制、添加并更新PE头
</h4><p>将原<code>IMAGE_IMPORT_DESCRIPTOR</code>数组完整复制到新位置，然后在新位置的末尾追加一个条目，这个条目要在终结描述符之前</p>
<p>更改后，总字节数是<code>(N+1)*0x14</code></p>
<div class="alert alert-tip">
    <div class="alert-header">
        <span class="alert-icon">
            💡
        </span>
        <span class="alert-title">
            Tip
        </span>
    </div>
    <div class="alert-content">
        <p>或许你还记得导入表条目的结构：</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#c678dd">typedef</span> <span style="color:#c678dd">struct</span> <span style="color:#e06c75">_IMAGE_IMPORT_DESCRIPTOR</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">union</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">DWORD</span> <span style="color:#e06c75">Characteristics</span>; 
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">DWORD</span> <span style="color:#e06c75">OriginalFirstThunk</span>;  <span style="color:#7f848e">//导入名称表 INT 的 RVA
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    };
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">DWORD</span> <span style="color:#e06c75">TimeDateStamp</span>;           <span style="color:#7f848e">// 通常为 0
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">DWORD</span> <span style="color:#e06c75">ForwarderChain</span>;          <span style="color:#7f848e">// 通常为 -1 或 0
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">DWORD</span> <span style="color:#e06c75">Name</span>;                    <span style="color:#7f848e">// DLL 名称的 RVA
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">DWORD</span> <span style="color:#e06c75">FirstThunk</span>;              <span style="color:#7f848e">// 导入地址表 IAT 的 RVA 
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>} <span style="color:#e06c75">IMAGE_IMPORT_DESCRIPTOR</span>;
</span></span><span style="display:flex;"><span> 
</span></span></code></pre></div><p>union是成员共用一块地址，所以一个<code>IMAGE_IMPORT_DESCRIPTOR</code>占用20字节（0x14）</p>
<p>此外，数组必须以一个全0的终结描述符结尾（类似C字符串的 <code>'\0'</code>），这个描述符也是20字节</p></div>
</div>
<p>这时候就能计算新表的RVA了：假设我们就用<code>.reloc</code>节后面的空白区域，用<code>.reloc</code>的<code>RAW</code>和<code>RVA</code>作为基准：</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-kotlin" data-lang="kotlin"><span style="display:flex;"><span><span style="color:#e06c75">新RVA</span> = <span style="color:#e06c75">新RAW</span> - <span style="color:#e06c75">节RAW</span> + <span style="color:#e06c75">节RVA</span>
</span></span></code></pre></div><p>这个新RAW我们能在十六进制编辑器中直接看见，就是选定的空白位置</p>
<p>之后修改PE头，将<code>DataDirectory[1]</code>（导入表目录）的<code>VirtualAddress</code>和<code>Size</code>更新</p>
<h4 id="构建新的intiat和字符串">构建新的INT、IAT和字符串
</h4><p><code>IMAGE_IMPORT_DESCRIPTOR</code>结构需要指向INT、IAT和DLL名称</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#c678dd">typedef</span> <span style="color:#c678dd">struct</span> <span style="color:#e06c75">_IMAGE_IMPORT_DESCRIPTOR</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">union</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">DWORD</span> <span style="color:#e06c75">Characteristics</span>; 
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">DWORD</span> <span style="color:#e06c75">OriginalFirstThunk</span>;  <span style="color:#7f848e">//导入名称表 INT 的 RVA
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    };
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">DWORD</span> <span style="color:#e06c75">TimeDateStamp</span>;           <span style="color:#7f848e">// 通常为 0
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">DWORD</span> <span style="color:#e06c75">ForwarderChain</span>;          <span style="color:#7f848e">// 通常为 -1 或 0
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">DWORD</span> <span style="color:#e06c75">Name</span>;                    <span style="color:#7f848e">// DLL 名称的 RVA
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">DWORD</span> <span style="color:#e06c75">FirstThunk</span>;              <span style="color:#7f848e">// 导入地址表 IAT 的 RVA 
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>} <span style="color:#e06c75">IMAGE_IMPORT_DESCRIPTOR</span>;
</span></span></code></pre></div><p>我们必须在文件的另一个空白区域手动构建这些东西</p>
<p><strong>为了方便看，先假设是在<code>.text</code>节的<code>RAW: 0xAB10</code>处：</strong></p>
<ul>
<li>
<p><strong><code>RAW: 0xAB10</code></strong></p>
<p>创建INT，写入指向<code>IMAGE_IMPORT_BY_NAME</code>的RVA</p>
</li>
<li>
<p><strong><code>RAW: 0xAB20</code></strong></p>
<p>写入字符串<code>&quot;MyDll.dll\0&quot;</code></p>
</li>
<li>
<p><strong><code>RAW: 0xAB30</code></strong></p>
<p>创建IAT，内容在加载前与INT完全相同，也写入指向<code>IMAGE_IMPORT_BY_NAME</code>的RVA</p>
</li>
<li>
<p><strong><code>RAW: 0xAB40</code></strong></p>
<p>写入<code>IMAGE_IMPORT_BY_NAME</code>结构（Hint<code>0x0000</code>+ 函数名<code>&quot;dummy\0&quot;</code>）、</p>
</li>
</ul>
<p>间隔0x10字节的原因是这样方便观看，如果空间足够可以随意</p>
<p>
<div class="post-img-view">
<a data-fancybox="gallery" data-caption="image-20251102174301399" href="http://picture.928330.xyz/typora/image-20251102174301399.png">
<img src="http://picture.928330.xyz/typora/image-20251102174301399.png" alt="image-20251102174301399"  />
</a>
</div>
</p>
<p>
<div class="post-img-view">
<a data-fancybox="gallery" data-caption="image-20251102174314034" href="http://picture.928330.xyz/typora/image-20251102174314034.png">
<img src="http://picture.928330.xyz/typora/image-20251102174314034.png" alt="image-20251102174314034"  />
</a>
</div>
</p>
<h4 id="计算新构建内容的rva">计算新构建内容的RVA
</h4><p>可以看见，在<code>IMAGE_IMPORT_DESCRIPTOR</code>中的一切都是RVA，所以我们必须计算所有的RVA</p>
<p>同样，假设<code>.text</code>节的<code>RAW</code>是<code>0x400</code>，<code>RVA</code>是<code>0x1000</code></p>
<ul>
<li><code>INT RVA = 0xAB10 - 0x400 + 0x1000 = 0xB710</code></li>
<li><code>Name RVA = 0xAB20 - 0x400 + 0x1000 = 0xB720</code></li>
<li><code>IAT RVA = 0xAB30 - 0x400 + 0x1000 = 0xB730</code></li>
<li><code>IMAGE_IMPORT_BY_NAME RVA = 0xAB40 - 0x400 + 0x1000 = 0xB740</code></li>
</ul>
<h4 id="填充新的image_import_descriptor">填充新的IMAGE_IMPORT_DESCRIPTOR**
</h4><p>回到我们移动的导入表末尾，填入我们新的<code>IMAGE_IMPORT_DESCRIPTOR</code>：</p>
<ul>
<li><code>OriginalFirstThunk (INT)</code>：<code>0xB710</code></li>
<li><code>TimeDateStamp</code>：<code>0xFFFFFFFF</code></li>
<li><code>ForwarderChain</code>：<code>0xFFFFFFFF</code></li>
<li><code>Name</code>：<code>0xB720</code></li>
<li><code>FirstThunk (IAT)</code>：<code>0xB730</code></li>
</ul>
<h4 id="修改节区属性">修改节区属性
</h4><p>在上面，我们的IAT被放在了<code>.text</code>节区，而<code>.text</code>节区默认属性是可执行、可读，但不可写</p>
<p>然而，PE加载器在运行时需要向IAT中写入函数的真实地址，怎么办？</p>
<p>因此我们必须修改<code>.text</code>节头的<code>Characteristics</code>字段，为其添加<code>IMAGE_SCN_MEM_WRITE</code>（<code>0x80000000</code>）属性：</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#d19a66">0x60000020</span><span style="color:#56b6c2">+</span><span style="color:#d19a66">0x80000000</span><span style="color:#56b6c2">=</span><span style="color:#d19a66">0xE0000020</span>
</span></span></code></pre></div><div class="alert alert-tip">
    <div class="alert-header">
        <span class="alert-icon">
            💡
        </span>
        <span class="alert-title">
            Tip
        </span>
    </div>
    <div class="alert-content">
        <p>回顾一下节区头：</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#7f848e">#define IMAGE_SIZEOF_SHORT_NAME 8
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">typedef</span> <span style="color:#c678dd">struct</span> <span style="color:#e06c75">_IMAGE_SECTION_HEADER</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">BYTE</span>  <span style="color:#e06c75">Name</span>[<span style="color:#e06c75">IMAGE_SIZEOF_SHORT_NAME</span>]; <span style="color:#7f848e">// 节名称，例如 &#34;.text&#34; &#34;.data&#34; &#34;.rdata&#34; &#34;.rsrc&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#c678dd">union</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">DWORD</span> <span style="color:#e06c75">PhysicalAddress</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">DWORD</span> <span style="color:#e06c75">VirtualSize</span>;               <span style="color:#7f848e">// 节区在内存中的大小（RVA对应）
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    } <span style="color:#e06c75">Misc</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">DWORD</span> <span style="color:#e06c75">VirtualAddress</span>;                     <span style="color:#7f848e">// 节在内存中的 RVA（相对于 ImageBase）
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">DWORD</span> <span style="color:#e06c75">SizeOfRawData</span>;                   <span style="color:#7f848e">// 节在文件中的大小（磁盘对齐后的字节数）
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">DWORD</span> <span style="color:#e06c75">PointerToRawData</span>;               <span style="color:#7f848e">// 节在文件中的起始偏移
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">DWORD</span> <span style="color:#e06c75">PointerToRelocations</span>;           <span style="color:#7f848e">// 重定位表指针（如果有重定位信息）
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">DWORD</span> <span style="color:#e06c75">PointerToLinenumbers</span>;           <span style="color:#7f848e">// 行号信息指针（调试用）
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">WORD</span>  <span style="color:#e06c75">NumberOfRelocations</span>;             <span style="color:#7f848e">// 重定位表条目数量
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">WORD</span>  <span style="color:#e06c75">NumberOfLinenumbers</span>;            <span style="color:#7f848e">// 行号条目数量
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">DWORD</span> <span style="color:#e06c75">Characteristics</span>;                               <span style="color:#7f848e">// 节特性标志（可读、可写、可执行等）
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>} <span style="color:#e06c75">IMAGE_SECTION_HEADER</span>, <span style="color:#56b6c2">*</span><span style="color:#e06c75">PIMAGE_SECTION_HEADER</span>;
</span></span></code></pre></div><p>其中<code>Characteristics</code>字段决定了节的特性，它的机制类似linux的rwx，每一个属性对应一个值：</p>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>位标志</th>
          <th>含义</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>0x00000020</td>
          <td>节里有代码</td>
      </tr>
      <tr>
          <td>0x20000000</td>
          <td>映射后可执行（E）</td>
      </tr>
      <tr>
          <td>0x40000000</td>
          <td>映射后可读（R）</td>
      </tr>
      <tr>
          <td>0x80000000</td>
          <td>映射后可写（W）</td>
      </tr>
  </tbody>
</table></div>
<p>当 Windows 加载器读取 PE 文件时，它会遍历节表：</p>
<ol>
<li>看到节的<code>Characteristics</code></li>
<li>按标志确定应该为这块区域申请怎样的内存页</li>
<li>调用内核 API</li>
<li>把节的数据映射进去，并把页保护设置为对应的Windows内存保护：</li>
</ol>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>PE属性组合</th>
          <th>映射后的页保护</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>R</td>
          <td><code>PAGE_READONLY</code></td>
      </tr>
      <tr>
          <td>R + W</td>
          <td><code>PAGE_READWRITE</code></td>
      </tr>
      <tr>
          <td>E + R</td>
          <td><code>PAGE_EXECUTE_READ</code></td>
      </tr>
      <tr>
          <td>E + R + W</td>
          <td><code>PAGE_EXECUTE_READWRITE</code></td>
      </tr>
  </tbody>
</table></div>
<p>默认<code>.text</code>的属性为：</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#d19a66">0x60000020</span>
</span></span><span style="display:flex;"><span><span style="color:#56b6c2">=</span> <span style="color:#d19a66">0x20000000</span> (<span style="color:#e06c75">EXECUTE</span>)
</span></span><span style="display:flex;"><span><span style="color:#56b6c2">+</span> <span style="color:#d19a66">0x40000000</span> (<span style="color:#e06c75">READ</span>)
</span></span><span style="display:flex;"><span><span style="color:#56b6c2">+</span> <span style="color:#d19a66">0x00000020</span> (<span style="color:#e06c75">CODE</span>)
</span></span></code></pre></div><p>也就是E+R，加载器映射时会分配为<code>PAGE_EXECUTE_READ</code>，因此<code>.text</code>在内存中可执行、可读，但不可写</p>
<p>为了让他可写，就要加上W属性：</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#d19a66">0x60000020</span><span style="color:#56b6c2">+</span><span style="color:#d19a66">0x80000000</span><span style="color:#56b6c2">=</span><span style="color:#d19a66">0xE0000020</span>
</span></span></code></pre></div><p>因此，要把<code>.text</code>节的<code>Characteristics</code>字段改成<code>0xE0000020</code></p></div>
</div>
<h4 id="清除绑定导入表">清除绑定导入表
</h4><p>PE文件中的<code>DataDirectory[12]</code>（绑定导入表）用于加速DLL加载，这个我们之前没有提到</p>
<p>它的存在可能会干扰我们修改过的导入表，最简单的方法是直接将其RVA和Size都清零，禁用该功能</p>
<h4 id="开始注入">开始注入
</h4><p>完成后，将<code>MyDll.dll</code>放在修改后的<code>notepad_patch.exe</code>同目录下，运行<code>notepad_patch.exe</code>，注入就会自动发生</p>
<h2 id="代码注入">代码注入
</h2><p>这是DLL注入的变体，我们不注入一个完整的DLL文件，而是只注入一小段独立的机器码</p>
<h3 id="原理-4">原理
</h3><p>代码注入也常被称为线程注入，我们不在<code>CreateRemoteThread</code>中调用<code>LoadLibrary</code>，而是：</p>
<ol>
<li>在目标进程中分配两块内存。一块用于<strong>代码</strong>（属性<code>PAGE_EXECUTE_READWRITE</code>），另一块用于<strong>数据/参数</strong>（属性<code>PAGE_READWRITE</code>）</li>
<li>将我们的机器码（一个函数的完整体）写入代码内存</li>
<li>将代码所需的数据（例如要调用的API地址、字符串等）打包成一个结构体，写入数据内存</li>
<li>调用<code>CreateRemoteThread</code>，将<code>lpStartAddress</code>指向代码内存的地址，<code>lpParameter</code>指向数据内存的地址</li>
</ol>
<h3 id="示例-4">示例
</h3><p>这个例子演示了如何注入一段代码，让<code>notepad.exe</code>弹出一个<code>MessageBoxA</code></p>
<h4 id="第1步定义共享结构体">第1步：定义共享结构体
</h4><p>被注入的代码无法访问注入器的内存。我们必须定义一个结构体，将所有需要的信息（API地址、字符串）打包传过去</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#c678dd">typedef</span> <span style="color:#c678dd">struct</span> <span style="color:#e06c75">_THREAD_PARAM</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// 我们需要目标进程调用 LoadLibraryA 和 GetProcAddress
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#7f848e">// 所以我们提前查好这两个API的地址传进去
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">FARPROC</span> <span style="color:#e06c75">pLoadLibrary</span>;      
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">FARPROC</span> <span style="color:#e06c75">pGetProcAddress</span>;   
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// 我们需要的数据（字符串）
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e5c07b">char</span> <span style="color:#e06c75">moduleName</span>[<span style="color:#d19a66">128</span>];     <span style="color:#7f848e">// &#34;user32.dll&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e5c07b">char</span> <span style="color:#e06c75">procName</span>[<span style="color:#d19a66">128</span>];       <span style="color:#7f848e">// &#34;MessageBoxA&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>} <span style="color:#e06c75">THREAD_PARAM</span>, <span style="color:#56b6c2">*</span><span style="color:#e06c75">PTHREAD_PARAM</span>;
</span></span></code></pre></div><h4 id="第2步被注入的函数-payload">第2步：被注入的函数 (Payload)
</h4><p><code>ThreadProc</code>就是即将被完整复制到目标进程的函数，它被设计为完全独立，只依赖传入的<code>THREAD_PARAM</code></p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#7f848e">// 定义函数指针类型，以便在代码中调用
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#c678dd">typedef</span> <span style="color:#61afef;font-weight:bold">HMODULE</span> (<span style="color:#e06c75">WINAPI</span> <span style="color:#56b6c2">*</span><span style="color:#e06c75">PFLOADLIBRARYA</span>)(<span style="color:#e06c75">LPCSTR</span>);
</span></span><span style="display:flex;"><span><span style="color:#c678dd">typedef</span> <span style="color:#61afef;font-weight:bold">FARPROC</span> (<span style="color:#e06c75">WINAPI</span> <span style="color:#56b6c2">*</span><span style="color:#e06c75">PFGETPROCADDRESS</span>)(<span style="color:#e06c75">HMODULE</span>, <span style="color:#e06c75">LPCSTR</span>);
</span></span><span style="display:flex;"><span><span style="color:#c678dd">typedef</span> <span style="color:#61afef;font-weight:bold">int</span> (<span style="color:#e06c75">WINAPI</span> <span style="color:#56b6c2">*</span><span style="color:#e06c75">PFMESSAGEBOXA</span>)(<span style="color:#e06c75">HWND</span>, <span style="color:#e06c75">LPCSTR</span>, <span style="color:#e06c75">LPCSTR</span>, <span style="color:#e06c75">UINT</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e">// 这就是我们的“有效载荷”
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e">// 它将在目标进程的内存中执行
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#e06c75">BOOL</span> <span style="color:#e06c75">WINAPI</span> <span style="color:#61afef;font-weight:bold">ThreadProc</span>(<span style="color:#e06c75">LPVOID</span> <span style="color:#e06c75">lParam</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">PTHREAD_PARAM</span> <span style="color:#e06c75">param</span> <span style="color:#56b6c2">=</span> (<span style="color:#e06c75">PTHREAD_PARAM</span>)<span style="color:#e06c75">lParam</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">HMODULE</span> <span style="color:#e06c75">hMod</span> <span style="color:#56b6c2">=</span> <span style="color:#e5c07b">NULL</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">FARPROC</span> <span style="color:#e06c75">pFunc</span> <span style="color:#56b6c2">=</span> <span style="color:#e5c07b">NULL</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// 1. 使用传入的 pLoadLibrary 地址，加载 &#34;user32.dll&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">hMod</span> <span style="color:#56b6c2">=</span> ((<span style="color:#e06c75">PFLOADLIBRARYA</span>)<span style="color:#e06c75">param</span><span style="color:#56b6c2">-&gt;</span><span style="color:#e06c75">pLoadLibrary</span>)(<span style="color:#e06c75">param</span><span style="color:#56b6c2">-&gt;</span><span style="color:#e06c75">moduleName</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> (<span style="color:#56b6c2">!</span><span style="color:#e06c75">hMod</span>) <span style="color:#c678dd">return</span> <span style="color:#e06c75">FALSE</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// 2. 使用传入的 pGetProcAddress 地址，获取 &#34;MessageBoxA&#34; 地址
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">pFunc</span> <span style="color:#56b6c2">=</span> ((<span style="color:#e06c75">PFGETPROCADDRESS</span>)<span style="color:#e06c75">param</span><span style="color:#56b6c2">-&gt;</span><span style="color:#e06c75">pGetProcAddress</span>)(<span style="color:#e06c75">hMod</span>, <span style="color:#e06c75">param</span><span style="color:#56b6c2">-&gt;</span><span style="color:#e06c75">procName</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> (<span style="color:#56b6c2">!</span><span style="color:#e06c75">pFunc</span>) <span style="color:#c678dd">return</span> <span style="color:#e06c75">FALSE</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// 3. 调用 MessageBoxA
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    ((<span style="color:#e06c75">PFMESSAGEBOXA</span>)<span style="color:#e06c75">pFunc</span>)(<span style="color:#e5c07b">NULL</span>, <span style="color:#e06c75">param</span><span style="color:#56b6c2">-&gt;</span><span style="color:#e06c75">moduleName</span>, <span style="color:#e06c75">param</span><span style="color:#56b6c2">-&gt;</span><span style="color:#e06c75">procName</span>, <span style="color:#e06c75">MB_OK</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">return</span> <span style="color:#e06c75">TRUE</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="第3步注入器-injectcode">第3步：注入器 (InjectCode)
</h4><p><code>InjectCode</code>函数负责填充<code>THREAD_PARAM</code>，分配两块远程内存，写入数据和代码，最后启动远程线程</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#e06c75">BOOL</span> <span style="color:#61afef;font-weight:bold">InjectCode</span>(<span style="color:#e06c75">DWORD</span> <span style="color:#e06c75">dwPID</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">HANDLE</span> <span style="color:#e06c75">hProcess</span> <span style="color:#56b6c2">=</span> <span style="color:#e5c07b">NULL</span>, <span style="color:#e06c75">hThread</span> <span style="color:#56b6c2">=</span> <span style="color:#e5c07b">NULL</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">LPVOID</span> <span style="color:#e06c75">pRemoteBuf</span>[<span style="color:#d19a66">2</span>] <span style="color:#56b6c2">=</span> {<span style="color:#d19a66">0</span>}; <span style="color:#7f848e">// pRemoteBuf[0] = 参数, pRemoteBuf[1] = 代码
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">THREAD_PARAM</span> <span style="color:#e06c75">param</span> <span style="color:#56b6c2">=</span> {<span style="color:#d19a66">0</span>};
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">DWORD</span> <span style="color:#e06c75">dwSize</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// 1. 填充参数结构体 (在注入器进程中)
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">HMODULE</span> <span style="color:#e06c75">hMod</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">GetModuleHandle</span>(<span style="color:#61afef;font-weight:bold">_T</span>(<span style="color:#98c379">&#34;kernel32.dll&#34;</span>));
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">param</span>.<span style="color:#e06c75">pLoadLibrary</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">GetProcAddress</span>(<span style="color:#e06c75">hMod</span>, <span style="color:#98c379">&#34;LoadLibraryA&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">param</span>.<span style="color:#e06c75">pGetProcAddress</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">GetProcAddress</span>(<span style="color:#e06c75">hMod</span>, <span style="color:#98c379">&#34;GetProcAddress&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#61afef;font-weight:bold">strcpy_s</span>(<span style="color:#e06c75">param</span>.<span style="color:#e06c75">moduleName</span>, <span style="color:#98c379">&#34;user32.dll&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#61afef;font-weight:bold">strcpy_s</span>(<span style="color:#e06c75">param</span>.<span style="color:#e06c75">procName</span>, <span style="color:#98c379">&#34;MessageBoxA&#34;</span>);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// ... (OpenProcess(PROCESS_ALL_ACCESS, FALSE, dwPID) 获取 hProcess) ...
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#c678dd">if</span> (<span style="color:#56b6c2">!</span><span style="color:#e06c75">hProcess</span>) <span style="color:#c678dd">return</span> <span style="color:#e06c75">FALSE</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// 2. 注入参数 (pRemoteBuf[0])
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">dwSize</span> <span style="color:#56b6c2">=</span> <span style="color:#c678dd">sizeof</span>(<span style="color:#e06c75">THREAD_PARAM</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">pRemoteBuf</span>[<span style="color:#d19a66">0</span>] <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">VirtualAllocEx</span>(<span style="color:#e06c75">hProcess</span>, <span style="color:#e5c07b">NULL</span>, <span style="color:#e06c75">dwSize</span>, <span style="color:#e06c75">MEM_COMMIT</span>, <span style="color:#e06c75">PAGE_READWRITE</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> (<span style="color:#56b6c2">!</span><span style="color:#e06c75">pRemoteBuf</span>[<span style="color:#d19a66">0</span>]) <span style="color:#c678dd">return</span> <span style="color:#e06c75">FALSE</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> (<span style="color:#56b6c2">!</span><span style="color:#61afef;font-weight:bold">WriteProcessMemory</span>(<span style="color:#e06c75">hProcess</span>, <span style="color:#e06c75">pRemoteBuf</span>[<span style="color:#d19a66">0</span>], (<span style="color:#e06c75">LPVOID</span>)<span style="color:#56b6c2">&amp;</span><span style="color:#e06c75">param</span>, <span style="color:#e06c75">dwSize</span>, <span style="color:#e5c07b">NULL</span>))
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">return</span> <span style="color:#e06c75">FALSE</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// 3. 注入代码 (pRemoteBuf[1])
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#7f848e">//    (InjectCode 和 ThreadProc 必须在同一个文件里)
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">dwSize</span> <span style="color:#56b6c2">=</span> (<span style="color:#e06c75">DWORD</span>)<span style="color:#e06c75">InjectCode</span> <span style="color:#56b6c2">-</span> (<span style="color:#e06c75">DWORD</span>)<span style="color:#e06c75">ThreadProc</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> (<span style="color:#e06c75">dwSize</span> <span style="color:#56b6c2">&lt;=</span> <span style="color:#d19a66">0</span>) <span style="color:#c678dd">return</span> <span style="color:#e06c75">FALSE</span>; <span style="color:#7f848e">// 确保大小正确
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">pRemoteBuf</span>[<span style="color:#d19a66">1</span>] <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">VirtualAllocEx</span>(<span style="color:#e06c75">hProcess</span>, <span style="color:#e5c07b">NULL</span>, <span style="color:#e06c75">dwSize</span>, <span style="color:#e06c75">MEM_COMMIT</span>, <span style="color:#e06c75">PAGE_EXECUTE_READWRITE</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> (<span style="color:#56b6c2">!</span><span style="color:#e06c75">pRemoteBuf</span>[<span style="color:#d19a66">1</span>]) <span style="color:#c678dd">return</span> <span style="color:#e06c75">FALSE</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> (<span style="color:#56b6c2">!</span><span style="color:#61afef;font-weight:bold">WriteProcessMemory</span>(<span style="color:#e06c75">hProcess</span>, <span style="color:#e06c75">pRemoteBuf</span>[<span style="color:#d19a66">1</span>], (<span style="color:#e06c75">LPVOID</span>)<span style="color:#e06c75">ThreadProc</span>, <span style="color:#e06c75">dwSize</span>, <span style="color:#e5c07b">NULL</span>))
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">return</span> <span style="color:#e06c75">FALSE</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// 4. 创建远程线程，执行代码
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">hThread</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">CreateRemoteThread</span>(<span style="color:#e06c75">hProcess</span>, <span style="color:#e5c07b">NULL</span>, <span style="color:#d19a66">0</span>,
</span></span><span style="display:flex;"><span>        (<span style="color:#e06c75">LPTHREAD_START_ROUTINE</span>)<span style="color:#e06c75">pRemoteBuf</span>[<span style="color:#d19a66">1</span>], <span style="color:#7f848e">// lpStartAddress = 代码地址
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>        <span style="color:#e06c75">pRemoteBuf</span>[<span style="color:#d19a66">0</span>],                         <span style="color:#7f848e">// lpParameter = 参数地址
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>        <span style="color:#d19a66">0</span>, <span style="color:#e5c07b">NULL</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> (<span style="color:#56b6c2">!</span><span style="color:#e06c75">hThread</span>) <span style="color:#c678dd">return</span> <span style="color:#e06c75">FALSE</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// ... (清理句柄) ...
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#c678dd">return</span> <span style="color:#e06c75">TRUE</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>在<code>InjectCode</code>示例中，代码大小是这样计算的：</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#e06c75">dwSize</span> <span style="color:#56b6c2">=</span> (<span style="color:#e06c75">DWORD</span>)<span style="color:#e06c75">InjectCode</span> <span style="color:#56b6c2">-</span> (<span style="color:#e06c75">DWORD</span>)<span style="color:#e06c75">ThreadProc</span>;
</span></span></code></pre></div><p>为什么呢？</p>
<p>当使用Visual C++的Release模式编译时，源代码中相邻的函数在最终的二进制文件中也物理相邻地存放，因此，<code>ThreadProc</code>函数的二进制码之后紧跟着<code>InjectCode</code>函数的二进制码</p>
<p>使用两个函数起始地址相减，就近似得到了<code>ThreadProc</code>函数的二进制码长度</p>
<h1 id="dll的卸载-dll-eject">DLL的卸载 (Dll Eject)
</h1><p><strong>注入的逆过程就是卸载（Eject），其原理是强制目标进程调用<code>FreeLibrary()</code>API</strong></p>
<p><code>FreeLibrary</code>的函数原型是：</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#e06c75">BOOL</span> <span style="color:#e06c75">WINAPI</span> <span style="color:#61afef;font-weight:bold">FreeLibrary</span>(<span style="color:#e06c75">HMODULE</span> <span style="color:#e06c75">hLibModule</span>);
</span></span></code></pre></div><p>它只接受一个参数：要卸载的DLL在目标进程中的模块句柄，也就是基地址</p>
<h2 id="示例-5">示例
</h2><div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#7f848e">#include</span> <span style="color:#7f848e">&lt;windows.h&gt;</span><span style="color:#7f848e">
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e">#include</span> <span style="color:#7f848e">&lt;tchar.h&gt;</span><span style="color:#7f848e">
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e">#include</span> <span style="color:#7f848e">&lt;tlhelp32.h&gt; // 用于CreateToolhelp32Snapshot</span><span style="color:#7f848e">
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e">// (这里需要一个FindProcessID函数，PDF中省略了，我们假设它已实现)
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#e06c75">DWORD</span> <span style="color:#61afef;font-weight:bold">FindProcessID</span>(<span style="color:#e06c75">LPCTSTR</span> <span style="color:#e06c75">szProcessName</span>); 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e06c75">BOOL</span> <span style="color:#61afef;font-weight:bold">EjectDll</span>(<span style="color:#e06c75">DWORD</span> <span style="color:#e06c75">dwPID</span>, <span style="color:#e06c75">LPCTSTR</span> <span style="color:#e06c75">szDllName</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">HANDLE</span> <span style="color:#e06c75">hSnapshot</span> <span style="color:#56b6c2">=</span> <span style="color:#e5c07b">NULL</span>, <span style="color:#e06c75">hProcess</span> <span style="color:#56b6c2">=</span> <span style="color:#e5c07b">NULL</span>, <span style="color:#e06c75">hThread</span> <span style="color:#56b6c2">=</span> <span style="color:#e5c07b">NULL</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">MODULEENTRY32</span> <span style="color:#e06c75">me</span> <span style="color:#56b6c2">=</span> {<span style="color:#c678dd">sizeof</span>(<span style="color:#e06c75">me</span>)}; <span style="color:#7f848e">// 必须初始化dwSize
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// 1. 创建工具快照，获取指定PID进程加载的所有模块（DLL）
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">hSnapshot</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">CreateToolhelp32Snapshot</span>(<span style="color:#e06c75">TH32CS_SNAPMODULE</span>, <span style="color:#e06c75">dwPID</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> (<span style="color:#e06c75">hSnapshot</span> <span style="color:#56b6c2">==</span> <span style="color:#e06c75">INVALID_HANDLE_VALUE</span>) <span style="color:#c678dd">return</span> <span style="color:#e06c75">FALSE</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// 2. 遍历模块列表
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">BOOL</span> <span style="color:#e06c75">bFound</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">FALSE</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">BOOL</span> <span style="color:#e06c75">bMore</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">Module32First</span>(<span style="color:#e06c75">hSnapshot</span>, <span style="color:#56b6c2">&amp;</span><span style="color:#e06c75">me</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">for</span> (; <span style="color:#e06c75">bMore</span>; <span style="color:#e06c75">bMore</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">Module32Next</span>(<span style="color:#e06c75">hSnapshot</span>, <span style="color:#56b6c2">&amp;</span><span style="color:#e06c75">me</span>)) {
</span></span><span style="display:flex;"><span>        <span style="color:#7f848e">// 比较模块名或路径，找到我们要卸载的DLL
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>        <span style="color:#c678dd">if</span> (<span style="color:#56b6c2">!</span><span style="color:#61afef;font-weight:bold">lstrcmpi</span>(<span style="color:#e06c75">me</span>.<span style="color:#e06c75">szModule</span>, <span style="color:#e06c75">szDllName</span>) <span style="color:#56b6c2">||</span> <span style="color:#56b6c2">!</span><span style="color:#61afef;font-weight:bold">lstrcmpi</span>(<span style="color:#e06c75">me</span>.<span style="color:#e06c75">szExePath</span>, <span style="color:#e06c75">szDllName</span>)) {
</span></span><span style="display:flex;"><span>            <span style="color:#e06c75">bFound</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">TRUE</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#c678dd">break</span>; <span style="color:#7f848e">// 找到了
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#61afef;font-weight:bold">CloseHandle</span>(<span style="color:#e06c75">hSnapshot</span>); <span style="color:#7f848e">// 关闭快照句柄
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#c678dd">if</span> (<span style="color:#56b6c2">!</span><span style="color:#e06c75">bFound</span>) <span style="color:#c678dd">return</span> <span style="color:#e06c75">FALSE</span>; <span style="color:#7f848e">// 没找到
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// 3. 获取目标进程句柄
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#c678dd">if</span> (<span style="color:#56b6c2">!</span>(<span style="color:#e06c75">hProcess</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">OpenProcess</span>(<span style="color:#e06c75">PROCESS_ALL_ACCESS</span>, <span style="color:#e06c75">FALSE</span>, <span style="color:#e06c75">dwPID</span>)))
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">return</span> <span style="color:#e06c75">FALSE</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// 4. 获取 FreeLibrary 的地址（它也在 kernel32.dll 中）
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">HMODULE</span> <span style="color:#e06c75">hModule</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">GetModuleHandle</span>(<span style="color:#61afef;font-weight:bold">_T</span>(<span style="color:#98c379">&#34;kernel32.dll&#34;</span>));
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">LPTHREAD_START_ROUTINE</span> <span style="color:#e06c75">pThreadProc</span> <span style="color:#56b6c2">=</span> (<span style="color:#e06c75">LPTHREAD_START_ROUTINE</span>)<span style="color:#61afef;font-weight:bold">GetProcAddress</span>(<span style="color:#e06c75">hModule</span>, <span style="color:#98c379">&#34;FreeLibrary&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// 5. 创建远程线程
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#7f848e">// 线程函数 = FreeLibrary
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#7f848e">// 线程参数 = 要卸载的DLL的基地址 (me.modBaseAddr)
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">hThread</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">CreateRemoteThread</span>(<span style="color:#e06c75">hProcess</span>, <span style="color:#e5c07b">NULL</span>, <span style="color:#d19a66">0</span>, <span style="color:#e06c75">pThreadProc</span>, <span style="color:#e06c75">me</span>.<span style="color:#e06c75">modBaseAddr</span>, <span style="color:#d19a66">0</span>, <span style="color:#e5c07b">NULL</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> (<span style="color:#e06c75">hThread</span> <span style="color:#56b6c2">==</span> <span style="color:#e5c07b">NULL</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#61afef;font-weight:bold">CloseHandle</span>(<span style="color:#e06c75">hProcess</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">return</span> <span style="color:#e06c75">FALSE</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#61afef;font-weight:bold">WaitForSingleObject</span>(<span style="color:#e06c75">hThread</span>, <span style="color:#e06c75">INFINITE</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#61afef;font-weight:bold">CloseHandle</span>(<span style="color:#e06c75">hThread</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#61afef;font-weight:bold">CloseHandle</span>(<span style="color:#e06c75">hProcess</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">return</span> <span style="color:#e06c75">TRUE</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e5c07b">int</span> <span style="color:#61afef;font-weight:bold">_tmain</span>(<span style="color:#e5c07b">int</span> <span style="color:#e06c75">argc</span>, <span style="color:#e06c75">TCHAR</span><span style="color:#56b6c2">*</span> <span style="color:#e06c75">argv</span>[]) {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">DWORD</span> <span style="color:#e06c75">dwPID</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">FindProcessID</span>(<span style="color:#61afef;font-weight:bold">_T</span>(<span style="color:#98c379">&#34;notepad.exe&#34;</span>));
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> (<span style="color:#e06c75">dwPID</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#61afef;font-weight:bold">EjectDll</span>(<span style="color:#e06c75">dwPID</span>, <span style="color:#61afef;font-weight:bold">_T</span>(<span style="color:#98c379">&#34;MyDll.dll&#34;</span>));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">return</span> <span style="color:#d19a66">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/re/">Re</a>
        
    </section>


    <section class="article-lastmod">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



        <span>
            最后更新于 2025-11-02
        </span>
    </section></footer>


    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">相关文章</h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="has-image">
    <a href="/p/%E9%80%86%E5%90%91%E5%9F%BA%E7%A1%805%E6%B7%B7%E6%B7%86%E6%8A%80%E6%9C%AF/">
        
        
            <div class="article-image">
                
                    <img src="http://picture.928330.xyz/typora/1942e99d5e2b2ffc67184eba1cfe48ea.jpg" loading="lazy" data-key="" data-hash="http://picture.928330.xyz/typora/1942e99d5e2b2ffc67184eba1cfe48ea.jpg"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">逆向基础5：混淆技术</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/%E9%80%86%E5%90%91%E5%9F%BA%E7%A1%804pe%E6%96%87%E4%BB%B6/">
        
        
            <div class="article-image">
                
                    <img src="http://picture.928330.xyz/typora/d9dc6363235d1bc4e4bf2e1debb14e39.jpg" loading="lazy" data-key="" data-hash="http://picture.928330.xyz/typora/d9dc6363235d1bc4e4bf2e1debb14e39.jpg"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">逆向基础4：PE文件</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/%E9%80%86%E5%90%91%E5%9F%BA%E7%A1%803elf%E6%96%87%E4%BB%B6/">
        
        
            <div class="article-image">
                
                    <img src="http://picture.928330.xyz/typora/16e7b03d07acb9525b5cade30292739c.jpg" loading="lazy" data-key="" data-hash="http://picture.928330.xyz/typora/16e7b03d07acb9525b5cade30292739c.jpg"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">逆向基础3：ELF文件</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/%E9%80%86%E5%90%91%E5%9F%BA%E7%A1%802%E5%8F%AF%E6%89%A7%E8%A1%8C%E6%96%87%E4%BB%B6%E6%A6%82%E8%BF%B0/">
        
        
            <div class="article-image">
                
                    <img src="http://picture.928330.xyz/typora/fd5a5ff7fbfb389c2ea3c8f72e2c9e69.png" loading="lazy" data-key="" data-hash="http://picture.928330.xyz/typora/fd5a5ff7fbfb389c2ea3c8f72e2c9e69.png"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">逆向基础2：可执行文件概述</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/%E9%80%86%E5%90%91%E5%9F%BA%E7%A1%801%E5%86%85%E5%AD%98%E4%B8%8E%E6%B1%87%E7%BC%96/">
        
        
            <div class="article-image">
                
                    <img src="http://picture.928330.xyz/typora/b0cd314b8588e4e7b43938004c890c48.png" loading="lazy" data-key="" data-hash="http://picture.928330.xyz/typora/b0cd314b8588e4e7b43938004c890c48.png"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">逆向基础1：内存与汇编</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    <script src='//unpkg.com/@waline/client@v2/dist/waline.js'></script>
<link href='//unpkg.com/@waline/client@v2/dist/waline.css' rel='stylesheet'/>
<div id="waline" class="waline-container"></div>
<style>
    .waline-container {
        background-color: var(--card-background);
        border-radius: var(--card-border-radius);
        box-shadow: var(--shadow-l1);
        padding: var(--card-padding);
        --waline-font-size: var(--article-font-size);
    }
    .waline-container .wl-count {
        color: var(--card-text-color-main);
    }
</style><script>
    
    Waline.init({"dark":"html[data-scheme=\"dark\"]","el":"#waline","emoji":["https://npm.elemecdn.com/@waline/emojis@1.1.0/bilibili","https://npm.elemecdn.com/@waline/emojis@1.1.0/bmoji","https://npm.elemecdn.com/@waline/emojis@1.1.0/weibo"],"lang":"zh-cn","locale":{"admin":"Admin","placeholder":null},"pageview":true,"placeholder":"欢迎评论，不好的评论我会删🙄💅🏻","requiredMeta":["name","email","url"],"serverURL":"https://comment.928330.xyz/"});
</script>

    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 2025 - 2025 kakahuote | 引用请注明文章链接
    </section>

    <section class="running-time">
        距离小站第一行代码被置下已经过去
        <span id="runningdays" class="running-days"></span>    
    </section>  

    <section class="powerby">
        使用 <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> 构建 <br />
        主题 <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.30.0">Stack</a></b> 由 <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> 设计 <br />

        
        <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
        <script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>
        

        <span>...当然还有kakahuote🤓👆</span>
    </section>
</footer>

    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >
    
    <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>
<style>
   
   
   
  @font-face {
   font-family: 'yuan';
   src: url('https://blog.928330.xyz/font/round.ttf') format('truetype');
  }

   
   
   
  :root {
   --base-font-family: 'yuan';
   --code-font-family: 'yuan';
  }

   
   
   
   
   
  #backTopBtn {
   position: fixed;
   bottom: 30px;
   right: 450px;
   z-index: 99;
   cursor: pointer;
   width: 32px;
   height: 32px;
   background-image: url('/icons/backTop.svg');
   background-size: cover;
   background-color: rgba(255, 255, 255, 0.9);
   border-radius: 50%;
   box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
   transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
   transform-origin: center center;
    
   animation: gentleFloat 3s ease-in-out infinite;
    
   overflow: visible;
  }

   
  [data-scheme="dark"] #backTopBtn {
   background-image: url('/icons/backTop-dark.svg') !important;
   background-color: rgba(0, 0, 0, 0.8) !important;
   box-shadow: 0 4px 20px rgba(255, 255, 255, 0.1) !important;
  }

   
  @media (prefers-color-scheme: dark) {
    #backTopBtn {
      background-image: url('/icons/backTop-dark.svg') !important;
      background-color: rgba(0, 0, 0, 0.8) !important;
      box-shadow: 0 4px 20px rgba(255, 255, 255, 0.1) !important;
    }
    
    .button-ripple {
      background-image: url('/icons/backTop-dark.svg') !important;
       
    }
  }

   
  html[data-scheme="dark"] #backTopBtn,
  body[data-scheme="dark"] #backTopBtn,
  .dark #backTopBtn,
  .dark-mode #backTopBtn {
    background-image: url('/icons/backTop-dark.svg') !important;
    background-color: rgba(0, 0, 0, 0.8) !important;
    box-shadow: 0 4px 20px rgba(255, 255, 255, 0.1) !important;
  }

  html[data-scheme="dark"] .button-ripple,
  body[data-scheme="dark"] .button-ripple,
  .dark .button-ripple,
  .dark-mode .button-ripple {
    background-image: url('/icons/backTop-dark.svg') !important;
     
  }

   
  [data-scheme="dark"] #backTopBtn::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    border-left: 6px solid transparent;
    border-right: 6px solid transparent;
    border-bottom: 10px solid #ffffff;
    transform: translate(-50%, -50%);
    z-index: 1;
     
    display: var(--show-css-arrow, none);
  }

   
  #backTopBtn::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    border-left: 6px solid transparent;
    border-right: 6px solid transparent;
    border-bottom: 10px solid #000000;
    transform: translate(-50%, -50%);
    z-index: 1;
     
    display: var(--show-css-arrow, none);
  }

   
  @keyframes gentleFloat {
   0%, 100% { transform: translateY(0px); }
   50% { transform: translateY(-6px); }
  }

   
  .button-ripple {
   position: absolute;
   top: 0;
   left: 0;
   width: 32px;
   height: 32px;
   border-radius: 50%;
   background-image: url('/icons/backTop.svg');
   background-size: cover;
   background-repeat: no-repeat;
   background-position: center;
   pointer-events: none;
   z-index: -1;
   animation: buttonRippleExpand 2.5s linear infinite;
   transform-origin: center center;
    
   will-change: transform, opacity;
   backface-visibility: hidden;
   perspective: 1000px;
   contain: layout style;
    
   transform: translateZ(0);
    
   transition: animation-duration 0.3s ease;
    
   --show-css-arrow: none !important;
    
   opacity: var(--ripple-opacity, 0.8) !important;
  }

   
  [data-scheme="dark"] .button-ripple {
   background-image: url('/icons/backTop-dark.svg') !important;
    
    
   --show-css-arrow: none !important;
  }

   
  @media (prefers-color-scheme: dark) {
    .button-ripple {
      background-image: url('/icons/backTop-dark.svg') !important;
       
       
      --show-css-arrow: none !important;
    }
  }

   
  .button-ripple.hover-mode {
   animation-duration: 1s;
  }

  @keyframes buttonRippleExpand {
   0% {
     --ripple-opacity: 0.8;
     transform: scale(1);
   }
   2% {
     --ripple-opacity: 0.78;
     transform: scale(1.02);
   }
   4% {
     --ripple-opacity: 0.76;
     transform: scale(1.04);
   }
   6% {
     --ripple-opacity: 0.74;
     transform: scale(1.06);
   }
   8% {
     --ripple-opacity: 0.72;
     transform: scale(1.08);
   }
   10% {
     --ripple-opacity: 0.7;
     transform: scale(1.1);
   }
   12% {
     --ripple-opacity: 0.68;
     transform: scale(1.12);
   }
   14% {
     --ripple-opacity: 0.66;
     transform: scale(1.14);
   }
   16% {
     --ripple-opacity: 0.64;
     transform: scale(1.16);
   }
   18% {
     --ripple-opacity: 0.62;
     transform: scale(1.18);
   }
   20% {
     --ripple-opacity: 0.6;
     transform: scale(1.2);
   }
   22% {
     --ripple-opacity: 0.58;
     transform: scale(1.22);
   }
   24% {
     --ripple-opacity: 0.56;
     transform: scale(1.24);
   }
   26% {
     --ripple-opacity: 0.54;
     transform: scale(1.26);
   }
   28% {
     --ripple-opacity: 0.52;
     transform: scale(1.28);
   }
   30% {
     --ripple-opacity: 0.5;
     transform: scale(1.3);
   }
   32% {
     --ripple-opacity: 0.48;
     transform: scale(1.32);
   }
   34% {
     --ripple-opacity: 0.46;
     transform: scale(1.34);
   }
   36% {
     --ripple-opacity: 0.44;
     transform: scale(1.36);
   }
   38% {
     --ripple-opacity: 0.42;
     transform: scale(1.38);
   }
   40% {
     --ripple-opacity: 0.4;
     transform: scale(1.4);
   }
   42% {
     --ripple-opacity: 0.38;
     transform: scale(1.42);
   }
   44% {
     --ripple-opacity: 0.36;
     transform: scale(1.44);
   }
   46% {
     --ripple-opacity: 0.34;
     transform: scale(1.46);
   }
   48% {
     --ripple-opacity: 0.32;
     transform: scale(1.48);
   }
   50% {
     --ripple-opacity: 0.3;
     transform: scale(1.5);
   }
   52% {
     --ripple-opacity: 0.28;
     transform: scale(1.52);
   }
   54% {
     --ripple-opacity: 0.26;
     transform: scale(1.54);
   }
   56% {
     --ripple-opacity: 0.24;
     transform: scale(1.56);
   }
   58% {
     --ripple-opacity: 0.22;
     transform: scale(1.58);
   }
   60% {
     --ripple-opacity: 0.2;
     transform: scale(1.6);
   }
   62% {
     --ripple-opacity: 0.18;
     transform: scale(1.62);
   }
   64% {
     --ripple-opacity: 0.16;
     transform: scale(1.64);
   }
   66% {
     --ripple-opacity: 0.14;
     transform: scale(1.66);
   }
   68% {
     --ripple-opacity: 0.12;
     transform: scale(1.68);
   }
   70% {
     --ripple-opacity: 0.1;
     transform: scale(1.7);
   }
   72% {
     --ripple-opacity: 0.08;
     transform: scale(1.72);
   }
   74% {
     --ripple-opacity: 0.07;
     transform: scale(1.74);
   }
   76% {
     --ripple-opacity: 0.06;
     transform: scale(1.76);
   }
   78% {
     --ripple-opacity: 0.05;
     transform: scale(1.78);
   }
   80% {
     --ripple-opacity: 0.04;
     transform: scale(1.8);
   }
   82% {
     --ripple-opacity: 0.035;
     transform: scale(1.82);
   }
   84% {
     --ripple-opacity: 0.03;
     transform: scale(1.84);
   }
   86% {
     --ripple-opacity: 0.025;
     transform: scale(1.86);
   }
   88% {
     --ripple-opacity: 0.02;
     transform: scale(1.88);
   }
   90% {
     --ripple-opacity: 0.015;
     transform: scale(1.9);
   }
   92% {
     --ripple-opacity: 0.01;
     transform: scale(1.92);
   }
   94% {
     --ripple-opacity: 0.008;
     transform: scale(1.94);
   }
   96% {
     --ripple-opacity: 0.005;
     transform: scale(1.96);
   }
   98% {
     --ripple-opacity: 0.002;
     transform: scale(1.98);
   }
   100% {
     --ripple-opacity: 0;
     transform: scale(2.0);
   }
  }

   
  .button-tooltip {
   position: absolute;
   bottom: 45px;
   right: 450px;
   background: rgba(0, 0, 0, 0.8);
   color: white;
   padding: 8px 12px;
   border-radius: 6px;
   font-size: 12px;
   white-space: nowrap;
   opacity: 0;
   transform: translateY(10px);
   transition: all 0.3s ease;
   pointer-events: none;
   z-index: 100;
  }

  .button-tooltip.show {
   opacity: 1;
   transform: translateY(0);
  }

  .button-tooltip::after {
   content: '';
   position: absolute;
   top: 100%;
   left: 50%;
   transform: translateX(-50%);
   border: 5px solid transparent;
   border-top-color: rgba(0, 0, 0, 0.8);
  }

   
  .hover-ripple-effect {
   display: none;
  }

   
  #backTopBtn:hover {
   transform: translateY(-8px) scale(1.1);
   box-shadow: 0 8px 30px rgba(0, 0, 0, 0.25);
   background-color: rgba(255, 255, 255, 1);
  }

   
  #backTopBtn.sprinting {
   animation: energyBurst 1.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
  }

  @keyframes energyBurst {
   0% {
     transform: scale(1) rotate(0deg);
     opacity: 1;
     filter: brightness(1) hue-rotate(0deg);
     box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
   }
   15% {
     transform: scale(1.2) rotate(0deg);
     opacity: 1;
     filter: brightness(1.2) hue-rotate(0deg);
     box-shadow: 0 0 25px rgba(255, 215, 0, 0.8), 0 0 50px rgba(255, 107, 107, 0.6);
   }
   30% {
     transform: scale(1.4) rotate(0deg);
     opacity: 1;
     filter: brightness(1.4) hue-rotate(60deg);
     box-shadow: 0 0 35px rgba(255, 182, 193, 0.8), 0 0 70px rgba(255, 215, 0, 0.6);
   }
   45% {
     transform: scale(1.6) rotate(0deg);
     opacity: 1;
     filter: brightness(1.6) hue-rotate(120deg);
     box-shadow: 0 0 45px rgba(173, 216, 230, 0.8), 0 0 90px rgba(255, 182, 193, 0.6);
   }
   60% {
     transform: scale(1.4) rotate(0deg);
     opacity: 1;
     filter: brightness(1.4) hue-rotate(180deg);
     box-shadow: 0 0 35px rgba(144, 238, 144, 0.8), 0 0 70px rgba(173, 216, 230, 0.6);
   }
   75% {
     transform: scale(1.2) rotate(0deg);
     opacity: 1;
     filter: brightness(1.2) hue-rotate(240deg);
     box-shadow: 0 0 25px rgba(255, 215, 0, 0.8), 0 0 50px rgba(144, 238, 144, 0.6);
   }
   90% {
     transform: scale(1.05) rotate(0deg);
     opacity: 1;
     filter: brightness(1.05) hue-rotate(300deg);
     box-shadow: 0 0 15px rgba(255, 107, 107, 0.6), 0 0 30px rgba(255, 215, 0, 0.4);
   }
   100% {
     transform: scale(1) rotate(0deg);
     opacity: 1;
     filter: brightness(1) hue-rotate(360deg);
     box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
   }
  }

   
  #backTopBtn.reappearing {
   animation: reappear 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
  }

   
  #backTopBtn.exploding {
   animation: explosionTransition 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
    
   z-index: 1000;
  }

   
  #backTopBtn.exploding .button-ripple {
   opacity: 0;
   animation-play-state: paused;
  }

  @keyframes explosionTransition {
   0% {
     transform: scale(1.6) rotate(0deg);
     opacity: 1;
     filter: brightness(1.6) hue-rotate(0deg);
     box-shadow: 0 0 50px rgba(255, 215, 0, 0.8), 0 0 100px rgba(255, 107, 107, 0.6);
   }
   30% {
     transform: scale(1.4) rotate(5deg);
     opacity: 1;
     filter: brightness(1.4) hue-rotate(120deg);
     box-shadow: 0 0 40px rgba(255, 182, 193, 0.8), 0 0 80px rgba(255, 215, 0, 0.6);
   }

   100% {
     transform: scale(1) rotate(0deg);
     opacity: 1;
     filter: brightness(1) hue-rotate(360deg);
     box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
   }
  }

  @keyframes reappear {
   0% {
     transform: scale(0.85);
     opacity: 0.7;
   }
   50% {
     transform: scale(1.05);
     opacity: 1;
   }
   100% {
     transform: scale(1);
     opacity: 1;
   }
  }

  #backTopBtn.rotating {
   animation: rotate360 0.6s ease-in-out;
  }

  @keyframes rotate360 {
   0% { transform: rotate(0deg); }
   100% { transform: rotate(360deg); }
  }

   
  .particle {
   position: absolute;
   top: 50%;
   left: 50%;
   width: 4px;
   height: 4px;
   background: radial-gradient(circle, #fff, #ffd700, #ff69b4, #87ceeb);
   border-radius: 50%;
   pointer-events: none;
   z-index: -2;
   animation: particleExplode 1s ease-out forwards;
  }

  @keyframes particleExplode {
   0% {
     transform: translate(-50%, -50%) scale(0);
     opacity: 1;
   }
   50% {
     opacity: 1;
   }
   100% {
     transform: translate(-50%, -50%) scale(1) translate(var(--x), var(--y));
     opacity: 0;
   }
  }

   
  .energy-wave {
   position: absolute;
   top: 50%;
   left: 50%;
   width: 0;
   height: 0;
   border: 2px solid transparent;
   border-radius: 50%;
   pointer-events: none;
   z-index: -3;
   animation: energyWave 1.2s ease-out forwards;
  }

  @keyframes energyWave {
   0% {
     width: 0;
     height: 0;
     border-color: rgba(255, 215, 0, 0.8);
     opacity: 1;
   }
   100% {
     width: 120px;
     height: 120px;
     border-color: rgba(255, 215, 0, 0);
     opacity: 0;
   }
  }

   
  .hero-aura {
   position: absolute;
   top: 50%;
   left: 50%;
   width: 100%;
   height: 100%;
   border-radius: 50%;
   background: conic-gradient(from 0deg, #ffd700, #ff69b4, #87ceeb, #98fb98, #ffa07a, #ffd700);
   background-size: 200% 200%;
   pointer-events: none;
   z-index: -4;
   animation: heroAura 2s linear infinite;
   opacity: 0;
   transition: opacity 0.3s ease;
  }

  #backTopBtn.sprinting .hero-aura {
   opacity: 0.6;
  }

  @keyframes heroAura {
   0% {
     background-position: 0% 0%;
     transform: translate(-50%, -50%) rotate(0deg);
   }
   100% {
     background-position: 100% 100%;
     transform: translate(-50%, -50%) rotate(360deg);
   }
  }

   
      @media (max-width: 768px) {
     #backTopBtn {
       left: 20px !important;  
       right: auto !important;
       bottom: 20px;
       width: 28px;
       height: 28px;
     }
     
     .button-tooltip {
       left: 20px !important;  
       right: auto !important;
       bottom: 35px;
     }
    }
  
    @media (max-width: 480px) {
     #backTopBtn {
       left: 15px !important;  
       right: auto !important;
       bottom: 15px;
       width: 26px;
       height: 26px;
     }
     
     .button-tooltip {
       left: 15px !important;
       right: auto !important;
       bottom: 31px;
     }
    }

   
   
   
  .no-text-selection {
    -webkit-user-select: none;  
    -moz-user-select: none;     
    -ms-user-select: none;      
    user-select: none;          
  }

   
   
   
  #rope-container {
    position: fixed;
    top: 0;
    left: 20px;
    z-index: 10000;
    width: 50px;
    height: 480px;
    pointer-events: none;
  }
  
   
  #rope-physics-container {
    pointer-events: auto !important;
  }
  
   
  #rope-svg-container svg {
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
  }
  
  #rope-svg-container path {
    transition: all 0.1s ease-out;
  }
  
   
  #rope-svg-container path,
  #rope-path {
    stroke: #4b2b0f !important;
    stroke-width: 2.5 !important;
  }
  
   
  #rope-svg-container svg path {
    stroke: #4b2b0f !important;
    stroke-width: 2.5 !important;
  }
  


  #rope {
    position: absolute;
    top: -80px;
    left: 50%;
    width: 3px;
    height: 400px;
    background: linear-gradient(to bottom, #654321, #8B4513, #A0522D, #8B4513, #654321);
    border-radius: 1.5px;
    transform: translateX(-50%);
    pointer-events: auto;
    transition: all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    box-shadow: 0 1px 3px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.1);
  }

  #pull-ring {
    position: absolute;
    top: 300px;
    left: 50%;
    font-size: 20px;
    color: #ffffff;
    text-shadow: 0 0 8px rgba(255, 255, 255, 0.8);
    transform: translateX(-50%);
    pointer-events: auto;
    transition: all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
  }

  #rope:hover {
    box-shadow: 0 2px 6px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.2);
  }

  #pull-ring:hover {
    transform: translateX(-50%) scale(1.2);
    text-shadow: 0 0 12px rgba(255, 255, 255, 1);
    filter: drop-shadow(0 4px 8px rgba(0,0,0,0.5));
  }

   
   
   
  .highlight {
   max-height: 400px;
   overflow: hidden;
   position: relative;
   transition: max-height 0.3s ease-out;
  }

  .code-show {
   max-height: none !important;
  }

  .code-more-box {
   width: 100%;
   padding-top: 20px;
   background-image: linear-gradient(to bottom, rgba(255, 255, 255, 0), #fff);
   position: absolute;
   left: 0;
   right: 0;
   bottom: 0;
   z-index: 1;
   text-align: center;
  }

  .code-more-btn {
   display: inline-block;
   padding: 5px 15px;
   background: #f0f0f5;
   border-radius: 5px;
   cursor: pointer;
   font-size: 0.9em;
  }

   
   
   
  #particles-js {
   position: fixed;
   top: 0;
   left: 0;
    width: 100vw;
    height: 100vh;
   z-index: -1;
    pointer-events: none;
  }
  
  #particles-js canvas {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
  }

   
   
   
  .toc-lock-btn {
    position: absolute;
    top: 32px;
    right: 5px;
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    border-radius: 50%;
    transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    background: rgba(0, 0, 0, 0.05);
    color: rgba(0, 0, 0, 0.7);
    z-index: 100;
    border: 1px solid rgba(0, 0, 0, 0.1);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }
  
  .toc-lock-btn:hover {
    background: rgba(0, 0, 0, 0.1);
    transform: scale(1.1);
    border-color: rgba(0, 0, 0, 0.2);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
  }
  
  .toc-lock-btn:active {
    transform: scale(0.95);
  }
  
   
  .toc-lock-btn:focus {
    outline: none;
    border-color: rgba(0, 0, 0, 0.4);
    box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1), 0 2px 8px rgba(0, 0, 0, 0.1);
    background: rgba(0, 0, 0, 0.08);
  }
  
  .toc-lock-btn:focus-visible {
    outline: none;
    border-color: rgba(0, 0, 0, 0.4);
    box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1), 0 2px 8px rgba(0, 0, 0, 0.1);
    background: rgba(0, 0, 0, 0.08);
  }
  
  .toc-lock-btn.locked {
    color: rgba(0, 0, 0, 0.9);
    background: rgba(0, 0, 0, 0.1);
    border-color: rgba(0, 0, 0, 0.3);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
  }
  
  .toc-lock-btn.locked:hover {
    background: rgba(0, 0, 0, 0.15);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.25);
  }
  
  .toc-lock-btn.locked .lock-icon.locked {
    display: block;
  }
  
  .toc-lock-btn.locked .lock-icon.unlocked {
    display: none;
  }
  
  .toc-lock-btn .lock-icon.locked {
    display: none;
  }
  
  .toc-lock-btn .lock-icon.unlocked {
    display: block;
  }
  
  .toc-lock-btn .lock-icon {
    width: 14px;
    height: 14px;
    stroke: currentColor;
    fill: none;
    stroke-width: 2.5;
    stroke-linecap: round;
    stroke-linejoin: round;
    transition: all 0.3s ease;
  }
  
   
  .toc-lock-label {
    position: absolute;
    top: 38px;
    right: 28px;
    font-size: 16px;
    color: rgba(0, 0, 0, 0.6);
    font-weight: 700;
    z-index: 100;
    user-select: none;
    pointer-events: none;
    line-height: 1;
    display: flex;
    align-items: center;
  }

   
  [data-scheme="dark"] .toc-lock-btn {
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(255, 255, 255, 0.1);
    color: rgba(255, 255, 255, 0.7);
  }
  
  [data-scheme="dark"] .toc-lock-btn:hover {
    background: rgba(255, 255, 255, 0.1);
    border-color: rgba(255, 255, 255, 0.2);
    box-shadow: 0 4px 16px rgba(255, 255, 255, 0.15);
  }
  
   
  [data-scheme="dark"] .toc-lock-btn:focus,
  [data-scheme="dark"] .toc-lock-btn:focus-visible {
    outline: none;
    border-color: rgba(255, 255, 255, 0.4);
    box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.1), 0 2px 8px rgba(255, 255, 255, 0.1);
    background: rgba(255, 255, 255, 0.08);
  }
  
  [data-scheme="dark"] .toc-lock-btn.locked {
    color: rgba(255, 255, 255, 0.9);
    background: rgba(255, 255, 255, 0.1);
    border-color: rgba(255, 255, 255, 0.3);
    box-shadow: 0 2px 8px rgba(255, 255, 255, 0.2);
  }
  
  [data-scheme="dark"] .toc-lock-btn.locked:hover {
    background: rgba(255, 255, 255, 0.15);
    box-shadow: 0 4px 16px rgba(255, 255, 255, 0.25);
  }
  
   
  [data-scheme="dark"] .toc-lock-label {
    color: rgba(255, 255, 255, 0.6);
  }

   
  #TableOfContents[data-scrollspy-disabled="true"] {
    opacity: 0.8 !important;
  }
  
  #TableOfContents[data-scrollspy-disabled="true"] .active-class {
     
    display: block !important;
    opacity: 1 !important;
  }
  
  #TableOfContents[data-scrollspy-disabled="true"] a {
    cursor: pointer !important;
  }
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>

<script>
   
   
   

  let s1 = '2025-5-8 15:00:00'; 
  s1 = new Date(s1.replace(/-/g, "/"));
  let s2 = new Date();
  let timeDifference = s2.getTime() - s1.getTime();

  let days = Math.floor(timeDifference / (1000 * 60 * 60 * 24));
  let hours = Math.floor((timeDifference % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
  let minutes = Math.floor((timeDifference % (1000 * 60 * 60)) / (1000 * 60));

  let result = days + "天" + hours + "小时" + minutes + "分钟";
  if (document.getElementById('runningdays')) {
      document.getElementById('runningdays').innerHTML = result;
  }
  
   
   
   
  
  

  function startContinuousRipple(button) {
   
   const buttonRipple = document.createElement('div');
   buttonRipple.className = 'button-ripple';
   button.appendChild(buttonRipple);
   
   
   button.buttonRipple = buttonRipple;
  }
  
  

  function createContinuousRipple(button) {
   
   if (button.querySelector('.continuous-ripple')) {
     return;
   }
   
   
   const rippleContainer = document.createElement('div');
   rippleContainer.className = 'ripple-container continuous-ripple';
   
   
   const ripple = document.createElement('div');
   ripple.className = 'ripple';
   ripple.style.background = 'radial-gradient(circle, rgba(255, 107, 107, 0.8) 0%, rgba(255, 255, 255, 0.9) 100%)';
   
   rippleContainer.appendChild(ripple);
   button.appendChild(rippleContainer);
   
   
   setTimeout(() => {
     if (rippleContainer.parentNode) {
       rippleContainer.parentNode.removeChild(rippleContainer);
     }
   }, 800);
  }
  
  

  function createHoverRipple(button) {
   
   if (button.buttonRipple) {
     
     button.buttonRipple.style.animationDuration = '1s';
     button.buttonRipple.classList.add('hover-mode');
   }
  }
  
  

  function showTooltip(button) {
   
   hideTooltip();
   
   
   const tooltip = document.createElement('div');
   tooltip.className = 'button-tooltip';
   tooltip.textContent = '返回顶部';
   document.body.appendChild(tooltip);
   
   
   setTimeout(() => {
     tooltip.classList.add('show');
   }, 10);
   
   
   button.tooltip = tooltip;
  }
  
  

  function hideTooltip() {
   const existingTooltip = document.querySelector('.button-tooltip');
   if (existingTooltip) {
     existingTooltip.classList.remove('show');
     setTimeout(() => {
       if (existingTooltip.parentNode) {
         existingTooltip.parentNode.removeChild(existingTooltip);
       }
     }, 300);
   }
  }
  
  

  function createRippleEffect(button) {
   
   
   
   const energyWave = document.createElement('div');
   energyWave.className = 'energy-wave';
   document.body.appendChild(energyWave);
   
   
   createParticleExplosion(button);
   
   
   setTimeout(() => {
     if (energyWave.parentNode) {
       energyWave.parentNode.removeChild(energyWave);
     }
   }, 1200);
  }

  

  function createParticleExplosion(button) {
   const particleCount = 16; 
   
   
   const particleColors = [
     'radial-gradient(circle, #ff6b6b, #ffd93d, #6bcf7f, #4d96ff)',
     'radial-gradient(circle, #ff8e8e, #ffed4e, #7ddb8f, #6ba6ff)',
     'radial-gradient(circle, #ffa1a1, #fff15f, #8ee79f, #89b6ff)',
     'radial-gradient(circle, #ffb4b4, #fff570, #9ff3af, #a7c6ff)'
   ];
   
   for (let i = 0; i < particleCount; i++) {
     const particle = document.createElement('div');
     particle.className = 'particle';
     
     
     const randomColor = particleColors[Math.floor(Math.random() * particleColors.length)];
     particle.style.background = randomColor;
     
     
     const angle = (i / particleCount) * 2 * Math.PI;
     const distance = 40 + Math.random() * 30; 
     const x = Math.cos(angle) * distance;
     const y = Math.sin(angle) * distance;
     
     particle.style.setProperty('--x', `${x}px`);
     particle.style.setProperty('--y', `${y}px`);
     
     
     particle.style.animationDelay = `${Math.random() * 0.4}s`;
     
     button.appendChild(particle);
     
     
     setTimeout(() => {
       if (particle.parentNode) {
         particle.parentNode.removeChild(particle);
       }
     }, 1000);
   }
  }

   
   
   
  

  function initScrollTop() {
   let rightSideBar = document.querySelector(".right-sidebar");
   if (!rightSideBar) {
    return;
   }

   
   let btn = document.createElement("div");
   btn.id = "backTopBtn";
   let isRotating = false; 

   
   const heroAura = document.createElement('div');
   heroAura.className = 'hero-aura';
   btn.appendChild(heroAura);

   
   btn.addEventListener('mouseenter', function() {
     createHoverRipple(this);
     showTooltip(this);
   });
   
   
   btn.addEventListener('mouseleave', function() {
     if (this.buttonRipple) {
       
       this.buttonRipple.style.animationDuration = '2s';
       this.buttonRipple.classList.remove('hover-mode');
     }
     hideTooltip();
   });

   btn.onclick = function() {
    if (!isRotating) {
     isRotating = true;
     backToTop(this, () => {
      isRotating = false; 
     });
    }
   };
   rightSideBar.appendChild(btn);

   
   btn.style.display = "block";
   
   
   startContinuousRipple(btn);
  }

  

  function backToTop(button, onComplete) {
   
   button.classList.add('sprinting');
   
   
   if (button.buttonRipple) {
     button.buttonRipple.style.display = 'none';
   }
   
   
   createRippleEffect(button);
   
   
   window.scrollTo({ top: 0, behavior: "smooth" });
   
   
   const checkScrollComplete = () => {
     if (window.scrollY === 0) {
       
       button.classList.remove('sprinting');
       
       
       button.classList.add('exploding');
       
       
       createParticleExplosion(button);
       
       
       if (button.buttonRipple) {
         button.buttonRipple.style.display = 'block';
       }
       
       
       setTimeout(() => {
         button.classList.remove('exploding');
         
         
         if (button.buttonRipple) {
           
           button.buttonRipple.style.animationPlayState = 'paused';
           
           button.buttonRipple.style.animation = 'none';
           button.buttonRipple.offsetHeight; 
           button.buttonRipple.style.animation = 'buttonRippleExpand 2s steps(25, end) infinite';
           button.buttonRipple.style.animationPlayState = 'running';
         }
         
         button.classList.add('reappearing');
         
         
         setTimeout(() => {
           button.classList.remove('reappearing');
           if (onComplete) {
             onComplete();
           }
         }, 600);
       }, 800); 
       
       return;
     }
     requestAnimationFrame(checkScrollComplete);
   };
   
   checkScrollComplete();
  }

  
  initScrollTop();
  
   
   
   
  

  function initRope() {


    if (typeof Matter === 'undefined') {
      console.error('Matter.js 库未加载，无法初始化物理绳索。');
      return;
    }
    if (document.getElementById('rope-physics-container')) {

      return;
    }

    let ropeContainer = document.getElementById('rope-container');
    if (!ropeContainer) {
      console.error('#rope-container 元素未在 HTML 或 CSS 中找到。');
      return;
    }
    
    ropeContainer.innerHTML = '';
    ropeContainer.style.height = '100vh';
    ropeContainer.style.pointerEvents = 'none';

    const monthlyEmojis = [
      { month: 1, name: "一月", ring: "❄️", falling: "❄️", description: "寒冬腊月，雪花飞舞" },
      { month: 2, name: "二月", ring: "🏮", falling: "🏮", description: "新春正月，灯笼高挂" },
      { month: 3, name: "三月", ring: "🌸", falling: "🌸", description: "春暖花开，樱花绽放" },
      { month: 4, name: "四月", ring: "🌧️", falling: "🌧️", description: "清明时节，春雨绵绵" },
      { month: 5, name: "五月", ring: "🌺", falling: "🌺", description: "立夏时节，牡丹盛开" },
      { month: 6, name: "六月", ring: "🌻", falling: "🌻", description: "芒种时节，向日葵开" },
      { month: 7, name: "七月", ring: "🌿", falling: "🌿", description: "小暑时节，绿意盎然" },
      { month: 8, name: "八月", ring: "🍉", falling: "🍉", description: "七夕时节，西瓜清甜" },
      { month: 9, name: "九月", ring: "🍁", falling: "🍁", description: "白露时节，秋葉飘落" },
      { month: 10, name: "十月", ring: "🍂", falling: "🍂", description: "寒露时节，落叶纷飞" },
      { month: 11, name: "十一月", ring: "🍊", falling: "🍊", description: "霜降时节，柑橘飘香" },
      { month: 12, name: "十二月", ring: "🌨️", falling: "🌨️", description: "大雪时节，雪花纷飞" }
    ];
    window.timeEmojis = [
      { period: "morning", name: "早晨", emojis: ["☀️", "🌤️", "🌱", "🌺", "🌿"], description: "晨曦初露，万物苏醒" },
      { period: "noon", name: "中午", emojis: ["🌞", "🌻", "🦋", "🦜", "🐝"], description: "烈日当空，生机勃勃" },
      { period: "evening", name: "傍晚", emojis: ["🌙", "⭐", "🦉"], description: "夕阳西下，夜幕降临" }
    ];
    const currentMonth = new Date().getMonth() + 1;
    const currentEmoji = monthlyEmojis.find(emoji => emoji.month === currentMonth);
    
    const ropeContainerLeft = 20;
    const ropeContainerWidth = 50;
    const ropeAnchorX = ropeContainerLeft + (ropeContainerWidth / 2);

    const { Engine, World, Bodies, Composite, Constraint, Runner, Mouse, MouseConstraint, Events, Body } = Matter;

    const engine = Engine.create();
    const world = engine.world;
    
    
    
    
    engine.world.gravity.y = 0;

    
    
    
    const ropeSegments = 80; 
    const segmentRadius = 1.5; 
    const segmentRenderHeight = 6; 
    const segmentRenderWidth = 4; 
    const constraintLength = 2.5; 

    const ropeGroup = Matter.Body.nextGroup(true);
    const ropeChain = Composite.create({ label: 'Rope' });

    
    for (let i = 0; i < ropeSegments - 1; i++) {
      const segment = Bodies.circle(ropeAnchorX, i * constraintLength, segmentRadius, {
          collisionFilter: { group: ropeGroup },
          density: 0.1, 
          friction: 0.4, 
          frictionAir: 0.08, 
          restitution: 0.02 
      });
      Composite.add(ropeChain, segment);
    }

    
    const pullRingBody = Bodies.circle(
      ropeAnchorX,
      (ropeSegments - 1) * constraintLength,
      15,
      {
        collisionFilter: { group: ropeGroup },
        density: 0.01, 
        friction: 0.5,  
        frictionAir: 0.1, 
        restitution: 0.02 
      }
    );
    Composite.add(ropeChain, pullRingBody);
    World.add(world, ropeChain);

    
    Composite.addConstraint(ropeChain, Constraint.create({
      bodyB: ropeChain.bodies[0],
      pointA: { x: ropeAnchorX, y: 0 },
      stiffness: 1 
    }));

    for (let i = 0; i < ropeSegments - 1; i++) {
      Composite.addConstraint(ropeChain, Constraint.create({
        bodyA: ropeChain.bodies[i],
        bodyB: ropeChain.bodies[i + 1],
        
        
        
        stiffness: 0.8, 
        damping: 0.8,   
        length: constraintLength * 0.6, 
        
        render: {
          visible: false
        }
      }));
    }
    
    const domContainer = document.createElement('div');
    domContainer.id = 'rope-physics-container';
    domContainer.style.position = 'fixed';
    domContainer.style.top = '0';
    domContainer.style.left = '0';
    domContainer.style.pointerEvents = 'auto'; 
    domContainer.style.zIndex = '10000';
    document.body.appendChild(domContainer);

    
    const svgContainer = document.createElement('div');
    svgContainer.id = 'rope-svg-container';
    svgContainer.style.cssText = `
      position: absolute;
      top: 0;
      left: 0;
      width: 100px;
      height: 100vh;
      pointer-events: none;
      z-index: 1;
      overflow: visible;
    `;
    domContainer.appendChild(svgContainer);
    
    
    const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
    svg.setAttribute('width', '100');
    svg.setAttribute('height', '100vh');
    svg.setAttribute('viewBox', '0 0 100 100vh');
    svg.style.cssText = `
      position: absolute;
      top: 0;
      left: 0;
      width: 100px;
      height: 100vh;
      overflow: visible;
    `;
    svgContainer.appendChild(svg);
    
    
    const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
    const gradient = document.createElementNS('http://www.w3.org/2000/svg', 'linearGradient');
    gradient.setAttribute('id', 'ropeGradient');
    gradient.setAttribute('x1', '0%');
    gradient.setAttribute('y1', '0%');
    gradient.setAttribute('x2', '0%');
    gradient.setAttribute('y2', '100%');
    
    const stop1 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
    stop1.setAttribute('offset', '0%');
    stop1.setAttribute('stop-color', '#654321');
    
    const stop2 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
    stop2.setAttribute('offset', '25%');
    stop2.setAttribute('stop-color', '#8B4513');
    
    const stop3 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
    stop3.setAttribute('offset', '50%');
    stop3.setAttribute('stop-color', '#A0522D');
    
    const stop4 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
    stop4.setAttribute('offset', '75%');
    stop4.setAttribute('stop-color', '#8B4513');
    
    const stop5 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
    stop5.setAttribute('offset', '100%');
    stop5.setAttribute('stop-color', '#654321');
    
    gradient.appendChild(stop1);
    gradient.appendChild(stop2);
    gradient.appendChild(stop3);
    gradient.appendChild(stop4);
    gradient.appendChild(stop5);
    defs.appendChild(gradient);
    svg.appendChild(defs);
    
    
    const ropePath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    ropePath.setAttribute('fill', 'none');
    
    ropePath.setAttribute('stroke', '#4b2b0f');
    ropePath.setAttribute('stroke-width', '2.5');
    ropePath.setAttribute('stroke-linecap', 'round');
    ropePath.setAttribute('stroke-linejoin', 'round');
    ropePath.setAttribute('id', 'rope-path'); 
    svg.appendChild(ropePath);
    
    
    ropePath.setAttribute('d', `M 50 0 L 50 400`);
    
    
    
    
    
    const pullRingDiv = document.createElement('div');
    pullRingDiv.id = 'pull-ring-physics';
    pullRingDiv.innerHTML = currentEmoji.ring;
    pullRingDiv.title = `${currentEmoji.name}: ${currentEmoji.description}`;
    pullRingDiv.style.cssText = `
      font-size: 24px; cursor: grab; pointer-events: auto;
      width: 30px; height: 30px; text-align: center;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3)); position: absolute;
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      z-index: 2;
      transform: translate(40px, 300px); /* 初始位置，向右移动5px */
    `;
    
    
    pullRingDiv.addEventListener('mousedown', () => {
      pullRingDiv.style.cursor = 'grabbing';
    });
    
    pullRingDiv.addEventListener('mouseup', () => {
      pullRingDiv.style.cursor = 'grab';
    });
    
    domContainer.appendChild(pullRingDiv);
    
    
    const ropeElements = {
      svg: svg,
      path: ropePath,
      pullRing: pullRingDiv
    };

    const mouse = Mouse.create(document.body);
    const mouseConstraint = MouseConstraint.create(engine, {
      mouse: mouse,
      constraint: { 
        stiffness: 0.8, 
        render: { visible: false },
        
        length: 0,
        damping: 0.05 
      }
    });
    World.add(world, mouseConstraint);
    
    
    mouseConstraint.constraint.bodyB = null;
    
    
    Events.on(mouseConstraint, 'mousedown', (event) => {

    });
    
    
    mouseConstraint.mouse.element = document.body;
    
    
    let dragStartPosition = null;
    
    Events.on(mouseConstraint, 'startdrag', () => {
      document.body.classList.add('no-text-selection');
      
      
      if (mouseConstraint.body && mouseConstraint.body === pullRingBody) {
        dragStartPosition = {
          x: mouseConstraint.body.position.x,
          y: mouseConstraint.body.position.y
        };
      }
    });
    
    Events.on(mouseConstraint, 'enddrag', () => {
      document.body.classList.remove('no-text-selection');
      
      
      
      if (dragStartPosition) {
        
        const currentPosition = pullRingBody.position;
        const dragDistance = Math.sqrt(
          Math.pow(currentPosition.x - dragStartPosition.x, 2) +
          Math.pow(currentPosition.y - dragStartPosition.y, 2)
        );
        
        
        if (dragDistance > 1) {
          createSeasonalFalling(currentEmoji);
          
          
          Matter.Body.applyForce(pullRingBody, pullRingBody.position, { x: 0, y: 0.5 });
          
          
          const targetX = ropeAnchorX;
          const targetY = (ropeSegments - 1) * constraintLength;
          
          
          const dx = targetX - currentPosition.x;
          const dy = targetY - currentPosition.y;
          
          
          Matter.Body.applyForce(pullRingBody, pullRingBody.position, { 
            x: dx * 0.001, 
            y: dy * 0.001 
          });
          
        }
        
        
        dragStartPosition = null;
      }
    });
    


    
    (function render() {
      
      let pathData = '';
      
      
      const topPoint = { x: 50, y: 0 }; 
      pathData += `M ${topPoint.x} ${topPoint.y}`;
      
      
      ropeChain.bodies.forEach((body, index) => {
        if (index < ropeSegments - 1) { 
          const relativeX = body.position.x - ropeAnchorX + 50; 
          const relativeY = body.position.y;
          pathData += ` L ${relativeX} ${relativeY}`;
        }
      });
      
      
      const pullRingBody = ropeChain.bodies[ropeSegments - 1];
      if (pullRingBody) {
        const relativeX = pullRingBody.position.x - ropeAnchorX + 50; 
        const relativeY = pullRingBody.position.y;
        pathData += ` L ${relativeX} ${relativeY}`;
      }
      
      
      ropeElements.path.setAttribute('d', pathData);
      
      
      if (pullRingBody) {
        
        
        const adjustedX = pullRingBody.position.x - 15 + 3.5; 
        const adjustedY = pullRingBody.position.y - 15;
        
        ropeElements.pullRing.style.transform = `translate(
          ${adjustedX}px,
          ${adjustedY}px
        )`;
        

      }
      
      setTimeout(() => requestAnimationFrame(render), 1000 / 240); 
    })();
    
    
    
    const runner = Runner.create();
    
    runner.delta = 1000 / 240; 
    Runner.run(runner, engine);

    
    
    
    setTimeout(() => {
      engine.world.gravity.y = 1.2;
    }, 100); 

    
    
    
    
    
    ropeChain.bodies.forEach((body, index) => {
      Matter.Body.set(body, 'sleeping', false);
      
      body.sleepThreshold = Infinity;
    });
    
    
    engine.enableSleeping = false;
    
    
    mouseConstraint.constraint.bodyB = null;
    mouseConstraint.mouse.element = document.body;


  }

  

  function createSeasonalFalling(emojiConfig) {

   
   
   const fallingContainer = document.createElement('div');
   fallingContainer.id = 'falling-container';
   fallingContainer.style.cssText = `
     position: fixed;
     top: 0;
     left: 0;
     width: 100vw;
     height: 100vh;
     pointer-events: none;
     z-index: 9999;
     overflow: hidden;
   `;
   document.body.appendChild(fallingContainer);

   
   
   const currentHour = new Date().getHours();
   let currentTimePeriod;
   if (currentHour >= 5 && currentHour < 11) {
    currentTimePeriod = window.timeEmojis.find(t => t.period === "morning");
   } else if (currentHour >= 11 && currentHour < 17) {
    currentTimePeriod = window.timeEmojis.find(t => t.period === "noon");
   } else {
    currentTimePeriod = window.timeEmojis.find(t => t.period === "evening");
   }
   

   
   
   const totalElements = emojiConfig.month >= 11 || emojiConfig.month <= 2 ? 30 : 25; 
   let activeElements = 0;
   

   
   for (let i = 0; i < totalElements; i++) {
    setTimeout(() => {
     const element = document.createElement('div');
     
     
     let selectedEmoji, emojiType;
     if (Math.random() < 0.7) {
      selectedEmoji = emojiConfig.falling;
      emojiType = "monthly";
     } else {
      
      selectedEmoji = currentTimePeriod.emojis[Math.floor(Math.random() * currentTimePeriod.emojis.length)];
      emojiType = "time";
     }
     

     element.innerHTML = selectedEmoji;
     
     
     let fontSize, color, textShadow;
     if (emojiType === "time") {
      
      if (currentTimePeriod.period === "morning") {
       
       fontSize = Math.random() * 18 + 16;
       color = '#FFD700';
       textShadow = '0 0 5px rgba(255, 215, 0, 0.7)';
      } else if (currentTimePeriod.period === "noon") {
       
       fontSize = Math.random() * 18 + 16;
       color = '#FF8C00';
       textShadow = '0 0 5px rgba(255, 140, 0, 0.7)';
      } else {
       
       fontSize = Math.random() * 18 + 16;
       color = '#4B0082';
       textShadow = '0 0 5px rgba(75, 0, 130, 0.7)';
      }
     } else {
      
      if (emojiConfig.month >= 11 || emojiConfig.month <= 2) {
       
       fontSize = Math.random() * 20 + 15;
       color = 'white';
       textShadow = '0 0 5px rgba(255, 255, 255, 0.8)';
      } else if (emojiConfig.month >= 3 && emojiConfig.month <= 5) {
       
       fontSize = Math.random() * 18 + 16;
       color = '#FF69B4';
       textShadow = '0 0 5px rgba(255, 105, 180, 0.6)';
      } else if (emojiConfig.month >= 6 && emojiConfig.month <= 8) {
       
       fontSize = Math.random() * 18 + 15;
       color = '#32CD32';
       textShadow = '0 0 5px rgba(50, 205, 50, 0.6)';
      } else {
       
       fontSize = Math.random() * 18 + 15;
       color = '#FF8C00';
       textShadow = '0 0 5px rgba(255, 140, 0, 0.6)';
      }
     }
     
     element.style.cssText = `
       position: absolute;
       font-size: ${fontSize}px;
       color: ${color};
       text-shadow: ${textShadow};
       left: ${Math.random() * window.innerWidth}px;
       top: -50px;
       user-select: none;
       pointer-events: none;
       z-index: 9999;
       transition: all 0.3s ease;
     `;
     
     fallingContainer.appendChild(element);
     activeElements++;
     
     
     const duration = 4000 + Math.random() * 2000;
     const endX = parseFloat(element.style.left) + (Math.random() - 0.5) * 400;
     const endY = window.innerHeight + 50;
     
     element.style.transition = `all ${duration}ms linear`;
     
     setTimeout(() => {
      element.style.left = endX + 'px';
      element.style.top = endY + 'px';
      element.style.opacity = '0';
     }, 50);
     
     
     setTimeout(() => {
      if (element.parentNode) {
       element.parentNode.removeChild(element);
      }
      activeElements--;
      
      
      if (activeElements === 0) {
       if (fallingContainer && fallingContainer.parentNode) {
        fallingContainer.parentNode.removeChild(fallingContainer);
       }
      }
     }, duration);
    }, i * 150);
   }
  }

   
   
   
  function initCodeMoreBox() {
   let codeBlocks = document.querySelectorAll(".highlight");
   if (!codeBlocks) {
    return;
   }
   codeBlocks.forEach(codeBlock => {
    
    if (codeBlock.scrollHeight <= codeBlock.clientHeight) {
     return;
    }
    
    
    let codeMoreBox = document.createElement('div');
    codeMoreBox.classList.add('code-more-box');
    
    let codeMoreBtn = document.createElement('span');
    codeMoreBtn.classList.add('code-more-btn');
    codeMoreBtn.innerText = '显示更多'; 
    let isExpanded = false; 

    codeMoreBtn.addEventListener('click', () => {
     if (!isExpanded) {
      codeBlock.classList.add('code-show'); 
      codeMoreBtn.innerText = '折叠'; 
      isExpanded = true;
     } else {
      codeBlock.classList.remove('code-show'); 
      codeMoreBtn.innerText = '显示更多'; 
      isExpanded = false;
     }
     
     window.dispatchEvent(new Event('resize'));
    });
    
    codeMoreBox.appendChild(codeMoreBtn);
    codeBlock.appendChild(codeMoreBox);
   });
  }


  
   
   
   
  
  

  function captureScrollListeners() {
    
    setTimeout(() => {
      
      overrideScrollspy();
    }, 2000);
  }
  
  

  function overrideScrollspy() {
    
    window.tocScrollspyEnabled = true;
    
    
    setTimeout(() => {
      
      
      
      
      if (!window.originalScrollTo) {
        window.originalScrollTo = HTMLElement.prototype.scrollTo;
        
        HTMLElement.prototype.scrollTo = function(options) {
          
          if (this.id === 'TableOfContents' && window.tocScrollDisabled) {
            return;
          }
          
          
          return window.originalScrollTo.call(this, options);
        };
      }
      
      
      if (!window.originalScrollIntoView) {
        window.originalScrollIntoView = HTMLElement.prototype.scrollIntoView;
        
        HTMLElement.prototype.scrollIntoView = function(options) {
          
          if (this.closest('#TableOfContents') && window.tocScrollDisabled) {
            return;
          }
          
          
          return window.originalScrollIntoView.call(this, options);
        };
      }
    }, 3000); 
  }
  
  function initTocLock() {
    
    
    const articleToc = document.querySelector('#TableOfContents');
    if (!articleToc) {
      
      return;
    }
    
    
    const tocContainer = document.querySelector('.widget.archives');
    if (!tocContainer) {
      return;
    }
    
    
    tocContainer.style.position = 'relative';
    
    
    captureScrollListeners();
    
    
    const lockLabel = document.createElement('div');
    lockLabel.className = 'toc-lock-label';
    lockLabel.textContent = '锁定：';
    
    
    const lockBtn = document.createElement('div');
    lockBtn.className = 'toc-lock-btn';
    lockBtn.innerHTML = `
      <svg class="lock-icon unlocked" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M19 11H5a2 2 0 0 0-2 2v7a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7a2 2 0 0 0-2-2z"/>
        <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
      </svg>
      <svg class="lock-icon locked" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="3" y="11" width="18" height="10" rx="2" ry="2"/>
        <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
        <path d="M9 12v3a3 3 0 0 0 6 0v-3"/>
      </svg>
    `;
    
    
    lockBtn.addEventListener('click', function() {
      const isLocked = this.classList.contains('locked');
      
      if (isLocked) {
        
        this.classList.remove('locked');
        localStorage.setItem('tocLocked', 'false');
        enableTocScroll();
      } else {
        
        this.classList.add('locked');
        localStorage.setItem('tocLocked', 'true');
        disableTocScroll();
      }
    });
    
    
    tocContainer.appendChild(lockLabel);
    tocContainer.appendChild(lockBtn);
    
    
    
    lockBtn.classList.remove('locked');
    localStorage.setItem('tocLocked', 'false');
    
    
    const observer = new MutationObserver(function(mutations) {
      mutations.forEach(function(mutation) {
        if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
          const isLocked = lockBtn.classList.contains('locked');
          if (isLocked) {
            disableTocScroll();
          } else {
            enableTocScroll();
          }
        }
      });
    });
    
    observer.observe(lockBtn, { attributes: true });
  }

  

  function disableTocScroll() {
    
    window.tocScrollDisabled = true;
    
    
    const tocContainer = document.querySelector('#TableOfContents');
    if (tocContainer) {
      
      window.savedTocScrollTop = tocContainer.scrollTop;
      
      
      const currentActive = tocContainer.querySelector('.active-class');
      if (currentActive) {
        window.savedActiveElement = currentActive;
      }
    }
    
    
    if (tocContainer) {
      tocContainer.setAttribute('data-scrollspy-disabled', 'true');
      tocContainer.title = '目录已锁定，不会自动跟随滚动';
    }
    
    
    const archivesContainer = document.querySelector('.widget.archives');
    if (archivesContainer) {
      archivesContainer.style.opacity = '0.8';
      archivesContainer.title = '目录已锁定，不会自动跟随滚动';
    }
  }

  

  function enableTocScroll() {
    
    window.tocScrollDisabled = false;
    
    
    const tocContainer = document.querySelector('#TableOfContents');
    if (tocContainer) {
      
      tocContainer.removeAttribute('data-scrollspy-disabled');
      tocContainer.title = '';
    }
    
    
    const archivesContainer = document.querySelector('.widget.archives');
    if (archivesContainer) {
      archivesContainer.style.opacity = '1';
      archivesContainer.title = '';
    }
  }

  
  
  
  document.addEventListener('DOMContentLoaded', function() {
  

    
    initCodeMoreBox();
    initRope();

    
    setTimeout(initTocLock, 1000);
  });

</script>


<div id="rope-container"></div>


<div id="particles-js"></div>

<script>

particlesJS('particles-js', {
  "particles": {
    "number": {
      "value": 80,
      "density": {
        "enable": true,
        "value_area": 800
      }
    },
    "color": {
      "value": ["#888888", "#aaaaaa", "#cccccc", "#eeeeee"]
    },
    "shape": {
      "type": "circle",
      "stroke": {
        "width": 0,
        "color": "#000000"
      },
      "polygon": {
        "nb_sides": 5
      }
    },
    "opacity": {
      "value": 0.5,
      "random": false,
      "anim": {
        "enable": false,
        "speed": 1,
        "opacity_min": 0.1,
        "sync": false
      }
    },
    "size": {
      "value": 2,
      "random": true,
      "anim": {
        "enable": false,
        "speed": 40,
        "size_min": 0.1,
        "sync": false
      }
    },
    "line_linked": {
      "enable": true,
      "distance": 150,
      "color": "#888888",
      "opacity": 0.4,
      "width": 1
    },
    "move": {
      "enable": true,
      "speed": 2,
      "direction": "none",
      "random": false,
      "straight": false,
      "out_mode": "out",
      "bounce": false,
      "attract": {
        "enable": false,
        "rotateX": 600,
        "rotateY": 1200
      }
    }
  },
  "interactivity": {
    "detect_on": "canvas",
    "events": {
      "onhover": {
        "enable": true,
        "mode": "grab"
      },
      "onclick": {
        "enable": true,
        "mode": "push"
      },
      "resize": true
    },
    "modes": {
      "grab": {
        "distance": 140,
        "line_linked": {
          "opacity": 1
        }
      },
      "bubble": {
        "distance": 400,
        "size": 40,
        "duration": 2,
        "opacity": 8,
        "speed": 3
      },
      "repulse": {
        "distance": 200,
        "duration": 0.4
      },
      "push": {
        "particles_nb": 4
      },
      "remove": {
        "particles_nb": 2
      }
    }
  },
  "retina_detect": true
});
</script>


<script>
(function() {
  'use strict';
  
  
  const categoryColors = [
    '#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57',
    '#ff9ff3', '#54a0ff', '#5f27cd', '#00d2d3', '#ff9f43',
    '#10ac84', '#ff6348', '#a55eea', '#e17055', '#d63031',
    '#00b894', '#fdcb6e', '#6c5ce7', '#fd79a8', '#f39c12',
    '#e67e22', '#e74c3c', '#9b59b6', '#3498db', '#1abc9c',
    '#16a085', '#27ae60', '#2ecc71', '#f1c40f', '#e67e22'
  ];
  
  
  function hashString(str) {
    let hash = 0;
    if (str.length === 0) return hash;
    
    for (let i = 0; i < str.length; i++) {
      const char = str.charCodeAt(i);
      hash = ((hash << 5) - hash) + char;
      hash = hash & hash; 
    }
    
    return Math.abs(hash);
  }
  
  
  function assignCategoryColors() {

    
    
    const isArchivesPage = document.body.classList.contains('template-archives') ||
                          window.location.pathname.includes('/archives/');
    const isArticlePage = document.querySelector('#TableOfContents') || 
                         document.querySelector('.article-category');
    
    
    
    
    if (isArticlePage && !isArchivesPage) {
      const categoryLinks = document.querySelectorAll('.article-category a');

      
      categoryLinks.forEach((link, index) => {
        
        const href = link.getAttribute('href');
        const categoryName = href.split('/').pop() || href.split('/').slice(-2, -1)[0] || 'default';
        
        
        const hash = hashString(categoryName);
        const colorIndex = hash % categoryColors.length;
        const backgroundColor = categoryColors[colorIndex];
        
        
        
        
        link.style.setProperty('background-color', backgroundColor, 'important');
        link.style.setProperty('color', '#fff', 'important');
        
        
        link.addEventListener('mouseenter', function() {
          this.style.opacity = '0.8';
          this.style.transform = 'scale(1.05)';
        });
        
        link.addEventListener('mouseleave', function() {
          this.style.opacity = '1';
          this.style.transform = 'scale(1)';
        });
      });
    }
    
    
    if (!isArchivesPage) {
      
      const sidebarCategories = document.querySelectorAll('.widget.categories a, .widget.tagCloud a');

      
      sidebarCategories.forEach((link, index) => {
        
        const href = link.getAttribute('href');
        const categoryName = href.split('/').pop() || href.split('/').slice(-2, -1)[0] || 'default';
        
        
        const hash = hashString(categoryName);
        const colorIndex = hash % categoryColors.length;
        const backgroundColor = categoryColors[colorIndex];
        
        
        
        
        link.style.setProperty('background-color', backgroundColor, 'important');
        link.style.setProperty('color', '#fff', 'important');
        link.style.setProperty('border-radius', '6px', 'important');
        link.style.setProperty('padding', '8px 12px', 'important');
        link.style.setProperty('margin', '4px 0', 'important');
        link.style.setProperty('display', 'inline-block', 'important');
        link.style.setProperty('text-decoration', 'none', 'important');
        link.style.setProperty('transition', 'all 0.3s ease', 'important');
        
        
        link.addEventListener('mouseenter', function() {
          this.style.opacity = '0.8';
          this.style.transform = 'scale(1.05)';
          this.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.2)';
        });
        
        link.addEventListener('mouseleave', function() {
          this.style.opacity = '1';
          this.style.transform = 'scale(1)';
          this.style.boxShadow = 'none';
        });
      });
    } else {
      

    }
    

  }
  
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', assignCategoryColors);
  } else {
    assignCategoryColors();
  }
  
  
  setTimeout(assignCategoryColors, 500);
  setTimeout(assignCategoryColors, 1000);
  setTimeout(assignCategoryColors, 2000);
  
  
  const observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
      if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
        
        const hasNewCategories = Array.from(mutation.addedNodes).some(node => {
          return node.nodeType === 1 && (
            node.classList.contains('article-category') ||
            node.querySelector('.article-category') ||
            node.classList.contains('widget') ||
            node.querySelector('.widget')
          );
        });
        
        if (hasNewCategories) {
          
          setTimeout(assignCategoryColors, 100);
          setTimeout(assignCategoryColors, 500);
        }
      }
    });
  });
  
  
  observer.observe(document.body, {
    childList: true,
    subtree: true
  });
})();
</script>


<script>
(function() {
  'use strict';
  
  
  function fixDarkModeToggleText() {
    const toggleBtn = document.getElementById('dark-mode-toggle');
    if (!toggleBtn) {
      return;
    }
    
    
    toggleBtn.classList.add('dark-mode-toggle-fix');
    
    
    const span = toggleBtn.querySelector('span');
    if (!span) {
      return;
    }
    
    
    function updateText() {
      const isDark = document.documentElement.dataset.scheme === 'dark';
      span.textContent = isDark ? '亮色模式' : '暗色模式';

    }
    
    
    updateText();
    
    
    function handleThemeChange() {
      setTimeout(updateText, 100); 
    }
    
    
    window.addEventListener('onColorSchemeChange', handleThemeChange);
    
    
    const observer = new MutationObserver(function(mutations) {
      mutations.forEach(function(mutation) {
        if (mutation.type === 'attributes' && mutation.attributeName === 'data-scheme') {
          handleThemeChange();
        }
      });
    });
    
    observer.observe(document.documentElement, {
      attributes: true,
      attributeFilter: ['data-scheme']
    });
    
    
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', handleThemeChange);
    
    
    toggleBtn.addEventListener('click', function() {
      
      setTimeout(updateText, 200);
    });
    

  }
  
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', fixDarkModeToggleText);
  } else {
    fixDarkModeToggleText();
  }
  
  
  setTimeout(fixDarkModeToggleText, 1000);
  setTimeout(fixDarkModeToggleText, 2000);
})();
</script>

  
  <script>
  
  if (!document.getElementById('new-theme-switch')) {
    document.write(`
      <div id="new-theme-switch" style="position: fixed; bottom: 50px; left: 50px; z-index: 1000; text-align: center;">
        <label class="theme-switch">
          <input type="checkbox" class="theme-switch__checkbox" id="theme-switch-checkbox">
          <div class="theme-switch__container">
            <div class="theme-switch__clouds"></div>
            <div class="theme-switch__stars-container">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 144 55" fill="none">
                <path fill-rule="evenodd" clip-rule="evenodd" d="M135.831 3.00688C135.055 3.85027 134.111 4.29946 133 4.35447C134.111 4.40947 135.055 4.85867 135.831 5.71123C136.607 6.55462 136.996 7.56303 136.996 8.72727C136.996 7.95722 137.172 7.25134 137.525 6.59129C137.886 5.93124 138.372 5.39954 138.98 5.00535C139.598 4.60199 140.268 4.39114 141 4.35447C139.88 4.2903 138.936 3.85027 138.16 3.00688C137.384 2.16348 136.996 1.16425 136.996 0C136.996 1.16425 136.607 2.16348 135.831 3.00688ZM31 23.3545C32.1114 23.2995 33.0551 22.8503 33.8313 22.0069C34.6075 21.1635 34.9956 20.1642 34.9956 19C34.9956 20.1642 35.3837 21.1635 36.1599 22.0069C36.9361 22.8503 37.8798 23.2903 39 23.3545C38.2679 23.3911 37.5976 23.602 36.9802 24.0053C36.3716 24.3995 35.8864 24.9312 35.5248 25.5913C35.172 26.2513 34.9956 26.9572 34.9956 27.7273C34.9956 26.563 34.6075 25.5546 33.8313 24.7112C33.0551 23.8587 32.1114 23.4095 31 23.3545ZM0 36.3545C1.11136 36.2995 2.05513 35.8503 2.83131 35.0069C3.6075 34.1635 3.99559 33.1642 3.99559 32C3.99559 33.1642 4.38368 34.1635 5.15987 35.0069C5.93605 35.8503 6.87982 36.2903 8 36.3545C7.26792 36.3911 6.59757 36.602 5.98015 37.0053C5.37155 37.3995 4.88644 37.9312 4.52481 38.5913C4.172 39.2513 3.99559 39.9572 3.99559 40.7273C3.99559 39.563 4.38368 38.5546 2.83131 37.7112C2.05513 36.8587 1.11136 36.4095 0 36.3545ZM56.8313 24.0069C56.0551 24.8503 55.1114 25.2995 54 25.3545C55.1114 25.4095 56.0551 25.8587 56.8313 26.7112C57.6075 27.5546 57.9956 28.563 57.9956 29.7273C57.9956 28.9572 58.172 28.2513 58.5248 27.5913C58.8864 26.9312 59.3716 26.3995 59.9802 26.0053C60.5976 25.602 61.2679 25.3911 62 25.3545C60.8798 25.2903 59.9361 24.8503 59.1599 24.0069C58.3837 23.1635 57.9956 22.1642 57.9956 21C57.9956 22.1642 57.6075 23.1635 56.8313 24.0069ZM81 25.3545C82.1114 25.2995 83.0551 24.8503 83.8313 24.0069C84.6075 23.1635 84.9956 22.1642 84.9956 21C84.9956 22.1642 85.3837 23.1635 86.1599 24.0069C86.9361 24.8503 87.8798 25.2903 89 25.3545C88.2679 25.3911 87.5976 25.602 86.9802 26.0053C86.3716 26.3995 85.8864 26.9312 85.5248 27.5913C85.172 28.2513 84.9956 28.9572 84.9956 29.7273C84.9956 28.563 84.6075 27.5546 83.8313 26.7112C83.0551 25.8587 82.1114 25.4095 81 25.3545ZM136 36.3545C137.111 36.2995 138.055 35.8503 138.831 35.0069C139.607 34.1635 139.996 33.1642 139.996 32C139.996 33.1642 140.384 34.1635 141.16 35.0069C141.936 35.8503 142.88 36.2903 144 36.3545C143.268 36.3911 142.598 36.602 141.98 37.0053C141.372 37.3995 140.886 37.9312 140.525 38.5913C140.172 39.2513 139.996 39.9572 139.996 40.7273C139.996 39.563 139.607 38.5546 138.831 37.7112C138.055 36.8587 137.111 36.4095 136 36.3545ZM101.831 49.0069C101.055 49.8503 100.111 50.2995 99 50.3545C100.111 50.4095 101.055 50.8587 101.831 51.7112C102.607 52.5546 102.996 53.563 102.996 54.7273C102.996 53.9572 103.172 53.2513 103.525 52.5913C103.886 51.9312 104.372 51.3995 104.98 51.0053C105.598 50.602 106.268 50.3911 107 50.3545C105.88 50.2903 104.936 49.8503 104.16 49.0069C103.384 48.1635 102.996 47.1642 102.996 46C102.996 47.1642 102.607 48.1635 101.831 49.0069Z" fill="currentColor"></path>
              </svg>
            </div>
            <div class="theme-switch__circle-container">
              <div class="theme-switch__sun-moon-container">
                <div class="theme-switch__moon">
                  <div class="theme-switch__spot"></div>
                  <div class="theme-switch__spot"></div>
                  <div class="theme-switch__spot"></div>
                </div>
              </div>
            </div>
          </div>
        </label>
        <div id="theme-switch-text" style="color: #fff; font-size: 14px; font-weight: 600; text-shadow: 0 1px 2px rgba(0,0,0,0.5); margin-top: 8px; text-align: center;">亮色模式</div>
      </div>
    `);
  }
  </script>


<style>
   
  .theme-switch {
    --toggle-size: 20px;  
    --container-width: 3.75em;
    --container-height: 1.7em;
    --container-radius: 4.2em;
    --container-light-bg: #3D7EAE;
    --container-night-bg: #1D1F2C;
    --circle-container-diameter: 2.25em;
    --sun-moon-diameter: 1.4em;
    --sun-bg: #ECCA2F;
    --moon-bg: #C4C9D1;
    --spot-color: #959DB1;
    --circle-container-offset: calc((var(--circle-container-diameter) - var(--container-height)) / 2 * -1);
    --stars-color: #fff;
    --clouds-color: #F3FDFF;
    --back-clouds-color: #AACADF;
    --transition: .5s cubic-bezier(0, -0.02, 0.4, 1.25);
    --circle-transition: .3s cubic-bezier(0, -0.02, 0.35, 1.17);
  }

  .theme-switch, .theme-switch *, .theme-switch *::before, .theme-switch *::after {
    -webkit-box-sizing: border-box;
    box-sizing: border-box;
    margin: 0;
    padding: 0;
    font-size: var(--toggle-size);
  }

  .theme-switch__container {
    width: var(--container-width);
    height: var(--container-height);
    background-color: var(--container-light-bg);
    border-radius: var(--container-radius);
    overflow: hidden;
    cursor: pointer;
    -webkit-box-shadow: 0em -0.062em 0.062em rgba(0, 0, 0, 0.25), 0em 0.062em 0.125em rgba(255, 255, 255, 0.94);
    box-shadow: 0em -0.062em 0.062em rgba(0, 0, 0, 0.25), 0em 0.062em 0.125em rgba(255, 255, 255, 0.94);
    -webkit-transition: var(--transition);
    -o-transition: var(--transition);
    transition: var(--transition);
    position: relative;
  }

  .theme-switch__container::before {
    content: "";
    position: absolute;
    z-index: 1;
    inset: 0;
    -webkit-box-shadow: 0em 0.05em 0.187em rgba(0, 0, 0, 0.25) inset, 0em 0.05em 0.187em rgba(0, 0, 0, 0.25) inset;
    box-shadow: 0em 0.05em 0.187em rgba(0, 0, 0, 0.25) inset, 0em 0.05em 0.187em rgba(0, 0, 0, 0.25) inset;
    border-radius: var(--container-radius)
  }

  .theme-switch__checkbox {
    display: none;
  }

  .theme-switch__circle-container {
    width: var(--circle-container-diameter);
    height: var(--circle-container-diameter);
    background-color: rgba(255, 255, 255, 0.1);
    position: absolute;
    left: var(--circle-container-offset);
    top: var(--circle-container-offset);
    border-radius: var(--container-radius);
    -webkit-box-shadow: inset 0 0 0 3.375em rgba(255, 255, 255, 0.1), inset 0 0 0 3.375em rgba(255, 255, 255, 0.1), 0 0 0 0.625em rgba(255, 255, 255, 0.1), 0 0 0 1.25em rgba(255, 255, 255, 0.1);
    box-shadow: inset 0 0 0 3.375em rgba(255, 255, 255, 0.1), inset 0 0 0 3.375em rgba(255, 255, 255, 0.1), 0 0 0 0.625em rgba(255, 255, 255, 0.1), 0 0 0 1.25em rgba(255, 255, 255, 0.1);
    display: -webkit-box;
    display: -ms-flexbox;
    display: flex;
    -webkit-transition: var(--circle-transition);
    -o-transition: var(--circle-transition);
    transition: var(--circle-transition);
    pointer-events: none;
  }

  .theme-switch__sun-moon-container {
    pointer-events: auto;
    position: relative;
    z-index: 2;
    width: var(--sun-moon-diameter);
    height: var(--sun-moon-diameter);
    margin: auto;
    border-radius: var(--container-radius);
    background-color: var(--sun-bg);
    -webkit-box-shadow: 0.062em 0.062em 0.062em 0em rgba(254, 255, 239, 0.61) inset, 0em -0.062em 0.062em 0em #a1872a inset;
    box-shadow: 0.062em 0.062em 0.062em 0em rgba(254, 255, 239, 0.61) inset, 0em -0.062em 0.062em 0em #a1872a inset;
    -webkit-filter: drop-shadow(0.062em 0.125em 0.125em rgba(0, 0, 0, 0.25)) drop-shadow(0em 0.062em 0.125em rgba(0, 0, 0, 0.25));
    filter: drop-shadow(0.062em 0.125em 0.125em rgba(0, 0, 0, 0.25)) drop-shadow(0em 0.062em 0.125em rgba(0, 0, 0, 0.25));
    overflow: hidden;
    -webkit-transition: var(--transition);
    -o-transition: var(--transition);
    transition: var(--transition);
  }

  .theme-switch__moon {
    -webkit-transform: translateX(100%);
    -ms-transform: translateX(100%);
    transform: translateX(100%);
    width: 100%;
    height: 100%;
    background-color: var(--moon-bg);
    border-radius: inherit;
    -webkit-box-shadow: 0.062em 0.062em 0.062em 0em rgba(254, 255, 239, 0.61) inset, 0em -0.062em 0.062em 0em #969696 inset;
    box-shadow: 0.062em 0.062em 0.062em 0em rgba(254, 255, 239, 0.61) inset, 0em -0.062em 0.062em 0em #969696 inset;
    -webkit-transition: var(--transition);
    -o-transition: var(--transition);
    transition: var(--transition);
    position: relative;
  }

  .theme-switch__spot {
    position: absolute;
    top: 0.75em;
    left: 0.312em;
    width: 0.75em;
    height: 0.75em;
    border-radius: var(--container-radius);
    background-color: var(--spot-color);
    -webkit-box-shadow: 0em 0.0312em 0.062em rgba(0, 0, 0, 0.25) inset;
    box-shadow: 0em 0.0312em 0.062em rgba(0, 0, 0, 0.25) inset;
  }

  .theme-switch__spot:nth-of-type(2) {
    width: 0.375em;
    height: 0.375em;
    top: 0.937em;
    left: 1.375em;
  }

  .theme-switch__spot:nth-last-of-type(3) {
    width: 0.25em;
    height: 0.25em;
    top: 0.312em;
    left: 0.812em;
  }

  .theme-switch__clouds {
    width: 1.25em;
    height: 1.25em;
    background-color: var(--clouds-color);
    border-radius: var(--container-radius);
    position: absolute;
    bottom: -0.625em;
    left: 0.312em;
    -webkit-box-shadow: 0.937em 0.312em var(--clouds-color), -0.312em -0.312em var(--back-clouds-color), 1.437em 0.375em var(--clouds-color), 0.5em -0.125em var(--back-clouds-color), 2.187em 0 var(--clouds-color), 1.25em -0.062em var(--back-clouds-color), 2.937em 0.312em var(--clouds-color), 2em -0.312em var(--back-clouds-color), 3.625em -0.062em var(--clouds-color), 2.625em 0em var(--back-clouds-color), 4.5em -0.312em var(--clouds-color), 3.375em -0.437em var(--back-clouds-color), 4.625em -1.75em 0 0.437em var(--clouds-color), 4em -0.625em var(--back-clouds-color), 4.125em -2.125em 0 0.437em var(--back-clouds-color);
    box-shadow: 0.937em 0.312em var(--clouds-color), -0.312em -0.312em var(--back-clouds-color), 1.437em 0.375em var(--clouds-color), 0.5em -0.125em var(--back-clouds-color), 2.187em 0 var(--clouds-color), 1.25em -0.062em var(--back-clouds-color), 2.937em 0.312em var(--clouds-color), 2em -0.312em var(--back-clouds-color), 3.625em -0.062em var(--clouds-color), 2.625em 0em var(--back-clouds-color), 4.5em -0.312em var(--clouds-color), 3.375em -0.437em var(--back-clouds-color), 4.625em -1.75em 0 0.437em var(--clouds-color), 4em -0.625em var(--back-clouds-color), 4.125em -2.125em 0 0.437em var(--back-clouds-color);
    -webkit-transition: 0.5s cubic-bezier(0, -0.02, 0.4, 1.25);
    -o-transition: 0.5s cubic-bezier(0, -0.02, 0.4, 1.25);
    transition: 0.5s cubic-bezier(0, -0.02, 0.4, 1.25);
  }

  .theme-switch__stars-container {
    position: absolute;
    color: var(--stars-color);
    top: -100%;
    left: 0.312em;
    width: 2.75em;
    height: auto;
    -webkit-transition: var(--transition);
    -o-transition: var(--transition);
    transition: var(--transition);
  }

   
  .theme-switch__checkbox:checked + .theme-switch__container {
    background-color: var(--container-night-bg);
  }

  .theme-switch__checkbox:checked + .theme-switch__container .theme-switch__circle-container {
    left: calc(100% - var(--circle-container-offset) - var(--circle-container-diameter));
  }

  .theme-switch__checkbox:checked + .theme-switch__container .theme-switch__circle-container:hover {
    left: calc(100% - var(--circle-container-offset) - var(--circle-container-diameter) - 0.187em)
  }

  .theme-switch__circle-container:hover {
    left: calc(var(--circle-container-offset) + 0.187em);
  }

  .theme-switch__checkbox:checked + .theme-switch__container .theme-switch__moon {
    -webkit-transform: translate(0);
    -ms-transform: translate(0);
    transform: translate(0);
    transform: translate(0);
  }

  .theme-switch__checkbox:checked + .theme-switch__container .theme-switch__clouds {
    bottom: -4.062em;
  }

  .theme-switch__checkbox:checked + .theme-switch__container .theme-switch__stars-container {
    top: 50%;
    -webkit-transform: translateY(-50%);
    -ms-transform: translateY(-50%);
    transform: translateY(-50%);
  }

   
  #dark-mode-toggle {
    display: none !important;
  }

   
  .dark-mode-toggle-fix span {
    font-size: 18px !important;
    font-weight: 600 !important;
  }
</style>


<script>
(function() {
  'use strict';
  
  
  if (window.themeSwitchInitialized) {
    console.log('主题切换开关已经初始化，跳过重复执行');
    return;
  }
  
  let isInitialized = false;
  let observer = null;
  
  function initNewThemeSwitch() {
    
    if (isInitialized) {
      return;
    }
    
    const checkbox = document.getElementById('theme-switch-checkbox');
    if (!checkbox) {
      return;
    }
    
    
    function updateCheckboxState() {
      const isDark = document.documentElement.dataset.scheme === 'dark';
      checkbox.checked = isDark;
      
      
      const textElement = document.getElementById('theme-switch-text');
      if (textElement) {
        textElement.textContent = isDark ? '暗色模式' : '亮色模式';
        console.log('更新主题切换文字:', isDark ? '暗色模式' : '亮色模式');
      }
      
      console.log('当前主题状态:', isDark ? 'dark' : 'light', 'checkbox状态:', checkbox.checked);
    }
    
    
    function waitForThemeSystem() {
      
      const schemeFromData = document.documentElement.dataset.scheme;
      const schemeFromClass = document.documentElement.className.includes('dark') ? 'dark' : 
                             document.documentElement.className.includes('light') ? 'light' : null;
      const schemeFromLocalStorage = localStorage.getItem('StackColorScheme');
      
      if (schemeFromData || schemeFromClass || schemeFromLocalStorage) {
        
        let finalScheme = schemeFromData || schemeFromClass || schemeFromLocalStorage;
        
        
        if (schemeFromData) {
          finalScheme = schemeFromData;
        }
        
        
        document.documentElement.dataset.scheme = finalScheme;
        
        
        updateCheckboxState();
        isInitialized = true;
        window.themeSwitchInitialized = true;
        
        console.log('主题系统已初始化，当前主题:', finalScheme);
      } else {
        
        setTimeout(waitForThemeSystem, 100);
      }
    }
    
    
    waitForThemeSystem();
    
    
    checkbox.addEventListener('change', function() {
      const scheme = this.checked ? 'dark' : 'light';
      document.documentElement.dataset.scheme = scheme;
      
      
      localStorage.setItem('StackColorScheme', scheme);
      
      
      document.dispatchEvent(new CustomEvent('onColorSchemeChange'));
    });
    
    
    window.addEventListener('onColorSchemeChange', updateCheckboxState);
    
    
    observer = new MutationObserver(function(mutations) {
      mutations.forEach(function(mutation) {
        if (mutation.type === 'attributes' && mutation.attributeName === 'data-scheme') {
          updateCheckboxState();
        }
      });
    });
    
    observer.observe(document.documentElement, {
      attributes: true,
      attributeFilter: ['data-scheme']
    });
  }
  
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initNewThemeSwitch);
  } else {
    initNewThemeSwitch();
  }
  
  
  setTimeout(initNewThemeSwitch, 1500);
})();
</script>


<script>
(function() {
  'use strict';
  
  
  if (window.hoverEffectsInitialized) {
    console.log('悬浮效果已经初始化，跳过重复执行');
    return;
  }
  
  let isHoverEffectsInitialized = false;
  let hoverObserver = null;
  
  
  function forceCategoryHoverEffects() {
    
    if (isHoverEffectsInitialized) {
      return;
    }
    
    const articles = document.querySelectorAll('.article-list--compact article');
    if (articles.length > 0) {
      articles.forEach(article => {
        
        if (article.hasAttribute('data-hover-initialized')) {
          return;
        }
        
        
        article.style.setProperty('transition', 'all 0.3s ease', 'important');
        article.style.setProperty('will-change', 'transform, box-shadow', 'important');
        
        
        article.addEventListener('mouseenter', function() {
          this.style.setProperty('transform', 'translateY(-5px)', 'important');
          this.style.setProperty('box-shadow', '0 10px 30px rgba(0, 0, 0, 0.12)', 'important');
        });
        
        article.addEventListener('mouseleave', function() {
          this.style.setProperty('transform', 'translateY(0)', 'important');
          this.style.setProperty('box-shadow', 'none', 'important');
        });
        
        
        article.setAttribute('data-hover-initialized', 'true');
      });
      
      isHoverEffectsInitialized = true;
      window.hoverEffectsInitialized = true;
    }
  }
  
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', forceCategoryHoverEffects);
  } else {
    forceCategoryHoverEffects();
  }
  
  
  setTimeout(forceCategoryHoverEffects, 1000);
  
  
  hoverObserver = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
      if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
        
        setTimeout(forceCategoryHoverEffects, 100);
      }
    });
  });
  
  
  hoverObserver.observe(document.body, {
    childList: true,
    subtree: true
  });
})();
</script>


            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>
<style>
   
   
   
  @font-face {
   font-family: 'yuan';
   src: url('https://blog.928330.xyz/font/round.ttf') format('truetype');
  }

   
   
   
  :root {
   --base-font-family: 'yuan';
   --code-font-family: 'yuan';
  }

   
   
   
   
   
  #backTopBtn {
   position: fixed;
   bottom: 30px;
   right: 450px;
   z-index: 99;
   cursor: pointer;
   width: 32px;
   height: 32px;
   background-image: url('/icons/backTop.svg');
   background-size: cover;
   background-color: rgba(255, 255, 255, 0.9);
   border-radius: 50%;
   box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
   transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
   transform-origin: center center;
    
   animation: gentleFloat 3s ease-in-out infinite;
    
   overflow: visible;
  }

   
  [data-scheme="dark"] #backTopBtn {
   background-image: url('/icons/backTop-dark.svg') !important;
   background-color: rgba(0, 0, 0, 0.8) !important;
   box-shadow: 0 4px 20px rgba(255, 255, 255, 0.1) !important;
  }

   
  @media (prefers-color-scheme: dark) {
    #backTopBtn {
      background-image: url('/icons/backTop-dark.svg') !important;
      background-color: rgba(0, 0, 0, 0.8) !important;
      box-shadow: 0 4px 20px rgba(255, 255, 255, 0.1) !important;
    }
    
    .button-ripple {
      background-image: url('/icons/backTop-dark.svg') !important;
       
    }
  }

   
  html[data-scheme="dark"] #backTopBtn,
  body[data-scheme="dark"] #backTopBtn,
  .dark #backTopBtn,
  .dark-mode #backTopBtn {
    background-image: url('/icons/backTop-dark.svg') !important;
    background-color: rgba(0, 0, 0, 0.8) !important;
    box-shadow: 0 4px 20px rgba(255, 255, 255, 0.1) !important;
  }

  html[data-scheme="dark"] .button-ripple,
  body[data-scheme="dark"] .button-ripple,
  .dark .button-ripple,
  .dark-mode .button-ripple {
    background-image: url('/icons/backTop-dark.svg') !important;
     
  }

   
  [data-scheme="dark"] #backTopBtn::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    border-left: 6px solid transparent;
    border-right: 6px solid transparent;
    border-bottom: 10px solid #ffffff;
    transform: translate(-50%, -50%);
    z-index: 1;
     
    display: var(--show-css-arrow, none);
  }

   
  #backTopBtn::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    border-left: 6px solid transparent;
    border-right: 6px solid transparent;
    border-bottom: 10px solid #000000;
    transform: translate(-50%, -50%);
    z-index: 1;
     
    display: var(--show-css-arrow, none);
  }

   
  @keyframes gentleFloat {
   0%, 100% { transform: translateY(0px); }
   50% { transform: translateY(-6px); }
  }

   
  .button-ripple {
   position: absolute;
   top: 0;
   left: 0;
   width: 32px;
   height: 32px;
   border-radius: 50%;
   background-image: url('/icons/backTop.svg');
   background-size: cover;
   background-repeat: no-repeat;
   background-position: center;
   pointer-events: none;
   z-index: -1;
   animation: buttonRippleExpand 2.5s linear infinite;
   transform-origin: center center;
    
   will-change: transform, opacity;
   backface-visibility: hidden;
   perspective: 1000px;
   contain: layout style;
    
   transform: translateZ(0);
    
   transition: animation-duration 0.3s ease;
    
   --show-css-arrow: none !important;
    
   opacity: var(--ripple-opacity, 0.8) !important;
  }

   
  [data-scheme="dark"] .button-ripple {
   background-image: url('/icons/backTop-dark.svg') !important;
    
    
   --show-css-arrow: none !important;
  }

   
  @media (prefers-color-scheme: dark) {
    .button-ripple {
      background-image: url('/icons/backTop-dark.svg') !important;
       
       
      --show-css-arrow: none !important;
    }
  }

   
  .button-ripple.hover-mode {
   animation-duration: 1s;
  }

  @keyframes buttonRippleExpand {
   0% {
     --ripple-opacity: 0.8;
     transform: scale(1);
   }
   2% {
     --ripple-opacity: 0.78;
     transform: scale(1.02);
   }
   4% {
     --ripple-opacity: 0.76;
     transform: scale(1.04);
   }
   6% {
     --ripple-opacity: 0.74;
     transform: scale(1.06);
   }
   8% {
     --ripple-opacity: 0.72;
     transform: scale(1.08);
   }
   10% {
     --ripple-opacity: 0.7;
     transform: scale(1.1);
   }
   12% {
     --ripple-opacity: 0.68;
     transform: scale(1.12);
   }
   14% {
     --ripple-opacity: 0.66;
     transform: scale(1.14);
   }
   16% {
     --ripple-opacity: 0.64;
     transform: scale(1.16);
   }
   18% {
     --ripple-opacity: 0.62;
     transform: scale(1.18);
   }
   20% {
     --ripple-opacity: 0.6;
     transform: scale(1.2);
   }
   22% {
     --ripple-opacity: 0.58;
     transform: scale(1.22);
   }
   24% {
     --ripple-opacity: 0.56;
     transform: scale(1.24);
   }
   26% {
     --ripple-opacity: 0.54;
     transform: scale(1.26);
   }
   28% {
     --ripple-opacity: 0.52;
     transform: scale(1.28);
   }
   30% {
     --ripple-opacity: 0.5;
     transform: scale(1.3);
   }
   32% {
     --ripple-opacity: 0.48;
     transform: scale(1.32);
   }
   34% {
     --ripple-opacity: 0.46;
     transform: scale(1.34);
   }
   36% {
     --ripple-opacity: 0.44;
     transform: scale(1.36);
   }
   38% {
     --ripple-opacity: 0.42;
     transform: scale(1.38);
   }
   40% {
     --ripple-opacity: 0.4;
     transform: scale(1.4);
   }
   42% {
     --ripple-opacity: 0.38;
     transform: scale(1.42);
   }
   44% {
     --ripple-opacity: 0.36;
     transform: scale(1.44);
   }
   46% {
     --ripple-opacity: 0.34;
     transform: scale(1.46);
   }
   48% {
     --ripple-opacity: 0.32;
     transform: scale(1.48);
   }
   50% {
     --ripple-opacity: 0.3;
     transform: scale(1.5);
   }
   52% {
     --ripple-opacity: 0.28;
     transform: scale(1.52);
   }
   54% {
     --ripple-opacity: 0.26;
     transform: scale(1.54);
   }
   56% {
     --ripple-opacity: 0.24;
     transform: scale(1.56);
   }
   58% {
     --ripple-opacity: 0.22;
     transform: scale(1.58);
   }
   60% {
     --ripple-opacity: 0.2;
     transform: scale(1.6);
   }
   62% {
     --ripple-opacity: 0.18;
     transform: scale(1.62);
   }
   64% {
     --ripple-opacity: 0.16;
     transform: scale(1.64);
   }
   66% {
     --ripple-opacity: 0.14;
     transform: scale(1.66);
   }
   68% {
     --ripple-opacity: 0.12;
     transform: scale(1.68);
   }
   70% {
     --ripple-opacity: 0.1;
     transform: scale(1.7);
   }
   72% {
     --ripple-opacity: 0.08;
     transform: scale(1.72);
   }
   74% {
     --ripple-opacity: 0.07;
     transform: scale(1.74);
   }
   76% {
     --ripple-opacity: 0.06;
     transform: scale(1.76);
   }
   78% {
     --ripple-opacity: 0.05;
     transform: scale(1.78);
   }
   80% {
     --ripple-opacity: 0.04;
     transform: scale(1.8);
   }
   82% {
     --ripple-opacity: 0.035;
     transform: scale(1.82);
   }
   84% {
     --ripple-opacity: 0.03;
     transform: scale(1.84);
   }
   86% {
     --ripple-opacity: 0.025;
     transform: scale(1.86);
   }
   88% {
     --ripple-opacity: 0.02;
     transform: scale(1.88);
   }
   90% {
     --ripple-opacity: 0.015;
     transform: scale(1.9);
   }
   92% {
     --ripple-opacity: 0.01;
     transform: scale(1.92);
   }
   94% {
     --ripple-opacity: 0.008;
     transform: scale(1.94);
   }
   96% {
     --ripple-opacity: 0.005;
     transform: scale(1.96);
   }
   98% {
     --ripple-opacity: 0.002;
     transform: scale(1.98);
   }
   100% {
     --ripple-opacity: 0;
     transform: scale(2.0);
   }
  }

   
  .button-tooltip {
   position: absolute;
   bottom: 45px;
   right: 450px;
   background: rgba(0, 0, 0, 0.8);
   color: white;
   padding: 8px 12px;
   border-radius: 6px;
   font-size: 12px;
   white-space: nowrap;
   opacity: 0;
   transform: translateY(10px);
   transition: all 0.3s ease;
   pointer-events: none;
   z-index: 100;
  }

  .button-tooltip.show {
   opacity: 1;
   transform: translateY(0);
  }

  .button-tooltip::after {
   content: '';
   position: absolute;
   top: 100%;
   left: 50%;
   transform: translateX(-50%);
   border: 5px solid transparent;
   border-top-color: rgba(0, 0, 0, 0.8);
  }

   
  .hover-ripple-effect {
   display: none;
  }

   
  #backTopBtn:hover {
   transform: translateY(-8px) scale(1.1);
   box-shadow: 0 8px 30px rgba(0, 0, 0, 0.25);
   background-color: rgba(255, 255, 255, 1);
  }

   
  #backTopBtn.sprinting {
   animation: energyBurst 1.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
  }

  @keyframes energyBurst {
   0% {
     transform: scale(1) rotate(0deg);
     opacity: 1;
     filter: brightness(1) hue-rotate(0deg);
     box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
   }
   15% {
     transform: scale(1.2) rotate(0deg);
     opacity: 1;
     filter: brightness(1.2) hue-rotate(0deg);
     box-shadow: 0 0 25px rgba(255, 215, 0, 0.8), 0 0 50px rgba(255, 107, 107, 0.6);
   }
   30% {
     transform: scale(1.4) rotate(0deg);
     opacity: 1;
     filter: brightness(1.4) hue-rotate(60deg);
     box-shadow: 0 0 35px rgba(255, 182, 193, 0.8), 0 0 70px rgba(255, 215, 0, 0.6);
   }
   45% {
     transform: scale(1.6) rotate(0deg);
     opacity: 1;
     filter: brightness(1.6) hue-rotate(120deg);
     box-shadow: 0 0 45px rgba(173, 216, 230, 0.8), 0 0 90px rgba(255, 182, 193, 0.6);
   }
   60% {
     transform: scale(1.4) rotate(0deg);
     opacity: 1;
     filter: brightness(1.4) hue-rotate(180deg);
     box-shadow: 0 0 35px rgba(144, 238, 144, 0.8), 0 0 70px rgba(173, 216, 230, 0.6);
   }
   75% {
     transform: scale(1.2) rotate(0deg);
     opacity: 1;
     filter: brightness(1.2) hue-rotate(240deg);
     box-shadow: 0 0 25px rgba(255, 215, 0, 0.8), 0 0 50px rgba(144, 238, 144, 0.6);
   }
   90% {
     transform: scale(1.05) rotate(0deg);
     opacity: 1;
     filter: brightness(1.05) hue-rotate(300deg);
     box-shadow: 0 0 15px rgba(255, 107, 107, 0.6), 0 0 30px rgba(255, 215, 0, 0.4);
   }
   100% {
     transform: scale(1) rotate(0deg);
     opacity: 1;
     filter: brightness(1) hue-rotate(360deg);
     box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
   }
  }

   
  #backTopBtn.reappearing {
   animation: reappear 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
  }

   
  #backTopBtn.exploding {
   animation: explosionTransition 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
    
   z-index: 1000;
  }

   
  #backTopBtn.exploding .button-ripple {
   opacity: 0;
   animation-play-state: paused;
  }

  @keyframes explosionTransition {
   0% {
     transform: scale(1.6) rotate(0deg);
     opacity: 1;
     filter: brightness(1.6) hue-rotate(0deg);
     box-shadow: 0 0 50px rgba(255, 215, 0, 0.8), 0 0 100px rgba(255, 107, 107, 0.6);
   }
   30% {
     transform: scale(1.4) rotate(5deg);
     opacity: 1;
     filter: brightness(1.4) hue-rotate(120deg);
     box-shadow: 0 0 40px rgba(255, 182, 193, 0.8), 0 0 80px rgba(255, 215, 0, 0.6);
   }

   100% {
     transform: scale(1) rotate(0deg);
     opacity: 1;
     filter: brightness(1) hue-rotate(360deg);
     box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
   }
  }

  @keyframes reappear {
   0% {
     transform: scale(0.85);
     opacity: 0.7;
   }
   50% {
     transform: scale(1.05);
     opacity: 1;
   }
   100% {
     transform: scale(1);
     opacity: 1;
   }
  }

  #backTopBtn.rotating {
   animation: rotate360 0.6s ease-in-out;
  }

  @keyframes rotate360 {
   0% { transform: rotate(0deg); }
   100% { transform: rotate(360deg); }
  }

   
  .particle {
   position: absolute;
   top: 50%;
   left: 50%;
   width: 4px;
   height: 4px;
   background: radial-gradient(circle, #fff, #ffd700, #ff69b4, #87ceeb);
   border-radius: 50%;
   pointer-events: none;
   z-index: -2;
   animation: particleExplode 1s ease-out forwards;
  }

  @keyframes particleExplode {
   0% {
     transform: translate(-50%, -50%) scale(0);
     opacity: 1;
   }
   50% {
     opacity: 1;
   }
   100% {
     transform: translate(-50%, -50%) scale(1) translate(var(--x), var(--y));
     opacity: 0;
   }
  }

   
  .energy-wave {
   position: absolute;
   top: 50%;
   left: 50%;
   width: 0;
   height: 0;
   border: 2px solid transparent;
   border-radius: 50%;
   pointer-events: none;
   z-index: -3;
   animation: energyWave 1.2s ease-out forwards;
  }

  @keyframes energyWave {
   0% {
     width: 0;
     height: 0;
     border-color: rgba(255, 215, 0, 0.8);
     opacity: 1;
   }
   100% {
     width: 120px;
     height: 120px;
     border-color: rgba(255, 215, 0, 0);
     opacity: 0;
   }
  }

   
  .hero-aura {
   position: absolute;
   top: 50%;
   left: 50%;
   width: 100%;
   height: 100%;
   border-radius: 50%;
   background: conic-gradient(from 0deg, #ffd700, #ff69b4, #87ceeb, #98fb98, #ffa07a, #ffd700);
   background-size: 200% 200%;
   pointer-events: none;
   z-index: -4;
   animation: heroAura 2s linear infinite;
   opacity: 0;
   transition: opacity 0.3s ease;
  }

  #backTopBtn.sprinting .hero-aura {
   opacity: 0.6;
  }

  @keyframes heroAura {
   0% {
     background-position: 0% 0%;
     transform: translate(-50%, -50%) rotate(0deg);
   }
   100% {
     background-position: 100% 100%;
     transform: translate(-50%, -50%) rotate(360deg);
   }
  }

   
      @media (max-width: 768px) {
     #backTopBtn {
       left: 20px !important;  
       right: auto !important;
       bottom: 20px;
       width: 28px;
       height: 28px;
     }
     
     .button-tooltip {
       left: 20px !important;  
       right: auto !important;
       bottom: 35px;
     }
    }
  
    @media (max-width: 480px) {
     #backTopBtn {
       left: 15px !important;  
       right: auto !important;
       bottom: 15px;
       width: 26px;
       height: 26px;
     }
     
     .button-tooltip {
       left: 15px !important;
       right: auto !important;
       bottom: 31px;
     }
    }

   
   
   
  .no-text-selection {
    -webkit-user-select: none;  
    -moz-user-select: none;     
    -ms-user-select: none;      
    user-select: none;          
  }

   
   
   
  #rope-container {
    position: fixed;
    top: 0;
    left: 20px;
    z-index: 10000;
    width: 50px;
    height: 480px;
    pointer-events: none;
  }
  
   
  #rope-physics-container {
    pointer-events: auto !important;
  }
  
   
  #rope-svg-container svg {
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
  }
  
  #rope-svg-container path {
    transition: all 0.1s ease-out;
  }
  
   
  #rope-svg-container path,
  #rope-path {
    stroke: #4b2b0f !important;
    stroke-width: 2.5 !important;
  }
  
   
  #rope-svg-container svg path {
    stroke: #4b2b0f !important;
    stroke-width: 2.5 !important;
  }
  


  #rope {
    position: absolute;
    top: -80px;
    left: 50%;
    width: 3px;
    height: 400px;
    background: linear-gradient(to bottom, #654321, #8B4513, #A0522D, #8B4513, #654321);
    border-radius: 1.5px;
    transform: translateX(-50%);
    pointer-events: auto;
    transition: all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    box-shadow: 0 1px 3px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.1);
  }

  #pull-ring {
    position: absolute;
    top: 300px;
    left: 50%;
    font-size: 20px;
    color: #ffffff;
    text-shadow: 0 0 8px rgba(255, 255, 255, 0.8);
    transform: translateX(-50%);
    pointer-events: auto;
    transition: all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
  }

  #rope:hover {
    box-shadow: 0 2px 6px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.2);
  }

  #pull-ring:hover {
    transform: translateX(-50%) scale(1.2);
    text-shadow: 0 0 12px rgba(255, 255, 255, 1);
    filter: drop-shadow(0 4px 8px rgba(0,0,0,0.5));
  }

   
   
   
  .highlight {
   max-height: 400px;
   overflow: hidden;
   position: relative;
   transition: max-height 0.3s ease-out;
  }

  .code-show {
   max-height: none !important;
  }

  .code-more-box {
   width: 100%;
   padding-top: 20px;
   background-image: linear-gradient(to bottom, rgba(255, 255, 255, 0), #fff);
   position: absolute;
   left: 0;
   right: 0;
   bottom: 0;
   z-index: 1;
   text-align: center;
  }

  .code-more-btn {
   display: inline-block;
   padding: 5px 15px;
   background: #f0f0f5;
   border-radius: 5px;
   cursor: pointer;
   font-size: 0.9em;
  }

   
   
   
  #particles-js {
   position: fixed;
   top: 0;
   left: 0;
    width: 100vw;
    height: 100vh;
   z-index: -1;
    pointer-events: none;
  }
  
  #particles-js canvas {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
  }

   
   
   
  .toc-lock-btn {
    position: absolute;
    top: 32px;
    right: 5px;
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    border-radius: 50%;
    transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    background: rgba(0, 0, 0, 0.05);
    color: rgba(0, 0, 0, 0.7);
    z-index: 100;
    border: 1px solid rgba(0, 0, 0, 0.1);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }
  
  .toc-lock-btn:hover {
    background: rgba(0, 0, 0, 0.1);
    transform: scale(1.1);
    border-color: rgba(0, 0, 0, 0.2);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
  }
  
  .toc-lock-btn:active {
    transform: scale(0.95);
  }
  
   
  .toc-lock-btn:focus {
    outline: none;
    border-color: rgba(0, 0, 0, 0.4);
    box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1), 0 2px 8px rgba(0, 0, 0, 0.1);
    background: rgba(0, 0, 0, 0.08);
  }
  
  .toc-lock-btn:focus-visible {
    outline: none;
    border-color: rgba(0, 0, 0, 0.4);
    box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1), 0 2px 8px rgba(0, 0, 0, 0.1);
    background: rgba(0, 0, 0, 0.08);
  }
  
  .toc-lock-btn.locked {
    color: rgba(0, 0, 0, 0.9);
    background: rgba(0, 0, 0, 0.1);
    border-color: rgba(0, 0, 0, 0.3);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
  }
  
  .toc-lock-btn.locked:hover {
    background: rgba(0, 0, 0, 0.15);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.25);
  }
  
  .toc-lock-btn.locked .lock-icon.locked {
    display: block;
  }
  
  .toc-lock-btn.locked .lock-icon.unlocked {
    display: none;
  }
  
  .toc-lock-btn .lock-icon.locked {
    display: none;
  }
  
  .toc-lock-btn .lock-icon.unlocked {
    display: block;
  }
  
  .toc-lock-btn .lock-icon {
    width: 14px;
    height: 14px;
    stroke: currentColor;
    fill: none;
    stroke-width: 2.5;
    stroke-linecap: round;
    stroke-linejoin: round;
    transition: all 0.3s ease;
  }
  
   
  .toc-lock-label {
    position: absolute;
    top: 38px;
    right: 28px;
    font-size: 16px;
    color: rgba(0, 0, 0, 0.6);
    font-weight: 700;
    z-index: 100;
    user-select: none;
    pointer-events: none;
    line-height: 1;
    display: flex;
    align-items: center;
  }

   
  [data-scheme="dark"] .toc-lock-btn {
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(255, 255, 255, 0.1);
    color: rgba(255, 255, 255, 0.7);
  }
  
  [data-scheme="dark"] .toc-lock-btn:hover {
    background: rgba(255, 255, 255, 0.1);
    border-color: rgba(255, 255, 255, 0.2);
    box-shadow: 0 4px 16px rgba(255, 255, 255, 0.15);
  }
  
   
  [data-scheme="dark"] .toc-lock-btn:focus,
  [data-scheme="dark"] .toc-lock-btn:focus-visible {
    outline: none;
    border-color: rgba(255, 255, 255, 0.4);
    box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.1), 0 2px 8px rgba(255, 255, 255, 0.1);
    background: rgba(255, 255, 255, 0.08);
  }
  
  [data-scheme="dark"] .toc-lock-btn.locked {
    color: rgba(255, 255, 255, 0.9);
    background: rgba(255, 255, 255, 0.1);
    border-color: rgba(255, 255, 255, 0.3);
    box-shadow: 0 2px 8px rgba(255, 255, 255, 0.2);
  }
  
  [data-scheme="dark"] .toc-lock-btn.locked:hover {
    background: rgba(255, 255, 255, 0.15);
    box-shadow: 0 4px 16px rgba(255, 255, 255, 0.25);
  }
  
   
  [data-scheme="dark"] .toc-lock-label {
    color: rgba(255, 255, 255, 0.6);
  }

   
  #TableOfContents[data-scrollspy-disabled="true"] {
    opacity: 0.8 !important;
  }
  
  #TableOfContents[data-scrollspy-disabled="true"] .active-class {
     
    display: block !important;
    opacity: 1 !important;
  }
  
  #TableOfContents[data-scrollspy-disabled="true"] a {
    cursor: pointer !important;
  }
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>

<script>
   
   
   

  let s1 = '2025-5-8 15:00:00'; 
  s1 = new Date(s1.replace(/-/g, "/"));
  let s2 = new Date();
  let timeDifference = s2.getTime() - s1.getTime();

  let days = Math.floor(timeDifference / (1000 * 60 * 60 * 24));
  let hours = Math.floor((timeDifference % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
  let minutes = Math.floor((timeDifference % (1000 * 60 * 60)) / (1000 * 60));

  let result = days + "天" + hours + "小时" + minutes + "分钟";
  if (document.getElementById('runningdays')) {
      document.getElementById('runningdays').innerHTML = result;
  }
  
   
   
   
  
  

  function startContinuousRipple(button) {
   
   const buttonRipple = document.createElement('div');
   buttonRipple.className = 'button-ripple';
   button.appendChild(buttonRipple);
   
   
   button.buttonRipple = buttonRipple;
  }
  
  

  function createContinuousRipple(button) {
   
   if (button.querySelector('.continuous-ripple')) {
     return;
   }
   
   
   const rippleContainer = document.createElement('div');
   rippleContainer.className = 'ripple-container continuous-ripple';
   
   
   const ripple = document.createElement('div');
   ripple.className = 'ripple';
   ripple.style.background = 'radial-gradient(circle, rgba(255, 107, 107, 0.8) 0%, rgba(255, 255, 255, 0.9) 100%)';
   
   rippleContainer.appendChild(ripple);
   button.appendChild(rippleContainer);
   
   
   setTimeout(() => {
     if (rippleContainer.parentNode) {
       rippleContainer.parentNode.removeChild(rippleContainer);
     }
   }, 800);
  }
  
  

  function createHoverRipple(button) {
   
   if (button.buttonRipple) {
     
     button.buttonRipple.style.animationDuration = '1s';
     button.buttonRipple.classList.add('hover-mode');
   }
  }
  
  

  function showTooltip(button) {
   
   hideTooltip();
   
   
   const tooltip = document.createElement('div');
   tooltip.className = 'button-tooltip';
   tooltip.textContent = '返回顶部';
   document.body.appendChild(tooltip);
   
   
   setTimeout(() => {
     tooltip.classList.add('show');
   }, 10);
   
   
   button.tooltip = tooltip;
  }
  
  

  function hideTooltip() {
   const existingTooltip = document.querySelector('.button-tooltip');
   if (existingTooltip) {
     existingTooltip.classList.remove('show');
     setTimeout(() => {
       if (existingTooltip.parentNode) {
         existingTooltip.parentNode.removeChild(existingTooltip);
       }
     }, 300);
   }
  }
  
  

  function createRippleEffect(button) {
   
   
   
   const energyWave = document.createElement('div');
   energyWave.className = 'energy-wave';
   document.body.appendChild(energyWave);
   
   
   createParticleExplosion(button);
   
   
   setTimeout(() => {
     if (energyWave.parentNode) {
       energyWave.parentNode.removeChild(energyWave);
     }
   }, 1200);
  }

  

  function createParticleExplosion(button) {
   const particleCount = 16; 
   
   
   const particleColors = [
     'radial-gradient(circle, #ff6b6b, #ffd93d, #6bcf7f, #4d96ff)',
     'radial-gradient(circle, #ff8e8e, #ffed4e, #7ddb8f, #6ba6ff)',
     'radial-gradient(circle, #ffa1a1, #fff15f, #8ee79f, #89b6ff)',
     'radial-gradient(circle, #ffb4b4, #fff570, #9ff3af, #a7c6ff)'
   ];
   
   for (let i = 0; i < particleCount; i++) {
     const particle = document.createElement('div');
     particle.className = 'particle';
     
     
     const randomColor = particleColors[Math.floor(Math.random() * particleColors.length)];
     particle.style.background = randomColor;
     
     
     const angle = (i / particleCount) * 2 * Math.PI;
     const distance = 40 + Math.random() * 30; 
     const x = Math.cos(angle) * distance;
     const y = Math.sin(angle) * distance;
     
     particle.style.setProperty('--x', `${x}px`);
     particle.style.setProperty('--y', `${y}px`);
     
     
     particle.style.animationDelay = `${Math.random() * 0.4}s`;
     
     button.appendChild(particle);
     
     
     setTimeout(() => {
       if (particle.parentNode) {
         particle.parentNode.removeChild(particle);
       }
     }, 1000);
   }
  }

   
   
   
  

  function initScrollTop() {
   let rightSideBar = document.querySelector(".right-sidebar");
   if (!rightSideBar) {
    return;
   }

   
   let btn = document.createElement("div");
   btn.id = "backTopBtn";
   let isRotating = false; 

   
   const heroAura = document.createElement('div');
   heroAura.className = 'hero-aura';
   btn.appendChild(heroAura);

   
   btn.addEventListener('mouseenter', function() {
     createHoverRipple(this);
     showTooltip(this);
   });
   
   
   btn.addEventListener('mouseleave', function() {
     if (this.buttonRipple) {
       
       this.buttonRipple.style.animationDuration = '2s';
       this.buttonRipple.classList.remove('hover-mode');
     }
     hideTooltip();
   });

   btn.onclick = function() {
    if (!isRotating) {
     isRotating = true;
     backToTop(this, () => {
      isRotating = false; 
     });
    }
   };
   rightSideBar.appendChild(btn);

   
   btn.style.display = "block";
   
   
   startContinuousRipple(btn);
  }

  

  function backToTop(button, onComplete) {
   
   button.classList.add('sprinting');
   
   
   if (button.buttonRipple) {
     button.buttonRipple.style.display = 'none';
   }
   
   
   createRippleEffect(button);
   
   
   window.scrollTo({ top: 0, behavior: "smooth" });
   
   
   const checkScrollComplete = () => {
     if (window.scrollY === 0) {
       
       button.classList.remove('sprinting');
       
       
       button.classList.add('exploding');
       
       
       createParticleExplosion(button);
       
       
       if (button.buttonRipple) {
         button.buttonRipple.style.display = 'block';
       }
       
       
       setTimeout(() => {
         button.classList.remove('exploding');
         
         
         if (button.buttonRipple) {
           
           button.buttonRipple.style.animationPlayState = 'paused';
           
           button.buttonRipple.style.animation = 'none';
           button.buttonRipple.offsetHeight; 
           button.buttonRipple.style.animation = 'buttonRippleExpand 2s steps(25, end) infinite';
           button.buttonRipple.style.animationPlayState = 'running';
         }
         
         button.classList.add('reappearing');
         
         
         setTimeout(() => {
           button.classList.remove('reappearing');
           if (onComplete) {
             onComplete();
           }
         }, 600);
       }, 800); 
       
       return;
     }
     requestAnimationFrame(checkScrollComplete);
   };
   
   checkScrollComplete();
  }

  
  initScrollTop();
  
   
   
   
  

  function initRope() {


    if (typeof Matter === 'undefined') {
      console.error('Matter.js 库未加载，无法初始化物理绳索。');
      return;
    }
    if (document.getElementById('rope-physics-container')) {

      return;
    }

    let ropeContainer = document.getElementById('rope-container');
    if (!ropeContainer) {
      console.error('#rope-container 元素未在 HTML 或 CSS 中找到。');
      return;
    }
    
    ropeContainer.innerHTML = '';
    ropeContainer.style.height = '100vh';
    ropeContainer.style.pointerEvents = 'none';

    const monthlyEmojis = [
      { month: 1, name: "一月", ring: "❄️", falling: "❄️", description: "寒冬腊月，雪花飞舞" },
      { month: 2, name: "二月", ring: "🏮", falling: "🏮", description: "新春正月，灯笼高挂" },
      { month: 3, name: "三月", ring: "🌸", falling: "🌸", description: "春暖花开，樱花绽放" },
      { month: 4, name: "四月", ring: "🌧️", falling: "🌧️", description: "清明时节，春雨绵绵" },
      { month: 5, name: "五月", ring: "🌺", falling: "🌺", description: "立夏时节，牡丹盛开" },
      { month: 6, name: "六月", ring: "🌻", falling: "🌻", description: "芒种时节，向日葵开" },
      { month: 7, name: "七月", ring: "🌿", falling: "🌿", description: "小暑时节，绿意盎然" },
      { month: 8, name: "八月", ring: "🍉", falling: "🍉", description: "七夕时节，西瓜清甜" },
      { month: 9, name: "九月", ring: "🍁", falling: "🍁", description: "白露时节，秋葉飘落" },
      { month: 10, name: "十月", ring: "🍂", falling: "🍂", description: "寒露时节，落叶纷飞" },
      { month: 11, name: "十一月", ring: "🍊", falling: "🍊", description: "霜降时节，柑橘飘香" },
      { month: 12, name: "十二月", ring: "🌨️", falling: "🌨️", description: "大雪时节，雪花纷飞" }
    ];
    window.timeEmojis = [
      { period: "morning", name: "早晨", emojis: ["☀️", "🌤️", "🌱", "🌺", "🌿"], description: "晨曦初露，万物苏醒" },
      { period: "noon", name: "中午", emojis: ["🌞", "🌻", "🦋", "🦜", "🐝"], description: "烈日当空，生机勃勃" },
      { period: "evening", name: "傍晚", emojis: ["🌙", "⭐", "🦉"], description: "夕阳西下，夜幕降临" }
    ];
    const currentMonth = new Date().getMonth() + 1;
    const currentEmoji = monthlyEmojis.find(emoji => emoji.month === currentMonth);
    
    const ropeContainerLeft = 20;
    const ropeContainerWidth = 50;
    const ropeAnchorX = ropeContainerLeft + (ropeContainerWidth / 2);

    const { Engine, World, Bodies, Composite, Constraint, Runner, Mouse, MouseConstraint, Events, Body } = Matter;

    const engine = Engine.create();
    const world = engine.world;
    
    
    
    
    engine.world.gravity.y = 0;

    
    
    
    const ropeSegments = 80; 
    const segmentRadius = 1.5; 
    const segmentRenderHeight = 6; 
    const segmentRenderWidth = 4; 
    const constraintLength = 2.5; 

    const ropeGroup = Matter.Body.nextGroup(true);
    const ropeChain = Composite.create({ label: 'Rope' });

    
    for (let i = 0; i < ropeSegments - 1; i++) {
      const segment = Bodies.circle(ropeAnchorX, i * constraintLength, segmentRadius, {
          collisionFilter: { group: ropeGroup },
          density: 0.1, 
          friction: 0.4, 
          frictionAir: 0.08, 
          restitution: 0.02 
      });
      Composite.add(ropeChain, segment);
    }

    
    const pullRingBody = Bodies.circle(
      ropeAnchorX,
      (ropeSegments - 1) * constraintLength,
      15,
      {
        collisionFilter: { group: ropeGroup },
        density: 0.01, 
        friction: 0.5,  
        frictionAir: 0.1, 
        restitution: 0.02 
      }
    );
    Composite.add(ropeChain, pullRingBody);
    World.add(world, ropeChain);

    
    Composite.addConstraint(ropeChain, Constraint.create({
      bodyB: ropeChain.bodies[0],
      pointA: { x: ropeAnchorX, y: 0 },
      stiffness: 1 
    }));

    for (let i = 0; i < ropeSegments - 1; i++) {
      Composite.addConstraint(ropeChain, Constraint.create({
        bodyA: ropeChain.bodies[i],
        bodyB: ropeChain.bodies[i + 1],
        
        
        
        stiffness: 0.8, 
        damping: 0.8,   
        length: constraintLength * 0.6, 
        
        render: {
          visible: false
        }
      }));
    }
    
    const domContainer = document.createElement('div');
    domContainer.id = 'rope-physics-container';
    domContainer.style.position = 'fixed';
    domContainer.style.top = '0';
    domContainer.style.left = '0';
    domContainer.style.pointerEvents = 'auto'; 
    domContainer.style.zIndex = '10000';
    document.body.appendChild(domContainer);

    
    const svgContainer = document.createElement('div');
    svgContainer.id = 'rope-svg-container';
    svgContainer.style.cssText = `
      position: absolute;
      top: 0;
      left: 0;
      width: 100px;
      height: 100vh;
      pointer-events: none;
      z-index: 1;
      overflow: visible;
    `;
    domContainer.appendChild(svgContainer);
    
    
    const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
    svg.setAttribute('width', '100');
    svg.setAttribute('height', '100vh');
    svg.setAttribute('viewBox', '0 0 100 100vh');
    svg.style.cssText = `
      position: absolute;
      top: 0;
      left: 0;
      width: 100px;
      height: 100vh;
      overflow: visible;
    `;
    svgContainer.appendChild(svg);
    
    
    const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
    const gradient = document.createElementNS('http://www.w3.org/2000/svg', 'linearGradient');
    gradient.setAttribute('id', 'ropeGradient');
    gradient.setAttribute('x1', '0%');
    gradient.setAttribute('y1', '0%');
    gradient.setAttribute('x2', '0%');
    gradient.setAttribute('y2', '100%');
    
    const stop1 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
    stop1.setAttribute('offset', '0%');
    stop1.setAttribute('stop-color', '#654321');
    
    const stop2 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
    stop2.setAttribute('offset', '25%');
    stop2.setAttribute('stop-color', '#8B4513');
    
    const stop3 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
    stop3.setAttribute('offset', '50%');
    stop3.setAttribute('stop-color', '#A0522D');
    
    const stop4 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
    stop4.setAttribute('offset', '75%');
    stop4.setAttribute('stop-color', '#8B4513');
    
    const stop5 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
    stop5.setAttribute('offset', '100%');
    stop5.setAttribute('stop-color', '#654321');
    
    gradient.appendChild(stop1);
    gradient.appendChild(stop2);
    gradient.appendChild(stop3);
    gradient.appendChild(stop4);
    gradient.appendChild(stop5);
    defs.appendChild(gradient);
    svg.appendChild(defs);
    
    
    const ropePath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    ropePath.setAttribute('fill', 'none');
    
    ropePath.setAttribute('stroke', '#4b2b0f');
    ropePath.setAttribute('stroke-width', '2.5');
    ropePath.setAttribute('stroke-linecap', 'round');
    ropePath.setAttribute('stroke-linejoin', 'round');
    ropePath.setAttribute('id', 'rope-path'); 
    svg.appendChild(ropePath);
    
    
    ropePath.setAttribute('d', `M 50 0 L 50 400`);
    
    
    
    
    
    const pullRingDiv = document.createElement('div');
    pullRingDiv.id = 'pull-ring-physics';
    pullRingDiv.innerHTML = currentEmoji.ring;
    pullRingDiv.title = `${currentEmoji.name}: ${currentEmoji.description}`;
    pullRingDiv.style.cssText = `
      font-size: 24px; cursor: grab; pointer-events: auto;
      width: 30px; height: 30px; text-align: center;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3)); position: absolute;
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      z-index: 2;
      transform: translate(40px, 300px); /* 初始位置，向右移动5px */
    `;
    
    
    pullRingDiv.addEventListener('mousedown', () => {
      pullRingDiv.style.cursor = 'grabbing';
    });
    
    pullRingDiv.addEventListener('mouseup', () => {
      pullRingDiv.style.cursor = 'grab';
    });
    
    domContainer.appendChild(pullRingDiv);
    
    
    const ropeElements = {
      svg: svg,
      path: ropePath,
      pullRing: pullRingDiv
    };

    const mouse = Mouse.create(document.body);
    const mouseConstraint = MouseConstraint.create(engine, {
      mouse: mouse,
      constraint: { 
        stiffness: 0.8, 
        render: { visible: false },
        
        length: 0,
        damping: 0.05 
      }
    });
    World.add(world, mouseConstraint);
    
    
    mouseConstraint.constraint.bodyB = null;
    
    
    Events.on(mouseConstraint, 'mousedown', (event) => {

    });
    
    
    mouseConstraint.mouse.element = document.body;
    
    
    let dragStartPosition = null;
    
    Events.on(mouseConstraint, 'startdrag', () => {
      document.body.classList.add('no-text-selection');
      
      
      if (mouseConstraint.body && mouseConstraint.body === pullRingBody) {
        dragStartPosition = {
          x: mouseConstraint.body.position.x,
          y: mouseConstraint.body.position.y
        };
      }
    });
    
    Events.on(mouseConstraint, 'enddrag', () => {
      document.body.classList.remove('no-text-selection');
      
      
      
      if (dragStartPosition) {
        
        const currentPosition = pullRingBody.position;
        const dragDistance = Math.sqrt(
          Math.pow(currentPosition.x - dragStartPosition.x, 2) +
          Math.pow(currentPosition.y - dragStartPosition.y, 2)
        );
        
        
        if (dragDistance > 1) {
          createSeasonalFalling(currentEmoji);
          
          
          Matter.Body.applyForce(pullRingBody, pullRingBody.position, { x: 0, y: 0.5 });
          
          
          const targetX = ropeAnchorX;
          const targetY = (ropeSegments - 1) * constraintLength;
          
          
          const dx = targetX - currentPosition.x;
          const dy = targetY - currentPosition.y;
          
          
          Matter.Body.applyForce(pullRingBody, pullRingBody.position, { 
            x: dx * 0.001, 
            y: dy * 0.001 
          });
          
        }
        
        
        dragStartPosition = null;
      }
    });
    


    
    (function render() {
      
      let pathData = '';
      
      
      const topPoint = { x: 50, y: 0 }; 
      pathData += `M ${topPoint.x} ${topPoint.y}`;
      
      
      ropeChain.bodies.forEach((body, index) => {
        if (index < ropeSegments - 1) { 
          const relativeX = body.position.x - ropeAnchorX + 50; 
          const relativeY = body.position.y;
          pathData += ` L ${relativeX} ${relativeY}`;
        }
      });
      
      
      const pullRingBody = ropeChain.bodies[ropeSegments - 1];
      if (pullRingBody) {
        const relativeX = pullRingBody.position.x - ropeAnchorX + 50; 
        const relativeY = pullRingBody.position.y;
        pathData += ` L ${relativeX} ${relativeY}`;
      }
      
      
      ropeElements.path.setAttribute('d', pathData);
      
      
      if (pullRingBody) {
        
        
        const adjustedX = pullRingBody.position.x - 15 + 3.5; 
        const adjustedY = pullRingBody.position.y - 15;
        
        ropeElements.pullRing.style.transform = `translate(
          ${adjustedX}px,
          ${adjustedY}px
        )`;
        

      }
      
      setTimeout(() => requestAnimationFrame(render), 1000 / 240); 
    })();
    
    
    
    const runner = Runner.create();
    
    runner.delta = 1000 / 240; 
    Runner.run(runner, engine);

    
    
    
    setTimeout(() => {
      engine.world.gravity.y = 1.2;
    }, 100); 

    
    
    
    
    
    ropeChain.bodies.forEach((body, index) => {
      Matter.Body.set(body, 'sleeping', false);
      
      body.sleepThreshold = Infinity;
    });
    
    
    engine.enableSleeping = false;
    
    
    mouseConstraint.constraint.bodyB = null;
    mouseConstraint.mouse.element = document.body;


  }

  

  function createSeasonalFalling(emojiConfig) {

   
   
   const fallingContainer = document.createElement('div');
   fallingContainer.id = 'falling-container';
   fallingContainer.style.cssText = `
     position: fixed;
     top: 0;
     left: 0;
     width: 100vw;
     height: 100vh;
     pointer-events: none;
     z-index: 9999;
     overflow: hidden;
   `;
   document.body.appendChild(fallingContainer);

   
   
   const currentHour = new Date().getHours();
   let currentTimePeriod;
   if (currentHour >= 5 && currentHour < 11) {
    currentTimePeriod = window.timeEmojis.find(t => t.period === "morning");
   } else if (currentHour >= 11 && currentHour < 17) {
    currentTimePeriod = window.timeEmojis.find(t => t.period === "noon");
   } else {
    currentTimePeriod = window.timeEmojis.find(t => t.period === "evening");
   }
   

   
   
   const totalElements = emojiConfig.month >= 11 || emojiConfig.month <= 2 ? 30 : 25; 
   let activeElements = 0;
   

   
   for (let i = 0; i < totalElements; i++) {
    setTimeout(() => {
     const element = document.createElement('div');
     
     
     let selectedEmoji, emojiType;
     if (Math.random() < 0.7) {
      selectedEmoji = emojiConfig.falling;
      emojiType = "monthly";
     } else {
      
      selectedEmoji = currentTimePeriod.emojis[Math.floor(Math.random() * currentTimePeriod.emojis.length)];
      emojiType = "time";
     }
     

     element.innerHTML = selectedEmoji;
     
     
     let fontSize, color, textShadow;
     if (emojiType === "time") {
      
      if (currentTimePeriod.period === "morning") {
       
       fontSize = Math.random() * 18 + 16;
       color = '#FFD700';
       textShadow = '0 0 5px rgba(255, 215, 0, 0.7)';
      } else if (currentTimePeriod.period === "noon") {
       
       fontSize = Math.random() * 18 + 16;
       color = '#FF8C00';
       textShadow = '0 0 5px rgba(255, 140, 0, 0.7)';
      } else {
       
       fontSize = Math.random() * 18 + 16;
       color = '#4B0082';
       textShadow = '0 0 5px rgba(75, 0, 130, 0.7)';
      }
     } else {
      
      if (emojiConfig.month >= 11 || emojiConfig.month <= 2) {
       
       fontSize = Math.random() * 20 + 15;
       color = 'white';
       textShadow = '0 0 5px rgba(255, 255, 255, 0.8)';
      } else if (emojiConfig.month >= 3 && emojiConfig.month <= 5) {
       
       fontSize = Math.random() * 18 + 16;
       color = '#FF69B4';
       textShadow = '0 0 5px rgba(255, 105, 180, 0.6)';
      } else if (emojiConfig.month >= 6 && emojiConfig.month <= 8) {
       
       fontSize = Math.random() * 18 + 15;
       color = '#32CD32';
       textShadow = '0 0 5px rgba(50, 205, 50, 0.6)';
      } else {
       
       fontSize = Math.random() * 18 + 15;
       color = '#FF8C00';
       textShadow = '0 0 5px rgba(255, 140, 0, 0.6)';
      }
     }
     
     element.style.cssText = `
       position: absolute;
       font-size: ${fontSize}px;
       color: ${color};
       text-shadow: ${textShadow};
       left: ${Math.random() * window.innerWidth}px;
       top: -50px;
       user-select: none;
       pointer-events: none;
       z-index: 9999;
       transition: all 0.3s ease;
     `;
     
     fallingContainer.appendChild(element);
     activeElements++;
     
     
     const duration = 4000 + Math.random() * 2000;
     const endX = parseFloat(element.style.left) + (Math.random() - 0.5) * 400;
     const endY = window.innerHeight + 50;
     
     element.style.transition = `all ${duration}ms linear`;
     
     setTimeout(() => {
      element.style.left = endX + 'px';
      element.style.top = endY + 'px';
      element.style.opacity = '0';
     }, 50);
     
     
     setTimeout(() => {
      if (element.parentNode) {
       element.parentNode.removeChild(element);
      }
      activeElements--;
      
      
      if (activeElements === 0) {
       if (fallingContainer && fallingContainer.parentNode) {
        fallingContainer.parentNode.removeChild(fallingContainer);
       }
      }
     }, duration);
    }, i * 150);
   }
  }

   
   
   
  function initCodeMoreBox() {
   let codeBlocks = document.querySelectorAll(".highlight");
   if (!codeBlocks) {
    return;
   }
   codeBlocks.forEach(codeBlock => {
    
    if (codeBlock.scrollHeight <= codeBlock.clientHeight) {
     return;
    }
    
    
    let codeMoreBox = document.createElement('div');
    codeMoreBox.classList.add('code-more-box');
    
    let codeMoreBtn = document.createElement('span');
    codeMoreBtn.classList.add('code-more-btn');
    codeMoreBtn.innerText = '显示更多'; 
    let isExpanded = false; 

    codeMoreBtn.addEventListener('click', () => {
     if (!isExpanded) {
      codeBlock.classList.add('code-show'); 
      codeMoreBtn.innerText = '折叠'; 
      isExpanded = true;
     } else {
      codeBlock.classList.remove('code-show'); 
      codeMoreBtn.innerText = '显示更多'; 
      isExpanded = false;
     }
     
     window.dispatchEvent(new Event('resize'));
    });
    
    codeMoreBox.appendChild(codeMoreBtn);
    codeBlock.appendChild(codeMoreBox);
   });
  }


  
   
   
   
  
  

  function captureScrollListeners() {
    
    setTimeout(() => {
      
      overrideScrollspy();
    }, 2000);
  }
  
  

  function overrideScrollspy() {
    
    window.tocScrollspyEnabled = true;
    
    
    setTimeout(() => {
      
      
      
      
      if (!window.originalScrollTo) {
        window.originalScrollTo = HTMLElement.prototype.scrollTo;
        
        HTMLElement.prototype.scrollTo = function(options) {
          
          if (this.id === 'TableOfContents' && window.tocScrollDisabled) {
            return;
          }
          
          
          return window.originalScrollTo.call(this, options);
        };
      }
      
      
      if (!window.originalScrollIntoView) {
        window.originalScrollIntoView = HTMLElement.prototype.scrollIntoView;
        
        HTMLElement.prototype.scrollIntoView = function(options) {
          
          if (this.closest('#TableOfContents') && window.tocScrollDisabled) {
            return;
          }
          
          
          return window.originalScrollIntoView.call(this, options);
        };
      }
    }, 3000); 
  }
  
  function initTocLock() {
    
    
    const articleToc = document.querySelector('#TableOfContents');
    if (!articleToc) {
      
      return;
    }
    
    
    const tocContainer = document.querySelector('.widget.archives');
    if (!tocContainer) {
      return;
    }
    
    
    tocContainer.style.position = 'relative';
    
    
    captureScrollListeners();
    
    
    const lockLabel = document.createElement('div');
    lockLabel.className = 'toc-lock-label';
    lockLabel.textContent = '锁定：';
    
    
    const lockBtn = document.createElement('div');
    lockBtn.className = 'toc-lock-btn';
    lockBtn.innerHTML = `
      <svg class="lock-icon unlocked" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M19 11H5a2 2 0 0 0-2 2v7a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7a2 2 0 0 0-2-2z"/>
        <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
      </svg>
      <svg class="lock-icon locked" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="3" y="11" width="18" height="10" rx="2" ry="2"/>
        <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
        <path d="M9 12v3a3 3 0 0 0 6 0v-3"/>
      </svg>
    `;
    
    
    lockBtn.addEventListener('click', function() {
      const isLocked = this.classList.contains('locked');
      
      if (isLocked) {
        
        this.classList.remove('locked');
        localStorage.setItem('tocLocked', 'false');
        enableTocScroll();
      } else {
        
        this.classList.add('locked');
        localStorage.setItem('tocLocked', 'true');
        disableTocScroll();
      }
    });
    
    
    tocContainer.appendChild(lockLabel);
    tocContainer.appendChild(lockBtn);
    
    
    
    lockBtn.classList.remove('locked');
    localStorage.setItem('tocLocked', 'false');
    
    
    const observer = new MutationObserver(function(mutations) {
      mutations.forEach(function(mutation) {
        if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
          const isLocked = lockBtn.classList.contains('locked');
          if (isLocked) {
            disableTocScroll();
          } else {
            enableTocScroll();
          }
        }
      });
    });
    
    observer.observe(lockBtn, { attributes: true });
  }

  

  function disableTocScroll() {
    
    window.tocScrollDisabled = true;
    
    
    const tocContainer = document.querySelector('#TableOfContents');
    if (tocContainer) {
      
      window.savedTocScrollTop = tocContainer.scrollTop;
      
      
      const currentActive = tocContainer.querySelector('.active-class');
      if (currentActive) {
        window.savedActiveElement = currentActive;
      }
    }
    
    
    if (tocContainer) {
      tocContainer.setAttribute('data-scrollspy-disabled', 'true');
      tocContainer.title = '目录已锁定，不会自动跟随滚动';
    }
    
    
    const archivesContainer = document.querySelector('.widget.archives');
    if (archivesContainer) {
      archivesContainer.style.opacity = '0.8';
      archivesContainer.title = '目录已锁定，不会自动跟随滚动';
    }
  }

  

  function enableTocScroll() {
    
    window.tocScrollDisabled = false;
    
    
    const tocContainer = document.querySelector('#TableOfContents');
    if (tocContainer) {
      
      tocContainer.removeAttribute('data-scrollspy-disabled');
      tocContainer.title = '';
    }
    
    
    const archivesContainer = document.querySelector('.widget.archives');
    if (archivesContainer) {
      archivesContainer.style.opacity = '1';
      archivesContainer.title = '';
    }
  }

  
  
  
  document.addEventListener('DOMContentLoaded', function() {
  

    
    initCodeMoreBox();
    initRope();

    
    setTimeout(initTocLock, 1000);
  });

</script>


<div id="rope-container"></div>


<div id="particles-js"></div>

<script>

particlesJS('particles-js', {
  "particles": {
    "number": {
      "value": 80,
      "density": {
        "enable": true,
        "value_area": 800
      }
    },
    "color": {
      "value": ["#888888", "#aaaaaa", "#cccccc", "#eeeeee"]
    },
    "shape": {
      "type": "circle",
      "stroke": {
        "width": 0,
        "color": "#000000"
      },
      "polygon": {
        "nb_sides": 5
      }
    },
    "opacity": {
      "value": 0.5,
      "random": false,
      "anim": {
        "enable": false,
        "speed": 1,
        "opacity_min": 0.1,
        "sync": false
      }
    },
    "size": {
      "value": 2,
      "random": true,
      "anim": {
        "enable": false,
        "speed": 40,
        "size_min": 0.1,
        "sync": false
      }
    },
    "line_linked": {
      "enable": true,
      "distance": 150,
      "color": "#888888",
      "opacity": 0.4,
      "width": 1
    },
    "move": {
      "enable": true,
      "speed": 2,
      "direction": "none",
      "random": false,
      "straight": false,
      "out_mode": "out",
      "bounce": false,
      "attract": {
        "enable": false,
        "rotateX": 600,
        "rotateY": 1200
      }
    }
  },
  "interactivity": {
    "detect_on": "canvas",
    "events": {
      "onhover": {
        "enable": true,
        "mode": "grab"
      },
      "onclick": {
        "enable": true,
        "mode": "push"
      },
      "resize": true
    },
    "modes": {
      "grab": {
        "distance": 140,
        "line_linked": {
          "opacity": 1
        }
      },
      "bubble": {
        "distance": 400,
        "size": 40,
        "duration": 2,
        "opacity": 8,
        "speed": 3
      },
      "repulse": {
        "distance": 200,
        "duration": 0.4
      },
      "push": {
        "particles_nb": 4
      },
      "remove": {
        "particles_nb": 2
      }
    }
  },
  "retina_detect": true
});
</script>


<script>
(function() {
  'use strict';
  
  
  const categoryColors = [
    '#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57',
    '#ff9ff3', '#54a0ff', '#5f27cd', '#00d2d3', '#ff9f43',
    '#10ac84', '#ff6348', '#a55eea', '#e17055', '#d63031',
    '#00b894', '#fdcb6e', '#6c5ce7', '#fd79a8', '#f39c12',
    '#e67e22', '#e74c3c', '#9b59b6', '#3498db', '#1abc9c',
    '#16a085', '#27ae60', '#2ecc71', '#f1c40f', '#e67e22'
  ];
  
  
  function hashString(str) {
    let hash = 0;
    if (str.length === 0) return hash;
    
    for (let i = 0; i < str.length; i++) {
      const char = str.charCodeAt(i);
      hash = ((hash << 5) - hash) + char;
      hash = hash & hash; 
    }
    
    return Math.abs(hash);
  }
  
  
  function assignCategoryColors() {

    
    
    const isArchivesPage = document.body.classList.contains('template-archives') ||
                          window.location.pathname.includes('/archives/');
    const isArticlePage = document.querySelector('#TableOfContents') || 
                         document.querySelector('.article-category');
    
    
    
    
    if (isArticlePage && !isArchivesPage) {
      const categoryLinks = document.querySelectorAll('.article-category a');

      
      categoryLinks.forEach((link, index) => {
        
        const href = link.getAttribute('href');
        const categoryName = href.split('/').pop() || href.split('/').slice(-2, -1)[0] || 'default';
        
        
        const hash = hashString(categoryName);
        const colorIndex = hash % categoryColors.length;
        const backgroundColor = categoryColors[colorIndex];
        
        
        
        
        link.style.setProperty('background-color', backgroundColor, 'important');
        link.style.setProperty('color', '#fff', 'important');
        
        
        link.addEventListener('mouseenter', function() {
          this.style.opacity = '0.8';
          this.style.transform = 'scale(1.05)';
        });
        
        link.addEventListener('mouseleave', function() {
          this.style.opacity = '1';
          this.style.transform = 'scale(1)';
        });
      });
    }
    
    
    if (!isArchivesPage) {
      
      const sidebarCategories = document.querySelectorAll('.widget.categories a, .widget.tagCloud a');

      
      sidebarCategories.forEach((link, index) => {
        
        const href = link.getAttribute('href');
        const categoryName = href.split('/').pop() || href.split('/').slice(-2, -1)[0] || 'default';
        
        
        const hash = hashString(categoryName);
        const colorIndex = hash % categoryColors.length;
        const backgroundColor = categoryColors[colorIndex];
        
        
        
        
        link.style.setProperty('background-color', backgroundColor, 'important');
        link.style.setProperty('color', '#fff', 'important');
        link.style.setProperty('border-radius', '6px', 'important');
        link.style.setProperty('padding', '8px 12px', 'important');
        link.style.setProperty('margin', '4px 0', 'important');
        link.style.setProperty('display', 'inline-block', 'important');
        link.style.setProperty('text-decoration', 'none', 'important');
        link.style.setProperty('transition', 'all 0.3s ease', 'important');
        
        
        link.addEventListener('mouseenter', function() {
          this.style.opacity = '0.8';
          this.style.transform = 'scale(1.05)';
          this.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.2)';
        });
        
        link.addEventListener('mouseleave', function() {
          this.style.opacity = '1';
          this.style.transform = 'scale(1)';
          this.style.boxShadow = 'none';
        });
      });
    } else {
      

    }
    

  }
  
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', assignCategoryColors);
  } else {
    assignCategoryColors();
  }
  
  
  setTimeout(assignCategoryColors, 500);
  setTimeout(assignCategoryColors, 1000);
  setTimeout(assignCategoryColors, 2000);
  
  
  const observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
      if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
        
        const hasNewCategories = Array.from(mutation.addedNodes).some(node => {
          return node.nodeType === 1 && (
            node.classList.contains('article-category') ||
            node.querySelector('.article-category') ||
            node.classList.contains('widget') ||
            node.querySelector('.widget')
          );
        });
        
        if (hasNewCategories) {
          
          setTimeout(assignCategoryColors, 100);
          setTimeout(assignCategoryColors, 500);
        }
      }
    });
  });
  
  
  observer.observe(document.body, {
    childList: true,
    subtree: true
  });
})();
</script>


<script>
(function() {
  'use strict';
  
  
  function fixDarkModeToggleText() {
    const toggleBtn = document.getElementById('dark-mode-toggle');
    if (!toggleBtn) {
      return;
    }
    
    
    toggleBtn.classList.add('dark-mode-toggle-fix');
    
    
    const span = toggleBtn.querySelector('span');
    if (!span) {
      return;
    }
    
    
    function updateText() {
      const isDark = document.documentElement.dataset.scheme === 'dark';
      span.textContent = isDark ? '亮色模式' : '暗色模式';

    }
    
    
    updateText();
    
    
    function handleThemeChange() {
      setTimeout(updateText, 100); 
    }
    
    
    window.addEventListener('onColorSchemeChange', handleThemeChange);
    
    
    const observer = new MutationObserver(function(mutations) {
      mutations.forEach(function(mutation) {
        if (mutation.type === 'attributes' && mutation.attributeName === 'data-scheme') {
          handleThemeChange();
        }
      });
    });
    
    observer.observe(document.documentElement, {
      attributes: true,
      attributeFilter: ['data-scheme']
    });
    
    
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', handleThemeChange);
    
    
    toggleBtn.addEventListener('click', function() {
      
      setTimeout(updateText, 200);
    });
    

  }
  
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', fixDarkModeToggleText);
  } else {
    fixDarkModeToggleText();
  }
  
  
  setTimeout(fixDarkModeToggleText, 1000);
  setTimeout(fixDarkModeToggleText, 2000);
})();
</script>

  
  <script>
  
  if (!document.getElementById('new-theme-switch')) {
    document.write(`
      <div id="new-theme-switch" style="position: fixed; bottom: 50px; left: 50px; z-index: 1000; text-align: center;">
        <label class="theme-switch">
          <input type="checkbox" class="theme-switch__checkbox" id="theme-switch-checkbox">
          <div class="theme-switch__container">
            <div class="theme-switch__clouds"></div>
            <div class="theme-switch__stars-container">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 144 55" fill="none">
                <path fill-rule="evenodd" clip-rule="evenodd" d="M135.831 3.00688C135.055 3.85027 134.111 4.29946 133 4.35447C134.111 4.40947 135.055 4.85867 135.831 5.71123C136.607 6.55462 136.996 7.56303 136.996 8.72727C136.996 7.95722 137.172 7.25134 137.525 6.59129C137.886 5.93124 138.372 5.39954 138.98 5.00535C139.598 4.60199 140.268 4.39114 141 4.35447C139.88 4.2903 138.936 3.85027 138.16 3.00688C137.384 2.16348 136.996 1.16425 136.996 0C136.996 1.16425 136.607 2.16348 135.831 3.00688ZM31 23.3545C32.1114 23.2995 33.0551 22.8503 33.8313 22.0069C34.6075 21.1635 34.9956 20.1642 34.9956 19C34.9956 20.1642 35.3837 21.1635 36.1599 22.0069C36.9361 22.8503 37.8798 23.2903 39 23.3545C38.2679 23.3911 37.5976 23.602 36.9802 24.0053C36.3716 24.3995 35.8864 24.9312 35.5248 25.5913C35.172 26.2513 34.9956 26.9572 34.9956 27.7273C34.9956 26.563 34.6075 25.5546 33.8313 24.7112C33.0551 23.8587 32.1114 23.4095 31 23.3545ZM0 36.3545C1.11136 36.2995 2.05513 35.8503 2.83131 35.0069C3.6075 34.1635 3.99559 33.1642 3.99559 32C3.99559 33.1642 4.38368 34.1635 5.15987 35.0069C5.93605 35.8503 6.87982 36.2903 8 36.3545C7.26792 36.3911 6.59757 36.602 5.98015 37.0053C5.37155 37.3995 4.88644 37.9312 4.52481 38.5913C4.172 39.2513 3.99559 39.9572 3.99559 40.7273C3.99559 39.563 4.38368 38.5546 2.83131 37.7112C2.05513 36.8587 1.11136 36.4095 0 36.3545ZM56.8313 24.0069C56.0551 24.8503 55.1114 25.2995 54 25.3545C55.1114 25.4095 56.0551 25.8587 56.8313 26.7112C57.6075 27.5546 57.9956 28.563 57.9956 29.7273C57.9956 28.9572 58.172 28.2513 58.5248 27.5913C58.8864 26.9312 59.3716 26.3995 59.9802 26.0053C60.5976 25.602 61.2679 25.3911 62 25.3545C60.8798 25.2903 59.9361 24.8503 59.1599 24.0069C58.3837 23.1635 57.9956 22.1642 57.9956 21C57.9956 22.1642 57.6075 23.1635 56.8313 24.0069ZM81 25.3545C82.1114 25.2995 83.0551 24.8503 83.8313 24.0069C84.6075 23.1635 84.9956 22.1642 84.9956 21C84.9956 22.1642 85.3837 23.1635 86.1599 24.0069C86.9361 24.8503 87.8798 25.2903 89 25.3545C88.2679 25.3911 87.5976 25.602 86.9802 26.0053C86.3716 26.3995 85.8864 26.9312 85.5248 27.5913C85.172 28.2513 84.9956 28.9572 84.9956 29.7273C84.9956 28.563 84.6075 27.5546 83.8313 26.7112C83.0551 25.8587 82.1114 25.4095 81 25.3545ZM136 36.3545C137.111 36.2995 138.055 35.8503 138.831 35.0069C139.607 34.1635 139.996 33.1642 139.996 32C139.996 33.1642 140.384 34.1635 141.16 35.0069C141.936 35.8503 142.88 36.2903 144 36.3545C143.268 36.3911 142.598 36.602 141.98 37.0053C141.372 37.3995 140.886 37.9312 140.525 38.5913C140.172 39.2513 139.996 39.9572 139.996 40.7273C139.996 39.563 139.607 38.5546 138.831 37.7112C138.055 36.8587 137.111 36.4095 136 36.3545ZM101.831 49.0069C101.055 49.8503 100.111 50.2995 99 50.3545C100.111 50.4095 101.055 50.8587 101.831 51.7112C102.607 52.5546 102.996 53.563 102.996 54.7273C102.996 53.9572 103.172 53.2513 103.525 52.5913C103.886 51.9312 104.372 51.3995 104.98 51.0053C105.598 50.602 106.268 50.3911 107 50.3545C105.88 50.2903 104.936 49.8503 104.16 49.0069C103.384 48.1635 102.996 47.1642 102.996 46C102.996 47.1642 102.607 48.1635 101.831 49.0069Z" fill="currentColor"></path>
              </svg>
            </div>
            <div class="theme-switch__circle-container">
              <div class="theme-switch__sun-moon-container">
                <div class="theme-switch__moon">
                  <div class="theme-switch__spot"></div>
                  <div class="theme-switch__spot"></div>
                  <div class="theme-switch__spot"></div>
                </div>
              </div>
            </div>
          </div>
        </label>
        <div id="theme-switch-text" style="color: #fff; font-size: 14px; font-weight: 600; text-shadow: 0 1px 2px rgba(0,0,0,0.5); margin-top: 8px; text-align: center;">亮色模式</div>
      </div>
    `);
  }
  </script>


<style>
   
  .theme-switch {
    --toggle-size: 20px;  
    --container-width: 3.75em;
    --container-height: 1.7em;
    --container-radius: 4.2em;
    --container-light-bg: #3D7EAE;
    --container-night-bg: #1D1F2C;
    --circle-container-diameter: 2.25em;
    --sun-moon-diameter: 1.4em;
    --sun-bg: #ECCA2F;
    --moon-bg: #C4C9D1;
    --spot-color: #959DB1;
    --circle-container-offset: calc((var(--circle-container-diameter) - var(--container-height)) / 2 * -1);
    --stars-color: #fff;
    --clouds-color: #F3FDFF;
    --back-clouds-color: #AACADF;
    --transition: .5s cubic-bezier(0, -0.02, 0.4, 1.25);
    --circle-transition: .3s cubic-bezier(0, -0.02, 0.35, 1.17);
  }

  .theme-switch, .theme-switch *, .theme-switch *::before, .theme-switch *::after {
    -webkit-box-sizing: border-box;
    box-sizing: border-box;
    margin: 0;
    padding: 0;
    font-size: var(--toggle-size);
  }

  .theme-switch__container {
    width: var(--container-width);
    height: var(--container-height);
    background-color: var(--container-light-bg);
    border-radius: var(--container-radius);
    overflow: hidden;
    cursor: pointer;
    -webkit-box-shadow: 0em -0.062em 0.062em rgba(0, 0, 0, 0.25), 0em 0.062em 0.125em rgba(255, 255, 255, 0.94);
    box-shadow: 0em -0.062em 0.062em rgba(0, 0, 0, 0.25), 0em 0.062em 0.125em rgba(255, 255, 255, 0.94);
    -webkit-transition: var(--transition);
    -o-transition: var(--transition);
    transition: var(--transition);
    position: relative;
  }

  .theme-switch__container::before {
    content: "";
    position: absolute;
    z-index: 1;
    inset: 0;
    -webkit-box-shadow: 0em 0.05em 0.187em rgba(0, 0, 0, 0.25) inset, 0em 0.05em 0.187em rgba(0, 0, 0, 0.25) inset;
    box-shadow: 0em 0.05em 0.187em rgba(0, 0, 0, 0.25) inset, 0em 0.05em 0.187em rgba(0, 0, 0, 0.25) inset;
    border-radius: var(--container-radius)
  }

  .theme-switch__checkbox {
    display: none;
  }

  .theme-switch__circle-container {
    width: var(--circle-container-diameter);
    height: var(--circle-container-diameter);
    background-color: rgba(255, 255, 255, 0.1);
    position: absolute;
    left: var(--circle-container-offset);
    top: var(--circle-container-offset);
    border-radius: var(--container-radius);
    -webkit-box-shadow: inset 0 0 0 3.375em rgba(255, 255, 255, 0.1), inset 0 0 0 3.375em rgba(255, 255, 255, 0.1), 0 0 0 0.625em rgba(255, 255, 255, 0.1), 0 0 0 1.25em rgba(255, 255, 255, 0.1);
    box-shadow: inset 0 0 0 3.375em rgba(255, 255, 255, 0.1), inset 0 0 0 3.375em rgba(255, 255, 255, 0.1), 0 0 0 0.625em rgba(255, 255, 255, 0.1), 0 0 0 1.25em rgba(255, 255, 255, 0.1);
    display: -webkit-box;
    display: -ms-flexbox;
    display: flex;
    -webkit-transition: var(--circle-transition);
    -o-transition: var(--circle-transition);
    transition: var(--circle-transition);
    pointer-events: none;
  }

  .theme-switch__sun-moon-container {
    pointer-events: auto;
    position: relative;
    z-index: 2;
    width: var(--sun-moon-diameter);
    height: var(--sun-moon-diameter);
    margin: auto;
    border-radius: var(--container-radius);
    background-color: var(--sun-bg);
    -webkit-box-shadow: 0.062em 0.062em 0.062em 0em rgba(254, 255, 239, 0.61) inset, 0em -0.062em 0.062em 0em #a1872a inset;
    box-shadow: 0.062em 0.062em 0.062em 0em rgba(254, 255, 239, 0.61) inset, 0em -0.062em 0.062em 0em #a1872a inset;
    -webkit-filter: drop-shadow(0.062em 0.125em 0.125em rgba(0, 0, 0, 0.25)) drop-shadow(0em 0.062em 0.125em rgba(0, 0, 0, 0.25));
    filter: drop-shadow(0.062em 0.125em 0.125em rgba(0, 0, 0, 0.25)) drop-shadow(0em 0.062em 0.125em rgba(0, 0, 0, 0.25));
    overflow: hidden;
    -webkit-transition: var(--transition);
    -o-transition: var(--transition);
    transition: var(--transition);
  }

  .theme-switch__moon {
    -webkit-transform: translateX(100%);
    -ms-transform: translateX(100%);
    transform: translateX(100%);
    width: 100%;
    height: 100%;
    background-color: var(--moon-bg);
    border-radius: inherit;
    -webkit-box-shadow: 0.062em 0.062em 0.062em 0em rgba(254, 255, 239, 0.61) inset, 0em -0.062em 0.062em 0em #969696 inset;
    box-shadow: 0.062em 0.062em 0.062em 0em rgba(254, 255, 239, 0.61) inset, 0em -0.062em 0.062em 0em #969696 inset;
    -webkit-transition: var(--transition);
    -o-transition: var(--transition);
    transition: var(--transition);
    position: relative;
  }

  .theme-switch__spot {
    position: absolute;
    top: 0.75em;
    left: 0.312em;
    width: 0.75em;
    height: 0.75em;
    border-radius: var(--container-radius);
    background-color: var(--spot-color);
    -webkit-box-shadow: 0em 0.0312em 0.062em rgba(0, 0, 0, 0.25) inset;
    box-shadow: 0em 0.0312em 0.062em rgba(0, 0, 0, 0.25) inset;
  }

  .theme-switch__spot:nth-of-type(2) {
    width: 0.375em;
    height: 0.375em;
    top: 0.937em;
    left: 1.375em;
  }

  .theme-switch__spot:nth-last-of-type(3) {
    width: 0.25em;
    height: 0.25em;
    top: 0.312em;
    left: 0.812em;
  }

  .theme-switch__clouds {
    width: 1.25em;
    height: 1.25em;
    background-color: var(--clouds-color);
    border-radius: var(--container-radius);
    position: absolute;
    bottom: -0.625em;
    left: 0.312em;
    -webkit-box-shadow: 0.937em 0.312em var(--clouds-color), -0.312em -0.312em var(--back-clouds-color), 1.437em 0.375em var(--clouds-color), 0.5em -0.125em var(--back-clouds-color), 2.187em 0 var(--clouds-color), 1.25em -0.062em var(--back-clouds-color), 2.937em 0.312em var(--clouds-color), 2em -0.312em var(--back-clouds-color), 3.625em -0.062em var(--clouds-color), 2.625em 0em var(--back-clouds-color), 4.5em -0.312em var(--clouds-color), 3.375em -0.437em var(--back-clouds-color), 4.625em -1.75em 0 0.437em var(--clouds-color), 4em -0.625em var(--back-clouds-color), 4.125em -2.125em 0 0.437em var(--back-clouds-color);
    box-shadow: 0.937em 0.312em var(--clouds-color), -0.312em -0.312em var(--back-clouds-color), 1.437em 0.375em var(--clouds-color), 0.5em -0.125em var(--back-clouds-color), 2.187em 0 var(--clouds-color), 1.25em -0.062em var(--back-clouds-color), 2.937em 0.312em var(--clouds-color), 2em -0.312em var(--back-clouds-color), 3.625em -0.062em var(--clouds-color), 2.625em 0em var(--back-clouds-color), 4.5em -0.312em var(--clouds-color), 3.375em -0.437em var(--back-clouds-color), 4.625em -1.75em 0 0.437em var(--clouds-color), 4em -0.625em var(--back-clouds-color), 4.125em -2.125em 0 0.437em var(--back-clouds-color);
    -webkit-transition: 0.5s cubic-bezier(0, -0.02, 0.4, 1.25);
    -o-transition: 0.5s cubic-bezier(0, -0.02, 0.4, 1.25);
    transition: 0.5s cubic-bezier(0, -0.02, 0.4, 1.25);
  }

  .theme-switch__stars-container {
    position: absolute;
    color: var(--stars-color);
    top: -100%;
    left: 0.312em;
    width: 2.75em;
    height: auto;
    -webkit-transition: var(--transition);
    -o-transition: var(--transition);
    transition: var(--transition);
  }

   
  .theme-switch__checkbox:checked + .theme-switch__container {
    background-color: var(--container-night-bg);
  }

  .theme-switch__checkbox:checked + .theme-switch__container .theme-switch__circle-container {
    left: calc(100% - var(--circle-container-offset) - var(--circle-container-diameter));
  }

  .theme-switch__checkbox:checked + .theme-switch__container .theme-switch__circle-container:hover {
    left: calc(100% - var(--circle-container-offset) - var(--circle-container-diameter) - 0.187em)
  }

  .theme-switch__circle-container:hover {
    left: calc(var(--circle-container-offset) + 0.187em);
  }

  .theme-switch__checkbox:checked + .theme-switch__container .theme-switch__moon {
    -webkit-transform: translate(0);
    -ms-transform: translate(0);
    transform: translate(0);
    transform: translate(0);
  }

  .theme-switch__checkbox:checked + .theme-switch__container .theme-switch__clouds {
    bottom: -4.062em;
  }

  .theme-switch__checkbox:checked + .theme-switch__container .theme-switch__stars-container {
    top: 50%;
    -webkit-transform: translateY(-50%);
    -ms-transform: translateY(-50%);
    transform: translateY(-50%);
  }

   
  #dark-mode-toggle {
    display: none !important;
  }

   
  .dark-mode-toggle-fix span {
    font-size: 18px !important;
    font-weight: 600 !important;
  }
</style>


<script>
(function() {
  'use strict';
  
  
  if (window.themeSwitchInitialized) {
    console.log('主题切换开关已经初始化，跳过重复执行');
    return;
  }
  
  let isInitialized = false;
  let observer = null;
  
  function initNewThemeSwitch() {
    
    if (isInitialized) {
      return;
    }
    
    const checkbox = document.getElementById('theme-switch-checkbox');
    if (!checkbox) {
      return;
    }
    
    
    function updateCheckboxState() {
      const isDark = document.documentElement.dataset.scheme === 'dark';
      checkbox.checked = isDark;
      
      
      const textElement = document.getElementById('theme-switch-text');
      if (textElement) {
        textElement.textContent = isDark ? '暗色模式' : '亮色模式';
        console.log('更新主题切换文字:', isDark ? '暗色模式' : '亮色模式');
      }
      
      console.log('当前主题状态:', isDark ? 'dark' : 'light', 'checkbox状态:', checkbox.checked);
    }
    
    
    function waitForThemeSystem() {
      
      const schemeFromData = document.documentElement.dataset.scheme;
      const schemeFromClass = document.documentElement.className.includes('dark') ? 'dark' : 
                             document.documentElement.className.includes('light') ? 'light' : null;
      const schemeFromLocalStorage = localStorage.getItem('StackColorScheme');
      
      if (schemeFromData || schemeFromClass || schemeFromLocalStorage) {
        
        let finalScheme = schemeFromData || schemeFromClass || schemeFromLocalStorage;
        
        
        if (schemeFromData) {
          finalScheme = schemeFromData;
        }
        
        
        document.documentElement.dataset.scheme = finalScheme;
        
        
        updateCheckboxState();
        isInitialized = true;
        window.themeSwitchInitialized = true;
        
        console.log('主题系统已初始化，当前主题:', finalScheme);
      } else {
        
        setTimeout(waitForThemeSystem, 100);
      }
    }
    
    
    waitForThemeSystem();
    
    
    checkbox.addEventListener('change', function() {
      const scheme = this.checked ? 'dark' : 'light';
      document.documentElement.dataset.scheme = scheme;
      
      
      localStorage.setItem('StackColorScheme', scheme);
      
      
      document.dispatchEvent(new CustomEvent('onColorSchemeChange'));
    });
    
    
    window.addEventListener('onColorSchemeChange', updateCheckboxState);
    
    
    observer = new MutationObserver(function(mutations) {
      mutations.forEach(function(mutation) {
        if (mutation.type === 'attributes' && mutation.attributeName === 'data-scheme') {
          updateCheckboxState();
        }
      });
    });
    
    observer.observe(document.documentElement, {
      attributes: true,
      attributeFilter: ['data-scheme']
    });
  }
  
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initNewThemeSwitch);
  } else {
    initNewThemeSwitch();
  }
  
  
  setTimeout(initNewThemeSwitch, 1500);
})();
</script>


<script>
(function() {
  'use strict';
  
  
  if (window.hoverEffectsInitialized) {
    console.log('悬浮效果已经初始化，跳过重复执行');
    return;
  }
  
  let isHoverEffectsInitialized = false;
  let hoverObserver = null;
  
  
  function forceCategoryHoverEffects() {
    
    if (isHoverEffectsInitialized) {
      return;
    }
    
    const articles = document.querySelectorAll('.article-list--compact article');
    if (articles.length > 0) {
      articles.forEach(article => {
        
        if (article.hasAttribute('data-hover-initialized')) {
          return;
        }
        
        
        article.style.setProperty('transition', 'all 0.3s ease', 'important');
        article.style.setProperty('will-change', 'transform, box-shadow', 'important');
        
        
        article.addEventListener('mouseenter', function() {
          this.style.setProperty('transform', 'translateY(-5px)', 'important');
          this.style.setProperty('box-shadow', '0 10px 30px rgba(0, 0, 0, 0.12)', 'important');
        });
        
        article.addEventListener('mouseleave', function() {
          this.style.setProperty('transform', 'translateY(0)', 'important');
          this.style.setProperty('box-shadow', 'none', 'important');
        });
        
        
        article.setAttribute('data-hover-initialized', 'true');
      });
      
      isHoverEffectsInitialized = true;
      window.hoverEffectsInitialized = true;
    }
  }
  
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', forceCategoryHoverEffects);
  } else {
    forceCategoryHoverEffects();
  }
  
  
  setTimeout(forceCategoryHoverEffects, 1000);
  
  
  hoverObserver = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
      if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
        
        setTimeout(forceCategoryHoverEffects, 100);
      }
    });
  });
  
  
  hoverObserver.observe(document.body, {
    childList: true,
    subtree: true
  });
})();
</script>

    </body>
</html>
